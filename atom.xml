<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>SN1987A</title>
  
  <subtitle>LAYã®BLOG</subtitle>
  <link href="http://sn1987a-1.github.io/atom.xml" rel="self"/>
  
  <link href="http://sn1987a-1.github.io/"/>
  <updated>2023-09-24T03:47:34.736Z</updated>
  <id>http://sn1987a-1.github.io/</id>
  
  <author>
    <name>SN1987A</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MLç®—æ³•ï¼šXGBoost</title>
    <link href="http://sn1987a-1.github.io/posts/f54e13d4.html"/>
    <id>http://sn1987a-1.github.io/posts/f54e13d4.html</id>
    <published>2023-11-28T12:48:34.000Z</published>
    <updated>2023-09-24T03:47:34.736Z</updated>
    
    <content type="html"><![CDATA[<h2 id="XGBoost"><a href="#XGBoost" class="headerlink" title="XGBoost"></a>XGBoost</h2><h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><p>æœ¬å®éªŒè¦æ±‚å­¦ä¹ XGBoostæ¨¡å‹çš„åŸç†ï¼Œå¹¶å®ç°è¯¥æ¨¡å‹ï¼Œä»¥åŠåœ¨æ•°æ®é›†ä¸Šå®Œæˆè®­ç»ƒå’Œæµ‹è¯•ã€‚</p><h3 id="å®éªŒåŸç†"><a href="#å®éªŒåŸç†" class="headerlink" title="å®éªŒåŸç†"></a>å®éªŒåŸç†</h3><p>XGBoostçš„åŸºæœ¬åŸç†å°±æ˜¯ä»¥å†³ç­–æ ‘ä½œä¸ºåŸºå­¦ä¹ å™¨çš„åŠ æ³•æ¨¡å‹ï¼Œæ¯æ£µæ ‘æ ¹æ®å‰tä¸ªæ¨¡å‹çš„è¾“å‡ºè®¡ç®—èŠ‚ç‚¹çš„æƒé‡ï¼Œæœ€ç»ˆçš„è¾“å‡ºä¸ºï¼š</p><script type="math/tex; mode=display">y_i^{(t)}=âˆ‘^t_{k=1}f_k (x_i )=y _i^{(t-1)}+f_t (x_i )</script><p>æœ¬å®éªŒçš„é—®é¢˜æ¨¡å‹ä¸ºå›å½’é—®é¢˜ï¼Œå³$ğ‘™ğ‘œğ‘ ğ‘ (ğ‘¦_ğ‘–,ğ‘¦ _ğ‘–^{(ğ‘¡)} )=(ğ‘¦_ğ‘–âˆ’\hat y _ğ‘–^{(ğ‘¡)} )^2$ã€‚</p><p>å¯¹äºæŸå¤±lossï¼Œè®° $g_i$ ä¸ºä¸€é˜¶å¯¼æ•°ï¼Œ$h_i$ ä¸ºäºŒé˜¶å¯¼æ•°ï¼Œå³$g_i=\frac{\partial\ loss(y_i,y _i^{(t-1)})}{\partial\  y _i^{(t-1) } }=2(\hat y^{t-1}-y)$, $h_i=\frac{\partial^2 loss(y_i,y _i^{(t-1)} )}{\partial \ (y _i^{(t-1)} )^2 }=2\\ $ã€‚</p><p>åœ¨è®­ç»ƒç¬¬tæ£µå†³ç­–æ ‘æ—¶,ç›®æ ‡å‡½æ•°ä¸º$Obj^{(t)}=âˆ‘_{i=1}^n[g_i f_t (x_i )+\frac12 h_i f_t^2 (x_i)]+penalty(f_t )$</p><p>å¯¹äºä¸€æ£µå†³ç­–æ ‘ï¼Œå…¶æƒ©ç½šä¸ºï¼š</p><script type="math/tex; mode=display">penalty(f)=\gamma\cdot T+\frac12\lambda\cdot\|w\|^2</script><p>å°†åˆ†é…åˆ°ç¬¬ $j$ ä¸ªå¶å­èŠ‚ç‚¹çš„æ ·æœ¬ç”¨ $I_j$ è¡¨ç¤ºï¼Œå³ $I_j=\{i|q(x_i )=j\} (1â‰¤jâ‰¤T)$ï¼Œåœ¨æ ‘ç»“æ„ç¡®å®šæ—¶å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–ï¼š</p><script type="math/tex; mode=display">\begin{split}ğ‘‚ğ‘ğ‘—^{(ğ‘¡)}&=âˆ‘_{ğ‘—=1}^ğ‘‡[(âˆ‘_{iâˆˆğ¼_ğ‘—}ğ‘”_ğ‘– )w_j+\frac12(\sum_{i\in I_j}h_i+\lambda)w^2_j]+\gamma T\end{split}\\è®° G_j=âˆ‘_{iâˆˆğ¼_ğ‘—}ğ‘”_ğ‘– , H_j=âˆ‘_{iâˆˆğ¼_ğ‘—}h_ğ‘– \\ Obj^{(t)}=\sum_{j=1}^T[G_jw_j+\frac12(H_j+\lambda)w_j^2]+\gamma T</script><p>æ±‚è§£$w$     :$w_j^*=-\frac{G_j}{H_j+\lambda}$ï¼Œæ­¤æ—¶å†³ç­–æ ‘çš„å¾—åˆ†ï¼š$Obj^{(t)}=-\frac12\sum^{T}_{j=1}\frac{G_j^2}{H_j+\lambda}+\gamma T$</p><h3 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h4 id="è¯»å–æ•°æ®å’Œæ•°æ®å¤„ç†"><a href="#è¯»å–æ•°æ®å’Œæ•°æ®å¤„ç†" class="headerlink" title="è¯»å–æ•°æ®å’Œæ•°æ®å¤„ç†"></a>è¯»å–æ•°æ®å’Œæ•°æ®å¤„ç†</h4><p>æ•°æ®æ–‡ä»¶ä¸­çš„å„é¡¹æ•°æ®å‡ä¸å«æœ‰NULLé¡¹ï¼Œæ— éœ€è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'train.data'</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'train.data'</span><span class="token punctuation">,</span>names<span class="token operator">=</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#é‡æ–°è¯»å–æ•°æ®ï¼Œé˜²æ­¢å°†ç¬¬ä¸€è¡Œçš„æ•°æ®è¯†åˆ«ä¸ºç´¢å¼•</span>Data<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>df<span class="token punctuation">)</span>a<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">*</span>Data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>Data<span class="token operator">=</span>np<span class="token punctuation">.</span>c_<span class="token punctuation">[</span>Data<span class="token punctuation">,</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>Data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T<span class="token punctuation">]</span>num<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>permutation<span class="token punctuation">(</span>Data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>Data<span class="token operator">=</span>Data<span class="token punctuation">[</span>num<span class="token punctuation">]</span>test_data<span class="token operator">=</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>train_data<span class="token operator">=</span>Data<span class="token punctuation">[</span>a<span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token comment">#æŒ‰ç…§7ï¼š3çš„æ¯”ä¾‹åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ•°æ®é›†çš„åŸºç¡€ä¸Šæ·»åŠ ä¸€åˆ—0ï¼Œç”¨æ¥å­˜å‚¨æ¯è½®è®­ç»ƒç»“æŸåçš„é¢„æµ‹å€¼ï¼Œå³<code>data=[:,-2]</code>ä»£è¡¨çœŸå®å€¼,<code>data[:,-1]</code>ä»£è¡¨é¢„æµ‹å€¼ã€‚</p><h4 id="å›å½’æ ‘æ¨¡å‹"><a href="#å›å½’æ ‘æ¨¡å‹" class="headerlink" title="å›å½’æ ‘æ¨¡å‹"></a>å›å½’æ ‘æ¨¡å‹</h4><p>è¶…å‚æ•°:</p><p>maxdepth=4,minscore=0,minindex=3,lambda=800,gamma=1e-7</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RegressionTree</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token punctuation">:</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>åˆå§‹åŒ–        <span class="token keyword">def</span> <span class="token function">Leaf</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#å¶èŠ‚ç‚¹</span>        G<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        H<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> <span class="token operator">-</span>G<span class="token operator">/</span><span class="token punctuation">(</span>H<span class="token operator">+</span>self<span class="token punctuation">.</span>lam<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">Obj</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#è®¡ç®—å¾—åˆ†</span>        G<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        H<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        obj<span class="token operator">=</span><span class="token operator">-</span>G<span class="token operator">**</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">/</span><span class="token punctuation">(</span>H<span class="token operator">+</span>self<span class="token punctuation">.</span>lam<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>gamma        <span class="token keyword">return</span> obj    <span class="token keyword">def</span> <span class="token function">split</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">,</span>num<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#æ ¹æ®numå’Œvalæ‰¾åˆ°æœ€ä½³åˆ’åˆ†</span>        lchild<span class="token operator">=</span>data<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>num<span class="token punctuation">]</span><span class="token operator">&lt;=</span>val<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>        rchild<span class="token operator">=</span>data<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>num<span class="token punctuation">]</span><span class="token operator">&gt;</span>val<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> lchild<span class="token punctuation">,</span>rchild    <span class="token keyword">def</span> <span class="token function">ChooseSplit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        å¯¹æ ·æœ¬é›†è¿›è¡Œåˆ’åˆ†ï¼Œæ‰¾åˆ°æœ€ä½³åˆ’åˆ†        """</span>        <span class="token keyword">if</span> data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>self<span class="token punctuation">.</span>minindex <span class="token keyword">or</span> depth<span class="token operator">&gt;</span>self<span class="token punctuation">.</span>maxdepth<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>Leaf<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>Leaf<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        pobj<span class="token operator">=</span>self<span class="token punctuation">.</span>Obj<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        maxscore<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>        maxnum<span class="token operator">=</span><span class="token number">0</span>        maxval<span class="token operator">=</span><span class="token number">0</span>        n<span class="token punctuation">,</span>m<span class="token operator">=</span>data<span class="token punctuation">.</span>shape        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            n<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">set</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>                lchild<span class="token punctuation">,</span>rchild<span class="token operator">=</span>self<span class="token punctuation">.</span>split<span class="token punctuation">(</span>data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>lchild<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rchild<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                score<span class="token operator">=</span><span class="token operator">-</span>self<span class="token punctuation">.</span>Obj<span class="token punctuation">(</span>lchild<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>Obj<span class="token punctuation">(</span>rchild<span class="token punctuation">)</span><span class="token operator">+</span>pobj                <span class="token keyword">if</span> score<span class="token operator">&gt;</span>maxscore<span class="token punctuation">:</span>                    maxscore<span class="token operator">=</span>score                    maxnum<span class="token operator">=</span>i                    maxval<span class="token operator">=</span>j        <span class="token keyword">if</span> maxscore<span class="token operator">&lt;=</span>self<span class="token punctuation">.</span>minscore<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>Leaf<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">return</span> maxnum<span class="token punctuation">,</span>maxval    <span class="token keyword">def</span> <span class="token function">CreateTree</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">:</span>        num<span class="token punctuation">,</span>val<span class="token operator">=</span>self<span class="token punctuation">.</span>ChooseSplit<span class="token punctuation">(</span>data<span class="token punctuation">,</span>depth<span class="token punctuation">)</span>        <span class="token keyword">if</span> num<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> val        lchild<span class="token punctuation">,</span>rchild<span class="token operator">=</span>self<span class="token punctuation">.</span>split<span class="token punctuation">(</span>data<span class="token punctuation">,</span>num<span class="token punctuation">,</span>val<span class="token punctuation">)</span>        Tree<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token triple-quoted-string string">"""        å¦‚æœä¸æ˜¯å¶èŠ‚ç‚¹ï¼Œåˆ™ä»¥å­—å…¸å½¢å¼å»ºæ ‘ï¼Œå¦åˆ™èŠ‚ç‚¹åªå­˜å‚¨å¶å­çš„å€¼        """</span>        Tree<span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token operator">=</span>num        Tree<span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span><span class="token operator">=</span>val        Tree<span class="token punctuation">[</span><span class="token string">'lchild'</span><span class="token punctuation">]</span><span class="token operator">=</span>self<span class="token punctuation">.</span>CreateTree<span class="token punctuation">(</span>lchild<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        Tree<span class="token punctuation">[</span><span class="token string">'rchild'</span><span class="token punctuation">]</span><span class="token operator">=</span>self<span class="token punctuation">.</span>CreateTree<span class="token punctuation">(</span>rchild<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Tree<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œå†³ç­–æ ‘çš„éå¶å­èŠ‚ç‚¹æœ‰å±æ€§ï¼š</p><ul><li>numï¼Œvalï¼šåœ¨è¯¥ç»“ç‚¹å¤„é€‰å–ç¬¬numä¸ªå±æ€§å€¼è¿›è¡Œåˆ’åˆ†ï¼Œæœ€ä½³åˆ’åˆ†ç‚¹ä¸ºval</li><li>lchildï¼Œrchildï¼šåˆ†åˆ«æŒ‡å‘ç¬¬numä¸ªå±æ€§å°äºç­‰äºvalå’Œå¤§äºvalçš„å­æ ‘</li></ul><p>å¯¹äºå•æ£µå†³ç­–æ ‘çš„åœæ­¢ç­–ç•¥ï¼š</p><ul><li>maxdepthï¼šæ¯æ¬¡åˆ’åˆ†è®°å½•æ ‘çš„é«˜åº¦ï¼Œæ·±åº¦ä¸ºmaxdepthæ—¶ç›´æ¥å½“ä½œå¶å­èŠ‚ç‚¹</li><li>minindexï¼šæ¯æ¬¡åˆ’åˆ†æ—¶ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„æ ·æœ¬æ•°å°äºminindexï¼Œåˆ™ç›´æ¥ä½œä¸ºå¶å­èŠ‚ç‚¹</li><li>minscoreï¼šè‹¥æ¯æ¬¡åˆ’åˆ†çš„æœ€ä½³åˆ’åˆ†çš„å¾—åˆ†å°äºç­‰äºminscoreæ—¶ï¼Œç›´æ¥ä½œä¸ºå¶å­èŠ‚ç‚¹</li></ul><p>ä¼˜åŒ–ChooseSpiltå‡½æ•°ã€‚ä¸ºäº†å‡å°‘æ¯æ¬¡å¯¹å¾—åˆ†Objçš„è®¡ç®—æ—¶å­˜åœ¨çš„é‡å¤è®¡ç®—ï¼Œå°†å‡½æ•°çš„æ ¸å¿ƒéƒ¨åˆ†åšä»¥ä¸‹ä¿®æ”¹ï¼šï¼ˆå°†æ•°æ®æŒ‰ç…§å½“å‰å±æ€§è¿›è¡Œæ’åºï¼Œæ¯æ¬¡é€‰å–çš„å±æ€§å€¼ä¾æ¬¡å¢å¤§ï¼Œå› æ­¤å·¦å³ä¸¤å­©å­çš„gï¼Œhçº¿æ€§å¢/å‡ï¼Œå¯¹äºå·¦å­©å­ï¼š$\Delta g=\sum _{data[j,i]=val}(data1[j,-1]-data1[j,-2])<em>2.0$,$\Delta h=2</em>\sum_{data[j,i]=val}$ï¼‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">gl<span class="token operator">=</span><span class="token number">0</span>hl<span class="token operator">=</span><span class="token number">0</span>gr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>hr<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>ndata1<span class="token operator">=</span>data<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gl<span class="token operator">+=</span><span class="token punctuation">(</span>data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2.0</span>    gr<span class="token operator">-=</span><span class="token punctuation">(</span>data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2.0</span>    hl<span class="token operator">+=</span><span class="token number">2</span>    hr<span class="token operator">-=</span><span class="token number">2</span>    <span class="token keyword">if</span> data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">==</span>data1<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>         <span class="token keyword">continue</span>    obj1<span class="token operator">=</span><span class="token operator">-</span>gl<span class="token operator">**</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">/</span><span class="token punctuation">(</span>hl<span class="token operator">+</span>self<span class="token punctuation">.</span>lam<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>gamma    obj2<span class="token operator">=</span><span class="token operator">-</span>gr<span class="token operator">**</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">/</span><span class="token punctuation">(</span>hr<span class="token operator">+</span>self<span class="token punctuation">.</span>lam<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>gamma    score<span class="token operator">=</span>pobj<span class="token operator">-</span>obj1<span class="token operator">-</span>obj2    <span class="token keyword">if</span> score<span class="token operator">&gt;</span>maxscore<span class="token punctuation">:</span>        maxscore<span class="token operator">=</span>score        maxnum<span class="token operator">=</span>i        maxval<span class="token operator">=</span>data1<span class="token punctuation">[</span>j<span class="token punctuation">,</span>i<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="XGBoostæ¨¡å‹"><a href="#XGBoostæ¨¡å‹" class="headerlink" title="XGBoostæ¨¡å‹"></a>XGBoostæ¨¡å‹</h4><p>è¶…å‚æ•°ï¼štreenum=30</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">XGBoost</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">,</span>treenum<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">isTree</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>tree<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#åˆ¤æ–­èŠ‚ç‚¹çš„ç±»å‹ï¼Œéå¶å­èŠ‚ç‚¹ä¸ºå­—å…¸ç±»å‹ï¼Œå¶å­èŠ‚ç‚¹ä¸ºfloatç±»å‹</span>        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token operator">==</span><span class="token string">'dict'</span>            <span class="token keyword">def</span> <span class="token function">find</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>tree<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#å¯¹äºå•ä¸ªæ ·æœ¬ï¼Œæ‰¾åˆ°æ‰€åœ¨å†³ç­–æ ‘çš„ä½ç½®</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>isTree<span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> data<span class="token punctuation">[</span>i<span class="token punctuation">,</span>tree<span class="token punctuation">[</span><span class="token string">"num"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span>tree<span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> self<span class="token punctuation">.</span>find<span class="token punctuation">(</span>data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>tree<span class="token punctuation">[</span><span class="token string">'lchild'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> self<span class="token punctuation">.</span>find<span class="token punctuation">(</span>data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>tree<span class="token punctuation">[</span><span class="token string">'rchild'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> tree        <span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        è®­ç»ƒå‡½æ•°ï¼Œå…¶ä¸­å…±è®­ç»ƒäº†treenumæ£µæ ‘ï¼Œè°ƒç”¨RegressionTreeï¼Œå¹¶è®¡ç®—æŸå¤±å’Œç›¸å…³ç³»æ•°        """</span>        loss<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>        r2<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>        va<span class="token operator">=</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>var<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>treenum<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>            tree<span class="token operator">=</span>Rtree<span class="token punctuation">.</span>CreateTree<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>                self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+=</span>self<span class="token punctuation">.</span>find<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">,</span>j<span class="token punctuation">,</span>tree<span class="token punctuation">)</span>            r<span class="token operator">=</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span>self<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>            r2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>r<span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span>va<span class="token punctuation">)</span>            lo<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>            loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lo<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>forest<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>        <span class="token keyword">return</span> loss<span class="token punctuation">,</span>r2            <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>        m<span class="token punctuation">,</span>n<span class="token operator">=</span>data<span class="token punctuation">.</span>shape        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>treenum<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>                test_data<span class="token punctuation">[</span>j<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+=</span>self<span class="token punctuation">.</span>find<span class="token punctuation">(</span>data<span class="token punctuation">,</span>j<span class="token punctuation">,</span>self<span class="token punctuation">.</span>forest<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®­ç»ƒæ¨¡å‹å¹¶å®ç°æŸå¤±å‡½æ•°å¯è§†åŒ–"><a href="#è®­ç»ƒæ¨¡å‹å¹¶å®ç°æŸå¤±å‡½æ•°å¯è§†åŒ–" class="headerlink" title="è®­ç»ƒæ¨¡å‹å¹¶å®ç°æŸå¤±å‡½æ•°å¯è§†åŒ–"></a>è®­ç»ƒæ¨¡å‹å¹¶å®ç°æŸå¤±å‡½æ•°å¯è§†åŒ–</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">Rtree<span class="token operator">=</span>RegressionTree<span class="token punctuation">(</span><span class="token punctuation">)</span>boost<span class="token operator">=</span>XGBoost<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>loss<span class="token punctuation">,</span>r2<span class="token operator">=</span>boost<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token punctuation">)</span>boost<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>loss<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">u"times"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">u"loss-value"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ¨¡å‹é¢„æµ‹å¹¶è¯„ä¼°ç»“æœ"><a href="#æ¨¡å‹é¢„æµ‹å¹¶è¯„ä¼°ç»“æœ" class="headerlink" title="æ¨¡å‹é¢„æµ‹å¹¶è¯„ä¼°ç»“æœ"></a>æ¨¡å‹é¢„æµ‹å¹¶è¯„ä¼°ç»“æœ</h4><p>ç»“æœè¯„ä¼°æŒ‡æ ‡ï¼š</p><ul><li>$RMSE=\sqrt{\frac1n\sum_{i=1}^n{(y-\hat y)^2}}$</li><li>$R2=1-\frac{RMSE}{var(y)}$</li><li>è¯¯å·®åˆ†å¸ƒç›´æ–¹å›¾</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">r<span class="token operator">=</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span>test_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r2<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>r<span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span>np<span class="token punctuation">.</span>var<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>res<span class="token operator">=</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>res<span class="token operator">=</span>np<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>res<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>res<span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> rwidth<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> density<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">u"data"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">u"num"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>test_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>r2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒç»“æœä¸åˆ†æ"><a href="#å®éªŒç»“æœä¸åˆ†æ" class="headerlink" title="å®éªŒç»“æœä¸åˆ†æ"></a>å®éªŒç»“æœä¸åˆ†æ</h3><p>ï¼ˆè°ƒå‚è¿‡ç¨‹ç•¥ï¼‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;XGBoost&quot;&gt;&lt;a href=&quot;#XGBoost&quot; class=&quot;headerlink&quot; title=&quot;XGBoost&quot;&gt;&lt;/a&gt;XGBoost&lt;/h2&gt;&lt;h3 id=&quot;å®éªŒç›®çš„&quot;&gt;&lt;a href=&quot;#å®éªŒç›®çš„&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="http://sn1987a-1.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>MLç®—æ³•ï¼šSVM</title>
    <link href="http://sn1987a-1.github.io/posts/7ab554ae.html"/>
    <id>http://sn1987a-1.github.io/posts/7ab554ae.html</id>
    <published>2023-11-10T12:48:34.000Z</published>
    <updated>2023-09-24T03:45:05.647Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SVM"><a href="#SVM" class="headerlink" title="SVM"></a>SVM</h2><h3 id="å®éªŒç›®æ ‡"><a href="#å®éªŒç›®æ ‡" class="headerlink" title="å®éªŒç›®æ ‡"></a>å®éªŒç›®æ ‡</h3><p>å­¦ä¹ æ”¯æŒå‘é‡æœºçš„åŸç†ï¼Œç”¨ä¸¤ç§ä¸åŒçš„ç®—æ³•å¯»æ‰¾æ”¯æŒå‘é‡æœºçš„è§£ï¼Œå¹¶å®Œæˆæ¯”è¾ƒã€‚</p><h3 id="å®éªŒåŸç†"><a href="#å®éªŒåŸç†" class="headerlink" title="å®éªŒåŸç†"></a>å®éªŒåŸç†</h3><p>å¯¹äºç»™å®šæ ·æœ¬é›†ï¼ŒSVMçš„ä»»åŠ¡å°±æ˜¯åŸºäºæ ·æœ¬é›†åœ¨æ ·æœ¬ç©ºé—´ä¸­ç¡®å®šä¸€ä¸ªåˆ’åˆ†è¶…å¹³é¢ï¼Œå°†ä¸åŒç±»åˆ«çš„æ ·æœ¬åˆ†å¼€ï¼Œå³æ‰¾åˆ°w,bä½¿å¾—$y(w^T+b)\ge1$æˆç«‹ï¼Œå¹¶å®ç°æœ€å¤§åŒ–é—´éš”ï¼Œå³æœ€å¤§åŒ–$||w||^{-1}$ã€‚ä¸ºæ±‚è§£wçš„æœ€ä¼˜è§£ï¼Œï¼Œç”±äºå®éªŒä¸­çš„æ•°æ®å¹¶ä¸å®Œå…¨æ˜¯çº¿æ€§å¯åˆ†çš„ï¼Œå› æ­¤é‡‡ç”¨ç¡¬é—´éš”çš„æ–¹æ³•æ±‚è§£å­˜åœ¨å›°éš¾ï¼Œæœ¬æ¬¡å®éªŒåˆ†åˆ«é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•å’ŒSMOï¼ˆåºåˆ—æœ€å°ä¼˜åŒ–ç®—æ³•ï¼‰æ¥æ±‚è§£ã€‚</p><p>SVMçš„ä»»åŠ¡ï¼š</p><script type="math/tex; mode=display">min_W||w||^2/2\\s.t. y_i(w^T)\phi(x_i)+b)\ge 1,i=1,2,...m</script><ul><li>æ¢¯åº¦ä¸‹é™æ³•</li></ul><p>SVMä¸­çš„æ¢¯åº¦ä¸‹é™æ–¹æ³•ä¹Ÿç±»ä¼¼äºé€»è¾‘å›å½’ä¸­çš„æ¢¯åº¦ä¸‹é™åŸç†ï¼Œæ ¹æ®è¿­ä»£çš„å€¼è®¡ç®—æŸå¤±å’Œæ¢¯åº¦æ›´æ–°å‚æ•°ï¼Œæ¯æ¬¡è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—å½“å‰çš„$y*(w^T+b)$çš„å€¼ï¼Œå°†å€¼å°äºä¸€çš„æ ·æœ¬è¿›è¡Œç´¯åŠ è®¡ç®—æ¢¯åº¦ï¼Œæ ¹æ®æ¢¯åº¦å’Œå­¦ä¹ ç‡æ›´æ–°wå’Œbã€‚</p><ul><li>SMO</li></ul><p>SMOç®—æ³•æ˜¯John Plattåœ¨ã€ŠSequential Minimal Optimization: A Fast Algorithm for Training Support Vector Machinesã€‹ä¸€æ–‡ä¸­æå‡ºçš„ç®—æ³•ï¼Œå¯¹äºè§£å†³ç¨€ç–æ•°æ®é›†ä¸Šçš„é—®é¢˜æœ‰ç€å¾ˆé«˜çš„æ•ˆç‡ã€‚å·²çŸ¥SVMçš„å¯¹å¶é—®é¢˜ä¸ºï¼š</p><script type="math/tex; mode=display">argmax\sum _\alpha ^N \alpha _i-1/2*\sum_{i=1}^N\sum_{j=1}^Ny_iy_j\alpha_i\alpha_jx_i^Tx_j\\ s.t.\alpha_i\ge0,\sum_{i=1}^T\alpha_iy_i=0</script><p>å…¶ä¸­ï¼Œæˆ‘ä»¬è¦å¯¹$ï¼ˆ\alpha_1,\alpha_2,â€¦,\alpha_N)$è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œç›´æ¥å¯¹Nä¸ªå‚æ•°è¿›è¡Œä¼˜åŒ–çš„æ•ˆç‡å°†å¾ˆä½ï¼Œå› æ­¤é‡‡ç”¨SMOç®—æ³•æ±‚è§£ï¼ŒSMOçš„åŸç†æ˜¯å°†Nä¸ªå‚æ•°çš„ä¼˜åŒ–é—®é¢˜è½¬åŒ–ä¸ºå¤šä¸ªå­é—®é¢˜ï¼Œå…¶ä¸­æ¯ä¸ªå­é—®é¢˜åªå¯¹ä¸¤ä¸ªå‚æ•°è¿›è¡Œä¼˜åŒ–ï¼Œæ¯æ¬¡è®¡ç®—å¹¶é€‰å–ä¸€å¯¹æœ€ä¼˜çš„$(\alpha_i,\alpha_j)$æ›´æ–°å¯¹åº”çš„$\alpha$å€¼ã€‚</p><h3 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h4 id="æ¢¯åº¦ä¸‹é™æ³•"><a href="#æ¢¯åº¦ä¸‹é™æ³•" class="headerlink" title="æ¢¯åº¦ä¸‹é™æ³•"></a>æ¢¯åº¦ä¸‹é™æ³•</h4><ul><li>æŸå¤±å‡½æ•°$loss=1/2*w^tw+\sum_{i=1}^mmax{0,1-y_i(wx_i-b)}$</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">mar<span class="token operator">=</span>y<span class="token operator">*</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>X<span class="token punctuation">,</span>self<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>b<span class="token punctuation">)</span>lo<span class="token operator">=</span><span class="token number">0.5</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>self<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> mar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> lo<span class="token operator">&lt;</span>tol <span class="token punctuation">:</span>    <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æŸå¤±å‡½æ•°çš„æ¢¯åº¦$\Delta=\lambda w-\sum{i=1}^mI|wx_i+b&lt;1|*x_iy_i$ï¼Œæ ¹æ®æ¢¯åº¦æ›´æ–°wå’Œb</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">if</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>w <span class="token operator">-=</span> lr <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>self<span class="token punctuation">.</span>b <span class="token operator">-=</span> lr <span class="token operator">*</span> <span class="token operator">-</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SMO"><a href="#SMO" class="headerlink" title="SMO"></a>SMO</h4><ul><li>é¢„å…ˆå­˜å‚¨éƒ¨åˆ†æ•°æ®ï¼Œæé«˜è¿ç®—æ•ˆç‡</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>m<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>self<span class="token punctuation">.</span>alpha<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#æ¯æ¬¡è¿­ä»£æ›´æ–°</span>self<span class="token punctuation">.</span>err<span class="token operator">=</span><span class="token operator">-</span>self<span class="token punctuation">.</span>y<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#æ¯æ¬¡è¿­ä»£æ›´æ–°</span><span class="token comment">#ä»¥ä¸‹æ˜¯ä¸ºäº†æ–¹ä¾¿è®¡ç®—lossçš„å€¼ï¼Œä¸éœ€è¦è®¡ç®—losså€¼æ—¶æ— éœ€è®¡ç®—ï¼Œæ›´èŠ‚çœæ—¶é—´å’Œå†…å­˜</span>self<span class="token punctuation">.</span>kappa_x<span class="token operator">=</span>self<span class="token punctuation">.</span>kappa<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span>self<span class="token punctuation">.</span>X<span class="token punctuation">)</span>self<span class="token punctuation">.</span>mulyx<span class="token operator">=</span>np<span class="token punctuation">.</span>outer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y<span class="token punctuation">,</span>self<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>kappa_xself<span class="token punctuation">.</span>outer_a<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">,</span>self<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#æ¯æ¬¡è¿­ä»£æ›´æ–°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æŸå¤±å‡½æ•°$\sum _\alpha ^N \alpha _i-1/2*\sum_{i=1}^N\sum_{j=1}^Ny_iy_j\alpha_i\alpha_jx_i^Tx_j$</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mulyx<span class="token operator">*</span>self<span class="token punctuation">.</span>outer_a<span class="token punctuation">)</span><span class="token operator">-</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>é€‰å–åˆé€‚çš„$(\alpha _i,\alpha_j)$<ul><li>ç»Ÿè®¡è¯¯å·®ä¸ä¸º0çš„ç´¢å¼•å€¼ï¼Œæœ‰ä¸ä¸ºé›¶çš„è¯¯å·®æ—¶ç»Ÿè®¡è¯¯å·®</li><li>æ²¡æœ‰ä¸ºé›¶è¯¯å·®æ—¶ï¼Œéšæœºé€‰å–$\alpha$</li></ul></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">  <span class="token keyword">if</span> arrlen<span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>t<span class="token operator">=</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>err<span class="token operator">-</span>ei<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> t<span class="token operator">!=</span>i <span class="token keyword">and</span> self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>t<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>   <span class="token keyword">return</span> <span class="token number">1</span>  arr<span class="token operator">=</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token operator">!=</span>self<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  ra<span class="token operator">=</span>np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>arr<span class="token punctuation">,</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> j <span class="token keyword">in</span> ra<span class="token punctuation">:</span><span class="token keyword">if</span> j<span class="token operator">!=</span>i <span class="token keyword">and</span> self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>   <span class="token keyword">return</span> <span class="token number">1</span>  ra<span class="token operator">=</span>np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> ra<span class="token punctuation">:</span><span class="token keyword">if</span> j<span class="token operator">!=</span>i <span class="token keyword">and</span> self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>  <span class="token keyword">return</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¯æ¬¡è¿­ä»£æ›´æ–°æ•°æ®</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> y1 <span class="token operator">!=</span>y2<span class="token punctuation">:</span><span class="token comment">#å–Lï¼ŒH</span>          t1<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>a2<span class="token operator">-</span>a1<span class="token punctuation">)</span>          t2<span class="token operator">=</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>a2<span class="token operator">-</span>a1<span class="token punctuation">)</span><span class="token operator">+</span>self<span class="token punctuation">.</span>c      <span class="token keyword">else</span><span class="token punctuation">:</span>          t1<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>c<span class="token punctuation">,</span>a1<span class="token operator">+</span>a2<span class="token punctuation">)</span><span class="token operator">-</span>self<span class="token punctuation">.</span>c          t2<span class="token operator">=</span><span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>c<span class="token punctuation">,</span>a1<span class="token operator">+</span>a2<span class="token punctuation">)</span>      <span class="token keyword">if</span> t1<span class="token operator">==</span>t2<span class="token punctuation">:</span>          <span class="token keyword">return</span> <span class="token number">0</span>      t3<span class="token operator">=</span>k11<span class="token operator">+</span>k22<span class="token operator">-</span><span class="token number">2</span><span class="token operator">*</span>k12      <span class="token keyword">if</span> t3<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token comment">#æ±‚è§£\alphaæ–°å€¼</span>          al2 <span class="token operator">=</span> a2<span class="token operator">+</span>y2<span class="token operator">*</span><span class="token punctuation">(</span>e1<span class="token operator">-</span>e2<span class="token punctuation">)</span><span class="token operator">/</span>t3          <span class="token keyword">if</span> al2<span class="token operator">&lt;</span>t1<span class="token punctuation">:</span>              al2<span class="token operator">=</span>t1          <span class="token keyword">elif</span> al2<span class="token operator">&gt;</span>t2<span class="token punctuation">:</span>              al2<span class="token operator">=</span>t2      <span class="token keyword">else</span><span class="token punctuation">:</span>          <span class="token comment">#æ„å¤–æƒ…å†µ,å¾ˆå°‘å‡ºç°</span>          self<span class="token punctuation">.</span>alpha<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token operator">=</span>t1          loss1<span class="token operator">=</span>self<span class="token punctuation">.</span>calloss<span class="token punctuation">(</span><span class="token punctuation">)</span>          self<span class="token punctuation">.</span>alpha<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token operator">=</span>t2          loss2<span class="token operator">=</span>self<span class="token punctuation">.</span>calloss<span class="token punctuation">(</span><span class="token punctuation">)</span>          self<span class="token punctuation">.</span>alpha<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token operator">=</span>a2          <span class="token keyword">if</span> loss1<span class="token operator">-</span>loss2<span class="token operator">&gt;</span>self<span class="token punctuation">.</span>eps<span class="token punctuation">:</span>              al2<span class="token operator">=</span>t2          <span class="token keyword">elif</span> loss2<span class="token operator">-</span>loss1<span class="token operator">&gt;</span>self<span class="token punctuation">.</span>eps<span class="token punctuation">:</span>              al2<span class="token operator">=</span>t1          <span class="token keyword">else</span><span class="token punctuation">:</span>              al2<span class="token operator">=</span>a2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> al2<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">:</span>    al2<span class="token operator">=</span><span class="token number">0.0</span><span class="token comment">#æˆªæ–­å¤„ç†</span>al2<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>al2<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span>al2<span class="token operator">=</span><span class="token builtin">min</span><span class="token punctuation">(</span>al2<span class="token punctuation">,</span>self<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>al2<span class="token operator">-</span>a2<span class="token punctuation">)</span><span class="token operator">&lt;</span>self<span class="token punctuation">.</span>eps<span class="token operator">*</span><span class="token punctuation">(</span>al2 <span class="token operator">+</span> a2 <span class="token operator">+</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">0</span>al1<span class="token operator">=</span>a1<span class="token operator">+</span><span class="token punctuation">(</span>a2<span class="token operator">-</span>al2<span class="token punctuation">)</span><span class="token operator">*</span>y1<span class="token operator">*</span>y2b1 <span class="token operator">=</span> e1 <span class="token operator">+</span> y1<span class="token operator">*</span><span class="token punctuation">(</span>al1 <span class="token operator">-</span> a1<span class="token punctuation">)</span><span class="token operator">*</span>k11 <span class="token operator">+</span> y2<span class="token operator">*</span><span class="token punctuation">(</span>al2 <span class="token operator">-</span> a2<span class="token punctuation">)</span><span class="token operator">*</span>k12 <span class="token operator">+</span> self<span class="token punctuation">.</span>bb2 <span class="token operator">=</span> e2 <span class="token operator">+</span> y1<span class="token operator">*</span><span class="token punctuation">(</span>al1 <span class="token operator">-</span> a1<span class="token punctuation">)</span><span class="token operator">*</span>k12 <span class="token operator">+</span> y2<span class="token operator">*</span><span class="token punctuation">(</span>al2 <span class="token operator">-</span> a2<span class="token punctuation">)</span><span class="token operator">*</span>k22 <span class="token operator">+</span> self<span class="token punctuation">.</span>b<span class="token comment">#æ ¹æ®ä»¥ä¸Šçš„al1ï¼Œal2ï¼Œb1ï¼Œb2æ›´æ–°å‚æ•°çš„å€¼ï¼šb,alpha,err</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è¿­ä»£<ul><li>changeï¼šä¸Šä¸€è½®è¿­ä»£ä¸­å‘ç”Ÿæ”¹å˜çš„æ•°ç›®</li><li>entireï¼šæ˜¯å¦å¯¹å…¨éƒ¨çš„å‚æ•°è¿›è¡Œæ£€æŸ¥</li><li>ep:è®°å½•è¿­ä»£æ¬¡æ•°ï¼Œè¿­ä»£æ¬¡æ•°åˆ°æœ€å¤§æ—¶é€€å‡ºå¾ªç¯</li></ul></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">while</span> change<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> entire<span class="token punctuation">:</span>            change<span class="token operator">=</span><span class="token number">0</span>            <span class="token keyword">if</span> entire <span class="token punctuation">:</span>                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>examine<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>                        change<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                ra<span class="token operator">=</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token operator">!=</span>self<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                <span class="token keyword">for</span> i <span class="token keyword">in</span> ra<span class="token punctuation">:</span>                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>examine<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>                        change<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ep<span class="token operator">&gt;</span>self<span class="token punctuation">.</span>max_iters<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">break</span>            <span class="token keyword">if</span> entire<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>                entire<span class="token operator">=</span><span class="token number">0</span>            <span class="token keyword">elif</span> change<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>                entire<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ•°æ®å¤„ç†ï¼Œé¢„æµ‹å’Œåˆ†æ"><a href="#æ•°æ®å¤„ç†ï¼Œé¢„æµ‹å’Œåˆ†æ" class="headerlink" title="æ•°æ®å¤„ç†ï¼Œé¢„æµ‹å’Œåˆ†æ"></a>æ•°æ®å¤„ç†ï¼Œé¢„æµ‹å’Œåˆ†æ</h4><p>æœ¬æ¬¡å®éªŒå¯¹è®­ç»ƒé›†å’Œæµ‹è¯•é›†æŒ‰ç…§8ï¼š2è¿›è¡Œåˆ’åˆ†ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mu <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>X_norm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>         sigma <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>X_norm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>      <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    X_norm<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>X_norm<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">-</span>mu<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>sigma<span class="token punctuation">[</span>i<span class="token punctuation">]</span>y<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span>num<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>permutation<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>X_norm<span class="token operator">=</span>X_norm<span class="token punctuation">[</span>num<span class="token punctuation">]</span>y<span class="token operator">=</span>y<span class="token punctuation">[</span>num<span class="token punctuation">]</span>a<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>X_test<span class="token operator">=</span>X_norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>X_train<span class="token operator">=</span>X_norm<span class="token punctuation">[</span>a<span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>y_test<span class="token operator">=</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>y_train<span class="token operator">=</span>y<span class="token punctuation">[</span>a<span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¢„æµ‹å‡½æ•°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"> m<span class="token punctuation">,</span>n<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token comment">##SMO: p=np.dot(self.kappa(X, self.X),self.alpha*self.y) - self.b</span><span class="token comment">##GD: p=np.dot(X,self.w)+self.b</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>     ans<span class="token operator">=</span>np<span class="token punctuation">.</span>sign<span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>     res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸå¤±æ›²çº¿ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss<span class="token operator">=</span>model2<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span>y_train<span class="token punctuation">)</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>loss<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">u"times"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">u"loss-value"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ•°æ®åˆ†æ</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">pred2 <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>m <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_test<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>y_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">and</span> pred2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>y_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">and</span> pred2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token operator">/</span>m<span class="token punctuation">)</span><span class="token comment">#SVMé¢„æµ‹çš„å‡†ç¡®ç‡</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> pred1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>pred2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>        i<span class="token operator">+=</span><span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token operator">/</span>m<span class="token punctuation">)</span><span class="token comment">#SVM1ï¼ŒSVM2çš„é¢„æµ‹ç›¸ä¼¼ç‡</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒç»“è®ºå’Œåˆ†æ"><a href="#å®éªŒç»“è®ºå’Œåˆ†æ" class="headerlink" title="å®éªŒç»“è®ºå’Œåˆ†æ"></a>å®éªŒç»“è®ºå’Œåˆ†æ</h3><h4 id="æ¢¯åº¦ä¸‹é™æ³•-1"><a href="#æ¢¯åº¦ä¸‹é™æ³•-1" class="headerlink" title="æ¢¯åº¦ä¸‹é™æ³•"></a>æ¢¯åº¦ä¸‹é™æ³•</h4><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><p>Xï¼Œè®­ç»ƒé›†X</p></li><li><p>yï¼Œè®­ç»ƒé›†</p></li><li><p>lrï¼Œå­¦ä¹ ç‡ï¼Œé»˜è®¤ä¸º0.001</p></li><li><p>max_itersï¼Œæœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤ä¸º1000</p></li><li><p>tolï¼Œæœ€å°è¯¯å·®ï¼Œ 0.0001</p></li></ul><p>è®­ç»ƒä¸€æ¬¡çš„æŸå¤±æ›²çº¿å¦‚ä¸‹æ‰€ç¤ºï¼ˆæ•°æ®è§„æ¨¡ä¸º10000ï¼Œç»´åº¦ä¸º20ï¼Œè®­ç»ƒæ—¶é—´ä¸º41.2sï¼‰ï¼Œåˆå§‹çš„losså€¼è¾ƒå¤§æ˜¯è®­ç»ƒæ—¶é¢„è®¾äº†wçš„å€¼ä¸ºéšæœºç”Ÿæˆ<code>np.random.randn(col,1)</code>.</p><p>å‡†ç¡®ç‡ï¼š96.1%</p><p>å¯ä»¥çœ‹å‡ºæ¢¯åº¦ä¸‹é™çš„æ”¶æ•›æ•ˆæœè¾ƒå¥½ï¼Œåœ¨è®­ç»ƒæ¬¡æ•°è¾ƒä½æ—¶æŸå¤±å‡½æ•°æ˜¾è‘—é™ä½ï¼Œå¾—åˆ°çš„ç»“æœå‡†ç¡®ç‡ä¹Ÿè¾ƒé«˜ã€‚</p><p>è€Œå½“å­¦ä¹ ç‡å˜å¤§ï¼ˆæ”¹ä¸ºlr=0.1)æ—¶ï¼ŒæŸå¤±å‡½æ•°ä¼šå‘ç”Ÿéœ‡è¡ï¼Œå¯¼è‡´é¢„æµ‹çš„å‡†ç¡®ç‡é™ä½</p><h4 id="SMO-1"><a href="#SMO-1" class="headerlink" title="SMO"></a>SMO</h4><p>å‚æ•°è§£é‡Šï¼š</p><ul><li>dimï¼šæ•°æ®çš„ç»´åº¦</li><li>cï¼šæ¾å¼›å˜é‡ï¼Œé»˜è®¤ä¸º1.0</li><li>epsï¼šå®¹é”™ç‡ï¼Œé»˜è®¤ä¸º0.01</li><li>max_iters:æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤ä¸º1000</li><li>kappaå‡½æ•°ï¼šé€‰å–çš„æ ¸å‡½æ•°ç±»å‹ï¼Œé»˜è®¤ä¸ºlinear</li></ul><p>è®­ç»ƒä¸€æ¬¡çš„æŸå¤±æ›²çº¿ï¼ˆæ•°æ®è§„æ¨¡ä¸º2000ï¼Œ20ç»´ï¼Œè®­ç»ƒæ¬¡æ•°1000ï¼Œè®­ç»ƒæ—¶é—´10sï¼‰</p><h4 id="æ¢¯åº¦ä¸‹é™æ³•å’ŒSMOçš„å¯¹æ¯”"><a href="#æ¢¯åº¦ä¸‹é™æ³•å’ŒSMOçš„å¯¹æ¯”" class="headerlink" title="æ¢¯åº¦ä¸‹é™æ³•å’ŒSMOçš„å¯¹æ¯”"></a>æ¢¯åº¦ä¸‹é™æ³•å’ŒSMOçš„å¯¹æ¯”</h4><p>æ€»ä½“æ¥è¯´ï¼Œæ¢¯åº¦ä¸‹é™æ³•å’ŒSMOçš„å‡†ç¡®ç‡å‡åœ¨90%ä»¥ä¸Šï¼Œæ”¶æ•›çš„é€Ÿåº¦éƒ½å¾ˆå¿«ï¼Œå¯¹ç»“æœé¢„æµ‹çš„ç›¸ä¼¼åº¦ä¸º97%ï¼Œä¸¤ç§æ¨¡å‹çš„è®­ç»ƒæ•ˆæœå‡è¾ƒå¥½ï¼Œæ¢¯åº¦ä¸‹é™çš„å‡†ç¡®ç‡ç›¸å¯¹æ›´é«˜ï¼Œè®­ç»ƒè¿‡ç¨‹ç›¸å¯¹æ›´ç›´è§‚ï¼›SMOçš„ä¼˜åŠ¿åœ¨äºæ¯æ¬¡åªå¯¹æœ€å°çš„é—®é¢˜è¿›è¡Œä¼˜åŒ–ï¼Œé—®é¢˜è§„æ¨¡å°ï¼Œå ç”¨çš„å†…å­˜å°‘ï¼Œå¯¹ç¡¬ä»¶çš„è¦æ±‚ä½ï¼Œå¯¹äºä¸åŒçš„å‚æ•°ï¼Œæˆ–è€…è¾ƒå¤§æˆ–è¾ƒå°çš„æ•°æ®é›†éƒ½æœ‰è¾ƒå¥½çš„ç»“æœã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;SVM&quot;&gt;&lt;a href=&quot;#SVM&quot; class=&quot;headerlink&quot; title=&quot;SVM&quot;&gt;&lt;/a&gt;SVM&lt;/h2&gt;&lt;h3 id=&quot;å®éªŒç›®æ ‡&quot;&gt;&lt;a href=&quot;#å®éªŒç›®æ ‡&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒç›®æ ‡&quot;&gt;&lt;/a&gt;å®éªŒç›®</summary>
      
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="http://sn1987a-1.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¯‘åŸç†-LLVM IRè¯­æ³•</title>
    <link href="http://sn1987a-1.github.io/posts/615503d3.html"/>
    <id>http://sn1987a-1.github.io/posts/615503d3.html</id>
    <published>2023-10-17T12:48:34.000Z</published>
    <updated>2023-09-24T05:28:23.642Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜1-getelementptr"><a href="#é—®é¢˜1-getelementptr" class="headerlink" title="é—®é¢˜1: getelementptr"></a>é—®é¢˜1: getelementptr</h2><p>è¯·ç»™å‡º <code>IR.md</code> ä¸­æåˆ°çš„ä¸¤ç§ getelementptr ç”¨æ³•çš„åŒºåˆ«,å¹¶ç¨åŠ è§£é‡Š:</p><ul><li><p><code>%2 = getelementptr [10 x i32], [10 x i32]* %1, i32 0, i32 %0</code></p></li><li><p><code>%2 = getelementptr i32, i32* %1, i32 %0</code></p><p>ä¸¤ç§GEPéƒ½æ˜¯å–æ•°ç»„ä¸­çš„ç‰¹å®šå…ƒç´ çš„åœ°å€æŒ‡é’ˆï¼ŒåŒºåˆ«åœ¨äºï¼ˆ1ï¼‰è®¡ç®—åŸºç¡€ç±»å‹ä¸ºæ•°ç»„æŒ‡é’ˆï¼Œï¼ˆ2ï¼‰ä¸­çš„è®¡ç®—åŸºç¡€ç±»å‹ä¸ºå…ƒç´ æŒ‡é’ˆï¼Œ (1)ä¸­çš„ç”¨æ³•æ˜¯å€ŸåŠ©é•¿åº¦ä¸º10ï¼Œæ•°æ®ç±»å‹ä¸ºi32çš„æ•°ç»„æŒ‡é’ˆå–å…¶ä¸­æŸä¸ªå…ƒç´ çš„åœ°å€æŒ‡é’ˆï¼Œå…¶ä¸­æ•°æ®ç´¢å¼•çš„åç§»æœ‰ä¸¤ä¸ªï¼Œå› ä¸ºæ•°æ®ç±»å‹æ˜¯<code>[10 x i32]</code>,ç¬¬ä¸€ä¸ªåç§»å¯¹åº”çš„å†…å­˜åç§»é‡ä¸º<code>åç§»å€¼ï¼ˆ0ï¼‰ x 10 x 4</code>ï¼Œç¬¬äºŒä¸ªåç§»å¯¹åº”çš„å†…å­˜åç§»é‡ä¸º<code>åç§»å€¼ï¼ˆ%0ï¼‰ x 4</code>ï¼Œåç§»é‡ä¸åŸåœ°å€ç›¸åŠ è®¡ç®—å¾—åˆ°çš„æ•°æ®å­˜å…¥<code>%2</code>ä¸­ï¼Œç±»å‹ä¸ºi32ï¼›ï¼ˆ2ï¼‰ä¸­çš„ç”¨æ³•æ˜¯é€šè¿‡å…ƒç´ æŒ‡é’ˆå’Œåç§»å€¼å¾—åˆ°æŸä¸ªå…ƒç´ çš„åœ°å€æŒ‡é’ˆï¼Œæ•°æ®ç±»å‹ä¸º<code>i32</code>ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªåç§»å€¼ï¼Œå¯¹åº”çš„å†…å­˜åç§»é‡ä¸º<code>åç§»å€¼ï¼ˆ%0ï¼‰ x 4</code>ï¼Œåç§»é‡ä¸åŸåœ°å€ç›¸åŠ è®¡ç®—å¾—åˆ°çš„æ•°æ®å­˜å…¥<code>%2</code>ä¸­ï¼Œç±»å‹ä¸ºi32ã€‚</p></li></ul><h2 id="é—®é¢˜2-cpp-ä¸-ll-çš„å¯¹åº”"><a href="#é—®é¢˜2-cpp-ä¸-ll-çš„å¯¹åº”" class="headerlink" title="é—®é¢˜2: cpp ä¸ .ll çš„å¯¹åº”"></a>é—®é¢˜2: cpp ä¸ .ll çš„å¯¹åº”</h2><ol><li><p>assign</p><p>ä¸å«æœ‰è½¬ç§»æŒ‡ä»¤ï¼Œå› æ­¤æ•´ä¸ªå‡½æ•°ä¸»ä½“éƒ¨åˆ†ä¸.llæ–‡ä»¶mainå‡½æ•°éƒ¨åˆ†å¯¹åº”</p></li><li><p>fun</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">   std::vector&lt;Type *&gt; Ints(1, Int32Type);   auto calleeFunType = FunctionType::get(Int32Type, Ints);  auto calleeFun = Function::create(calleeFunType,                                  "callee", module);  auto bb = BasicBlock::create(module, "entry", calleeFun);  builder-&gt;set_insert_point(bb);  std::vector&lt;Value *&gt; args;    for (auto arg = calleeFun-&gt;arg_begin(); arg != calleeFun-&gt;arg_end(); arg++) {    args.push_back(*arg);    }  auto temp = builder-&gt;create_imul(CONST_INT(2),args[0]);  builder-&gt;create_ret(temp);/*å¯¹åº”ï¼šdefine dso_local i32 @callee (i32 %0) #0 {    %2 = mul i32 2,%0    ret i32 %2}*/  auto mainFun = Function::create(FunctionType::get(Int32Type, {}),                                  "main", module);  bb = BasicBlock::create(module, "entry", mainFun);  builder-&gt;set_insert_point(bb);  auto call = builder-&gt;create_call(calleeFun, {CONST_INT(110)});/*å¯¹åº”ï¼šdefine dso_local i32 @main () #0{    %1 = call i32 @callee(i32 110)*/  builder-&gt;create_ret(call);/*å¯¹åº”ï¼š    ret i32 %1*/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>if</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++"> auto mainFun = Function::create(FunctionType::get(Int32Type, {}),                                  "main", module);  auto bb = BasicBlock::create(module, "entry", mainFun);  builder-&gt;set_insert_point(bb);  auto aAlloca = builder-&gt;create_alloca(FloatTypenum);  builder-&gt;create_store(CONST_FP(5.555),aAlloca);  auto aload = builder-&gt;create_load(aAlloca);  auto fcmp =  builder-&gt;create_fcmp_gt(aload,CONST_FP(1.0));  auto trueBB = BasicBlock::create(module, "trueBB", mainFun);    auto falseBB = BasicBlock::create(module, "falseBB", mainFun);  auto br = builder-&gt;create_cond_br(fcmp, trueBB, falseBB); /*å¯¹åº”ï¼š    %1 = alloca float    store float 0x40163851E0000000, float* %1    %2 = load float, float* %1    %3 = fcmp ogt float %2,1.000000e+00    br i1 %3, label %4, label %5*/  builder-&gt;set_insert_point(trueBB);   builder-&gt;create_ret(CONST_INT(233));/*å¯¹åº”ï¼š    4:    ret i32 233*/  builder-&gt;set_insert_point(falseBB);  builder-&gt;create_ret(CONST_INT(0));/*å¯¹åº”ï¼š5:    ret i32 0*/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>while</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">   auto aAlloca = builder-&gt;create_alloca(Int32Type);  auto iAlloca = builder-&gt;create_alloca(Int32Type);  builder-&gt;create_store(CONST_INT(10),aAlloca);  builder-&gt;create_store(CONST_INT(0),iAlloca);  builder-&gt;create_br(loopBB);/*å¯¹åº”ï¼š%1 = alloca i32    store i32 10,i32* %1    %2 = alloca i32    store i32 0,i32* %2    br label %3 */  builder-&gt;set_insert_point(loopBB);  auto iLoad = builder-&gt;create_load(iAlloca);   auto icmp =  builder-&gt;create_icmp_lt(iLoad,CONST_INT(10));  auto br = builder-&gt;create_cond_br(icmp, trueBB, falseBB); /*å¯¹åº”ï¼š    3:    %4 = load i32, i32* %2    %5 = icmp slt i32 %4,10    br i1 %5,label %6,label %11*/  builder-&gt;set_insert_point(trueBB);   auto temp = builder-&gt;create_iadd(iLoad,CONST_INT(1));  builder-&gt;create_store(temp,iAlloca);  iLoad = builder-&gt;create_load(iAlloca);  auto aLoad = builder-&gt;create_load(aAlloca);  auto temp1 = builder-&gt;create_iadd(aLoad,iLoad);  builder-&gt;create_store(temp1,aAlloca);  builder-&gt;create_br(loopBB);/*å¯¹åº”ï¼š    6:    %7 = add i32 %4,1    store i32 %7, i32* %2    %8 = load i32, i32* %2    %9 = load i32, i32* %1    %10 = add i32 %8,%9    store i32 %10, i32* %1    br label %3 */  builder-&gt;set_insert_point(falseBB);   aLoad = builder-&gt;create_load(aAlloca);  builder-&gt;create_ret(aLoad); /*  å¯¹åº”ï¼š    11:    %12 = load i32, i32* %1    ret i32 %12*/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="é—®é¢˜3-Visitor-Pattern"><a href="#é—®é¢˜3-Visitor-Pattern" class="headerlink" title="é—®é¢˜3: Visitor Pattern"></a>é—®é¢˜3: Visitor Pattern</h2><p>åˆ†æ <code>calc</code> ç¨‹åºåœ¨è¾“å…¥ä¸º <code>4 * (8 + 4 - 1) / 2</code> æ—¶çš„è¡Œä¸ºï¼š</p><ol><li>è¯·ç”»å‡ºè¯¥è¡¨è¾¾å¼å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆä½¿ç”¨ <code>calc_ast.hpp</code> ä¸­çš„ <code>CalcAST*</code> ç±»å‹å’Œåœ¨è¯¥ç±»å‹ä¸­å­˜å‚¨çš„å€¼æ¥è¡¨ç¤ºï¼‰ï¼Œå¹¶ç»™èŠ‚ç‚¹ä½¿ç”¨æ•°å­—ç¼–å·ã€‚</li><li>è¯·æŒ‡å‡ºç¤ºä¾‹ä»£ç åœ¨ç”¨è®¿é—®è€…æ¨¡å¼éå†è¯¥è¯­æ³•æ ‘æ—¶çš„éå†é¡ºåºã€‚</li></ol><p>åºåˆ—è¯·æŒ‰å¦‚ä¸‹æ ¼å¼æŒ‡æ˜ï¼ˆåºå·ä¸ºé—®é¢˜ 3.1 ä¸­çš„ç¼–å·ï¼‰ï¼š  3-&gt;2-&gt;5-&gt;1</p><p>æŠ½è±¡è¯­æ³•æ ‘ï¼š</p><p>éå†é¡ºåºï¼š</p><p>1-&gt;2-&gt;3-&gt;4-&gt;6-&gt;8-&gt;7-&gt;9-&gt;11-&gt;14-&gt;16-&gt;12-&gt;15-&gt;10-&gt;13-&gt;5</p><h2 id="å®éªŒè¦æ±‚"><a href="#å®éªŒè¦æ±‚" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h2><p>æœ¬æ¬¡å®éªŒçš„æ ¸å¿ƒä»»åŠ¡æ˜¯ä½¿ç”¨è®¿é—®è€…æ¨¡å¼æ¥å®ç°cminus-f è¯­è¨€çš„LLVM IR çš„è‡ªåŠ¨ç”Ÿæˆã€‚</p><h2 id="å®éªŒéš¾ç‚¹"><a href="#å®éªŒéš¾ç‚¹" class="headerlink" title="å®éªŒéš¾ç‚¹"></a>å®éªŒéš¾ç‚¹</h2><ul><li><p>æ•°æ®ç±»å‹ä¸åŒ¹é…æ—¶åŠæ—¶è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œå¦‚ä»¥ä¸‹æƒ…å†µ</p><ul><li>assignè¯­å¥</li><li>æ¯”è¾ƒ/è®¡ç®—ç­‰äºŒå…ƒè¿ç®—çš„å‚æ•°ç±»å‹ä¸ä¸€è‡´</li><li>è®¡ç®—æ•°ç»„ä¸‹æ ‡çš„ç»“æœå¹¶éintå‹</li><li>å‡½æ•°å‚æ•°ç±»å‹å’Œè°ƒç”¨æ—¶çš„å®å‚ç±»å‹ä¸åŒ¹é…</li><li>å‡½æ•°è¿”å›å€¼çš„è¡¨è¾¾å¼å’Œç±»å‹ä¸åŒ¹é…</li></ul><p>å…¶ä¸­int,floatä¹‹é—´çš„è½¬æ¢éœ€è¦çš„å‡½æ•°ä¸º<code>create_sitofp</code>,<code>create_fptosi</code>,int1å’Œint32ä¹‹é—´çš„è½¬æ¢éœ€è¦çš„å‡½æ•°ä¸º<code>create_zext</code>,<code>create_icmp_ne(*,CONST_INT(0))</code>ã€‚</p></li><li><p>åŒºåˆ«å…ƒç´ å€¼å’Œå…ƒç´ åœ°å€ï¼ŒäºŒè€…å­˜å‚¨çš„æ•°æ®ç±»å‹å‡ä¸º<code>Value *</code>ç±»å‹ï¼Œæœ¬å®éªŒä¸­ï¼Œè®¾ç½®ä¸¤ä¸ªå…¨å±€å˜é‡<code>cur_val</code>,<code>cur_expr</code>åˆ†åˆ«å­˜å‚¨åœ°å€å’Œå€¼ï¼Œå…¶ä¸­åœ°å€ä»…åœ¨æŒ‡é’ˆ/æ•°ç»„è¿ç®—ä»¥åŠèµ‹å€¼è¯­å¥è¢«ç”¨åˆ°ã€‚</p></li><li><p>åŒºåˆ†æŒ‡é’ˆç±»å‹å’Œæ•°ç»„ç±»å‹ï¼Œæ ¹æ®lab2é—®é¢˜1ï¼Œè·å–å…ƒç´ çš„åœ°å€æœ‰ä¸¤ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ä½œä¸ºæŒ‡é’ˆæ ¹æ®åŸºå…ƒç´ çš„å€¼è¿›è¡Œè¿ç®—ï¼Œå’Œä½œä¸ºæ•°ç»„ç±»å‹çš„æŒ‡é’ˆæ ¹æ®åŸºå…ƒç´ çš„åœ°å€è¿›è¡Œè®¡ç®—ï¼Œåœ¨è°ƒç”¨æ—¶è¦åŠ ä»¥åŒºåˆ†ã€‚</p></li><li><p>å‡½æ•°å½¢å‚å’Œå®å‚çš„å¤„ç†</p></li></ul><h2 id="å®éªŒè®¾è®¡"><a href="#å®éªŒè®¾è®¡" class="headerlink" title="å®éªŒè®¾è®¡"></a>å®éªŒè®¾è®¡</h2><h4 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h4><ul><li><p>number</p><p>åœ¨å¯¹åŸºæœ¬å—è¿›è¡Œå‘½åæ—¶ï¼Œå¦‚æœç¨‹åºä¸­å­˜åœ¨å¤šä¸ªç±»å‹ç›¸åŒçš„åŸºæœ¬å—ï¼Œåˆ™ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤è®¾ç½®ä¸€ä¸ªintç±»å‹çš„å…¨å±€å˜é‡ï¼Œæ¯é‡åˆ°éœ€è¦æ˜¾ç¤ºå‘½åçš„åŸºæœ¬å—ï¼Œåˆ™å°†å½“å‰numberçš„å€¼è½¬åŒ–ä¸ºå­—ç¬¦ä¸²åŠ å…¥åŸºæœ¬å—çš„å‘½åä¸­(<code>std::to_string(number++)</code>)ã€‚</p></li><li><p>cur_val &amp; cur_expr</p><p><code>cur_val</code>è®°å½•å½“å‰æ•°æ®å¯¹åº”çš„åœ°å€ï¼Œå¦‚è¿è¡Œèµ‹å€¼è¯­å¥æ—¶ï¼Œå³å€¼è®¡ç®—çš„æ•°å€¼å°†å­˜å‚¨åˆ°å·¦å€¼ä¸­å¯¹åº”çš„åœ°å€ä¸­ï¼Œä»¥åŠæ ¹æ®åŸºåœ°å€è®¡ç®—æ•°ç»„æŸä¸ªå…ƒç´ å¯¹åº”çš„ä½ç½®ï¼› <code>cur_expr</code>è®°å½•å½“å‰æ•°æ®å¯¹åº”çš„å€¼çš„æ‹·è´ï¼Œç”¨äºå„ç±»è¡¨è¾¾å¼çš„è®¡ç®—å’Œèµ‹å€¼ï¼Œè°ƒç”¨<code>create_load(cur_val)</code>å³å¯å¾—åˆ°å½“å‰æ•°æ®åœ°å€çš„å¯¹åº”çš„å€¼ã€‚</p><p><img src="C:\Users\SN1987A\AppData\Roaming\Typora\typora-user-images\image-20221103153726594.png" alt="image-20221103153726594" style="zoom:67%;"></p></li></ul><h4 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h4><ul><li><p>SelectionStmtéƒ¨åˆ†ï¼Œåœ¨trueBBï¼ŒfalseBBå¯¹åº”çš„è¯­å¥æ‰§è¡Œç»“æŸåï¼Œå¦‚æœåœ¨æ‰§è¡Œå®Œçš„åŸºæœ¬å—ä¸­æ²¡æœ‰ç»ˆæ­¢è¯­å¥ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿå‘ä¸‹ä¸€ä¸ªåŸºæœ¬å—çš„è·³è½¬ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> exist<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>builder<span class="token operator">-&gt;</span><span class="token function">get_insert_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get_terminator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>nullptr<span class="token punctuation">)</span>  <span class="token punctuation">{</span>    retBB<span class="token operator">=</span>BasicBlock<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"retBB"</span><span class="token operator">+</span>std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">,</span>cur_fun<span class="token punctuation">)</span><span class="token punctuation">;</span>    builder<span class="token operator">-&gt;</span><span class="token function">create_br</span><span class="token punctuation">(</span>retBB<span class="token punctuation">)</span><span class="token punctuation">;</span>    exist<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>builder<span class="token operator">-&gt;</span><span class="token function">get_insert_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get_terminator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>exist<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      retBB<span class="token operator">=</span>BasicBlock<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"retBB"</span><span class="token operator">+</span>std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">,</span>cur_fun<span class="token punctuation">)</span><span class="token punctuation">;</span>      builder<span class="token operator">-&gt;</span><span class="token function">create_br</span><span class="token punctuation">(</span>retBB<span class="token punctuation">)</span><span class="token punctuation">;</span>      exist<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span>  builder<span class="token operator">-&gt;</span><span class="token function">create_br</span><span class="token punctuation">(</span>retBB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>iterationåŒç†</p></li><li><p>æ•°ç»„è´Ÿä¸‹æ ‡æ£€æµ‹,è°ƒç”¨<code>neg_idx_expect</code>å‡½æ•°ï¼Œä»…å¯¹è´Ÿä¸‹æ ‡è¿›è¡Œæ£€æµ‹ï¼Œä¸ä¼šå¯¹æ•°ç»„çš„ä¸Šç•Œè¿›è¡Œæ£€æŸ¥ï¼ˆå³è¶Šç•Œè®¿é—®ï¼‰</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">auto b=builder-&gt;create_icmp_lt(cur_expr,CONST_INT(0));auto trueBB=...;autofalseBB=...;auto br=builder-&gt;create_cond_br(b,trueBB,falseBB);builder-&gt;set_insert_point(trueBB);auto err=scope.find("neg_idx_except");builder-&gt;create_call(err,{});        builder-&gt;create_br(falseBB);builder-&gt;set_insert_point(falseBB);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å‡½æ•°å£°æ˜éƒ¨åˆ†ï¼Œå¯¹å‡½æ•°å‚æ•°çš„å¤„ç†ä»…åœ¨FunDeclarationéƒ¨åˆ†å®Œæˆï¼Œæœªè°ƒç”¨<code>ASTParam</code>éƒ¨åˆ†ã€‚</p></li></ul><h3 id="å®éªŒæ€»ç»“"><a href="#å®éªŒæ€»ç»“" class="headerlink" title="å®éªŒæ€»ç»“"></a>å®éªŒæ€»ç»“</h3><ul><li>å®éªŒæ¡†æ¶çš„åŸºæœ¬æ€è·¯æ˜¯è®¿é—®è€…æ¨¡å¼å®ç°LRçš„è‡ªåŠ¨ç”Ÿæˆï¼Œå’Œlab2ä¸­é—®é¢˜ä¸‰çš„æ€è·¯ç±»ä¼¼ã€‚</li><li>åŠ æ·±äº†å¯¹æ•°ç»„å’ŒæŒ‡é’ˆç±»å‹çš„ç†è§£ï¼Œä»¥åŠå¯¹åŸºæœ¬å—ï¼Œè·³è½¬è¯­å¥ç­‰çš„ç†è§£</li><li>å¯¹C++çš„è¯­æ³•æŒæ¡æ›´å¤š</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;é—®é¢˜1-getelementptr&quot;&gt;&lt;a href=&quot;#é—®é¢˜1-getelementptr&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜1: getelementptr&quot;&gt;&lt;/a&gt;é—®é¢˜1: getelementptr&lt;/h2&gt;&lt;p&gt;è¯·ç»™å‡º &lt;cod</summary>
      
    
    
    
    <category term="ç¼–è¯‘åŸç†" scheme="http://sn1987a-1.github.io/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>LLVM IRè¯­æ³•</title>
    <link href="http://sn1987a-1.github.io/posts/b38fcafd.html"/>
    <id>http://sn1987a-1.github.io/posts/b38fcafd.html</id>
    <published>2023-10-17T12:48:34.000Z</published>
    <updated>2023-09-24T05:27:12.380Z</updated>
    
    
    
    
    <category term="ç¼–è¯‘åŸç†" scheme="http://sn1987a-1.github.io/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>MLç®—æ³•ï¼šé€»è¾‘å›å½’</title>
    <link href="http://sn1987a-1.github.io/posts/f1383170.html"/>
    <id>http://sn1987a-1.github.io/posts/f1383170.html</id>
    <published>2023-10-17T12:48:34.000Z</published>
    <updated>2023-09-24T03:48:50.515Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é€»è¾‘å›å½’"><a href="#é€»è¾‘å›å½’" class="headerlink" title="é€»è¾‘å›å½’"></a>é€»è¾‘å›å½’</h2><h3 id="å®éªŒå†…å®¹åŠæ­¥éª¤"><a href="#å®éªŒå†…å®¹åŠæ­¥éª¤" class="headerlink" title="å®éªŒå†…å®¹åŠæ­¥éª¤"></a>å®éªŒå†…å®¹åŠæ­¥éª¤</h3><p>æœ¬å®éªŒä¸»è¦åˆ©ç”¨é€»è¾‘å›å½’(logistics regression)å¯¹kaggleæ•°æ®é›†è¿›è¡Œåˆ†æé¢„æµ‹ã€‚</p><ul><li>æ•°æ®å¤„ç†</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#NULLé¡¹èˆå¼ƒ</span>df<span class="token operator">=</span>df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ENcodeï¼Œå°†éæ•°å­—å‹çš„å±æ€§å€¼ç¼–ç ä¸º0~1çš„æ•°å­—</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">df<span class="token punctuation">.</span>Gender<span class="token operator">=</span>df<span class="token punctuation">.</span>Gender<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Male'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Female'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Married<span class="token operator">=</span>df<span class="token punctuation">.</span>Married<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Yes'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'No'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Dependents<span class="token operator">=</span>df<span class="token punctuation">.</span>Dependents<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'1'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">:</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">:</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token string">'3+'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Education<span class="token operator">=</span>df<span class="token punctuation">.</span>Education<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Graduate'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Not Graduate'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Self_Employed<span class="token operator">=</span>df<span class="token punctuation">.</span>Self_Employed<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Yes'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'No'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Property_Area<span class="token operator">=</span>df<span class="token punctuation">.</span>Property_Area<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Rural'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'Urban'</span><span class="token punctuation">:</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token string">'Semiurban'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>Loan_Status<span class="token operator">=</span>df<span class="token punctuation">.</span>Loan_Status<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'Y'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'N'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ•°æ®å½’ä¸€åŒ–ï¼Œé‡‡ç”¨$X_{norm}=(X-\mu)/\sigma$ï¼Œå…¶ä¸­$\mu$ä¸ºå¹³å‡å€¼ï¼Œ$\sigma$ä¸ºæ ‡å‡†å·®</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_splitX <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Loan_Status"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>y <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"Loan_Status"</span><span class="token punctuation">]</span>X_norm<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span>mu <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>X_norm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>         sigma <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>X_norm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>      <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    X_norm<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>X_norm<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">-</span>mu<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>sigma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œæ­¤å¤„é‡‡ç”¨è®­ç»ƒé›†ï¼šæµ‹è¯•æœº=8ï¼š2çš„æ–¹å¼è¿›è¡Œåˆ’åˆ†ï¼Œåˆ©ç”¨permutation()å‡½æ•°è¿›è¡Œå¤„ç†</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">num<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>permutation<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>X_norm<span class="token operator">=</span>X_norm<span class="token punctuation">[</span>num<span class="token punctuation">]</span>y<span class="token operator">=</span>y<span class="token punctuation">[</span>num<span class="token punctuation">]</span>a<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>X_test<span class="token operator">=</span>X_norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>X_train<span class="token operator">=</span>X_norm<span class="token punctuation">[</span>a<span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>y_test<span class="token operator">=</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>y_train<span class="token operator">=</span>y<span class="token punctuation">[</span>a<span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è®­ç»ƒéƒ¨åˆ†é¢„å¤„ç†</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">col<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span> m<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>X<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span>X <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>  y<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>theta<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span>temp<span class="token operator">=</span>np<span class="token punctuation">.</span>matrix<span class="token punctuation">(</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>max_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æŸå¤±å‡½æ•°ï¼šåˆ©ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°è®¡ç®—</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss<span class="token operator">=</span><span class="token operator">-</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>X<span class="token punctuation">,</span>theta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">/</span>m<span class="token operator">-</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>X<span class="token punctuation">,</span>theta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token operator">/</span>m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>æ¢¯åº¦ä¸‹é™</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">grad<span class="token operator">=</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>X<span class="token punctuation">,</span>theta<span class="token punctuation">)</span><span class="token operator">-</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>æ­£åˆ™åŒ–ï¼Œå…¶ä¸­L1ç›¸å½“äºæ·»åŠ 1-èŒƒæ•°é¡¹ï¼ŒL2ç›¸å½“äºåœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ 2-èŒƒæ•°é¡¹</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>penalty<span class="token operator">==</span><span class="token string">"l1"</span><span class="token punctuation">:</span>   loss<span class="token operator">+=</span>self<span class="token punctuation">.</span>gamma<span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>m   grad<span class="token operator">+=</span>self<span class="token punctuation">.</span>gamma<span class="token operator">*</span>np<span class="token punctuation">.</span>sign<span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>   loss<span class="token operator">+=</span>self<span class="token punctuation">.</span>gamma<span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>m   grad<span class="token operator">+=</span>self<span class="token punctuation">.</span>gamma<span class="token operator">*</span>theta<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è®­ç»ƒéƒ¨åˆ†å‡½æ•°ä¸»ä½“</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>max_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment">#è®¡ç®—losså’Œgard</span>     temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">=</span>theta<span class="token operator">-</span><span class="token punctuation">(</span>lr<span class="token operator">/</span>m<span class="token punctuation">)</span><span class="token operator">*</span>grad     theta<span class="token operator">=</span>temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span>     m <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>     j_history<span class="token operator">=</span>np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>j_history<span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>tol<span class="token punctuation">:</span>          <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>sigmoidå‡½æ•°</li></ul><pre class="line-numbers language-pyth" data-language="pyth"><code class="language-pyth">return 1.0/(1+np.exp(-np.dot(w,x)))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>é¢„æµ‹å‡½æ•°</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">,</span>y<span class="token punctuation">,</span>theta<span class="token punctuation">)</span><span class="token punctuation">:</span>    m<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>    X<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span>    X<span class="token operator">=</span>np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>      p<span class="token operator">=</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>X<span class="token punctuation">,</span>theta<span class="token punctuation">)</span>    p<span class="token operator">=</span>p<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    y<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token builtin">sum</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span> <span class="token keyword">and</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>        <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span>        <span class="token keyword">elif</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">and</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">:</span>        <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span>    <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token operator">/</span>m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒç»“æœåŠåˆ†æ"><a href="#å®éªŒç»“æœåŠåˆ†æ" class="headerlink" title="å®éªŒç»“æœåŠåˆ†æ"></a>å®éªŒç»“æœåŠåˆ†æ</h3><p>é‡‡ç”¨å®éªŒé»˜è®¤å‚æ•°è¿›è¡Œè®­ç»ƒï¼šlr=0.01, tol=1e-7, max_iter=3e3,penalty=â€l2â€,gamma=0,fit_intercept=True</p><p>Acc=83.2%</p><ul><li>å‚æ•°æ¯”è¾ƒ</li></ul><p>é¦–å…ˆå¯¹ä¸åŒçš„å­¦ä¹ ç‡è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚ä¸‹ä¸ºä¸åŒçš„å­¦ä¹ ç‡ä¸‹çš„æŸå¤±å‡½æ•°</p><p>lr=0.001,æ­¤æ—¶åˆ°è¾¾max_iteræ—¶æŸå¤±å‡½æ•°ä»åœ¨å¿«é€Ÿé€’å‡ã€</p><p>ç›¸æ¯”ä¹‹ä¸‹lr=0.01çš„å­¦ä¹ ç‡é¿å…äº†å›¾åƒçš„æŠ–åŠ¨ï¼Œä¹Ÿé¿å…äº†è®­ç»ƒè¿‡æ…¢å¯¼è‡´è®­ç»ƒæ—¶é—´é•¿ã€‚</p><p>ä¸åŒçš„æ­£åˆ™åŒ–å‚æ•°ï¼š</p><p>è§‚å¯Ÿå›¾åƒçš„çºµåæ ‡ï¼Œå¯ä»¥çœ‹å‡ºé€‰æ‹©l2æ­£åˆ™åŒ–çš„æ”¶æ•›æ•ˆæœæœ€å¥½ï¼Œå› æ­¤é‡‡å–l2æ­£åˆ™åŒ–ã€‚</p><ul><li>æœ€ä½³å‡†ç¡®ç‡çš„æƒ…å†µï¼š</li></ul><p>ï¼ˆæ­¤æ—¶çš„å‚æ•°ï¼šlr=0.01, tol=1e-7, max_iter=3e3,penalty=â€l2â€,gamma=1,fit_intercept=Trueï¼‰</p><p>å‡†ç¡®ç‡è¾¾åˆ°äº†87.37%ï¼Œå…¶ä¸­æµ‹è¯•é›†å’Œè®­ç»ƒé›†çš„æ¯”ä¾‹ä¸º2ï¼š8</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;é€»è¾‘å›å½’&quot;&gt;&lt;a href=&quot;#é€»è¾‘å›å½’&quot; class=&quot;headerlink&quot; title=&quot;é€»è¾‘å›å½’&quot;&gt;&lt;/a&gt;é€»è¾‘å›å½’&lt;/h2&gt;&lt;h3 id=&quot;å®éªŒå†…å®¹åŠæ­¥éª¤&quot;&gt;&lt;a href=&quot;#å®éªŒå†…å®¹åŠæ­¥éª¤&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒå†…</summary>
      
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="http://sn1987a-1.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>Ginæ¡†æ¶</title>
    <link href="http://sn1987a-1.github.io/posts/6d104c29.html"/>
    <id>http://sn1987a-1.github.io/posts/6d104c29.html</id>
    <published>2023-09-23T12:48:34.000Z</published>
    <updated>2023-09-23T13:05:25.832Z</updated>
    
    <content type="html"><![CDATA[<h2 id="GoWeb"><a href="#GoWeb" class="headerlink" title="GoWeb"></a>GoWeb</h2><p>å®˜æ–¹åŒ…<code>net/http</code>æä¾›äº†åŸºç¡€çš„è·¯ç”±å‡½æ•°ç»„åˆå’ŒåŠŸèƒ½å‡½æ•°ï¼Œæ— éœ€API</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">echo</span><span class="token punctuation">(</span>wr http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        wr<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"echo error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    writeLen<span class="token punctuation">,</span> err <span class="token operator">:=</span> wr<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> writeLen <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"write len:"</span><span class="token punctuation">,</span> writeLen<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> echo<span class="token punctuation">)</span>    err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¡†æ¶ç±»å‹</p><ul><li>Router</li><li>MVC</li></ul><h2 id="Gin"><a href="#Gin" class="headerlink" title="Gin"></a>Gin</h2><p><a href="https://github.com/gin-gonic/gin">Gin</a></p><h3 id="Ginè·¯ç”±"><a href="#Ginè·¯ç”±" class="headerlink" title="Ginè·¯ç”±"></a>Ginè·¯ç”±</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// åˆ›å»ºä¸€ä¸ª Gin è·¯ç”±</span>    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// è®¾ç½®ä¸€ä¸ªè·¯ç”±å¤„ç†å™¨ï¼Œå¤„ç†æ ¹è·¯å¾„ "/"</span>    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// å‘é€ "Hello, World!" ä½œä¸ºå“åº”</span>        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment">// åœ¨ç«¯å£ 8000 ä¸Šå¯åŠ¨ Web æœåŠ¡å™¨</span>    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç±»ä¼¼åœ°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/xxxpost"</span><span class="token punctuation">,</span>getting<span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">"/xxxput"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ”¯æŒRestfulé£æ ¼APIï¼Œï¼ˆè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–ï¼‰ï¼Œæ˜¯ä¸€ç§äº’è”ç½‘åº”ç”¨ç¨‹åºçš„APIè®¾è®¡ç†å¿µï¼šURLå®šä½èµ„æºï¼Œç”¨HTTPæè¿°æ“ä½œ</p><pre class="line-numbers language-none"><code class="language-none">1.è·å–æ–‡ç«  /blog/getXxx Get blog/Xxx2.æ·»åŠ  /blog/addXxx POST blog/Xxx3.ä¿®æ”¹ /blog/updateXxx PUT blog/Xxx4.åˆ é™¤ /blog/delXxxx DELETE blog/Xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>APIå‚æ•°</strong>ï¼šå¯ä»¥é€šè¿‡contextåœ°Paramæ–¹æ³•è·å–APIå‚æ•°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user/:name/*action"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>       name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>       action <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">)</span>       action <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>       c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> name<span class="token operator">+</span><span class="token string">" is "</span><span class="token operator">+</span>action<span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>URLå‚æ•°</strong>ï¼šå¯ä»¥é€šè¿‡DefaultQuery()ï¼ˆå‚æ•°ä¸å­˜åœ¨ï¼Œè¿”å›<em>é»˜è®¤å€¼</em>ï¼‰æˆ–Query()ï¼ˆå‚æ•°ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºä¸²ï¼‰æ–¹æ³•è·å–</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"xx"</span><span class="token punctuation">,</span><span class="token string">"é»˜è®¤å€¼"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>è¡¨å•å‚æ•°</strong>è¡¨å•å‚æ•°æ˜¯postè¯·æ±‚ï¼Œé€šè¿‡PostFormè·å–</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">types <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"post"</span><span class="token punctuation">)</span>username <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>password <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"userpassword"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:8080/form<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/x-www-form-urlencoded<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>ç”¨æˆ·åï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>è¯·è¾“å…¥ä½ çš„ç”¨æˆ·å<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span> å¯†<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>ç ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userpassword<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>è¯·è¾“å…¥ä½ çš„å¯†ç <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>æäº¤<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ä¸Šä¼ æ–‡ä»¶</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go">file<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"ä¸Šä¼ å›¾ç‰‡å‡ºé”™"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>c<span class="token punctuation">.</span><span class="token function">SaveUploadedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºä¸Šä¼ çš„æ–‡ä»¶ï¼Œå¯ä»¥é™åˆ¶æ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶å¤§å°</p><p>ä¹Ÿå¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œè·å–æ‰€æœ‰çš„æ–‡ä»¶ï¼Œå†éå†æ–‡ä»¶ï¼Œé€ä¸ªå¤„ç†ï¼ˆhtmlçš„multipleï¼‰</p><p><strong>routes group</strong> ç®¡ç†ç›¸åŒçš„URL</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">v1 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v1"</span><span class="token punctuation">)</span>   <span class="token comment">// {} æ˜¯ä¹¦å†™è§„èŒƒ</span>   <span class="token punctuation">{</span>      v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> login<span class="token punctuation">)</span>      v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/submit"</span><span class="token punctuation">,</span> submit<span class="token punctuation">)</span>   <span class="token punctuation">}</span>v2<span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·¯ç”±åŸç†ï¼šhttprouterä¼šå°†æ‰€æœ‰è·¯ç”±è§„åˆ™æ„é€ æˆå‰ç¼€æ ‘</p><p>URIåŒ…å«URLå’ŒURN</p><ul><li>urlç”¨æ¥æ ‡è¯†èµ„æºçš„ä½ç½®</li><li>urnç”¨æ¥æ ‡è¯†èµ„æºçš„åç§°ï¼Œä¸å«ä½ç½®ä¿¡æ¯</li><li>uriæ•°æ®æŒ‡çš„æ˜¯URIçš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼</li></ul><h3 id="ginæ•°æ®è§£æå’Œç»‘å®š"><a href="#ginæ•°æ®è§£æå’Œç»‘å®š" class="headerlink" title="ginæ•°æ®è§£æå’Œç»‘å®š"></a>ginæ•°æ®è§£æå’Œç»‘å®š</h3><p><strong>jsonæ•°æ®</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Login <span class="token keyword">struct</span> <span class="token punctuation">{</span>   <span class="token comment">// binding:"required"ä¿®é¥°çš„å­—æ®µï¼Œè‹¥æ¥æ”¶ä¸ºç©ºå€¼ï¼Œåˆ™æŠ¥é”™ï¼Œæ˜¯å¿…é¡»å­—æ®µ</span>   User    <span class="token builtin">string</span> <span class="token string">`form:"username" json:"user" uri:"user" xml:"user" binding:"required"`</span>   Pssword <span class="token builtin">string</span> <span class="token string">`form:"password" json:"password" uri:"password" xml:"password" binding:"required"`</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> json Login<span class="token comment">// å°†requestçš„bodyä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨æŒ‰ç…§jsonæ ¼å¼è§£æåˆ°ç»“æ„ä½“</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>    <span class="token comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span>    <span class="token comment">// gin.Hå°è£…äº†ç”Ÿæˆjsonæ•°æ®çš„å·¥å…·</span>    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span class="token comment">// åˆ¤æ–­ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®</span><span class="token keyword">if</span> json<span class="token punctuation">.</span>User <span class="token operator">!=</span> <span class="token string">"root"</span> <span class="token operator">||</span> json<span class="token punctuation">.</span>Pssword <span class="token operator">!=</span> <span class="token string">"admin"</span> <span class="token punctuation">{</span>    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"304"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"200"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>è¡¨å•æ•°æ®</strong>ï¼Œç±»ä¼¼äºjsonæ•°æ®ï¼Œåªéœ€ä¿®æ”¹è§£æçš„å‡½æ•°ï¼Œä½¿ç”¨bind()é»˜è®¤è§£æåˆ°formçš„æ ¼å¼</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> form Login<span class="token comment">// Bind()é»˜è®¤è§£æå¹¶ç»‘å®šformæ ¼å¼</span><span class="token comment">// æ ¹æ®è¯·æ±‚å¤´ä¸­content-typeè‡ªåŠ¨æ¨æ–­</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>URIæ•°æ®</strong></p><p>URIæ•°æ®çš„getå‡½æ•°å‚æ•°<code>"/:user/:password"</code>ä»¥ä¾¿æ ‡è¯†</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindUri</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ginæ¸²æŸ“"><a href="#ginæ¸²æŸ“" class="headerlink" title="ginæ¸²æŸ“"></a>ginæ¸²æŸ“</h3><p>JSONï¼ŒXMLï¼ŒYAMLï¼Œç»“æ„ä½“</p><p><code>r.get("/someXML")</code>(æ›¿æ¢æˆsomeStruct/someYAML/someJSON)ï¼Œç”¨<code>c.XML...</code>æ¥æ”¶ï¼ˆstructæ ¼å¼éœ€è¦å¤„ç†msgæ ¼å¼ï¼Œç”¨c.JSONæ¥æ”¶ï¼‰</p><p><strong>HTMLæ¨¡æ¿æ¸²æŸ“</strong></p><p>åœ¨r.GETä¹‹å‰è°ƒç”¨<code>r.LoadHTMLGlob("tem/**/*")</code>(å…·ä½“æ ¹æ®ç›®å½•æ¥å®š)</p><p>HTMLé¦–å°¾åˆ†ç¦»</p><p>é¦–ï¼š</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">{{define "public/header"}}<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{.title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>{{end}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°¾ï¼š</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">{{define "public/footer"}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>{{ end }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>indexæ–‡ä»¶ï¼š</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">{{ define "user/index.html" }}{{template "public/header" .}}        fgkjdskjdsh{{.address}}{{template "public/footer" .}}{{ end }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>é‡å®šå‘</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go">c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMovedPermanently<span class="token punctuation">,</span> <span class="token string">"http..."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>åŒæ­¥å’Œå¼‚æ­¥å¤„ç†</strong></p><p>goroutineå¯ä»¥è¿›è¡Œå¼‚æ­¥å¤„ç†</p><p><em>å¯åŠ¨æ–°çš„goroutineæ—¶ï¼Œä¸åº”è¯¥ä½¿ç”¨åŸå§‹ä¸Šä¸‹æ–‡ï¼Œè€Œæ˜¯ä½¿ç”¨åªè¯»å‰¯æœ¬</em></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"> <span class="token comment">// 1.å¼‚æ­¥</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/long_async"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// éœ€è¦æä¸€ä¸ªå‰¯æœ¬</span>    copyContext <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// å¼‚æ­¥å¤„ç†</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"å¼‚æ­¥æ‰§è¡Œï¼š"</span> <span class="token operator">+</span> copyContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// 2.åŒæ­¥</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/long_sync"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"åŒæ­¥æ‰§è¡Œï¼š"</span> <span class="token operator">+</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ginä¸­é—´ä»¶"><a href="#ginä¸­é—´ä»¶" class="headerlink" title="ginä¸­é—´ä»¶"></a>ginä¸­é—´ä»¶</h3><p>â€œé»˜è®¤ä½¿ç”¨ä¸¤ä¸ªä¸­é—´ä»¶ï¼šLoggerï¼ŒRecoveryâ€<code>r:=gin.Default()</code></p><p><strong>å…¨å±€ä¸­é—´ä»¶</strong>ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡è¯¥ä¸­é—´ä»¶</p><p>å®šä¹‰ä¸­é—´ä»¶ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">MiddleWare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">{</span>    <span class="token comment">//è®¾ç½®å˜é‡åˆ°Contextçš„keyä¸­ï¼Œå¯ä»¥é€šè¿‡â€™Getâ€˜è·å–</span>    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span><span class="token string">"..."</span><span class="token punctuation">)</span>    <span class="token comment">//è·å–ç›¸å…³å˜é‡</span>    status <span class="token operator">:=</span> c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨å†Œä¸­é—´ä»¶ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">MiddleWare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/ce"</span><span class="token punctuation">,</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>Next()æ–¹æ³•</strong>ï¼šä¸­é—´ä»¶æ‰§è¡Œå®Œåç»­çš„ä¸€äº›äº‹æƒ…ï¼Œåœ¨å®šä¹‰ä¸­é—´ä»¶éƒ¨åˆ†å†™å…¥</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">MiddleWare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span> <span class="token string">"ä¸­é—´ä»¶"</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        status <span class="token operator">:=</span> c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        t2 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"time:"</span><span class="token punctuation">,</span> t2<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹æ¯”ï¼š</p><p>å»æ‰c.Next()å‡½æ•°ï¼šè¾“å‡ºçš„timeï¼ˆæ—¶é—´é—´éš”ï¼‰ä¸º0</p><p>åŠ ä¸Šc.Next()å‡½æ•°ï¼Œè¾“å‡ºçš„timeä¸ä¸º0ï¼Œä¸ºä¸­é—´ä»¶å¼€å§‹æ‰§è¡Œåˆ°è¿è¡Œç»“æŸçš„æ—¶é—´</p><p><strong>å±€éƒ¨ä¸­é—´ä»¶</strong></p><p>å±€éƒ¨ä¸­é—´ä»¶æ³¨å†Œçš„æ–¹æ³•ï¼šï¼ˆä¹Ÿå¯ä»¥ç±»ä¼¼äºå…¨å±€çš„å£°æ˜ï¼‰</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/ce"</span><span class="token punctuation">,</span><span class="token function">MiddleWare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å±€éƒ¨å’Œå…¨å±€çš„åŒºåˆ«ï¼šå±€éƒ¨å¯ä»¥é’ˆå¯¹å¿’å…šçš„è·¯ç”±æˆ–è·¯ç”±ç»„ç”Ÿæ•ˆï¼Œåœ¨æ³¨å†Œå‰åˆ›å»ºè·¯ç”±ç»„ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">authgroup<span class="token operator">:=</span>r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/xxx"</span><span class="token punctuation">)</span>authgroup<span class="token punctuation">.</span><span class="token function">USE</span><span class="token punctuation">(</span>MiddleWare<span class="token punctuation">)</span>authgroup<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="ä¼šè¯æ§åˆ¶"><a href="#ä¼šè¯æ§åˆ¶" class="headerlink" title="ä¼šè¯æ§åˆ¶"></a>ä¼šè¯æ§åˆ¶</h3><p>HTTPï¼šæ— çŠ¶æ€åè®®ï¼ŒHTTP1.1å¼•å…¥cookieè§£å†³æ— çŠ¶æ€çš„æ–¹æ¡ˆï¼ŒCookieç”±æœåŠ¡å™¨åˆ›å»ºï¼Œæµè§ˆå™¨ä¿å­˜ï¼Œæ¯æ¬¡å‘é€è¯·æ±‚ç»™æœåŠ¡å™¨æ—¶ï¼Œå‘é€Cookie</p><p><strong>cookieè®¾ç½®</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"cookie"</span><span class="token punctuation">,</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">{</span>    cookie<span class="token punctuation">,</span>err<span class="token operator">=</span>c<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"key_cookie"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">{</span>        <span class="token comment">//è¯´æ˜cookieæœªè®¾ç½®</span>        c<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€ŸåŠ©ä¸­é—´ä»¶æ ¡éªŒcookieï¼Œå¦‚æœæ ¡éªŒå¤±è´¥ï¼šè¿”å›é”™è¯¯ä¿¡æ¯å¹¶é€€å‡º</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span><span class="token string">"err"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸Šè¿°cookieçš„ç¼ºç‚¹</p><ul><li>ä¸å®‰å…¨ï¼Œé€šè¿‡æ˜æ–‡ä¼ è¾“ï¼ˆåªæœ‰httpsä¼ è¾“æ‰å¯ä»¥ä¿è¯å®‰å…¨æ€§ï¼‰</li><li>å¯ä»¥è¢«ç¦ç”¨</li><li>å¢åŠ å®½å¸¦æŸè€—</li><li>cookieæœ‰ä¸Šé™</li><li>åªåœ¨åŒä¸€åŸŸåä¸‹çš„é¡µé¢ä¹‹é—´å…±äº«</li></ul><p><strong>Sessions</strong> ä¸»è¦åŠŸèƒ½ï¼š</p><ul><li>ç®€å•çš„APIï¼Œå¯ä»¥ä½œä¸ºè®¾ç½®ç­¾åcookieçš„ç®€ä¾¿æ–¹æ³•</li><li>å†…ç½®çš„åç«¯å¯ä»¥å°†sessionå­˜å‚¨åœ¨cookieçš„æˆ–è€…æ–‡ä»¶ç³»ç»Ÿä¸­</li><li>Flashæ¶ˆæ¯ï¼šæŒç»­è¯»å–session</li><li>åˆ‡æ¢Sessionçš„æŒä¹…æ€§å’Œä¾¿æ·æ–¹æ³•</li><li>æ—‹è½¬èº«ä»½éªŒè¯ï¼ŒåŠ å¯†å¯†é’¥</li><li>æ¯ä¸ªè¯·æ±‚æœ‰å¤šä¸ªsession</li><li>è‡ªå®šä¹‰sessionåç«¯çš„æ¥å£å’ŒåŸºç¡€ç»“æ„ï¼Œå¯ä»¥é€šè¿‡APIå‡å°‘å¹¶æ‰¹é‡ä¿å­˜</li></ul><p>sessionsçš„ç‰¹ç‚¹</p><ul><li>åœ¨æœåŠ¡å™¨å­˜å‚¨ï¼Œå­˜å‚¨åœ¨æœåŠ¡å™¨çš„å†…å­˜æˆ–è€…æ•°æ®åº“ä¸­</li><li>æ²¡æœ‰æ˜ç¡®çš„å®¹é‡é™åˆ¶</li><li>å¯ä»¥æŒä¹…å­˜åœ¨</li><li>å®¢æˆ·ç«¯æ— æ³•ç›´æ¥è®¿é—®ä½ æˆ–ä¿®æ”¹ï¼Œæ›´å®‰å…¨</li><li>å¯ä»¥è§£å†³cookieçš„è·¨åŸŸé—®é¢˜ï¼Œæ›´çµæ´»</li><li>é€šå¸¸ç”¨æ¥å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Œå¦‚ç”¨æˆ·çš„èº«ä»½éªŒè¯ä¿¡æ¯</li></ul><p>sessionsç›¸å…³å‡½æ•°ç”¨æ³•ï¼š</p><p>ä¿å­˜sessionï¼ˆæ›´æ”¹ï¼‰</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SaveSession</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    session<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"session-name"</span><span class="token punctuation">)</span>    <span class="token comment">//Getæ°¸è¿œä¼šè¿”å›ä¸€ä¸ªsessionï¼Œå³ä¾¿æ˜¯ç©ºçš„session</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    session<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"bar"</span>    <span class="token operator">...</span>    <span class="token comment">// ä¿å­˜æ›´æ”¹</span>    session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·å–session</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">GetSession</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    session<span class="token punctuation">,</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"session-name"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    foo <span class="token operator">:=</span> session<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ é™¤session: å°†sessionçš„æœ€å¤§å­˜å‚¨æ—¶é—´è®¾ç½®ä¸ºå°äºé›¶çš„æ•°å³ä¸ºåˆ é™¤</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">session<span class="token punctuation">.</span>Options<span class="token punctuation">.</span>MaxAge <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å‚æ•°éªŒè¯"><a href="#å‚æ•°éªŒè¯" class="headerlink" title="å‚æ•°éªŒè¯"></a>å‚æ•°éªŒè¯</h3><p><strong>ç»“æ„ä½“éªŒè¯</strong>ï¼šGINæ¡†æ¶è¿›è¡Œæ•°æ®éªŒè¯ï¼Œæ— éœ€è§£ææ•°æ®ï¼Œæ›´ç®€æ´</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> person Person<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%#v"</span><span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœéœ€è¦æ·»åŠ è‡ªå®šä¹‰éªŒè¯ï¼š</p><ul><li><p>é¦–å…ˆï¼Œè¦åœ¨structä¸­é™åˆ¶ï¼šformï¼Œbindingç­‰ï¼ˆç”¨``ï¼‰</p></li><li><p>è‡ªå®šä¹‰æ ¡éªŒæ–¹æ³•ï¼ˆå¦‚é™åˆ¶å­—æ®µä¸ä¸ºç©ºï¼Œä¸ç­‰äºadminï¼‰</p></li><li><p>æ³¨å†Œæ ¡éªŒæ–¹æ³•</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">v<span class="token operator">:=</span>binding<span class="token punctuation">.</span>Validator<span class="token punctuation">.</span><span class="token function">Engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>validator<span class="token punctuation">.</span>Validate<span class="token punctuation">)</span>v<span class="token punctuation">.</span><span class="token function">RegisterValidation</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>func_name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>å†ç”¨ShouldBindè¿›è¡Œæ ¡éªŒ</p></li></ul><p><strong>å¤šè¯­è¨€ç¿»è¯‘éªŒè¯</strong></p><p>å½“ä¸šåŠ¡ç³»ç»Ÿå¯¹éªŒè¯ä¿¡æ¯æœ‰ç‰¹æ®Šéœ€æ±‚æ—¶ï¼Œä¾‹å¦‚ï¼šè¿”å›ä¿¡æ¯éœ€è¦è‡ªå®šä¹‰ï¼Œæ‰‹æœºç«¯è¿”å›çš„ä¿¡æ¯éœ€è¦æ˜¯ä¸­æ–‡è€Œpcç«¯è¿”å›çš„ä¿¡æ¯éœ€è¦æ—¶è‹±æ–‡ï¼Œå¦‚ä½•åšåˆ°è¯·æ±‚ä¸€ä¸ªæ¥å£æ»¡è¶³ä¸Šè¿°ä¸‰ç§æƒ…å†µã€‚</p><p>å€ŸåŠ©ä¸­é—´ä»¶å®ç°ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">startPage</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//è¿™éƒ¨åˆ†åº”æ”¾åˆ°ä¸­é—´ä»¶ä¸­</span>    locale <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> <span class="token string">"zh"</span><span class="token punctuation">)</span>    trans<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> Uni<span class="token punctuation">.</span><span class="token function">GetTranslator</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span>    <span class="token keyword">switch</span> locale <span class="token punctuation">{</span>  <span class="token operator">...</span>        <span class="token keyword">break</span>    <span class="token punctuation">}</span>    <span class="token comment">//è‡ªå®šä¹‰é”™è¯¯å†…å®¹</span>    Validate<span class="token punctuation">.</span><span class="token function">RegisterTranslation</span><span class="token punctuation">(</span><span class="token string">"required"</span><span class="token punctuation">,</span> trans<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ut ut<span class="token punctuation">.</span>Translator<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ut<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"required"</span><span class="token punctuation">,</span> <span class="token string">"{0} must have a value!"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// see universal-translator for details</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ut ut<span class="token punctuation">.</span>Translator<span class="token punctuation">,</span> fe validator<span class="token punctuation">.</span>FieldError<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>        t<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ut<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token string">"required"</span><span class="token punctuation">,</span> fe<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> t    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment">//è¿™å—åº”è¯¥æ”¾åˆ°å…¬å…±éªŒè¯æ–¹æ³•ä¸­</span>    user <span class="token operator">:=</span> User<span class="token punctuation">{</span><span class="token punctuation">}</span>    c<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>    err <span class="token operator">:=</span> Validate<span class="token punctuation">.</span><span class="token function">Struct</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        errs <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span>ValidationErrors<span class="token punctuation">)</span>        sliceErrs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> errs <span class="token punctuation">{</span>            sliceErrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sliceErrs<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">Translate</span><span class="token punctuation">(</span>trans<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%#v"</span><span class="token punctuation">,</span> sliceErrs<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%#v"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>éªŒè¯ç åº“ï¼šgithub.com/dchest/captcha</p></blockquote><p>å…·ä½“å®ç°ï¼š</p><ul><li>ç”Ÿæˆä¸€ä¸ªè·¯ç”±ï¼Œåœ¨sessioné‡Œå†™å…¥é”®å€¼å¯¹kï¼Œvï¼Œå°†våŠ è½½åˆ°å›¾ç‰‡ä¸Šï¼Œç„¶åç”Ÿæˆå›¾ç‰‡ã€‚åœ¨æµè§ˆå™¨æ˜¾ç¤º</li><li>å‰ç«¯å°†å›¾ç‰‡çš„å†…å®¹å‘é€ç»™åç«¯ï¼Œåç«¯æ ¹æ®sessionä¸­çš„kå–å¾—vï¼Œæ¯”å¯¹æ ¡éªŒ</li></ul><p>ç¤ºä¾‹ä»£ç </p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"bytes"</span>    <span class="token string">"github.com/dchest/captcha"</span>    <span class="token string">"github.com/gin-contrib/sessions"</span>    <span class="token string">"github.com/gin-contrib/sessions/cookie"</span>    <span class="token string">"github.com/gin-gonic/gin"</span>    <span class="token string">"net/http"</span>    <span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// ä¸­é—´ä»¶ï¼Œå¤„ç†session</span><span class="token keyword">func</span> <span class="token function">Session</span><span class="token punctuation">(</span>keyPairs <span class="token builtin">string</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>    store <span class="token operator">:=</span> <span class="token function">SessionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> sessions<span class="token punctuation">.</span><span class="token function">Sessions</span><span class="token punctuation">(</span>keyPairs<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">SessionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> sessions<span class="token punctuation">.</span>Store <span class="token punctuation">{</span>    sessionMaxAge <span class="token operator">:=</span> <span class="token number">3600</span>    sessionSecret <span class="token operator">:=</span> <span class="token string">"topgoer"</span>    <span class="token keyword">var</span> store sessions<span class="token punctuation">.</span>Store    store <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>sessionSecret<span class="token punctuation">)</span><span class="token punctuation">)</span>    store<span class="token punctuation">.</span><span class="token function">Options</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>        MaxAge<span class="token punctuation">:</span> sessionMaxAge<span class="token punctuation">,</span> <span class="token comment">//seconds</span>        Path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> store<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">Captcha</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> length <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    l <span class="token operator">:=</span> captcha<span class="token punctuation">.</span>DefaultLen    w<span class="token punctuation">,</span> h <span class="token operator">:=</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">36</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        l <span class="token operator">=</span> length<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">{</span>        w <span class="token operator">=</span> length<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">{</span>        h <span class="token operator">=</span> length<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    captchaId <span class="token operator">:=</span> captcha<span class="token punctuation">.</span><span class="token function">NewLen</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>    session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>    session<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"captcha"</span><span class="token punctuation">,</span> captchaId<span class="token punctuation">)</span>    <span class="token boolean">_</span> <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">Serve</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> captchaId<span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">"zh"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">CaptchaVerify</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> code <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>    <span class="token keyword">if</span> captchaId <span class="token operator">:=</span> session<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"captcha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> captchaId <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        session<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">"captcha"</span><span class="token punctuation">)</span>        <span class="token boolean">_</span> <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> captcha<span class="token punctuation">.</span><span class="token function">VerifyString</span><span class="token punctuation">(</span>captchaId<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">Serve</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> id<span class="token punctuation">,</span> ext<span class="token punctuation">,</span> lang <span class="token builtin">string</span><span class="token punctuation">,</span> download <span class="token builtin">bool</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"no-cache, no-store, must-revalidate"</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Pragma"</span><span class="token punctuation">,</span> <span class="token string">"no-cache"</span><span class="token punctuation">)</span>    w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Expires"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> content bytes<span class="token punctuation">.</span>Buffer    <span class="token keyword">switch</span> ext <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token string">".png"</span><span class="token punctuation">:</span>        w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"image/png"</span><span class="token punctuation">)</span>        <span class="token boolean">_</span> <span class="token operator">=</span> captcha<span class="token punctuation">.</span><span class="token function">WriteImage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>content<span class="token punctuation">,</span> id<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>    <span class="token keyword">case</span> <span class="token string">".wav"</span><span class="token punctuation">:</span>        w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"audio/x-wav"</span><span class="token punctuation">)</span>        <span class="token boolean">_</span> <span class="token operator">=</span> captcha<span class="token punctuation">.</span><span class="token function">WriteAudio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>content<span class="token punctuation">,</span> id<span class="token punctuation">,</span> lang<span class="token punctuation">)</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> captcha<span class="token punctuation">.</span>ErrNotFound    <span class="token punctuation">}</span>    <span class="token keyword">if</span> download <span class="token punctuation">{</span>       w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    http<span class="token punctuation">.</span><span class="token function">ServeContent</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> id<span class="token operator">+</span>ext<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">LoadHTMLGlob</span><span class="token punctuation">(</span><span class="token string">"./*.html"</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token string">"topgoer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/captcha"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">Captcha</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"index.html"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/captcha/verify/:value"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        value <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">CaptchaVerify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"failed"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;GoWeb&quot;&gt;&lt;a href=&quot;#GoWeb&quot; class=&quot;headerlink&quot; title=&quot;GoWeb&quot;&gt;&lt;/a&gt;GoWeb&lt;/h2&gt;&lt;p&gt;å®˜æ–¹åŒ…&lt;code&gt;net/http&lt;/code&gt;æä¾›äº†åŸºç¡€çš„è·¯ç”±å‡½æ•°ç»„åˆå’ŒåŠŸèƒ½å‡½æ•°ï¼Œæ— éœ€API&lt;/p&gt;
&lt;pre c</summary>
      
    
    
    
    <category term="Golang" scheme="http://sn1987a-1.github.io/categories/Golang/"/>
    
    
    <category term="Gin" scheme="http://sn1987a-1.github.io/tags/Gin/"/>
    
  </entry>
  
  <entry>
    <title>VueåŸºç¡€çŸ¥è¯†</title>
    <link href="http://sn1987a-1.github.io/posts/1d1c79fd.html"/>
    <id>http://sn1987a-1.github.io/posts/1d1c79fd.html</id>
    <published>2023-09-23T12:48:34.000Z</published>
    <updated>2023-09-23T13:29:20.201Z</updated>
    
    
    
    
    <category term="å‰ç«¯" scheme="http://sn1987a-1.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="http://sn1987a-1.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>å¹¶è¡Œæ•°æ®ç»“æ„-p-tree</title>
    <link href="http://sn1987a-1.github.io/posts/a4d33f77.html"/>
    <id>http://sn1987a-1.github.io/posts/a4d33f77.html</id>
    <published>2023-09-22T07:46:11.000Z</published>
    <updated>2023-09-23T13:05:25.842Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¹¶è¡Œæ•°æ®ç»“æ„"><a href="#å¹¶è¡Œæ•°æ®ç»“æ„" class="headerlink" title="å¹¶è¡Œæ•°æ®ç»“æ„"></a>å¹¶è¡Œæ•°æ®ç»“æ„</h2><p>å¹¶è¡Œæ•°æ®ç»“æ„çš„å‡ ä¸ªæ¦‚å¿µ</p><ul><li><p>non-blocking</p><p>ä¸€ä¸ªçº¿ç¨‹è¢«æŒ‚èµ·æˆ–ä¸­æ–­ä¸ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹æ‰§è¡Œè¢«block</p></li><li><p>lock-free</p><p>ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„æ‰§è¡Œè¿›åº¦æ˜¯ä¸æ–­æ¨è¿›çš„</p></li><li><p>wait-free</p><p>ä¿è¯æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œè¿›åº¦æ˜¯ä¸æ–­æ¨è¿›çš„</p></li></ul><p>é€šå¸¸éœ€è¦åšåˆ°lock-free,ä¸è¦æ±‚wait-free(è¾ƒéš¾å®ç°ï¼Œæ€§èƒ½è¾ƒå·®)</p><p>lock-free:</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">auto expected = x.load();do {     bool ok = x.compare_exchange_strong(expected, new_value);} while(!ok)//compare_exchange_strong è§£é‡Šã€‚// if true, åˆ™xå’Œexpectedç›¸ç­‰ï¼Œä½¿ç”¨new_valueæ›¿æ¢xçš„å€¼//if false, åˆ™xå’Œexpectedä¸ç›¸ç­‰ï¼Œå¹¶expectedä¼šè¢«ä¿®æ”¹æˆxçš„å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ï¼ˆå¦åˆ™éœ€è¦spin lockï¼‰</p><p>ä»…ä»…ä½¿ç”¨ä¸²è¡Œæ•°æ®ç»“æ„+é”è¿œè¿œä¸èƒ½è¾¾åˆ°è¦æ±‚ï¼ˆè¿˜å¯èƒ½å¯¼è‡´æ­»é”ï¼‰</p><p><strong>æ¶‰åŠçš„æ•°æ®ç»“æ„</strong></p><p>CSDSï¼ˆå¹¶è¡ŒæŸ¥æ‰¾æ•°æ®ç»“æ„ï¼‰</p><ul><li>é“¾è¡¨ï¼Œè·³è¡¨ï¼Œå“ˆå¸Œè¡¨</li><li>ä¸»è¦å®ç°ï¼šæŸ¥æ‰¾ï¼Œæ’å…¥ï¼Œåˆ é™¤<ul><li>æŸ¥æ‰¾ï¼šéå†</li><li>æ’å…¥åˆ é™¤ï¼Œå…ˆæ‰¾åˆ°ä½ç½®ï¼Œå†è¿›è¡Œæ“ä½œ</li></ul></li><li>å…³é”®<ul><li>é€Ÿåº¦å¿«ï¼Œé¿å…è€—æ—¶æ“ä½œï¼ˆå†™æ“ä½œï¼‰ï¼Œç­‰å¾…å’Œé‡è¯•</li><li>ç»†ç²’åº¦ï¼Œä¿®æ”¹å°½é‡è®¾è®¡è¾ƒå°çš„èŒƒå›´ï¼Œéœ€è¦ç”¨é”ï¼šç»†ç²’åº¦é”</li></ul></li></ul><p>éæŸ¥æ‰¾æ•°æ®ç»“æ„ï¼š</p><ul><li>é˜Ÿåˆ—ï¼Œæ ˆï¼Œç«äº‰ç‚¹éƒ½åœ¨å¤´/å°¾ï¼Œé˜Ÿå°¾ç«äº‰æ¿€çƒˆ</li></ul><h3 id="å¹¶è¡Œæ•°æ®ç»“æ„è®¾è®¡"><a href="#å¹¶è¡Œæ•°æ®ç»“æ„è®¾è®¡" class="headerlink" title="å¹¶è¡Œæ•°æ®ç»“æ„è®¾è®¡"></a>å¹¶è¡Œæ•°æ®ç»“æ„è®¾è®¡</h3><h4 id="å•é“¾è¡¨"><a href="#å•é“¾è¡¨" class="headerlink" title="å•é“¾è¡¨"></a>å•é“¾è¡¨</h4><p>ä¸²è¡Œæ•°æ®ç»“æ„çš„å•é“¾è¡¨çš„å¢åˆ æ”¹æŸ¥éƒ½ç›¸å¯¹å®¹æ˜“ï¼Œåœ¨å¹¶å‘ä¸­å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼š</p><ul><li>åˆ é™¤å’Œæ’å…¥ï¼Œæ’å…¥å’Œæ’å…¥ï¼Œåˆ é™¤å’Œåˆ é™¤ï¼Œéƒ½ä¼šå¼•å‘é—®é¢˜</li><li>å†…å­˜ç®¡ç†é—®é¢˜ï¼šå¯¹å·²åˆ é™¤çš„èŠ‚ç‚¹ï¼Œéœ€è¦é‡Šæ”¾å†…å­˜ï¼Œä½†å¦‚æœå…¶ä»–çº¿ç¨‹æŒæœ‰åœ¨è¯¥ç‚¹çš„æ“ä½œï¼Œä¸èƒ½ç«‹å³é‡Šæ”¾</li><li>ABAé—®é¢˜ï¼šæ’å…¥æŸèŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹çš„å‰é©±åˆšè¢«é‡Šæ”¾ä¸”ç©ºé—´è¢«åˆ†é…åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå†…å­˜å¤ç”¨ï¼‰ï¼Œå¯¼è‡´é“¾è¡¨ä¹±åº</li><li>çº¿æ€§åŒ–é—®é¢˜ï¼šéå†é“¾è¡¨å¾—åˆ°çš„éå†ç»“æœä¸ä¸€å®šæ˜¯å†å²å­˜åœ¨è¿‡çš„é“¾è¡¨ç‰ˆæœ¬æ•°æ®ï¼ˆè§£å†³æ–¹æ¡ˆï¼šä¸æä¾›éå†æ“ä½œå³å¯ï¼Œåªæä¾›æ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾ï¼Œè¿™ä¸‰ä¸ªæ“ä½œå¯ä»¥æ˜¯çº¿æ€§åŒ–çš„ï¼‰</li></ul><p>è§£å†³æ–¹æ¡ˆï¼ˆå¤§éƒ¨åˆ†çš„é—®é¢˜éƒ½æ˜¯åˆ é™¤æ“ä½œã€é‡Šæ”¾ç©ºé—´äº§ç”Ÿçš„ï¼‰</p><ul><li>èŠ‚ç‚¹ä¸åˆ é™¤ï¼Œå…ˆæ ‡è®°å†é›†ä¸­GCï¼ŒGCåŠ é”<ul><li>såˆ é™¤å¯¼è‡´çš„GCä¼šå‡ºç°çŸ­æš‚é˜»å¡ï¼Œå‡ºç°é•¿å°¾</li></ul></li><li>èŠ‚ç‚¹åˆ é™¤ä½†ä¸é‡Šæ”¾å†…å­˜<ul><li>å†…å­˜ä¼šä¸æ–­å¢é•¿</li></ul></li><li>èŠ‚ç‚¹åˆ é™¤å¹¶é‡Šæ”¾å†…å­˜<ul><li>ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„æ–¹å¼ç®¡ç†é“¾è¡¨å†…å­˜é‡Šæ”¾ï¼Œæ¯æ¬¡éå†å¯¹èŠ‚ç‚¹è¿›è¡Œå¼•ç”¨è®¡æ•°ï¼ˆå¯¹æ€§èƒ½å½±å“è¾ƒå¤§ï¼‰</li></ul></li></ul><p>æ’å…¥åˆ é™¤å†²çªçš„è§£å†³</p><p>å…³é”®åœ¨äºï¼šè¢«åˆ é™¤èŠ‚ç‚¹çš„nextä¸èƒ½è¢«æ”¹å˜ï¼Œå¯ä»¥å°†è¢«åˆ é™¤èŠ‚ç‚¹çš„nextæ·»åŠ æ ‡è®°ç¬¦1ï¼ˆnext&amp;1ï¼‰ï¼Œé˜»æ­¢å…¶ä»–çº¿ç¨‹æ”¹å˜è¯¥èŠ‚ç‚¹çš„å€¼ã€‚</p><p><img src="https://segmentfault.com/img/bVcXvpQ" alt="image.png" style="zoom:33%;"></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">bool del_node(ListNode* pre_del_node) {        ListNode* del_node = pre_del_node-&gt;next.load();        //1. æ ‡è®°del_node-&gt;next;        ListNode* excepted_next = del_node-&gt;next.load();        //2. nextæŒ‡é’ˆæ·»åŠ æ ‡è®°ä½        if (!del_node-&gt;next-&gt;compare_exchange_strong(excepted_next, excepted_next&amp;1)) {            return false;        }        //3. ä¿®æ”¹å‰é©±èŠ‚ç‚¹nextæŒ‡é’ˆ        if(!pre_del_node-&gt;next.compare_exchange_strong(del_node, del_node-&gt;next)) {            return false;        }               return true;} <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœä¿®æ”¹ä¸æˆåŠŸå°†é€€å‡ºï¼Œæ’å…¥ä¹Ÿç±»ä¼¼ã€‚</p><p><code>compare_exchange_strong</code></p><p><strong>ABAé—®é¢˜çš„è§£å†³</strong></p><p>ä½¿ç”¨tagged pointerè§£å†³ï¼ˆåœ¨æŒ‡é’ˆä¸Šå¸¦ä¸Šç‰ˆæœ¬å·è¿›è¡Œç®¡ç†ï¼‰</p><p>ä½¿ç”¨æŒ‡é’ˆçš„æœ€é«˜16å°¾å­˜å‚¨æŒ‡é’ˆçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¯æ¬¡æŒ‡é’ˆå†…å®¹å‘ç”Ÿå˜åŒ–æ—¶æ”¹å˜ç‰ˆæœ¬å·ï¼ˆæŒ‡é’ˆä¸€èˆ¬64ä½ï¼ŒCPUå†…å­˜è¿œè¿œä¸åŠï¼‰<a href="https://www.boost.org/doc/libs/1_57_0/boost/lockfree/detail/tagged_ptr.hpp">å‚è€ƒ</a></p><p><strong>å†…å­˜ç®¡ç†é—®é¢˜è§£å†³</strong></p><p>é£é™©æŒ‡é’ˆHazard Pointers</p><p>åŸç†ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹æŠŠè‡ªå·±è®¿é—®çš„èŠ‚ç‚¹çš„åœ°å€æ”¾åœ¨å…¨å±€å¯è§çš„åœ°æ–¹ï¼Œè¿™æ ·çš„å…¨å±€å¯è§çš„æŒ‡é’ˆè¢«ç§°ä¸ºé£é™©æŒ‡é’ˆï¼Œè®¿é—®å®ŒèŠ‚ç‚¹åæ¸…é™¤è‡ªå·±çš„é£é™©æŒ‡é’ˆ</li><li>æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªfreelistï¼š<ul><li>å½“æŸä¸ªç»“ç‚¹Aè¢«åˆ é™¤åï¼Œæ”¾åˆ°freelisté‡Œ</li><li>æ£€æŸ¥å…¶ä»–çº¿ç¨‹çš„é£é™©æŒ‡é’ˆï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å’ŒAç›¸åŒçš„åœ°å€ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹æ­£åœ¨è®¿é—®Aï¼ŒAå¯ä»¥è¢«é‡Šæ”¾</li></ul></li></ul><p>ä¼˜åŒ–ï¼šé£é™©æŒ‡é’ˆè‡ªèº«ä¹Ÿè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦é«˜æ•ˆå®ç°â€”â€”<code>shared_ptr</code></p><p>ä½¿ç”¨shared-ptrç»„ç»‡é“¾è¡¨ï¼Œæ¯ä¸ªListNode*éƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>éå†é“¾è¡¨æ—¶ï¼Œæ¯èµ°è¿‡ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å¼•ç”¨æ•°+1ï¼Œç¦»å¼€æ—¶å¼•ç”¨æ•°-1ï¼ŒåŸå­æ“ä½œæ¯”è¾ƒæ…¢ï¼Œå› æ­¤æœç´¢é€Ÿåº¦æ…¢ï¼Œä¸æ»¡è¶³CSDSçš„åŸåˆ™</li><li>é‡‡ç”¨é€’å½’æ–¹å¼é‡Šæ”¾æ•´ä¸ªé“¾è¡¨ï¼Œæˆ–è€…é“¾è¡¨ä¸­çš„ä¸€æ®µï¼Œå¯èƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡º</li><li>å¦‚æœä¸€ä¸ªçº¿ç¨‹è·å¾—ä¸€ä¸ªç»“ç‚¹çš„å¼•ç”¨è®¡æ•°ï¼Œä½†è¢«å¡ä½äº†ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šé‡Šæ”¾è¿™ä¸ªè®¡æ•°ï¼Œè¯¥èŠ‚ç‚¹æ‰€æœ‰çš„åç»§èŠ‚ç‚¹éƒ½ä¼šè¢«å»¶è¿Ÿé‡Šæ”¾</li></ul><h3 id="å¹¶è¡Œæ‰©å¼ æ ‘P-tree"><a href="#å¹¶è¡Œæ‰©å¼ æ ‘P-tree" class="headerlink" title="å¹¶è¡Œæ‰©å¼ æ ‘P-tree"></a>å¹¶è¡Œæ‰©å¼ æ ‘P-tree</h3><p>SunYihan  <em>Parallel Ordered Sets Using Join</em> 2016,<em>PAM: Parallel Augmented Maps</em> 2018,<em>Join-based Parallel Balanced Binary Trees</em> 2019</p><p>å¯¹äºå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ä¸Šä¸‡ä¸ªå›¾èŠ‚ç‚¹ï¼Œåœ¨åšå›¾ç®—æ³•æ—¶ï¼Œå¯¹å›¾è¿›è¡Œè™šæ‹ŸåŒ–ã€‚è™šæ‹Ÿå›¾å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä¸¤ç§æ–¹å¼æ¥åŠ¨æ€æ„å»ºï¼š1. â€œä¸­æ–­â€å¼çš„æ„å»ºï¼›2. å¤šçº¿ç¨‹çš„æ„å»ºï¼Œå³å­˜åœ¨ä¸€ä¸ªæ‰«æçº¿ç¨‹ï¼Œåå°æ‰«ææ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹ï¼ŒåŠ è½½åˆ°è™šæ‹Ÿå›¾ä¸­ã€‚</p><p>æ‰€è°“â€œä¸­æ–­â€å¼çš„æ„å»ºï¼Œæ˜¯æŒ‡è¦éå†åˆ°çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸åœ¨è™šæ‹Ÿå›¾ä¸Šï¼Œè§¦å‘â€œä¸­æ–­â€ï¼Œå¼€å§‹ä»ç£ç›˜åŠ è½½ä¸€æ‰¹æ–°çš„å›¾èŠ‚ç‚¹è¿›æ¥ã€‚è€Œå¤šçº¿ç¨‹æ„å»ºæ–¹å¼ï¼Œåˆ™æ˜¯åŠ¨æ€å¸è½½å·²ç»è®¿é—®è¿‡çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶åŠ¨æ€åŠ è½½æ–°çš„èŠ‚ç‚¹ã€‚ä¸ºäº†æé«˜å¯¹è™šæ‹Ÿå›¾è¯»å†™çš„å¹¶å‘æ€§ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸€ç§æ•°æ®ç»“æ„ï¼šParrellel Auguemented Map.</p><p>ä¸¤ä¸ªåŸºæœ¬å‡½æ•°ï¼š</p><p><code>join(l,k,R)</code>ï¼Œè¡¨ç¤ºä»¥kä¸ºæ ¹èŠ‚ç‚¹è¿æ¥çš„å·¦å³ä¸¤æ£µå­æ ‘LR</p><p><code>expose(T)</code>è¡¨ç¤ºä»¥æ ‘Tçš„æ ¹kä½œä¸ºåˆ†è£‚èŠ‚ç‚¹ï¼Œå°†æ ‘åˆ†è£‚ä¸ºLï¼Œkï¼ŒRå¹¶è¿”å›</p><p>ç›¸å…³å‡½æ•°ï¼š</p><p><strong>split ()ä»¥kä¸ºèŠ‚ç‚¹åˆ’åˆ†æ ‘ï¼Œè¿”å›å·¦å­æ ‘ï¼Œå³å­æ ‘å’Œæ˜¯å¦null</strong></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">split(T,k)    if T = null             (null,false,null)        else (L,m,R)=expose(T)        if k = m             (L,true,R)            else if k &lt; m                (LL,b,LR)=split(L,k)                (LL,b,join(LR,m,R))            else                 (RL,b,RR)=split(R,k)                (join(L,m,RL),b,RR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>insertï¼ˆï¼‰æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹</strong></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">insert(T,k) (TL,m,TR)=split(T,k)    join(TL,k,TR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>splitlast() ç§»é™¤Tæœ€å¤§å€¼çš„èŠ‚ç‚¹ï¼ˆå³å³å­æ ‘çš„æœ€ä¸‹æ–¹çš„å€¼ï¼Œè¿”å›ç§»é™¤åçš„å¹³è¡¡æ ‘å’Œç§»é™¤çš„èŠ‚ç‚¹ï¼‰</strong></p><pre class="line-numbers language-none"><code class="language-none">splitlast(T)    (L,k,R)=expose(T)    if R=null        (L,k)    else        (T',k')=splitLast(R)        (join(L,k,T'),k')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>join2() å°†ä¸¤æ£µæ ‘æ‹¼æ¥èµ·æ¥ï¼Œæ ¹èŠ‚ç‚¹ä¸ºå·¦å­æ ‘çš„æœ€å¤§æ ¹</strong></p><pre class="line-numbers language-none"><code class="language-none">join2(TL,TR)    if TL = null        TR    else       (TL',k)=splitlast(TL)       join(TL',k,TR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>delete()ä»Tä¸­åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹k</strong></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">delete(T,k)    (TL,m,TR)=split(T,k)    join2(TL,TR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šçš„å‡ ä¸ªå‡½æ•°æœªæ¶‰åŠå¹¶å‘ï¼Œåœ¨ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨å¹¶å‘è¿›è¡Œå®ç°ä»¥ä¸‹å‡½æ•°ï¼š(ç”¨æ¥å¤„ç†èŠ‚ç‚¹è¿‡å¤šçš„æƒ…å†µï¼Œæé«˜æ•ˆç‡)</p><p><em>å…¶ä¸­ï¼Œ||è¡¨ç¤ºå·¦å³ä¸¤è¾¹çš„å‡½æ•°å¯ä»¥å¹¶å‘è¿›è¡Œ</em></p><p><strong>union()å°†ä¸¤ä¸ªæ ‘åˆå¹¶æˆä¸€ä¸ªæ–°çš„æ ‘</strong></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">union(T1,T2)    if T1 = null         T2    else if T2 = null        T1    else        (L2,k,R2)=expose(T2)        (L1,m,R1)=spilt(T1,k)       TL=union(L1,L2)|| TR=union(R1,R2)        join(TL,k,TR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>difference(T1,T2) å°†T1ä¸­åŒ…å«T2çš„èŠ‚ç‚¹åˆ é™¤ï¼Œå¯ä»¥ç”¨æ¥æ‰¹é‡åˆ é™¤èŠ‚ç‚¹</strong></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">difference(T1,T2)    if T1=null        null    else if T2=null        T1    else        (L2,k,R2)=expose(T2)        (L1,m,R2)=split(T1,k)        T1=difference(L1,L2) || T2=difference(R1,R2)        join2(T1,TR)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å¹¶è¡Œæ•°æ®ç»“æ„&quot;&gt;&lt;a href=&quot;#å¹¶è¡Œæ•°æ®ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;å¹¶è¡Œæ•°æ®ç»“æ„&quot;&gt;&lt;/a&gt;å¹¶è¡Œæ•°æ®ç»“æ„&lt;/h2&gt;&lt;p&gt;å¹¶è¡Œæ•°æ®ç»“æ„çš„å‡ ä¸ªæ¦‚å¿µ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;non-blocking&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªçº¿ç¨‹è¢«æŒ‚</summary>
      
    
    
    
    <category term="HPC" scheme="http://sn1987a-1.github.io/categories/HPC/"/>
    
    
    <category term="å¹¶è¡Œæ•°æ®ç»“æ„" scheme="http://sn1987a-1.github.io/tags/%E5%B9%B6%E8%A1%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>CGO</title>
    <link href="http://sn1987a-1.github.io/posts/d4c66f48.html"/>
    <id>http://sn1987a-1.github.io/posts/d4c66f48.html</id>
    <published>2023-09-20T12:48:34.000Z</published>
    <updated>2023-09-23T13:03:50.253Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CGO"><a href="#CGO" class="headerlink" title="CGO"></a>CGO</h2><h4 id="åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç "><a href="#åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç " class="headerlink" title="åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç "></a>åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç </h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//include "xxx.h"</span><span class="token keyword">import</span> <span class="token string">"C"</span>C<span class="token punctuation">.</span><span class="token function">puts</span><span class="token punctuation">(</span>helloworld<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>.hæ–‡ä»¶ä¸­å£°æ˜å‡½æ•°ï¼Œ.c/.cppæ–‡ä»¶å¯¹åº”å‡½æ•°çš„å®šä¹‰</p><p>import â€œCâ€å‰é¢çš„æ³¨é‡Šå³ä¸ºè¦è¿è¡Œçš„Cä»£ç </p><p>é»˜è®¤Cï¼Œå¦‚æœéœ€è¦ç”¨C++ï¼ˆcppæ–‡ä»¶ï¼‰ï¼Œè¦å£°æ˜ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">export</span> <span class="token string">"C"</span><span class="token punctuation">{</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;xxx.h&gt;</span></span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Goç”ŸæˆCå‡½æ•°</strong></p><p>é€šè¿‡ä½¿ç”¨<code>extern "C"</code>ï¼Œå¯ä»¥ç¡®ä¿å‡½æ•°åœ¨Cé“¾æ¥ä¸‹å¯ç”¨ï¼Œä»è€Œå…è®¸ä»Cä»£ç ä¸­è°ƒç”¨å®ƒï¼Œè€Œä¸ä¼šå—åˆ°C++åç§°é‡æ•´çš„å½±å“ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//export funct</span><span class="token keyword">func</span> funct <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    C<span class="token punctuation">.</span><span class="token function">funct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨goé‡æ–°å®ç°Cè¯­è¨€å‡½æ•°ã€‚</p><p>goå‡½æ•°C.CSstring()å°†å­—ç¬¦ä¸²è½¬åŒ–ä¸º(const)char*</p><p>ä¸Šè¿°å‡½æ•°è¿è¡Œè¿‡ç¨‹ï¼š</p><p>Goçš„mainå‡½æ•°æ‰§è¡Œï¼Œåˆ°CGOè‡ªåŠ¨ç”Ÿæˆçš„Cè¯­è¨€ç‰ˆæœ¬çš„functæ¡¥æ¥å‡½æ•°ï¼Œå›åˆ°GOä¸­çš„functå‡½æ•°ã€‚</p><p><strong>Cè¯­è¨€å¯ä»¥è°ƒç”¨GOç”Ÿæˆçš„å‡½æ•°</strong>ï¼ŒCGOçœçš„â€_cgi_export.hâ€åŒ…å«äº†å¯¼å‡ºåçš„Cè¯­è¨€å‡½æ•°å£°æ˜</p><h4 id="ç±»å‹è½¬åŒ–"><a href="#ç±»å‹è½¬åŒ–" class="headerlink" title="ç±»å‹è½¬åŒ–"></a>ç±»å‹è½¬åŒ–</h4><p>æ•°å­—ç±»å‹è½¬åŒ–ï¼š</p><div class="table-container"><table><thead><tr><th>C è¯­è¨€ç±»å‹</th><th>CGO ç±»å‹</th><th>Go è¯­è¨€ç±»å‹</th></tr></thead><tbody><tr><td>char</td><td>C.char</td><td>byte</td></tr><tr><td>signed char</td><td>C.schar</td><td>int8</td></tr><tr><td>unsigned char</td><td>C.uchar</td><td>uint8</td></tr><tr><td>short</td><td>C.short</td><td>int16</td></tr><tr><td>unsigned short</td><td>C.ushort</td><td>uint16</td></tr><tr><td>int</td><td>C.int</td><td>int32</td></tr><tr><td>unsigned int</td><td>C.uint</td><td>uint32</td></tr><tr><td>long</td><td>C.long</td><td>int32</td></tr><tr><td>unsigned long</td><td>C.ulong</td><td>uint32</td></tr><tr><td>long long int</td><td>C.longlong</td><td>int64</td></tr><tr><td>unsigned long long int</td><td>C.ulonglong</td><td>uint64</td></tr><tr><td>float</td><td>C.float</td><td>float32</td></tr><tr><td>double</td><td>C.double</td><td>float64</td></tr><tr><td>size_t</td><td>C.size_t</td><td>uint</td></tr></tbody></table></div><p>åœ¨CGOç”Ÿæˆçš„<code>_cgo_export.h</code>å¤´æ–‡ä»¶ä¸­ï¼Œä¼šä¸ºgoçš„å­—ç¬¦ä¸²ï¼Œåˆ‡ç‰‡ï¼Œå­—å…¸ï¼Œæ¥å£ï¼Œç®¡é“ç­‰ç‰¹æ®Šæ•°æ®ç»“æ„ç”Ÿæˆå¯¹åº”çš„Cè¯­è¨€ç±»å‹ã€‚ï¼ˆåªæœ‰åˆ‡ç‰‡å’Œå­—ç¬¦ä¸²æœ‰ä¸€å®šçš„è°ƒç”¨ä»·å€¼ï¼Œå› CGOå¯¹ä»–ä»¬çš„æŸäº›æ“ä½œå‡½æ•°ç”Ÿæˆäº†å¯¹åº”çš„Cè¯­è¨€ç‰ˆæœ¬ï¼‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> GoInt n<span class="token punctuation">;</span><span class="token punctuation">}</span> GoString<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>GoMap<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>GoChan<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token keyword">void</span> <span class="token operator">*</span>t<span class="token punctuation">;</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">;</span><span class="token punctuation">}</span> GoInterface<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span> GoInt len<span class="token punctuation">;</span> GoInt cap<span class="token punctuation">;</span><span class="token punctuation">}</span> GoSlice<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ç»“æ„ä½“</strong> é€šè¿‡<code>C.struct_xxx</code>è®¿é—®Cä¸­å®šä¹‰çš„struct xxxçš„ç»“æ„ä½“ç±»å‹ï¼Œç»“æ„ä½“å†…å­˜å¸ƒå±€æŒ‰ç…§Cè¯­è¨€é€šç”¨å¯¹é½è§„åˆ™ï¼ˆ32/64ä½ï¼‰ï¼Œè‹¥ç»“æ„ä½“çš„æˆå‘˜çš„åå­—æ˜¯goçš„å…³é”®å­—ï¼Œå¯ä»¥åœ¨æˆå‘˜åå¼€å¤´æ·»åŠ _æ¥è®¿é—®</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">/*struct A {    int type; // type æ˜¯ Go è¯­è¨€çš„å…³é”®å­—};*/</span><span class="token keyword">import</span> <span class="token string">"C"</span><span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a C<span class="token punctuation">.</span>struct_A    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>_type<span class="token punctuation">)</span> <span class="token comment">// _type å¯¹åº” type</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ°å¥½æœ‰ä¸¤ä¸ªæˆå‘˜ type,_typeï¼Œåˆ™typeå°†è¢«å±è”½ã€‚</p><p>Cè¯­è¨€ä¸­æ— æ³•ç›´æ¥è®¿é—®Goå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ã€‚</p><p><strong>åˆ‡ç‰‡å’Œå­—ç¬¦ä¸²</strong></p><p>Goä¸­çš„åˆ‡ç‰‡å’ŒCä¸­çš„æŒ‡å‘ä¸€å®šé•¿åº¦å†…å­˜çš„æŒ‡é’ˆï¼ˆsliceå®é™…ä¸Šæ˜¯ç®€åŒ–ç‰ˆçš„åŠ¨æ€æ•°å­—ï¼‰</p><p>goä¸­çš„å­—ç¬¦ä¸²æ˜¯åªè¯»çš„</p><p><strong>æŒ‡é’ˆ</strong></p><p>Cè¯­è¨€ä¸­çš„æŒ‡é’ˆå¯ä»¥è¿›è¡Œæ˜¾ç¤ºæˆ–éšå¼åˆ‡æ¢ï¼ˆéšå¼ä¼šåœ¨ç¼–è¯‘é˜¶æ®µç»™å‡ºwarningsï¼‰ï¼Œgoå¯¹ä¸åŒç±»å‹çš„è½¬æ¢éå¸¸ä¸¥æ ¼ï¼Œæ— æ³•è‡ªç”±è½¬æ¢ã€‚å¦‚æœæ ¼å¼ä¸€è‡´ï¼ŒæŒ‡é’ˆå¯ä»¥é€šç”¨ã€‚CGOè§£å†³äº†GOæ— æ³•è‡ªç”±è½¬æ¢å’Œè¿›è¡ŒæŒ‡é’ˆè¿ç®—çš„é™åˆ¶ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> p <span class="token operator">*</span>X<span class="token keyword">var</span> q <span class="token operator">*</span>Yq <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>Y<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// *X =&gt; *Y</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>X<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// *Y =&gt; *X</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨unsafe.Pointerä½œä¸ºä¸­é—´æ¡¥æ¥ç±»å‹å®ç°ä¸åŒç±»å‹æŒ‡é’ˆçš„è½¬æ¢ï¼Œè½¬æ¢æµç¨‹ï¼š*X-&gt;unsafe.pointer-&gt;*Y</p><p>åŒæ ·ï¼Œgoä¹Ÿæ— æ³•å®ç°æ•°å€¼ç±»å‹è½¬åŒ–ä¸ºæŒ‡é’ˆç±»å‹ï¼Œé‡‡ç”¨uintpträ½œä¸ºä¸­é—´ç±»å‹å®ç°ï¼Œè½¬åŒ–è¿‡ç¨‹ï¼šint32-&gt;uintptr-&gt;unsafe.pointer-&gt;char*</p><h4 id="å‡½æ•°è°ƒç”¨"><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h4><p>Cä¸æ”¯æŒå¤šè¿”å›å€¼ï¼Œä½†Goéœ€è¦errorè¿”å›æŠ¥é”™ä¿¡æ¯(å¦‚divé™¤æ•°ä¸º0)ï¼Œè§£å†³æ–¹æ¡ˆï¼š</p><p>å¼•å…¥errnoåŒ…</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;errno.h&gt;int div(int a, int b) {    if(b == 0) {        errno = EINVAL;        return 0;    }    return a/b;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CGOçš„å¤„ç†ï¼šåœ¨CGOä¸­å¦‚æœæœ‰ä¸¤ä¸ªè¿”å›å€¼ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªè¿”å›å€¼ä¸ºerrnoï¼Œå¯ä»¥è¿‘ä¼¼åœ°å°†å‡½æ•°çœ‹ä½œä»¥ä¸‹ç±»å‹ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> C<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b C<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token builtin">error</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>voidå‡½æ•°</strong>è¿”å›å€¼</p><p>æŒ‰ç…§å‰æ–‡æ‰€è¿°ï¼Œå¯¹äºæ²¡æœ‰è¿”å›å€¼çš„voidå‡½æ•°ï¼Œå¦‚æœå‡ºç°errnoï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼ŒCGOæ— æ³•ç›´æ¥åˆ¤æ–­é”™è¯¯çŠ¶æ€ï¼ŒCGOçš„å¤„ç†å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"C"</span><span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> C<span class="token punctuation">.</span><span class="token function">noreturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CGO&quot;&gt;&lt;a href=&quot;#CGO&quot; class=&quot;headerlink&quot; title=&quot;CGO&quot;&gt;&lt;/a&gt;CGO&lt;/h2&gt;&lt;h4 id=&quot;åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç &quot;&gt;&lt;a href=&quot;#åœ¨Goä¸­è°ƒç”¨Cçš„ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;åœ¨</summary>
      
    
    
    
    <category term="Golang" scheme="http://sn1987a-1.github.io/categories/Golang/"/>
    
    
    <category term="CGO" scheme="http://sn1987a-1.github.io/tags/CGO/"/>
    
  </entry>
  
  <entry>
    <title>GolangåŸºç¡€çŸ¥è¯†</title>
    <link href="http://sn1987a-1.github.io/posts/c303e9c6.html"/>
    <id>http://sn1987a-1.github.io/posts/c303e9c6.html</id>
    <published>2023-09-18T12:48:34.000Z</published>
    <updated>2023-09-23T13:03:58.933Z</updated>
    
    <content type="html"><![CDATA[<h2 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h2><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>å®ç°ï¼šå“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œé€šè¿‡é“¾è¡¨æ³•è§£å†³å“ˆå¸Œå†²çª</p><ul><li>éšæœºéå†ï¼Œé¡ºåºæ— æ³•é¢„æµ‹</li><li>æ‰©å®¹ç‰¹ç‚¹ï¼šé€æ­¥è¿›è¡Œï¼Œæ–°ï¼Œæ—§bucket<ul><li>éå†ä¸­å‡ºç°æ‰©å®¹</li><li>éå†å‰å·²ç»å¼€å§‹æ‰©å®¹</li></ul></li></ul><h3 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h3><p>åº•å±‚ç»“æ„ï¼šæœ¬è´¨ä¸Šæ˜¯å¼•ç”¨ç±»å‹ï¼Œåº•å±‚ç»“æ„æœ‰ä¸‰ä¸ªå˜é‡ï¼šlenï¼Œcapï¼Œåº•å±‚æ•°ç»„çš„æŒ‡é’ˆ</p><ul><li>ç©ºåˆ‡ç‰‡æ—¶ï¼Œcap=len=0</li><li>ä¸€èˆ¬åˆå§‹åŒ–æ–¹å¼<code>a:=[]int{}</code>cap=len=åˆå§‹åŒ–é•¿åº¦</li><li>ä½¿ç”¨makeè¿›è¡Œåˆå§‹åŒ–ï¼š<code>a:=make([]int,4,5)</code>ï¼šcap=5ï¼Œlen=4ï¼Œaä¸º[0,0,0,0]</li><li><code>var a []int</code>é»˜è®¤cap=len=0</li></ul><p>appendæ“ä½œ</p><ul><li>capè¶³å¤Ÿï¼Œç›´æ¥ä¿®æ”¹lenï¼Œè¿½åŠ </li><li>capä¸è¶³æ—¶â€¦</li><li><em>capè¶³å¤Ÿæ—¶ï¼Œä¸€æ¬¡è¿½åŠ å¤šä¸ªå’Œå¤šæ¬¡è¿½åŠ ä¸€ä¸ªç»“æœç›¸åŒï¼Œcapä¸è¶³æ—¶ä¼šå‡ºç°ä¸ä¸€æ ·çš„ç»“æœï¼ˆcapçš„ç»“æœä¸åŒï¼Œå¤šæ¬¡è¿½åŠ ä¸€ä¸ªçš„æƒ…å†µå¯èƒ½ä¼šæ›´å¤§ï¼‰</em></li></ul><p>åˆ‡ç‰‡æˆªå–æ“ä½œï¼š</p><ul><li><em>åˆ‡ç‰‡è¿›è¡Œæˆªå–æ—¶ï¼Œæ•°ç»„å®¹é‡çš„æœ«å°¾å’ŒåŸåˆ‡ç‰‡æ•°ç»„æœ«å°¾å¯¹é½ï¼Œæ•°ç»„åœ°å€ä¸ºæˆªå–å•å…ƒçš„é¦–åœ°å€ï¼Œä¸”å¯ä»¥è¶…è¿‡å…¶lençš„èŒƒå›´è¿›è¡Œæˆªå–ï¼Œå½“å…¶ä¸­ä¸€ä¸ªæ•°ç»„å‘ç”Ÿæ‰©å®¹æ—¶ï¼Œå¦ä¸€ä¸ªæ•°ç»„çš„åœ°å€ä¸å˜</em></li></ul><p>åˆ‡ç‰‡æ‰©å®¹æ—¶ä¼šæ”¹å˜ï¼šcapå’Œæ•°å­—æŒ‡é’ˆ</p><h3 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h3><ul><li>å¼•ç”¨è®¡æ•°ï¼Œ0å›æ”¶ï¼Œæ— æ³•å¤„ç† å¾ªç¯å¼•ç”¨</li><li>æ ‡è®°-æ¸…é™¤ï¼š éœ€è¦STW</li><li>åˆ†ä»£æ”¶é›†ï¼šæŒ‰ç…§ç”Ÿå­˜å‘¨æœŸè€/æ–°ä¸åŒçš„ç®—æ³•ï¼Œæ•ˆç‡é«˜ï¼Œç®—æ³•è®¾è®¡å¤æ‚</li><li><strong>ä¸‰è‰²æ ‡è®°æ³•</strong>ï¼šç™½-åƒåœ¾ï¼Œç°-éå†åˆ°çš„å¯¹è±¡ï¼Œé»‘ï¼Œéå†ç°è‰²ï¼Œæ ‡è®°ä¸ºé»‘è‰²å¹¶å°†å¼•ç”¨çš„å˜é‡æ ‡è®°ä¸ºç°è‰²ï¼Œç›´åˆ°æ²¡æœ‰ç°è‰²<ul><li><strong>æ¯æ¬¡GCå¾ªç¯æ—¶ï¼Œä¸éœ€è¦å°†æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°ç™½è‰²åŒºåŸŸï¼Œåªè¦å°†é»‘è‰²å’Œç™½è‰²çš„é¢œè‰²äº’æ¢å³å¯ï¼Œæ›´é«˜æ•ˆ</strong></li></ul></li><li><strong>STW</strong>ï¼šå½±å“æ€§èƒ½&lt;1ms</li><li><strong>å†™å±éšœæŠ€æœ¯</strong>ç¼©çŸ­STW<ul><li>å¼•ç”¨å¯¹è±¡ä¸¢å¤±ï¼šé»‘è‰²èŠ‚ç‚¹æ·»åŠ äº†æŒ‡å‘ç™½è‰²ç»“ç‚¹çš„å¼•ç”¨ï¼Œä½†æ— æ³•è¢«æ‰«æ</li><li>ç ´åä»¥ä¸‹äºŒè€…ä¹‹ä¸€ï¼š<ul><li>dijistraå†™å±éšœï¼ˆå¼ºä¸‰è‰²ä¸å˜æ€§ï¼‰ï¼Œä¸å…è®¸é»‘è‰²èŠ‚ç‚¹å¼•ç”¨ç™½è‰²èŠ‚ç‚¹ï¼Œå¼•ç”¨åˆ™å°†ç™½è‰²èŠ‚ç‚¹æ”¹ä¸ºç°è‰²</li><li>yuasaå†™å±éšœï¼ˆå¼±ä¸‰è‰²ä¸å˜æ€§ï¼‰ï¼Œç™½è‰²èŠ‚ç‚¹è¢«åˆ é™¤äº†ä¸€ä¸ªå¼•ç”¨æ—¶ï¼Œè®¤ä¸ºä¼šè¢«é»‘è‰²èŠ‚ç‚¹æ–°å¢å¼•ç”¨ï¼ˆæ‚²è§‚ï¼‰ï¼Œè®¾ç½®ä¸ºç°è‰²</li></ul></li></ul></li></ul><p>goçš„åƒåœ¾å›æ”¶å™¨æ˜¯å’Œä¸»ç¨‹åºå¹¶è¡Œçš„ï¼Œå…³é”®åœ¨äºä¸‰è‰²æ ‡è®°æ³•èƒ½è®©ç³»ç»Ÿçš„gcæš‚åœæ—¶é—´èƒ½å¤Ÿé¢„æµ‹</p><h3 id="GPMè°ƒåº¦å’ŒCSPæ¨¡å‹"><a href="#GPMè°ƒåº¦å’ŒCSPæ¨¡å‹" class="headerlink" title="GPMè°ƒåº¦å’ŒCSPæ¨¡å‹"></a>GPMè°ƒåº¦å’ŒCSPæ¨¡å‹</h3><p><em>ä¸è¦ä»¥å…±äº«å†…å­˜çš„æ–¹å¼æ¥é€šä¿¡ï¼Œè¦ä»¥é€šä¿¡çš„æ–¹å¼æ¥å…±äº«å†…å­˜</em></p><ul><li>CSPæ¨¡å‹ï¼šä»¥é€šä¿¡çš„æ–¹å¼å…±äº«å†…å­˜ï¼ˆchannelè¿›è¡Œé€šä¿¡ï¼‰</li><li><p>GPMå«ä¹‰</p><ul><li>Gï¼šgoåç¨‹Goroutine</li><li>Mï¼šå·¥ä½œçº¿ç¨‹ï¼ŒCPUæ•°é‡</li><li>Pï¼šå¤„ç†å™¨ï¼Œç”¨æ¥è°ƒåº¦Gï¼ŒMçš„å…³è”å…³ç³»ï¼ŒMæ‹¥æœ‰Pæ‰èƒ½æ‰§è¡ŒGçš„ä»£ç </li></ul></li><li><p>Goroutineçš„è°ƒåº¦ç­–ç•¥</p><ul><li>é˜Ÿåˆ—è½®è½¬ï¼šPå‘¨æœŸæ€§åœ°è°ƒåº¦Gåˆ°Mä¸­è¿è¡Œï¼Œä¸€æ®µæ—¶é—´åä¿å­˜ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆé˜Ÿåˆ—ï¼‰</li><li>ç³»ç»Ÿè°ƒç”¨ï¼šG0å³å°†è¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒM0é‡Šæ”¾Pï¼ŒæŸä¸ªM1è·å¾—Pè¿è¡Œå‰©ä¸‹çš„Gï¼ŒG0ç»“æŸåç­‰å¾…å…¶ä»–çš„Pè°ƒåº¦ï¼ˆæˆ–ç©ºé—²Pï¼‰ï¼Œæ­¤åè¿›å…¥ç¼“å­˜æ± ç¡çœ </li></ul></li></ul><h3 id="ChanåŸç†ï¼ˆchannelï¼‰"><a href="#ChanåŸç†ï¼ˆchannelï¼‰" class="headerlink" title="ChanåŸç†ï¼ˆchannelï¼‰"></a>ChanåŸç†ï¼ˆchannelï¼‰</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go">  <span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{</span> qcount   <span class="token builtin">uint</span>  <span class="token comment">// é˜Ÿåˆ—ä¸­çš„æ€»å…ƒç´ ä¸ªæ•°</span> dataqsiz <span class="token builtin">uint</span>  <span class="token comment">// ç¯å½¢é˜Ÿåˆ—å¤§å°ï¼Œå³å¯å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°</span> buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// ç¯å½¢é˜Ÿåˆ—æŒ‡é’ˆ</span> elemsize <span class="token builtin">uint16</span>  <span class="token comment">//æ¯ä¸ªå…ƒç´ çš„å¤§å°</span> closed   <span class="token builtin">uint32</span>  <span class="token comment">//æ ‡è¯†å…³é—­çŠ¶æ€</span> elemtype <span class="token operator">*</span>_type <span class="token comment">// å…ƒç´ ç±»å‹</span> sendx    <span class="token builtin">uint</span>   <span class="token comment">// å‘é€ç´¢å¼•ï¼Œå…ƒç´ å†™å…¥æ—¶å­˜æ”¾åˆ°é˜Ÿåˆ—ä¸­çš„ä½ç½®</span> recvx    <span class="token builtin">uint</span>   <span class="token comment">// æ¥æ”¶ç´¢å¼•ï¼Œå…ƒç´ ä»é˜Ÿåˆ—çš„è¯¥ä½ç½®è¯»å‡º</span> recvq    waitq  <span class="token comment">// ç­‰å¾…è¯»æ¶ˆæ¯çš„goroutineé˜Ÿåˆ—</span> sendq    waitq  <span class="token comment">// ç­‰å¾…å†™æ¶ˆæ¯çš„goroutineé˜Ÿåˆ—</span> lock mutex  <span class="token comment">//äº’æ–¥é”ï¼Œchanä¸å…è®¸å¹¶å‘è¯»å†™</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å†™æ•°æ®<ul><li>recvqä¸ä¸ºç©ºï¼Œç¼“å†²åŒºæ— æ•°æ®/æ— ç¼“å†²åŒºï¼Œåˆ™ç›´æ¥ä»recvqå–å‡ºGï¼Œå†™å…¥æ•°æ®ï¼Œå¹¶æŠŠGå”¤é†’</li><li>ç¼“å†²åŒºæœ‰ç©ºä½™ä½ç½®ï¼Œå†™å…¥ç¼“å†²åŒº</li><li>ç¼“å†²åŒºæ— ç©ºä½™ä½ç½®ï¼Œå°†æ•°æ®å†™å…¥Gï¼Œå°†å½“å‰GåŠ å…¥sendqï¼Œè¿›å…¥ç¡çœ è¢«å”¤é†’</li></ul></li><li>è¯»æ•°æ®<ul><li>sendqä¸ä¸ºç©ºï¼Œä¸”æ— ç¼“å†²åŒºï¼Œç›´æ¥ä»sendqå»é™¤Gï¼ŒæŠŠGæ•°æ®è¯»èµ°å¹¶å”¤é†’</li><li>sendqä¸ä¸ºç©ºï¼ˆç¼“å†²åŒºå·²æ»¡ï¼‰ï¼Œä»ç¼“å†²åŒºé¦–éƒ¨è¯»å‡ºæ•°æ®ï¼Œå°†Gä¸­çš„æ•°æ®å†™å…¥ç¼“å†²åŒºå°¾éƒ¨ï¼Œå”¤é†’G</li><li>ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œä»ç¼“å†²åŒºè¯»å–æ•°æ®</li><li>å°†å½“å‰GåŠ å…¥recvqè¿›å…¥ç¡çœ </li></ul></li><li>å…³é—­channel<ul><li>å”¤é†’recvqä¸­æ‰€æœ‰çš„Gï¼Œæœ¬è¯¥å†™å…¥æ•°æ®çš„å†…å®¹ä¸ºnilï¼Œsendqä¸­çš„Gå”¤é†’ï¼ˆä¼šå‡ºç°panicï¼‰</li><li>panicå‡ºç°çš„åœºæ™¯<ul><li>å…³é—­å€¼ä¸ºnilçš„channel</li><li>å…³é—­å·²ç»å…³é—­çš„channel</li><li>å‘å·²å…³é—­çš„channelå†™å…¥æ•°æ®</li></ul></li></ul></li></ul><p>æ— ç¼“å†²åŒºæƒ…å†µï¼šè¯»å’Œå†™åŒæ­¥ï¼ˆä¼šé˜»å¡ï¼‰</p><h3 id="contextä¸Šä¸‹æ–‡ç»“æ„"><a href="#contextä¸Šä¸‹æ–‡ç»“æ„" class="headerlink" title="contextä¸Šä¸‹æ–‡ç»“æ„"></a>contextä¸Šä¸‹æ–‡ç»“æ„</h3><p>å¹¶å‘å®‰å…¨ï¼Œæ ‘çŠ¶çš„goroutine</p><p>åªå®šä¹‰äº†æ¥å£</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"> <span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>   <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>   <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>   <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>deadlineï¼šåˆ°è¾¾ddlè‡ªåŠ¨å‘èµ·å–æ¶ˆè¯·æ±‚</li><li>Doneï¼šè¿”å›åªè¯»çš„channelï¼Œå¦‚æœå¯ä»¥è¯»å–è¯´æ˜å·²ç»å‘å‡ºå–æ¶ˆä¿¡å·ï¼Œå¯ä»¥æ¸…ç†å¹¶é‡Šæ”¾</li><li>errï¼šè¿”å›è¢«å–æ¶ˆçš„åŸå› </li><li>valueï¼šè·å–contextä¸Šç»‘å®šçš„å€¼ï¼Œkey-value</li></ul><h3 id="ç«æ€ä¸å†…å­˜é€ƒé€¸"><a href="#ç«æ€ä¸å†…å­˜é€ƒé€¸" class="headerlink" title="ç«æ€ä¸å†…å­˜é€ƒé€¸"></a>ç«æ€ä¸å†…å­˜é€ƒé€¸</h3><ul><li><p>ç«æ€ï¼šåœ¨ç¨‹åºä¸­ï¼ŒåŒä¸€ä¸ªå†…å­˜å—è¢«å¤šä¸ªgorountineè®¿é—®</p><ul><li>è§£å†³ï¼šå¯¹èµ„æºè¿›è¡ŒåŠ é”ï¼Œsync.Mutex,sync.RWMutex</li><li>æ£€æµ‹ï¼šæ·»åŠ <code>-race</code></li></ul></li><li><p>é€ƒé€¸åˆ†æï¼šå†…å­˜çš„åˆ†é…ä½ç½®ç”±ç¼–è¯‘å™¨å†³å®šï¼Œåˆ†é…é€Ÿåº¦æ…¢ä¸”ä¼šå½¢æˆå†…å­˜ç¢ç‰‡</p><p>ä»¥ä¸‹åœºæ™¯</p><ul><li>æŒ‡é’ˆé€ƒé€¸</li><li>æ ˆç©ºé—´ä¸è¶³é€ƒé€¸</li><li>åŠ¨æ€ç±»å‹é€ƒé€¸</li><li>é—­åŒ…å¼•ç”¨å¯¹è±¡é€ƒé€¸</li></ul></li></ul><h3 id="é›¶ç¢"><a href="#é›¶ç¢" class="headerlink" title="é›¶ç¢"></a>é›¶ç¢</h3><p><strong>å®‰å…¨è¯»å†™å…±äº«å˜é‡æ–¹å¼</strong></p><ul><li>Mutexé”</li><li>goroutineé€šè¿‡channel</li></ul><p><strong>newå’Œmakeçš„åŒºåˆ«</strong></p><ul><li>makeç”¨æ¥åˆ†é…å’Œåˆå§‹åŒ–ç±»å‹ä¸ºsliceï¼Œmapï¼Œchançš„æ•°æ®ï¼Œnewä»»æ„æ•°æ®å¹¶è¿”å›å†…å­˜æŒ‡é’ˆ</li><li>makeè¿”å›å¼•ç”¨ï¼Œå³typeï¼Œåˆ†é…ç©ºé—´åè¿›è¡Œåˆå§‹ï¼Œnewåˆ†é…çš„ç©ºé—´ä¼šè¢«æ¸…é›¶</li></ul><p><strong>å¯¹nilçš„sliceå’Œç©ºsilceçš„å¤„ç†åŒºåˆ«</strong></p><ul><li>slice:=make([]int,0)ï¼šç©ºsliceï¼Œä¸ä¸º0</li><li>slice:=[]int{} å€¼æ˜¯nilï¼Œä¿è¯è¿”å›sliceçš„å‡½æ•°å¼‚å¸¸æ—¶ä»å¯ä¿è¯è¿”å›nil</li></ul><p><strong>åç¨‹ï¼Œè¿›ç¨‹ï¼Œçº¿ç¨‹çš„åŒºåˆ«</strong></p><ul><li><p>è¿›ç¨‹: è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºï¼Œè¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…å’Œè°ƒåº¦çš„æœ€å°å•ä½ã€‚ æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹é€šè¿‡è¿›ç¨‹é—´é€šä¿¡æ¥é€šä¿¡ã€‚ç”±äºè¿›ç¨‹æ¯”è¾ƒé‡é‡ï¼Œå æ®ç‹¬ç«‹çš„å†…å­˜ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡è¿›ç¨‹é—´çš„åˆ‡æ¢å¼€é”€ï¼ˆæ ˆã€å¯„å­˜å™¨ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰æ¯”è¾ƒå¤§ï¼Œä½†ç›¸å¯¹æ¯”è¾ƒç¨³å®šå®‰å…¨ã€‚</p></li><li><p>çº¿ç¨‹: çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“,çº¿ç¨‹æ˜¯å†…æ ¸æ€,è€Œä¸”æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½,å®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½ã€‚çº¿ç¨‹é—´é€šä¿¡ä¸»è¦é€šè¿‡å…±äº«å†…å­˜ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¾ˆå¿«ï¼Œèµ„æºå¼€é”€è¾ƒå°‘ï¼Œä½†ç›¸æ¯”è¿›ç¨‹ä¸å¤Ÿç¨³å®šå®¹æ˜“ä¸¢å¤±æ•°æ®ã€‚</p></li><li><p>åç¨‹: åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨æ˜¯ç”±ç”¨æˆ·æ¥æ§åˆ¶çš„ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚ åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚</p></li></ul><p><strong>golangçš„å†…å­˜æ¨¡å‹ä¸­ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šåŠ å¤§GCå‹åŠ›</strong></p><ul><li><p>å°å¯¹è±¡è¿‡å¤šä¼šå¯¼è‡´GCä¸‰è‰²æ³•æ¶ˆè€—è¿‡å¤šCPU</p></li><li><p>è§£å†³æ€è·¯ï¼šå‡å°‘å¯¹è±¡åˆ†é…</p></li></ul><p><strong>channelä¸ºä»€ä¹ˆå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨</strong></p><ul><li>å…ˆè¿›å…ˆå‡ºï¼Œæœ¬èº«ç”¨æ¥åœ¨å¤šä»»åŠ¡é—´ä¼ é€’æ•°æ®ï¼Œé€šè¿‡é€šä¿¡å…±äº«å†…å­˜ï¼Œæœ‰å¤©ç„¶ä¼˜åŠ¿</li></ul><p><strong>GCè§¦å‘æ¡ä»¶</strong></p><ul><li>æ‰‹åŠ¨è§¦å‘ï¼ˆä¸»åŠ¨ï¼‰ï¼šè°ƒç”¨runtime.GCï¼Œé˜»å¡å¼</li><li>è¢«åŠ¨è§¦å‘ï¼š<ul><li>ç³»ç»Ÿç›‘æ§ï¼Œè¶…è¿‡ä¸¤åˆ†é’Ÿæ²¡æœ‰GCåˆ™è§¦å‘</li><li>pacingï¼ˆæ­¥è°ƒï¼‰ç®—æ³•ï¼Œæ§åˆ¶å†…å­˜å¢é•¿çš„æ¯”ä¾‹ï¼Œæ¯æ¬¡åˆ†é…å†…å­˜æ—¶æ£€æµ‹æ˜¯å¦ä»¥è¾¾åˆ°é˜ˆå€¼ï¼Œé»˜è®¤100%</li></ul></li></ul><p><strong>goroutineçš„æ•°é‡æŸ¥çœ‹å’Œé™åˆ¶</strong></p><ul><li>æŸ¥çœ‹ï¼š GOMAXPROCSæ§åˆ¶æœªè¢«é˜»å¡çš„æ‰€æœ‰goroutineï¼Œé€šè¿‡GOMAXPROCEå³å¯æŸ¥çœ‹</li><li>é™åˆ¶ï¼šä½¿ç”¨channelï¼Œæ¯æ¬¡æ‰§è¡Œgoroutineå‰å‘é€šé“å†™å…¥å€¼</li></ul><p><strong>Channelæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„</strong></p><p>â€‹    å¼‚æ­¥çš„</p><ul><li>channelçš„çŠ¶æ€ï¼š<ul><li>nilï¼Œåˆå§‹æˆ–æ‰‹åŠ¨èµ‹å€¼ï¼Œæ— æ³•å…³é—­ï¼ˆpanicï¼‰ï¼Œsend/recvè¢«æ°¸ä¹…é˜»å¡</li><li>closedï¼Œå…³é—­æˆ–sendä¼španicï¼Œrecvä¸ä¼šé˜»å¡</li><li>activeï¼Œå¯å…³é—­ï¼Œsend/recv</li></ul></li></ul><p><strong>goroutine å’Œçº¿ç¨‹çš„åŒºåˆ«</strong></p><ul><li>çº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªgoroutine</li><li>çº¿ç¨‹ï¼Œè¿›ç¨‹éƒ½æ˜¯åŒæ­¥çš„ï¼Œåç¨‹æ˜¯å¼‚æ­¥çš„</li><li>åç¨‹å¯ä»¥ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€</li><li>åç¨‹éœ€è¦çº¿ç¨‹æ¥æ‰¿è½½è¿è¡Œï¼Œä¸èƒ½ä»£æ›¿çº¿ç¨‹</li><li><strong>çº¿ç¨‹æ˜¯åˆ†å‰²çš„CPUèµ„æºï¼Œåç¨‹æ˜¯ç»„ç»‡å¥½çš„ä»£ç æµç¨‹</strong></li></ul><p><strong>structèƒ½ä¸èƒ½æ¯”è¾ƒ</strong></p><ul><li>ç›¸åŒstructç±»å‹å¯ä»¥</li><li>ä¸åŒstructä¸èƒ½æ¯”è¾ƒï¼Œç¼–è¯‘ä¸é€šè¿‡</li></ul><p><strong>goä¸»åç¨‹å¦‚ä½•ç­‰å¾…å…¶ä»–åç¨‹</strong></p><p>ç”¨sync.WaitGroupï¼Œå†…éƒ¨å®ç°è®¡æ•°å™¨è®¡æ•°æœªå®Œæˆçš„æ“ä½œä¸ªæ•°ï¼ŒAdd()æ·»åŠ è®¡æ•°ï¼ŒDone()è®¡æ•°å‡ä¸€ï¼ŒWait()ç­‰å¾…æ‰€æœ‰æ“ä½œç»“æŸï¼Œè®¡æ•°ä¸º0ï¼ˆç«‹å³è¿”å›ï¼‰</p><p><strong>sliceæ‰©å®¹</strong></p><p>appendè¿½åŠ å…ƒç´ ï¼Œç©ºé—´ä¸è¶³åˆ™æ‰©å®¹ï¼Œé‡æ–°åˆ†é…slice</p><p>æ‰©å®¹è§„åˆ™ï¼ˆåªå¯¹å®¹é‡ï¼‰</p><ul><li>å°äº1024ï¼šæ‰©å®¹æ—¶ç¿»å€ï¼Œè¶…è¿‡1024ï¼Œå¢é•¿å› å­å˜ä¸º1.25</li><li>å®¹é‡å¤Ÿç”¨åˆ™è¿½åŠ ï¼Œlen++</li><li>å®¹é‡ä¸å¤Ÿç”¨ï¼Œå…ˆæ‰©å®¹å†è¿½åŠ </li></ul><p><strong>mapé¡ºåºè¯»å–</strong></p><p>ï¼ˆä¸€èˆ¬æ˜¯éšæœºçš„ï¼‰</p><p>å…ˆæŠŠmapä¸­çš„keyç”¨sortæ’åºåæ ¹æ®keyè¯»å–</p><p><strong>å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…</strong></p><p>æ–¹æ³•çš„æ¥æ”¶è€…</p><ul><li>å€¼ç±»å‹ï¼šå¯ä»¥è°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•å’ŒæŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•</li><li>æŒ‡é’ˆç±»å‹ï¼šå¯ä»¥è°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•å’ŒæŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•</li></ul><p>æ¥å£å®ç°ä¸åŒï¼š</p><ul><li>å€¼ç±»å‹æ¥å£ï¼šç±»å‹æœ¬èº«å’Œè¯¥ç±»å‹çš„æŒ‡é’ˆç±»å‹éƒ½å®ç°äº†è¯¥æ¥å£</li><li>æŒ‡é’ˆç±»å‹æ¥å£ï¼šåªæœ‰å¯¹åº”çš„æŒ‡é’ˆç±»å‹æ‰è¢«è®¤ä¸ºå®ç°äº†æ¥å£</li></ul><p>é€šå¸¸ä½¿ç”¨æŒ‡é’ˆä½œä¸ºæ–¹æ³•çš„æ¥æ”¶è€…</p><ul><li>èƒ½å¤Ÿä¿®æ”¹æ¥æ”¶è€…æŒ‡å‘çš„å€¼</li><li>é¿å…æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ—¶å¤åˆ¶è¯¥å€¼ï¼Œæ›´é«˜æ•ˆ</li></ul><p><strong>å‘ç”Ÿå†…å­˜æ³„æ¼çš„åŸå› </strong></p><ul><li>goroutineéœ€è¦ç»´æŠ¤ç”¨æˆ·ä»£ç çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…å­˜æ¥ä¿å­˜æ­¤ç±»ä¿¡æ¯ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºä¸æ–­äº§ç”Ÿgoroutineï¼Œä¸ç»“æŸå·²åˆ›å»ºçš„goroutineå¹¶å¤ç”¨è¯¥éƒ¨åˆ†å†…å­˜ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼</li></ul><p>åç¨‹æ³„éœ²ï¼šï¼ˆæŸæ®µä»£ç å¡ä½ï¼Œé™·å…¥æ­»å¾ªç¯ç­‰ï¼‰åº”è¯¥è¢«é‡Šæ”¾çš„åç¨‹æ²¡æœ‰è¢«æ­£ç¡®é‡Šæ”¾</p><p><strong>å¦‚ä½•æ£€æµ‹å†…å­˜æ³„æ¼</strong></p><p>è‡ªå¸¦çš„å·¥å…·ï¼špprofï¼Œæˆ–è€…ç”¨Gopsæ£€æµ‹å½“å‰è¿è¡Œçš„goç¨‹å ç”¨çš„èµ„æº</p><p><strong>ä¸¤ä¸ªnilå¯èƒ½ä¸ç›¸ç­‰</strong></p><p>æ¥å£interfaceæ˜¯å¯¹æ¥å£å€¼çš„å°è£…ï¼Œå†…éƒ¨åŒ…å«ç±»å‹Tå’Œå€¼Vï¼Œä¸€ä¸ªæ¥å£ä¸ºnilå½“ä¸”ä»…å½“T=nilï¼ŒV=unset</p><p>ä¸¤ä¸ªæ¥å£æ¯”è¾ƒæ—¶ï¼Œå…ˆæ¯”è¾ƒTå†æ¯”è¾ƒV(æ¥å£å€¼å’Œéæ¥å£å€¼è¿›è¡Œæ¯”è¾ƒä¼šå°†éæ¥å£å€¼è½¬åŒ–ä¸ºæ¥å£å€¼)</p><p>ä¾‹å¦‚<code>var p *int =nil</code>è½¬åŒ–ä¸ºæ¥å£å€¼T=*intï¼Œæ˜¾ç„¶å’Œå€¼ä¸ºnilçš„æ¥å£ä¸ç›¸ç­‰</p><p><strong>å‡½æ•°ä¼ å‚æ˜¯å€¼ç±»å‹è¿˜æ˜¯å¼•ç”¨ç±»å‹</strong></p><p>åªå­˜åœ¨å€¼ä¼ é€’ï¼ˆå€¼æˆ–æŒ‡é’ˆçš„å‰¯æœ¬ï¼‰ï¼Œéƒ½ä¼šå¼€è¾Ÿæ–°çš„ç©ºé—´</p><p>ä¸è¦æ··æ·†å€¼ä¼ é€’ï¼Œå¼•ç”¨ä¼ é€’å’Œå€¼ç±»å‹ï¼Œå¼•ç”¨ç±»å‹</p><p><strong>å†…å­˜å¯¹é½</strong></p><p>CPUéƒ½æ˜¯ä»¥å­—é•¿è®¿é—®çš„ï¼ˆ32ä½ï¼Œ64ä½ï¼‰ï¼Œä¸è¿›è¡Œå†…å­˜å¯¹é½ä¼šå¢åŠ CPUè®¿é—®å†…å­˜çš„æ¬¡æ•°ï¼Œå†…å­˜å¯¹é½å¯¹å®ç°å˜é‡çš„åŸå­æ€§æ“ä½œæœ‰å¥½å¤„ï¼ˆå¹¶å‘åœºæ™¯ä¸‹ï¼‰</p><p><strong>ä¸¤ä¸ªinterfaceçš„æ¯”è¾ƒ</strong></p><ul><li>åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸€æ ·ï¼š<code>reflect.TypeOf(a).Kind()</code></li><li>åˆ¤æ–­æ¥å£æ˜¯å¦ç›¸ç­‰ï¼š<code>reflect.DeepEqual(a,b,interface{})</code></li><li>å°†interfaceèµ‹å€¼ç»™å¦ä¸€ä¸ªï¼š<code>reflect.ValueOf(a).Elem().Set(reflect.ValueOf(b))</code></li></ul><p><strong>æ‰“å°<code>%v</code>,<code>%+v</code>,<code>%#v</code>çš„åŒºåˆ«</strong></p><p>(è¾“å‡ºstructä¸­çš„å…ƒç´ )</p><ul><li>%vè¾“å‡ºæ‰€æœ‰çš„å€¼</li><li>%+vå…ˆè¾“å‡ºå­—æ®µåå­—ï¼Œå†è¾“å‡ºè¯¥å­—æ®µçš„å€¼ï¼ˆname:valueï¼‰</li><li>%#vå…ˆè¾“å‡ºç»“æ„ä½“åå­—ï¼Œå†è¾“å‡ºç»“æ„ä½“ï¼ˆname:valueï¼‰</li></ul><p><strong>runeç±»å‹</strong></p><p>goçš„å­—ç¬¦æœ‰ä»¥ä¸‹ä¸¤ç§</p><ul><li>uint8ï¼ˆbyteï¼‰ï¼Œè¡¨ç¤ºASCIIçš„å­—ç¬¦</li><li>runeç±»å‹ï¼Œè¡¨ç¤ºUTF-8å­—ç¬¦ï¼Œç­‰ä»·äºint32</li></ul><p>stringåº•å±‚é€šè¿‡byteæ•°ç»„å®ç°ï¼Œå¯¹stringæ±‚lenè®¡ç®—äº†å­—èŠ‚é•¿åº¦</p><p>[]rune(str)  :stringè½¬åŒ–ä¸ºruneç±»å‹ï¼Œç»Ÿè®¡é•¿åº¦ç¤ºä¾‹ï¼š</p><ul><li>â€œhello ä½ å¥½â€ string length=12(æ±‰å­—3ä¸ª),rune length=8</li></ul><p><strong>ç©ºstruct{}å ç”¨çš„ç©ºé—´</strong></p><p>ä½¿ç”¨unsafe.Sizeof(struct{})=0ï¼Œä¸å ç”¨ä»»ä½•å†…å­˜ç©ºé—´</p><p><strong>ç©ºstructçš„ç”¨é€”</strong></p><p>ä¼˜ç‚¹ï¼šä¸å å†…å­˜ç©ºé—´ï¼Œé€šå¸¸è¢«å½“ä½œå ä½ç¬¦</p><ul><li>mapä½œä¸ºé›†åˆä½¿ç”¨ï¼ˆ<code>type set map[string]struct{}</code>)</li><li>ä¸å‘é€æ•°æ®çš„channelï¼Œåªæ˜¯é€šçŸ¥å­åç¨‹æ‰§è¡Œä»»åŠ¡æˆ–æ§åˆ¶åç¨‹å¹¶å‘ï¼ˆ<code>make(chan struct{})</code>ï¼‰</li><li>æœ‰å¯èƒ½ç»“æ„ä½“ä¸­åªåŒ…å«æ–¹æ³•ï¼Œä¸å«ä»»ä½•å­—æ®µ</li></ul><p><strong>å˜é‡çš„åˆ†é…ä½ç½®åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Š</strong></p><p>ç”±ç¼–è¯‘å™¨å†³å®šï¼Œå¦‚æœæ— æ³•åˆ¤æ–­å˜é‡ä½œç”¨åŸŸå’Œå¤§å°ï¼Œé€šå¸¸ä¼šåˆ†é…åˆ°å †ä¸Šï¼ˆå †ä¸Šçš„å˜é‡åœ¨å‡½æ•°å‡ºæ ˆè‡ªè¡Œé‡Šæ”¾ï¼Œæ— éœ€gcï¼‰</p><p><strong>selectæ‰§è¡Œ</strong></p><p>selectï¼šå¤šä¸ªå¯ç”¨æ“ä½œï¼šéšæœºé€‰ä¸€ä¸ª</p><ul><li>select ä¸­åªè¦æœ‰ä¸€ä¸ª case èƒ½ returnï¼Œåˆ™ç«‹åˆ»æ‰§è¡Œ</li><li>å½“å¦‚æœåŒä¸€æ—¶é—´æœ‰å¤šä¸ª case å‡èƒ½ return åˆ™ä¼ªéšæœºæ–¹å¼æŠ½å–ä»»æ„ä¸€ä¸ªæ‰§è¡Œ</li><li>å¦‚æœæ²¡æœ‰ä¸€ä¸ª case èƒ½ return åˆ™å¯ä»¥æ‰§è¡Œâ€defaultâ€ å—</li></ul><p><strong>arrayå’Œsliceçš„åŒºåˆ«</strong></p><ul><li>arrayï¼šå›ºå®šé•¿åº¦ï¼Œ<em>é•¿åº¦æ˜¯æ•°ç»„ç±»å‹çš„ä¸€éƒ¨åˆ†</em>ï¼Œéœ€æŒ‡å®šå¤§å°æˆ–æ ¹æ®åˆå§‹åŒ–å€¼ç¡®å®š</li><li>sliceï¼šå¯å˜é•¿åº¦ï¼Œä¸‰ä¸ªå±æ€§ï¼š<em>æŒ‡é’ˆï¼Œé•¿åº¦ï¼Œå®¹é‡</em>ï¼Œé€šè¿‡makeåˆå§‹åŒ–ï¼Œå¯ä»¥æ‰©å®¹</li></ul><p><strong>deferçš„ä½œç”¨</strong></p><p>åœ¨<strong>è°ƒç”¨</strong>æ™®é€šå‡½æ•°æˆ–æ–¹æ³•å‰åŠ ä¸Šå…³é”®è¯deferå³å¯ã€‚deferè¢«æ‰§è¡Œæ—¶ï¼Œdeferåé¢çš„å‡½æ•°è¢«å»¶è¿Ÿæ‰§è¡Œï¼Œç›´åˆ°åŒ…å«è¯¥deferè¯­å¥çš„å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼ˆä¸ç®¡returnç»“æŸè¿˜æ˜¯panicç»“æŸï¼‰ï¼Œå³ä¸ºåœ¨å‡½æ•°è¿”å›ä¹‹å‰è°ƒç”¨ï¼Œ<strong>deferæ˜¯åœ¨returnä¹‹å‰å®Œæˆçš„</strong>ã€‚</p><p>å¸¸è¢«ç”¨äºå¤„ç†æˆå¯¹çš„æ“ä½œï¼Œä¿è¯èµ„æºèƒ½è¢«é‡Šæ”¾ç­‰ï¼ˆæ‰“å¼€/å…³é—­ï¼Œè¿æ¥/æ–­å¼€ï¼ŒåŠ é”/é‡Šæ”¾é”ï¼‰</p><p>é‡Šæ”¾èµ„æºçš„deferè·Ÿåœ¨è¯·æ±‚èµ„æºçš„è¯­å¥å</p><p>æœ€åé¢çš„deferæœ€å…ˆè¢«è°ƒç”¨ï¼ˆç±»ä¼¼äºæ ˆï¼‰</p><p><em>return xxxå¹¶ä¸æ˜¯ä¸€æ¡åŸå­è¯­å¥</em>ï¼šå…ˆç»™è¿”å›å€¼èµ‹å€¼ï¼Œå†è°ƒç”¨deferè¯­å¥ï¼Œä¾‹å¦‚ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     t <span class="token operator">:=</span> <span class="token number">5</span>     <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">5</span>     <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token keyword">return</span> t<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿”å›å€¼ä¸º5</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">defer_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"æ‰“å°å‰"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"æ‰“å°ä¸­"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"æ‰“å°å"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"è§¦å‘å¼‚å¸¸"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœ</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">æ‰“å°åæ‰“å°ä¸­æ‰“å°å‰panic:è§¦å‘å¼‚å¸¸<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>goå…³é”®å­—</strong></p><p><code>go func(x,y,z)</code>åªæœ‰fun(x,y,z)åœ¨æ–°çš„goroutineä¸­è¿è¡Œï¼Œå‚æ•°çš„è®¡ç®—åœ¨åŸgoroutineä¸­å®Œæˆã€‚</p><p><strong>varå’Œ:=å®šä¹‰å˜é‡çš„åŒºåˆ«</strong></p><p><code>:=</code>åªèƒ½åœ¨å£°æ˜å±€éƒ¨å˜é‡ä½¿ç”¨ï¼Œ<code>var</code>æ— é™åˆ¶</p><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> student <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Name <span class="token builtin">string</span>    Age  <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">pase_student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>student<span class="token punctuation">)</span>    stus <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>student<span class="token punctuation">{</span>        <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"zhou"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"li"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"wang"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> stu <span class="token operator">:=</span> <span class="token keyword">range</span> stus <span class="token punctuation">{</span>        m<span class="token punctuation">[</span>stu<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>stu    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é”™è¯¯ï¼š<code>for _, stu := range stus {m[stu.Name] = &amp;stu}</code>ä¸€å¥ä¸­ï¼Œstuå®é™…ä¸Šæ˜¯å‰¯æœ¬ï¼Œæ‰€ä»¥æ­¤å¤„è¿”å›çš„å‡ä¸ºåŒä¸€ä¸ªåœ°å€ã€‚</p><p>ä¿®æ”¹ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>stus<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span>  <span class="token punctuation">{</span>       m<span class="token punctuation">[</span>stus<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>stus<span class="token punctuation">[</span>i<span class="token punctuation">]</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A: "</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>            wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B: "</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>            wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœ <code>A:</code>å‡ä¸ºè¾“å‡º 10ï¼Œ<code>B:</code>ä» 0~9 è¾“å‡º (é¡ºåºä¸å®š)</p><p><strong>deferå¤šå±‚åµŒå¥—</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>       <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"E"</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"F"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœè¾“å‡ºé¡ºåºï¼šAFEDBC</p><pre class="line-numbers language-GO" data-language="GO"><code class="language-GO">func main() {    for i:=0; i&lt;5; i++ {        defer func() {           fmt.Println(i)         }()    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºï¼š5 5 5 5 5</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºï¼š4 3 2 1 0</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">calc</span><span class="token punctuation">(</span>index <span class="token builtin">string</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>    ret <span class="token operator">:=</span> a <span class="token operator">+</span> b    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> ret<span class="token punctuation">)</span>    <span class="token keyword">return</span> ret<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">:=</span> <span class="token number">1</span>    b <span class="token operator">:=</span> <span class="token number">2</span>    <span class="token keyword">defer</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>    a <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">defer</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">"20"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>    b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡º</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">10 1 2 320 0 2 22 0 2 21 1 3 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;golang&quot;&gt;&lt;a href=&quot;#golang&quot; class=&quot;headerlink&quot; title=&quot;golang&quot;&gt;&lt;/a&gt;golang&lt;/h2&gt;&lt;h3 id=&quot;map&quot;&gt;&lt;a href=&quot;#map&quot; class=&quot;headerlink&quot; title=&quot;map</summary>
      
    
    
    
    <category term="Golang" scheme="http://sn1987a-1.github.io/categories/Golang/"/>
    
    
    <category term="Go" scheme="http://sn1987a-1.github.io/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>AI algorithms</title>
    <link href="http://sn1987a-1.github.io/posts/e95a583.html"/>
    <id>http://sn1987a-1.github.io/posts/e95a583.html</id>
    <published>2023-06-30T12:48:34.000Z</published>
    <updated>2023-09-24T03:27:01.940Z</updated>
    
    <content type="html"><![CDATA[<p>è´å¶æ–¯ç½‘ç»œï¼Œk-means å’Œtransformer</p><h2 id="PART1"><a href="#PART1" class="headerlink" title="PART1"></a>PART1</h2><h3 id="æ‰‹å†™æ•°å­—è¯†åˆ«"><a href="#æ‰‹å†™æ•°å­—è¯†åˆ«" class="headerlink" title="æ‰‹å†™æ•°å­—è¯†åˆ«"></a>æ‰‹å†™æ•°å­—è¯†åˆ«</h3><p>æœ¬éƒ¨åˆ†é€šè¿‡è´å¶æ–¯ç½‘ç»œå®ç°æ‰‹å†™æ•°å­—çš„è¯†åˆ«</p><h4 id="å®éªŒå†…å®¹"><a href="#å®éªŒå†…å®¹" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h4><ul><li><p>fitå‡½æ•°</p><p>Pixelsä¸­æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå›¾åƒï¼Œæ¯ä¸€åˆ—ä»£è¡¨ä¸€ä¸ªåƒç´ å€¼ã€‚Labelsæ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸ºï¼ˆn_samples,ï¼‰çš„å‘é‡ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç›¸åº”å›¾åƒçš„ç±»æ ‡ç­¾ã€‚</p><p>è¯¥æ–¹æ³•é€šè¿‡è®¡ç®—æ¯ä¸ªç±»åˆ«çš„å…ˆéªŒæ¦‚ç‡å’Œç»™å®šæ¯ä¸ªç±»åˆ«çš„æ¯ä¸ªåƒç´ å€¼çš„æ¡ä»¶æ¦‚ç‡ï¼Œå°†æ¨¡å‹ä¸æ•°æ®æ‹Ÿåˆã€‚å®ƒä½¿ç”¨ç±»çš„ä¸¤ä¸ªå±æ€§ï¼šself.labels_prior å’Œ self.pixels_cond_labelã€‚å‰è€…æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º(n_classes,)çš„å‘é‡ï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªç±»åˆ«çš„å…ˆéªŒæ¦‚ç‡ã€‚åè€…æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸ºï¼ˆn_pixels, n_values, n_classesï¼‰çš„çŸ©é˜µï¼Œå­˜å‚¨äº†ç»™å®šæ¯ä¸ªç±»åˆ«çš„æ¯ä¸ªåƒç´ å€¼çš„æ¡ä»¶æ¦‚ç‡ã€‚è¯¥æ–¹æ³•é€šè¿‡è®¡ç®—æ•°æ®ä¸­æ¯ä¸ªç±»åˆ«å’Œæ¯ä¸ªåƒç´ å€¼çš„é¢‘ç‡å¹¶é™¤ä»¥é€‚å½“çš„åˆ†æ¯æ¥æ›´æ–°è¿™äº›å±æ€§ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pixels<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>    n_samples <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>    <span class="token keyword">for</span> label <span class="token keyword">in</span> labels<span class="token punctuation">:</span>        self<span class="token punctuation">.</span>labels_prior<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>        self<span class="token punctuation">.</span>labels_prior <span class="token operator">/=</span> n_samples        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span><span class="token punctuation">:</span>            pixel_values <span class="token operator">=</span> pixels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            label <span class="token operator">=</span> labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            <span class="token keyword">for</span> pixel <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_pixels<span class="token punctuation">)</span><span class="token punctuation">:</span>                self<span class="token punctuation">.</span>pixels_cond_label<span class="token punctuation">[</span>pixel<span class="token punctuation">]</span><span class="token punctuation">[</span>pixel_values<span class="token punctuation">[</span>pixel<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>                <span class="token keyword">for</span> pixel <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_pixels<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> value <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_values<span class="token punctuation">)</span><span class="token punctuation">:</span>                        self<span class="token punctuation">.</span>pixels_cond_label<span class="token punctuation">[</span>pixel<span class="token punctuation">]</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">/=</span> self<span class="token punctuation">.</span>labels_prior<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>predictå‡½æ•°</p><p>è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå½¢çŠ¶ä¸ºï¼ˆn_samples,ï¼‰çš„å‘é‡ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç›¸åº”å›¾åƒçš„é¢„æµ‹ç±»åˆ«æ ‡ç­¾ã€‚é€šè¿‡æ‰¾åˆ°åéªŒæ¦‚ç‡æœ€å¤§çš„ç±»åˆ«æ¥è·å¾—é¢„æµ‹ç»“æœã€‚é€šè¿‡æ‹Ÿåˆæ–¹æ³•è®¡ç®—self.labels_priorå’Œself.pixels_cond_labelå±æ€§ã€‚è¯¥æ–¹æ³•å¯¹æ¯å¹…å›¾åƒå’Œæ¯ä¸ªç±»åˆ«è¿›è¡Œå¾ªç¯ï¼Œå¹¶é€šè¿‡å°†å…ˆéªŒæ¦‚ç‡çš„å¯¹æ•°ä¸ç»™å®šç±»åˆ«çš„æ¯ä¸ªåƒç´ å€¼çš„æ¡ä»¶æ¦‚ç‡çš„å¯¹æ•°ç›¸åŠ æ¥è®¡ç®—åéªŒæ¦‚ç‡ã€‚ç„¶åå°†åéªŒæ¦‚ç‡ä¸å½“å‰æœ€å¤§å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåéªŒæ¦‚ç‡å¤§äºå½“å‰æœ€å¤§å€¼ï¼Œåˆ™æ›´æ–°é¢„æµ‹æ ‡ç­¾ã€‚ç„¶åå°†é¢„æµ‹æ ‡ç­¾åˆ†é…ç»™è¾“å‡ºå‘é‡ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pixels<span class="token punctuation">)</span><span class="token punctuation">:</span>      n_samples <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pixels<span class="token punctuation">)</span>      labels <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span>      <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span><span class="token punctuation">:</span>          pixel_values <span class="token operator">=</span> pixels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>          max_posterior <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">"-inf"</span><span class="token punctuation">)</span>          predicted_label <span class="token operator">=</span> <span class="token boolean">None</span>          <span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_labels<span class="token punctuation">)</span><span class="token punctuation">:</span>              posterior <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>labels_prior<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token keyword">for</span> pixel <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_pixels<span class="token punctuation">)</span><span class="token punctuation">:</span>                  posterior <span class="token operator">+=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pixels_cond_label<span class="token punctuation">[</span>pixel<span class="token punctuation">]</span><span class="token punctuation">[</span>pixel_values<span class="token punctuation">[</span>pixel<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token keyword">if</span> posterior <span class="token operator">&gt;</span> max_posterior<span class="token punctuation">:</span>                  max_posterior <span class="token operator">=</span> posterior                  predicted_label <span class="token operator">=</span> label          labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> predicted_label      <span class="token keyword">return</span> labels<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å›¾ç‰‡å‹ç¼©"><a href="#å›¾ç‰‡å‹ç¼©" class="headerlink" title="å›¾ç‰‡å‹ç¼©"></a>å›¾ç‰‡å‹ç¼©</h3><p>æœ¬éƒ¨åˆ†ä½¿ç”¨k-meanså®ç°å›¾ç‰‡å‹ç¼©ï¼Œå¹¶åœ¨ä¸åŒçš„å‚æ•°ä¸‹å®ç°ä¸åŒçš„å‹ç¼©æ•ˆæœã€‚</p><h4 id="å®éªŒåŸç†"><a href="#å®éªŒåŸç†" class="headerlink" title="å®éªŒåŸç†"></a>å®éªŒåŸç†</h4><p>å›¾ç‰‡å‹ç¼©çš„åŸç†æ˜¯å°†å›¾ç‰‡ä¸­çš„åƒç´ åˆ†æˆå‡ ä¸ªç±»åˆ«ï¼Œæ¯ä¸ªç±»åˆ«ç”¨ä¸€ä¸ªä»£è¡¨é¢œè‰²æ¥è¡¨ç¤ºï¼Œä»è€Œå‡å°‘å›¾ç‰‡ä¸­çš„é¢œè‰²æ•°ç›®ï¼Œé™ä½æ–‡ä»¶å¤§å°ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨RGBé¢œè‰²ç©ºé—´è¡¨ç¤ºå›¾åƒçš„é¢œè‰²ï¼Œå°†å›¾ç‰‡å±•å¹³ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªåƒç´ ï¼Œæ¯ä¸€åˆ—ä»£è¡¨ä¸€ä¸ªé¢œè‰²é€šé“ã€‚</li><li>å¯¹å±•å¹³çš„å›¾ç‰‡æ•°ç»„åº”ç”¨K-meansèšç±»ç®—æ³•ï¼ŒKä»£è¡¨å‹ç¼©åçš„å›¾ç‰‡ä¸­æƒ³è¦çš„é¢œè‰²æ•°ç›®ã€‚ç®—æ³•ä¼šæ ¹æ®åƒç´ çš„RGBå€¼å°†ç›¸ä¼¼çš„åƒç´ åˆ†åˆ°ä¸€èµ·ï¼Œå¹¶ç»™æ¯ä¸ªç±»åˆ«åˆ†é…ä¸€ä¸ªå¹³å‡çš„RGBå€¼ã€‚å…¶ä¸­Kçš„å€¼å†³å®šäº†å‹ç¼©çš„ç¨‹åº¦ã€‚</li><li>å°†åŸå§‹å›¾ç‰‡ä¸­çš„æ¯ä¸ªåƒç´ æ›¿æ¢ä¸ºå…¶æ‰€å±ç±»åˆ«çš„å¹³å‡RGBå€¼ã€‚è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªé¢œè‰²æ•°ç›®æ›´å°‘ï¼Œä½†æ˜¯å¤–è§‚ç›¸ä¼¼çš„å›¾ç‰‡ã€‚</li></ul><h4 id="å®éªŒå†…å®¹-1"><a href="#å®éªŒå†…å®¹-1" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h4><ul><li><p>assign_pointså‡½æ•°</p><p>ä¸»è¦æµç¨‹ï¼š</p><ul><li>éå†æ¯ä¸ªæ ·æœ¬ç‚¹ï¼Œè®¡ç®—å®ƒä¸æ¯ä¸ªèšç±»ä¸­å¿ƒçš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œä½¿ç”¨np.linalg.normå‡½æ•°ã€‚</li><li>æ‰¾å‡ºè·ç¦»æœ€å°çš„èšç±»ä¸­å¿ƒçš„ç´¢å¼•ï¼Œä½¿ç”¨np.argminå‡½æ•°ï¼Œå°†å…¶ä½œä¸ºè¯¥æ ·æœ¬ç‚¹çš„èšç±»æ ‡ç­¾ï¼Œå­˜å…¥labelsæ•°ç»„ä¸­ã€‚</li><li>æœ€åæ›´æ–°labelsæ•°ç»„ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">assign_points</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> centers<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>        n_samples<span class="token punctuation">,</span> n_dims <span class="token operator">=</span> points<span class="token punctuation">.</span>shape        labels <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_samples<span class="token punctuation">)</span><span class="token punctuation">:</span>            distances <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> centers<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>            labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>distances<span class="token punctuation">)</span>        <span class="token keyword">return</span> labels<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>uptdate_centerså‡½æ•°</p><p>ä¸»è¦æµç¨‹</p><ul><li>éå†æ¯ä¸ªèšç±»ä¸­å¿ƒï¼Œæ‰¾å‡ºæ‰€æœ‰å±äºè¯¥èšç±»çš„æ ·æœ¬ç‚¹ã€‚</li><li>å¦‚æœè¯¥èšç±»æœ‰æ ·æœ¬ç‚¹ï¼Œåˆ™è®¡ç®—è¿™äº›æ ·æœ¬ç‚¹åœ¨æ¯ä¸ªç»´åº¦ä¸Šçš„å¹³å‡å€¼ä½œä¸ºæ–°çš„èšç±»ä¸­å¿ƒã€‚</li><li>å¦‚æœè¯¥èšç±»æ²¡æœ‰æ ·æœ¬ç‚¹ï¼Œåˆ™ä¿æŒåŸæ¥çš„èšç±»ä¸­å¿ƒä¸å˜ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">update_centers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> centers<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>            cluster_points <span class="token operator">=</span> points<span class="token punctuation">[</span>labels <span class="token operator">==</span> k<span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cluster_points<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>                centers<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> cluster_points<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> centers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>fitå‡½æ•°</p><p>ä¸»è¦æµç¨‹ï¼š</p><ul><li>è°ƒç”¨initialize_centersæ–¹æ³•ï¼Œéšæœºåˆå§‹åŒ–èšç±»ä¸­å¿ƒcentersã€‚</li><li>è¿›è¡Œmax_iteræ¬¡å¾ªç¯<ul><li>è°ƒç”¨assign_pointsæ–¹æ³•ï¼Œæ ¹æ®å½“å‰çš„èšç±»ä¸­å¿ƒcentersï¼Œå°†æ¯ä¸ªæ ·æœ¬ç‚¹åˆ†é…åˆ°æœ€è¿‘çš„èšç±»ä¸­ï¼Œå¾—åˆ°æ¯ä¸ªæ ·æœ¬ç‚¹çš„èšç±»æ ‡ç­¾labelsã€‚</li><li>è°ƒç”¨update_centersæ–¹æ³•ï¼Œæ ¹æ®æ–°çš„ç‚¹åˆ†é…labelsï¼Œæ›´æ–°èšç±»ä¸­å¿ƒcentersã€‚</li></ul></li><li>è¿”å›æœ€ç»ˆçš„èšç±»ä¸­å¿ƒcentersã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>        centers <span class="token operator">=</span> self<span class="token punctuation">.</span>initialize_centers<span class="token punctuation">(</span>points<span class="token punctuation">)</span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>            labels <span class="token operator">=</span> self<span class="token punctuation">.</span>assign_points<span class="token punctuation">(</span>centers<span class="token punctuation">,</span> points<span class="token punctuation">)</span>            centers <span class="token operator">=</span> self<span class="token punctuation">.</span>update_centers<span class="token punctuation">(</span>centers<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> points<span class="token punctuation">)</span>        <span class="token keyword">return</span> centers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>compresså‡½æ•°</p><p>ä¸»è¦æµç¨‹</p><ul><li>å°†å›¾ç‰‡çš„åƒç´ å€¼å±•å¹³ä¸ºä¸€ä¸ªRGBäºŒç»´æ•°ç»„ã€‚</li><li>è°ƒç”¨fitæ–¹æ³•ï¼Œå¯¹å±•å¹³çš„åƒç´ ç‚¹è¿›è¡ŒK-meansèšç±»ï¼Œå¾—åˆ°èšç±»ä¸­å¿ƒcentersã€‚</li><li>å¯¹äºæ¯ä¸ªåƒç´ ç‚¹ï¼Œè®¡ç®—å®ƒä¸æ¯ä¸ªèšç±»ä¸­å¿ƒçš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œæ‰¾å‡ºè·ç¦»æœ€å°çš„èšç±»ä¸­å¿ƒçš„ç´¢å¼•ã€‚</li><li>ç”¨è·ç¦»æœ€å°çš„èšç±»ä¸­å¿ƒçš„é¢œè‰²å€¼æ›¿æ¢åŸæ¥çš„åƒç´ å€¼ï¼Œå¾—åˆ°å‹ç¼©åçš„åƒç´ ç‚¹ã€‚</li><li>åƒç´ ç‚¹é‡å¡‘ä¸ºåŸæ¥çš„å›¾ç‰‡å½¢çŠ¶ï¼Œå¾—åˆ°å‹ç¼©åçš„å›¾ç‰‡ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">compress</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>        points <span class="token operator">=</span> img<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        centers <span class="token operator">=</span> self<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>points<span class="token punctuation">)</span>        compressed_img <span class="token operator">=</span> centers<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token operator">-</span> centers<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        compressed_img <span class="token operator">=</span> compressed_img<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        <span class="token keyword">return</span> compressed_img<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="PART-2"><a href="#PART-2" class="headerlink" title="PART 2"></a>PART 2</h2><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3><h4 id="å®éªŒå†…å®¹-2"><a href="#å®éªŒå†…å®¹-2" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h4><h5 id="char-tokenizer"><a href="#char-tokenizer" class="headerlink" title="char_tokenizer"></a>char_tokenizer</h5><p>å®ç°äº†ä¸€ä¸ªåŸºäºå­—ç¬¦çš„åˆ†è¯å™¨ã€‚å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•°åˆ—è¡¨ï¼Œæˆ–è€…å°†ä¸€ä¸ªæ•´æ•°åˆ—è¡¨è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p><p>å…·ä½“åŠŸèƒ½åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p><ul><li><p>åˆå§‹åŒ–__init__ï¼Œè®¡ç®—è¯­æ–™åº“ä¸­çš„ä¸åŒå­—ç¬¦çš„ä¸ªæ•°ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå­—å…¸ï¼Œå°†æ¯ä¸ªå­—ç¬¦æ˜ å°„åˆ°ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> corpus<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>corpus <span class="token operator">=</span> corpus        self<span class="token punctuation">.</span>vocab <span class="token operator">=</span> <span class="token punctuation">{</span>char<span class="token punctuation">:</span> i <span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>        self<span class="token punctuation">.</span>n_vocab <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><ul><li><p>ç¼–ç encodeï¼Œç¼–ç æ–‡æœ¬ï¼Œå°†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦æ›¿æ¢ä¸ºå­—å…¸ä¸­å¯¹åº”çš„æ•´æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ•´æ•°åˆ—è¡¨ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> string<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        encode_res<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> string<span class="token punctuation">]</span>        <span class="token keyword">return</span> encode_res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><ul><li><p>è§£ç decodeï¼Œè§£ç ç¼–ç ã€‚å°†æ•´æ•°åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ•´æ•°æ›¿æ¢ä¸ºå­—å…¸ä¸­å¯¹åº”çš„å­—ç¬¦ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> codes<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        decode_res<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> codes<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> decode_res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h5 id="Head"><a href="#Head" class="headerlink" title="Head"></a>Head</h5><p>è‡ªæ³¨æ„åŠ›æ˜¯ä¸€ç§ç”¨äºæ•æ‰åºåˆ—ä¸­çš„é•¿è·ç¦»ä¾èµ–å…³ç³»çš„æœºåˆ¶ï¼Œå®ƒé€šè¿‡è®¡ç®—åºåˆ—ä¸­æ¯ä¸ªå…ƒç´ ä¸å…¶ä»–å…ƒç´ çš„ç›¸å…³æ€§æ¥ç”Ÿæˆä¸€ä¸ªåŠ æƒå¹³å‡çš„è¾“å‡ºã€‚æœ¬éƒ¨åˆ†å®ç°äº†ä¸€ä¸ªæ³¨æ„åŠ›å•å¤´ã€‚</p><p>å…·ä½“åŠŸèƒ½åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p><ul><li><p>init</p><p>åˆ›å»ºä¸‰ä¸ªçº¿æ€§å±‚ï¼Œåˆ†åˆ«ç§°ä¸ºKeyï¼ŒQueryå’ŒValueï¼Œå®ƒä»¬éƒ½å°†è¾“å…¥ç»´åº¦n_embdæ˜ å°„åˆ°è¾“å‡ºç»´åº¦head_sizeã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> head_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>Key <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> head_size<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>Query <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> head_size<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>Value <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> head_size<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>head_size <span class="token operator">=</span> head_size    self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">"tril"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tril<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>block_size<span class="token punctuation">,</span> block_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>forwardå‡½æ•°</p><ul><li>è°ƒç”¨Keyï¼ŒQueryå’ŒValueå¯¹inputsè¿›è¡Œçº¿æ€§å˜æ¢ã€‚</li><li>è®¡ç®—queryå’Œkeyå¼ é‡çš„ç‚¹ç§¯ï¼Œå¹¶åœ¨æœ€åä¸¤ä¸ªç»´åº¦ä¸Šè½¬ç½®keyå¼ é‡ï¼Œå¾—åˆ°scoreså¼ é‡ã€‚</li><li>å¯¹scoreså¼ é‡è¿›è¡Œæ©ç æ“ä½œï¼Œå°†å…¶ä¸Šä¸‰è§’éƒ¨åˆ†ï¼ˆåŒ…æ‹¬å¯¹è§’çº¿ï¼‰å¡«å……ä¸ºè´Ÿæ— ç©·å¤§ã€‚</li><li>åœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šå¯¹scoreså¼ é‡è¿›è¡Œsoftmaxæ“ä½œï¼Œå¾—åˆ°weightså¼ é‡ï¼Œè¡¨ç¤ºæ¯ä¸ªå…ƒç´ å¯¹å…¶ä»–å…ƒç´ çš„æ³¨æ„åŠ›æƒé‡ã€‚</li><li>é€šè¿‡weightså’Œvalueè®¡ç®—å¾—åˆ°outå¼ é‡ï¼Œè¡¨ç¤ºæ¯ä¸ªå…ƒç´ çš„åŠ æƒå¹³å‡è¾“å‡ºã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>        key <span class="token operator">=</span> self<span class="token punctuation">.</span>Key<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>        query <span class="token operator">=</span> self<span class="token punctuation">.</span>Query<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>        value <span class="token operator">=</span> self<span class="token punctuation">.</span>Value<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>        scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>query<span class="token punctuation">,</span> key<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>head_size<span class="token punctuation">)</span>        mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>tril<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        weights <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> value<span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h5 id="MultiHead-Attention"><a href="#MultiHead-Attention" class="headerlink" title="MultiHead_Attention"></a>MultiHead_Attention</h5><p>å¤šå¤´è‡ªæ³¨æ„åŠ›æ˜¯ä¸€ç§å°†å¤šä¸ªå•å¤´è‡ªæ³¨æ„åŠ›çš„è¾“å‡ºæ‹¼æ¥èµ·æ¥ï¼Œå¹¶è¿›è¡Œçº¿æ€§å˜æ¢çš„æœºåˆ¶ã€‚æœ¬éƒ¨åˆ†åœ¨Headçš„åŸºç¡€ä¸Šå®ç°äº†MultiHeadã€‚</p><ul><li><p>initå‡½æ•°</p><ul><li><p>åˆ›å»ºä¸€ä¸ªæ¨¡å—åˆ—è¡¨ï¼ŒåŒ…å«n_headsä¸ªHeadå¯¹è±¡ã€‚</p></li><li><p>åˆ›å»ºä¸€ä¸ªçº¿æ€§å±‚ï¼Œå°†n_heads * head_sizeæ˜ å°„åˆ°n_embd</p></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n_heads<span class="token punctuation">,</span> head_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>heads <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>Head<span class="token punctuation">(</span>head_size<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_heads<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>projection <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_heads <span class="token operator">*</span> head_size<span class="token punctuation">,</span> n_embd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>forwardå‡½æ•°</p><ul><li>å¯¹headsåˆ—è¡¨ä¸­çš„æ¯ä¸ªHeadå¯¹è±¡ï¼Œè°ƒç”¨å…¶å‰å‘æ–¹æ³•ï¼Œå¯¹inputsè¿›è¡Œå•å¤´è‡ªæ³¨æ„åŠ›ï¼Œå¹¶å°†æ‰€æœ‰å•å¤´çš„è¾“å‡ºåœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šæ‹¼æ¥èµ·æ¥.</li><li>è°ƒç”¨projectionå±‚ï¼Œå¯¹æ‹¼æ¥åçš„å¼ é‡è¿›è¡Œçº¿æ€§å˜æ¢ï¼Œå¹¶è¿”å›ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>    out <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>head<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token keyword">for</span> head <span class="token keyword">in</span> self<span class="token punctuation">.</span>heads<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> self<span class="token punctuation">.</span>projection<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h5 id="Feedforward"><a href="#Feedforward" class="headerlink" title="Feedforward"></a>Feedforward</h5><p>å‰é¦ˆç¥ç»ç½‘ç»œæ˜¯ä¸€ç§å°†è¾“å…¥é€šè¿‡ä¸€ç³»åˆ—çš„çº¿æ€§å˜æ¢å’Œéçº¿æ€§æ¿€æ´»å‡½æ•°æ˜ å°„åˆ°è¾“å‡ºçš„æœºåˆ¶ã€‚</p><ul><li><p>initå‡½æ•°</p><p>åˆ›å»ºä¸€ä¸ªé¡ºåºæ¨¡å—ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚å’Œä¸€ä¸ªReLUæ¿€æ´»å‡½æ•°ã€‚ç¬¬ä¸€ä¸ªçº¿æ€§å±‚å°†n_embdæ˜ å°„åˆ°4<em>n_embdï¼Œç¬¬äºŒä¸ªçº¿æ€§å±‚å°†4</em>n_embdæ˜ å°„å›n_embdã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FeedForward</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n_embd<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        Linear_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">*</span>n_embd<span class="token punctuation">)</span>        Linear_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>n_embd<span class="token punctuation">,</span> n_embd<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Linear_1<span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Linear_2<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h5 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h5><p>æœ¬éƒ¨åˆ†å°†å¤šå¤´è‡ªæ³¨æ„åŠ›å’Œå‰é¦ˆç¥ç»ç½‘ç»œç»“åˆèµ·æ¥ï¼Œå¹¶ä½¿ç”¨æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–çš„æœºåˆ¶ï¼Œå®ç°åºåˆ—åˆ°åºåˆ—çš„æ˜ å°„å’Œç¼–ç ã€‚</p><ul><li><p>initå‡½æ•°</p><p>åˆ›å»ºä¸¤ä¸ªå±‚å½’ä¸€åŒ–å±‚ï¼Œä¸€ä¸ªå¤šå¤´è‡ªæ³¨æ„åŠ›æ¨¡å—å’Œä¸€ä¸ªå‰é¦ˆç¥ç»ç½‘ç»œæ¨¡å—</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n_embd<span class="token punctuation">,</span> n_heads<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>n_embd<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>n_embd<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>attention <span class="token operator">=</span> MultiHeadAttention<span class="token punctuation">(</span>n_heads<span class="token punctuation">,</span> n_embd<span class="token operator">//</span>n_heads<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>feed_forward <span class="token operator">=</span> FeedForward<span class="token punctuation">(</span>n_embd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>forwardå‡½æ•°</p><ul><li>å¯¹inputså’Œå¤šå¤´è‡ªæ³¨æ„åŠ›æ¨¡å—çš„è¾“å‡ºå³ç›¸åŠ ï¼Œå¯¹ç¬¬ä¸€ä¸ªå±‚å½’ä¸€åŒ–ï¼Œå¾—åˆ°attention_outputã€‚</li><li>å¯¹attention_outputå’Œå‰é¦ˆç¥ç»ç½‘ç»œæ¨¡å—çš„è¾“å‡ºç›¸åŠ ï¼Œå¯¹ç¬¬äºŒä¸ªå±‚å½’ä¸€åŒ–å¾—åˆ°outputsã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>       attention_output <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>inputs<span class="token operator">+</span>self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span>       outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>attention_output<span class="token operator">+</span>self<span class="token punctuation">.</span>feed_forward<span class="token punctuation">(</span>attention_output<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token keyword">return</span> outputs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h5 id="Transformer-1"><a href="#Transformer-1" class="headerlink" title="Transformer"></a>Transformer</h5><p>å€ŸåŠ©ä»¥ä¸Šçš„æ¨¡å—ï¼Œå¯ä»¥æ„å»ºTransformeræ¨¡å—ã€‚</p><ul><li><p>init</p><ul><li>åµŒå…¥è¡¨ï¼Œå°†è¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªå•è¯æ˜ å°„åˆ°ä¸€ä¸ªn_embdç»´çš„å‘é‡ã€‚</li><li>å½’ä¸€åŒ–å±‚ï¼Œå¯¹è¾“å…¥è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚</li><li>çº¿æ€§å±‚ï¼Œå°†n_embdç»´çš„å‘é‡æ˜ å°„å›è¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªå•è¯ã€‚</li><li>ä½ç½®åµŒå…¥å‚æ•°ï¼Œè¡¨ç¤ºæ¯ä¸ªä½ç½®çš„å‘é‡ï¼Œç”¨äºå¢åŠ ä½ç½®ä¿¡æ¯ã€‚</li><li>æ¨¡å—åˆ—è¡¨ï¼ŒåŒ…å«n_layersä¸ªå˜æ¢å™¨çš„å—ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>n_vocab<span class="token punctuation">,</span> n_embd<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>norm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>n_embd<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> n_vocab<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>position_embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> block_size<span class="token punctuation">,</span> n_embd<span class="token punctuation">)</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>blocks <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>Block<span class="token punctuation">(</span>n_embd<span class="token punctuation">,</span> n_heads<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_layers<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>forward</p><ul><li>å¾—åˆ°æ¯ä¸ªå•è¯çš„åµŒå…¥å‘é‡embeddingã€‚</li><li>æ ¹æ®inputsçš„æ—¶é—´ç»´åº¦ï¼Œæˆªå–ä½ç½®åµŒå…¥å‚æ•°ä¸­å¯¹åº”çš„éƒ¨åˆ†ï¼Œå¾—åˆ°position_embeddingå¼ é‡ï¼Œè¡¨ç¤ºæ¯ä¸ªä½ç½®çš„åµŒå…¥å‘é‡ã€‚</li><li>å°†embeddingå’Œposition_embeddingç›¸åŠ ï¼Œå¾—åˆ°attenså¼ é‡.</li><li>å¯¹attensåˆ—è¡¨ä¸­çš„æ¯ä¸ªå˜æ¢å™¨çš„å—å¯¹è±¡ï¼Œè°ƒç”¨forwardæ–¹æ³•ï¼Œæ›´æ–°attenså¼ é‡ã€‚</li><li>å¯¹attensåº”ç”¨å±‚å½’ä¸€åŒ–å±‚ã€‚</li><li>å¯¹attensåº”ç”¨çº¿æ€§å±‚ï¼Œå¾—åˆ°logitså¼ é‡ï¼Œè¡¨ç¤ºæ¯ä¸ªæ—¶é—´æ­¥æ¯ä¸ªå•è¯çš„é¢„æµ‹æ¦‚ç‡ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    batch<span class="token punctuation">,</span> time <span class="token operator">=</span> inputs<span class="token punctuation">.</span>shape    embedding <span class="token operator">=</span> self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>    position_embedding <span class="token operator">=</span> self<span class="token punctuation">.</span>position_embedding<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>time<span class="token punctuation">]</span>    attens <span class="token operator">=</span> embedding <span class="token operator">+</span> position_embedding    <span class="token keyword">for</span> block <span class="token keyword">in</span> self<span class="token punctuation">.</span>blocks<span class="token punctuation">:</span>        attens <span class="token operator">=</span> block<span class="token punctuation">(</span>attens<span class="token punctuation">)</span>        attens <span class="token operator">=</span> self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>attens<span class="token punctuation">)</span>        logits <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>attens<span class="token punctuation">)</span>    <span class="token keyword">if</span> labels <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        loss <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        batch<span class="token punctuation">,</span> time<span class="token punctuation">,</span> channel <span class="token operator">=</span> logits<span class="token punctuation">.</span>shape        logits <span class="token operator">=</span> logits<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch <span class="token operator">*</span> time<span class="token punctuation">,</span> channel<span class="token punctuation">)</span>        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch <span class="token operator">*</span> time<span class="token punctuation">)</span>        loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>        <span class="token keyword">return</span> logits<span class="token punctuation">,</span> loss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>generate</p><ul><li>forwardå¯¹inputsè¿›è¡Œé¢„æµ‹ï¼Œå¾—åˆ°logitså¼ é‡ã€‚</li><li>å¯¹logitså¼ é‡åœ¨æœ€åä¸€ä¸ªæ—¶é—´å–æœ€å¤§å€¼ï¼Œå¾—åˆ°æœ€å¯èƒ½çš„ç´¢å¼•ã€‚</li><li>å¹¶æ›´æ–°inputså¼ é‡ã€‚</li><li>ä»¥ä¸Šæ“ä½œè¿›è¡Œmax_new_tokensæ¬¡å¾ªç¯</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> max_new_tokens<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_new_tokens<span class="token punctuation">)</span><span class="token punctuation">:</span>            logits<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>            logits <span class="token operator">=</span> logits<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>inputs<span class="token punctuation">,</span> logits<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> inputs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è´å¶æ–¯ç½‘ç»œï¼Œk-means å’Œtransformer&lt;/p&gt;
&lt;h2 id=&quot;PART1&quot;&gt;&lt;a href=&quot;#PART1&quot; class=&quot;headerlink&quot; title=&quot;PART1&quot;&gt;&lt;/a&gt;PART1&lt;/h2&gt;&lt;h3 id=&quot;æ‰‹å†™æ•°å­—è¯†åˆ«&quot;&gt;&lt;a href=&quot;#æ‰‹</summary>
      
    
    
    
    <category term="AI" scheme="http://sn1987a-1.github.io/categories/AI/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>æ™ºèƒ½åˆçº¦</title>
    <link href="http://sn1987a-1.github.io/posts/c85b8ed3.html"/>
    <id>http://sn1987a-1.github.io/posts/c85b8ed3.html</id>
    <published>2023-06-28T12:48:34.000Z</published>
    <updated>2023-09-24T03:52:18.905Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><ul><li>ç†è§£ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦</li><li>å¼€å‘å®ç°ç®€å•çš„æ™ºèƒ½åˆçº¦</li><li>éƒ¨ç½²ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦</li></ul><h3 id="å®éªŒåŸç†"><a href="#å®éªŒåŸç†" class="headerlink" title="å®éªŒåŸç†"></a>å®éªŒåŸç†</h3><p>æ™ºèƒ½åˆçº¦æ˜¯ä¸€ç§ç‰¹æ®Šåè®®ï¼Œåœ¨åŒºå—é“¾å†…åˆ¶å®šåˆçº¦æ—¶ä½¿ç”¨ï¼Œå½“ä¸­å†…å«äº†ä»£ç å‡½æ•° (Function)ï¼Œäº¦èƒ½ä¸å…¶ä»–åˆçº¦è¿›è¡Œäº¤äº’ã€åšå†³ç­–ã€å­˜å‚¨èµ„æ–™åŠå‘é€ä»¥å¤ªå¸ç­‰åŠŸèƒ½ã€‚æ™ºèƒ½åˆçº¦ä¸»åŠ›æä¾›éªŒè¯åŠæ‰§è¡Œåˆçº¦å†…æ‰€è®¢ç«‹çš„æ¡ä»¶ã€‚æ™ºèƒ½åˆçº¦å…è®¸åœ¨æ²¡æœ‰ç¬¬ä¸‰æ–¹çš„æƒ…å†µä¸‹è¿›è¡Œå¯ä¿¡äº¤æ˜“ã€‚è¿™äº›äº¤æ˜“å¯è¿½è¸ªä¸”ä¸å¯é€†è½¬ã€‚</p><p>åœ¨ä»¥å¤ªåŠä¸Šï¼Œæ™ºèƒ½åˆçº¦æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ä»¥å¤ªåŠé“¾ä¸Šçš„ç¨‹åºã€‚ å®ƒæ˜¯ä½äºä»¥å¤ªåŠåŒºå—é“¾ä¸Šä¸€ä¸ªç‰¹å®šåœ°å€çš„ä¸€ç³»åˆ—ä»£ç ï¼ˆå‡½æ•°ï¼‰å’Œæ•°æ®ï¼ˆçŠ¶æ€ï¼‰ã€‚</p><p>æ™ºèƒ½åˆçº¦ä¹Ÿæ˜¯ä¸€ä¸ªä»¥å¤ªåŠå¸æˆ·ï¼Œå³åˆçº¦å¸æˆ·ã€‚ è¿™æ„å‘³ç€å®ƒä»¬æœ‰ä½™é¢ï¼Œå¯ä»¥æˆä¸ºäº¤æ˜“çš„å¯¹è±¡ã€‚ ä½†æ˜¯ï¼Œå®ƒä»¬æ— æ³•è¢«äººæ“æ§ï¼Œå®ƒä»¬æ˜¯è¢«éƒ¨ç½²åœ¨ç½‘ç»œä¸Šä½œä¸ºç¨‹åºè¿è¡Œç€ã€‚ ä¸ªäººç”¨æˆ·å¯ä»¥é€šè¿‡æäº¤äº¤æ˜“æ‰§è¡Œæ™ºèƒ½åˆçº¦çš„æŸä¸€ä¸ªå‡½æ•°æ¥ä¸æ™ºèƒ½åˆçº¦è¿›è¡Œäº¤äº’ã€‚ æ™ºèƒ½åˆçº¦èƒ½åƒå¸¸è§„åˆçº¦ä¸€æ ·å®šä¹‰è§„åˆ™ï¼Œå¹¶é€šè¿‡ä»£ç è‡ªåŠ¨å¼ºåˆ¶æ‰§è¡Œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨æ— æ³•åˆ é™¤æ™ºèƒ½åˆçº¦ï¼Œä¸å®ƒä»¬çš„äº¤äº’æ˜¯ä¸å¯é€†çš„.ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦åŸºæœ¬ç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ†ä¸ºå¼€å‘ã€ç¼–è¯‘ã€éƒ¨ç½²å’Œè¿è¡Œã€‚</p><h3 id="å®éªŒå†…å®¹"><a href="#å®éªŒå†…å®¹" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h3><h4 id="ç¼–å†™æŠ•ç¥¨åˆçº¦"><a href="#ç¼–å†™æŠ•ç¥¨åˆçº¦" class="headerlink" title="ç¼–å†™æŠ•ç¥¨åˆçº¦"></a>ç¼–å†™æŠ•ç¥¨åˆçº¦</h4><p>æœ¬å®éªŒå®ç°äº†ç®€å•çš„æŠ•ç¥¨åˆçº¦ç¤ºä¾‹ï¼Œå³VotingContractï¼ŒåŸºæœ¬ç»“æ„ä¸ºï¼š</p><ul><li><code>Option</code>è¡¨ç¤ºæ¯ä¸ªæŠ•ç¥¨é€‰é¡¹çš„åç§°å’ŒæŠ•ç¥¨è®¡æ•°ã€‚<code>addoption()</code>å¯ä»¥å¢åŠ æ–°çš„é€‰é¡¹ï¼›<code>getOptionCount()</code>è·å–å½“å‰çš„æŠ•ç¥¨é€‰é¡¹æ•°ç›®ï¼›<code>getOption()</code>è·å–ç‰¹å®šçš„é€‰é¡¹çš„å…·ä½“ä¿¡æ¯ã€‚<br>99 8888888<pre class="line-numbers language-none"><code class="language-none">struct Option {        string OptionName;        uint256 voteCount;    }    Option[] public options;    function addOption(string memory _name) public {        options.push(Option(_name, 0));    }    function getOptionCount() public view returns (uint256) {        return options.length;    }    function getOption(uint256 _optionIndex) public view returns (string memory, uint256) {        require(_optionIndex &lt; options.length, "Invalid option index");        Option memory option = options[_optionIndex];        return (option.OptionName, option.voteCount);    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><ul><li><p>æŠ•ç¥¨ç”±<code>votes</code>å­˜å‚¨ï¼Œé€šè¿‡æ˜ å°„è®²åœ°å€å’Œé€‰é¡¹ç´¢å¼•å…³è”èµ·æ¥</p><pre class="line-numbers language-none"><code class="language-none">mapping(address =&gt; uint256) public votes;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ul><li><p>ç”¨æˆ·é€šè¿‡<code>vote()</code>è¿›è¡ŒæŠ•ç¥¨ï¼Œå·²ç»æŠ•ç¥¨çš„ç”¨æˆ·æ— æ³•å†æŠ•ç¥¨</p><pre class="line-numbers language-none"><code class="language-none">function vote(uint256 _optionIndex) public {        require(_optionIndex &lt; options.length, "Invalid option index");        require(votes[msg.sender] == 0, "Already voted");        options[_optionIndex].voteCount++;        votes[msg.sender] = _optionIndex;    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="éƒ¨ç½²å’Œè°ƒç”¨åˆçº¦"><a href="#éƒ¨ç½²å’Œè°ƒç”¨åˆçº¦" class="headerlink" title="éƒ¨ç½²å’Œè°ƒç”¨åˆçº¦"></a>éƒ¨ç½²å’Œè°ƒç”¨åˆçº¦</h4><p>å¯¹æŠ•ç¥¨åˆçº¦è¿›è¡Œéƒ¨ç½²ï¼Œä¿®æ”¹jsæ–‡ä»¶ï¼š</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> VotingContract <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"VotingContract"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">deployer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  deployer<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>VotingContract<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éƒ¨ç½²å‘½ä»¤ï¼š</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">truffle compiletruffle developtruffle migrate --reset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>éƒ¨ç½²ç»“æœï¼š</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt; Compiling .\contracts\lab.sol&gt; Artifacts written to E:\2023spring\blockchain\lab4\build\contracts&gt; Compiled successfully using:   - solc: 0.8.20+commit.a1b79de6.Emscripten.clang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨åˆçº¦</p><ul><li><p>åˆ›å»ºæŠ•ç¥¨é€‰é¡¹</p>  <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">truffle(develop)&gt; let contract = await VotingContract.deployed()undefinedtruffle(develop)&gt; await contract.addOption("Option 1"){  tx: '0x7736c02bd8c1801d1785efa78ac225ca00cb670fe94f564965e241072ed8349a',  recei  ...  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æŠ•ç¥¨</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">truffle(develop)&gt; await contract.vote(0);{  tx: '  ...  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æŸ¥çœ‹æŠ•ç¥¨ä¿¡æ¯</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">truffle(develop)&gt; let optionCount = await contract.getOptionCount();undefinedtruffle(develop)&gt; console.log("Option count:", optionCount.toNumber());Option count: 1undefinedtruffle(develop)&gt; let option = await contract.getOption(0);undefinedtruffle(develop)&gt; console.log("Option:", option[0], "Votes:", option[1].toNumber())Option: Option 1 Votes: 1undefined<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®éªŒç›®çš„&quot;&gt;&lt;a href=&quot;#å®éªŒç›®çš„&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒç›®çš„&quot;&gt;&lt;/a&gt;å®éªŒç›®çš„&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ç†è§£ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦&lt;/li&gt;
&lt;li&gt;å¼€å‘å®ç°ç®€å•çš„æ™ºèƒ½åˆçº¦&lt;/li&gt;
&lt;li&gt;éƒ¨ç½²ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦&lt;/l</summary>
      
    
    
    
    <category term="åŒºå—é“¾" scheme="http://sn1987a-1.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>ä»£æ•°ç»“æ„ä¹ é¢˜è¯¾-2</title>
    <link href="http://sn1987a-1.github.io/posts/94cbcba9.html"/>
    <id>http://sn1987a-1.github.io/posts/94cbcba9.html</id>
    <published>2023-06-02T12:48:34.000Z</published>
    <updated>2023-09-23T13:35:08.541Z</updated>
    
    <content type="html"><![CDATA[<p><strong>2023springä»£æ•°ç»“æ„ä¹ é¢˜è¯¾è®²ä¹‰</strong></p><h3 id="ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾"><a href="#ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾" class="headerlink" title="ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾"></a>ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾</h3><h4 id="çŸ¥è¯†æ•´ç†"><a href="#çŸ¥è¯†æ•´ç†" class="headerlink" title="çŸ¥è¯†æ•´ç†"></a>çŸ¥è¯†æ•´ç†</h4><p>ç¯çš„å®šä¹‰ï¼ˆéªŒè¯$<r,+,\cdot>$æ˜¯å¦æ˜¯ç¯ï¼‰</r,+,\cdot></p><ul><li>$<r,+>$æ˜¯äº¤æ¢ç¾¤</r,+></li><li>$<r,\cdot>$æ˜¯å«å¹ºåŠç¾¤ï¼ˆå°é—­æ€§ï¼Œç»“åˆå¾‹ï¼Œä¹˜æ³•å•ä½å…ƒï¼‰</r,\cdot></li><li>ä¹˜æ³•å¯¹åŠ æ³•æœ‰å·¦å³åˆ†é…å¾‹</li></ul><p>äº¤æ¢ç¯ï¼šä¹˜æ³•å…·æœ‰äº¤æ¢å¾‹</p><ul><li>è´Ÿå…ƒï¼šåŠ æ³•é€†å…ƒï¼Œä¸€å®šå­˜åœ¨</li><li>å¯é€†å…ƒï¼šä¹˜æ³•é€†å…ƒå­˜åœ¨æ—¶ï¼Œç§°ä¸ºå¯é€†å…ƒ</li><li>è¿ç®—:$a\cdot 0=0\cdot a=0,a\cdot(-b)=(-a)\cdot b=-(a\cdot b),(-a)\cdot (-b)=a\cdot b$</li></ul><p>ç‰¹æ®Šçš„ç¯ï¼š</p><ul><li><p>æ•°ç¯ï¼ŒRï¼ŒCï¼ŒQ</p></li><li><p>è‡ªåŒæ€ç¯: $<g,+>$æ˜¯äº¤æ¢ç¾¤ï¼Œ$E=\{f|f:G\rightarrow Gæ˜¯åŒæ€æ˜ å°„\}$ï¼Œåœ¨Eä¸Šå®šä¹‰è¿ç®—ï¼š</g,+></p></li></ul><script type="math/tex; mode=display">(f+g)(x)=f(x)+g(x)\\(f\cdot g)(x)=f(x)\cdot g(x)</script><p>æ­¤æ—¶$<e,+,\cdot>$ä¸ºç¯ï¼Œäº¤æ¢ç¾¤Gä¸Šçš„è‡ªåŒæ€ç¯ã€‚</e,+,\cdot></p><ul><li>æ¨¡nåŒä½™ç±»ç¯$&lt;\Z_n,+,\cdot&gt;$ <script type="math/tex; mode=display">[i]+[j]=[i+j]\\[i]\cdot[j]=[i\cdot j]</script></li></ul><p>æ•´ç¯å’ŒåŸŸ</p><ul><li>é›¶å› å­ï¼Œå·¦ï¼ˆå³ï¼‰é›¶å› å­ï¼š$a\in R,\exist b,a\cdot b=0(b\cdot a=0)$</li><li>æ— é›¶å› å­ å½“ä¸”ä»…å½“ ä¹˜æ³•æœ‰å·¦å³æ¶ˆå»å¾‹</li><li>æ•´ç¯ï¼šéå¹³å‡¡äº¤æ¢ç¯ï¼Œæ— é›¶å› å­<ul><li>æœ‰å·¦å³æ¶ˆå»å¾‹</li><li>åŠ é˜¶ï¼ˆå…³äºåŠ æ³•è¿ç®—çš„é˜¶ï¼‰ï¼šæ— é™ï¼ˆç‰¹å¾ä¸º0ï¼‰/ç´ æ•°ï¼ˆç‰¹å¾ä¸ºpï¼‰</li></ul></li><li>åŸŸï¼šéå¹³å‡¡äº¤æ¢ç¯ï¼Œæ¯ä¸ªéé›¶å…ƒç´ aéƒ½å­˜åœ¨ä¹˜æ³•é€†å…ƒï¼ˆå…³äºä¹˜æ³•æ„æˆäº¤æ¢ç¾¤ï¼‰<ul><li>åŸŸ$\Rightarrow$æ•´ç¯ï¼ˆå¿…è¦ä¸å……åˆ†ï¼‰</li><li>æœ‰é™æ•´ç¯$\Rightarrow$åŸŸï¼Œå³ä¸ºæœ‰é™åŸŸï¼Œç‰¹å¾ä¸ºpï¼ˆå……åˆ†ä¸å¿…è¦ï¼‰ <em>æ•´æ•°ç¯ä¸æ˜¯åŸŸï¼Œ$&lt;\Z_p,+\cdot&gt;$æ˜¯åŸŸ</em></li></ul></li></ul><p>å­ç¯</p><ul><li><p>åˆ¤æ–­å­ç¯</p><ul><li>å…³äºåŠ æ³•æ„æˆå­ç¾¤</li><li>å¯¹ä¹˜æ³•è¿ç®—å°é—­</li><li><strong>åŒ…å«ä¹˜æ³•å•ä½å…ƒ</strong></li></ul></li><li><p>ç¯åŒæ€æ˜ å°„fï¼š</p><ul><li>$f(a+b)=f(a)+f(b)$</li><li>$f(a\cdot b)=f(a)\cdot f(b)$</li><li>$f(1_{R_1})=1_{R_2}$(å¦‚æœæ²¡æœ‰è¯¥æ¡ä»¶ä¿è¯ï¼Œä¼šå‡ºç°$f(1_{R_1})=0_{R_2}$çš„æƒ…å†µ)</li></ul></li><li><p>åŒæ€æ˜ å°„ç›¸å…³æ€§è´¨</p><ul><li>$f(0_{R_1})=0_{R_2}$</li><li>$f(-a)=-f(a)$</li><li>å¯é€†å…ƒæ˜ å°„åˆ°å¯é€†å…ƒï¼Œ$f(aâ€™)=(f(a))â€™$</li></ul></li><li><p>åŒæ€æ˜ å°„ä¸èƒ½ä¿æŒæ•´ç¯/åŸŸç­‰çš„ç»“æ„ï¼ˆä¾‹7.14ï¼‰ï¼Œç¯åŒæ„æ˜ å°„å¯ä»¥ã€‚</p></li><li><p>å¯¹äºæ»¡å°„f:</p><script type="math/tex; mode=display">f(a+b)=f(a)+f(b)\\f(a\cdot b)=f(a)\cdot f(b)</script><p>å¯ä»¥åˆ¤æ–­æ˜¯ç¯ã€‚</p></li></ul><p>ç†æƒ³å’Œå•†ç¯</p><ul><li><p>ç†æƒ³ï¼šå¯¹äºç¯Rçš„éç©ºå­é›†Iï¼Œæ»¡è¶³$\forall x,y\in I,r\in R\Rightarrow x-y \in I,x\cdot r\in I,r\cdot x\in I$</p></li><li><p>ç†æƒ³å…³äºåŠ æ³•æ„æˆå­ç¾¤</p></li><li><p>çœŸç†æƒ³ï¼Œå¹³å‡¡ç†æƒ³</p></li><li><p>ç†æƒ³çš„è¿ç®—å¾—åˆ°çš„éƒ½æ˜¯ç†æƒ³</p><script type="math/tex; mode=display">I_1\cdot I_2=\{\sum _{k=1}^{n}r_{1k}\cdot r_{2k}|r_{1k}\in R_1,r_{2k}\in R_2,1\leq k_1\leq n,n=1,2... \}\\I_1+I_2=\{r_1+r_2|r_1\in I_1,r_2\in I_2 \}</script></li><li><p>å•†ç¯ï¼š$R/I=\{x+I|x\in R\}$</p></li><li>è‹¥ç†æƒ³Iä¸­æœ‰å¯é€†å…ƒï¼Œ$I=R$(å¹³å‡¡ç†æƒ³)$\Rightarrow$åŸŸä¸­æ‰€æœ‰çš„ç†æƒ³éƒ½æ˜¯å¹³å‡¡ç†æƒ³ï¼Œæ²¡æœ‰çœŸç†æƒ³</li><li><p>ä¸»ç†æƒ³ï¼šäº¤æ¢ç¯ä¸­å…ƒç´ aç”Ÿæˆçš„ç†æƒ³ï¼š$\forall a \in R,(a)=\{a\cdot r|r\in R\}$ï¼›æ¨å¹¿åˆ°äº¤æ¢ç¯çš„å­é›†ï¼š$\forall S=\{a_1,a_2,â€¦a_k\} \subseteq R,(a_1,a_2,â€¦a_k)=\{a_1\cdot r_1+â€¦a_k\cdot r_k|r_1,r_2,â€¦r_k\in R\}$</p><ul><li>ä¸»ç†æƒ³ç¯ï¼šæ‰€æœ‰çš„ç†æƒ³éƒ½æ˜¯ä¸»ç†æƒ³     (æ•´æ•°ç¯)</li></ul></li></ul><p>å¤šé¡¹å¼ç¯</p><ul><li><p>ç¯Rä¸Šçš„å¤šé¡¹å¼$p(x)=a_0+a_1x+â€¦+a_nx^n,a_n\neq 0_R,n\geq 0$</p><ul><li>$a_i$ä¸ºç³»æ•°ï¼Œxä¸ºæœªå®šå…ƒï¼Œnä¸ºæ¬¡æ•°$deg(p(x))=n$ï¼›Rä¸Šçš„éé›¶å…ƒç´ ï¼šå¸¸æ•°å¤šé¡¹å¼ï¼›$0_R$é›¶å¤šé¡¹å¼ï¼›</li></ul></li><li><p>å…¨ä½“å¤šé¡¹å¼è®°ä¸ºR[x]ï¼Œå®šä¹‰è¿ç®—ï¼š</p><script type="math/tex; mode=display">\forall f(x),g(x)\in R[x],\\f(x)+g(x)=\sum^{max\{m,n\}}_{k=0}(a_k+b_k)x^k\\f(x)\cdot g(x)=\sum^{m+n}_{k=0}c_kx^k,c_k=\sum_{i+j=k}a_i\cdot b_j,0\leq k\leq m+n</script><p>R[x]æ˜¯ç¯ï¼ˆé›¶å…ƒï¼Œé€†å…ƒï¼Œä¹˜æ³•å•ä½å…ƒï¼‰ï¼Œä¸”æ˜¯æ•´ç¯ã€‚</p></li><li><p>åŸŸä¸Šçš„å¤šé¡¹å¼</p><p>å¯¹äºR[x]ä¸Šçš„f(x),g(x)ï¼Œè‹¥g(x)ä¸æ˜¯é›¶å¤šé¡¹å¼ï¼Œå­˜åœ¨å”¯ä¸€çš„$q(x),r(x)\in F[x]$:</p><script type="math/tex; mode=display">f(x)=q(x)\cdot g(x)+r(x)ï¼Œå…¶ä¸­r(x)çš„æ¬¡æ•°å°äºdeg(g(x))ï¼Œä¹Ÿå¯èƒ½æ˜¯é›¶å¤šé¡¹å¼ã€‚</script><p>è¯¥å¼å­è¯´æ˜åŸŸä¸Šçš„å¤šé¡¹å¼å¯ä»¥åšé™¤æ³•ï¼Œå•†å’Œä½™å¼å”¯ä¸€ç¡®å®šï¼›å…¶ä¸­$f(x)=q(x)\cdot g(x)$æ—¶ï¼Œç§°g(x)ä¸ºf(x)çš„å› å¼ï¼›</p><script type="math/tex; mode=display">f(x)=q(x)\cdot(x-a)+r_0\Rightarrow f(a)=r_0</script><p>å› æ­¤x-aä¸ºf(x)çš„å› å¼å½“ä¸”ä»…å½“$f(a)=0_F$,æ­¤æ—¶aä¸ºf(x)çš„æ ¹ã€‚</p><ul><li>åŸŸä¸Šçš„å¤šé¡¹å¼ç¯æ˜¯ä¸»ç†æƒ³ç¯ã€‚ï¼ˆéƒ½å¯ä»¥å†™ä¸º$I=(g(x))$ï¼‰</li></ul></li><li><p>åŸŸä¸Šçš„å¤šé¡¹å¼å•†ç¯</p><script type="math/tex; mode=display">F[x]/P=\{f(x)+P|f(x)\in F(x) \},f(x)=q(x)\cdot p(x)+r(x),f(x)-r(x)\in(p(x))\\F[x]/P=\{b_0+b_1x+...+b_{n-1}+P|b_0,b_1,...b_{n-1}\in F \}</script></li></ul><p>ç¯åŒæ€å®šç†</p><ul><li><p>åŒæ€æ ¸ï¼š$\phi$ä¸ºä»$R_1$åˆ°$R_2$çš„åŒæ€æ˜ å°„ï¼Œ$Ker\phi =\{r|r\in R_1,\phi(r)=0_{R_2} \}$</p></li><li><p>$Ker\phi$ä¸º$R_1$çš„ç†æƒ³</p></li><li><p>ç¯åŒæ€åŸºæœ¬å®šç†ï¼šç¯$R_1$çš„ä»»æ„å•†ç¯éƒ½æ˜¯ç¯$R_1$çš„åŒæ€åƒã€‚è‹¥$\phi$æ˜¯ä»$R_1$åˆ°$R_2$çš„æ»¡åŒæ€æ˜ å°„</p><script type="math/tex; mode=display">R_1/Ker\phi \cong R_2</script></li><li><p>è‹¥fä¸ºä»$R_1$åˆ°$R_2$çš„åŒæ€æ˜ å°„</p><ul><li>$S_1$æ˜¯$R_1$çš„å­ç¯ï¼Œ$f(S_1)$æ˜¯$R_2$çš„å­ç¯ï¼ˆ$f(R_1)$æ˜¯å­ç¯ï¼‰</li><li>$S_1$æ˜¯$R_1$çš„ç†æƒ³ï¼Œ$f(S_1)$æ˜¯$R_2$çš„ç†æƒ³</li><li>$S_2$æ˜¯$f(R_1)$çš„å­ç¯ï¼Œ$f^{-1}(S_2)$æ˜¯$R_1$çš„å­ç¯</li><li>$S_2$æ˜¯$f(R_1)$çš„ç†æƒ³ï¼Œ$f^{-1}(S_2)$æ˜¯$R_1$çš„ç†æƒ³ï¼Œä¸”$R_1/f^{-1}(S_2)\cong f(R_1)/S_2$</li></ul></li><li><p>è‹¥$I_1,I_2$ä¸ºRçš„ç†æƒ³ï¼Œ$I_2\subseteq I_1$ï¼Œ$I_1/I_2$æ˜¯$R/I_2$çš„ç†æƒ³</p><script type="math/tex; mode=display">\frac{R/I_2}{I_1/I_2}\cong R/I_1</script></li></ul><h4 id="è¡¥å……ä¹ é¢˜"><a href="#è¡¥å……ä¹ é¢˜" class="headerlink" title="è¡¥å……ä¹ é¢˜"></a>è¡¥å……ä¹ é¢˜</h4><ol><li><p>æ‰¾åˆ°$\mathbb{Z}[\mathrm{i}],\mathbb{Q}[\mathrm{i}]$ä¸­å…¨éƒ¨å¯é€†å…ƒã€‚</p><p> $\mathbb{Z}[\mathrm{i}]$ä¸­çš„å…ƒç´ å¯ä»¥å†™ä¸º$a+b\mathrm{i},a,b\in\mathbb{Z}$ï¼Œå½“$a,b$ä¸å…¨ä¸º0æ—¶ï¼Œè‹¥$(a+b\mathrm{i})(c+d\mathrm{i})=1$ï¼Œè§£å‡º$c=\frac{a}{a^2+b^2},d=\frac{-b}{a^2+b^2}$ã€‚è‹¥å¯é€†ï¼Œæ„å‘³ç€$c,d\in\mathbb{Z}$ã€‚å½“$a\ne0,b\ne0$æ—¶ï¼Œ$a&lt;a^2+b^2$ï¼Œ$c$ä¸å¯èƒ½ä¸ºæ•´æ•°ï¼Œå› æ­¤ä¸å¯èƒ½å¯é€†ï¼Œåˆ†$a=0$æˆ–$b=0$è®¨è®ºå¯çŸ¥$\mathbb{Z}[\mathrm{i}]$å¯é€†å…ƒä¸º$1,-1,\mathrm{i},-\mathrm{i}$ã€‚</p><p> $\mathbb{Q}[\mathrm{i}]$ä¸­çš„å…ƒç´ å¯ä»¥å†™ä¸º$a+b\mathrm{i},a,b\in\mathbb{Q}$ï¼Œå½“$a,b$ä¸å…¨ä¸º0æ—¶ï¼Œè‹¥$(a+b\mathrm{i})(c+d\mathrm{i})=1$ï¼Œè§£å‡º$c=\frac{a}{a^2+b^2},d=\frac{-b}{a^2+b^2}$ã€‚è‹¥å¯é€†ï¼Œæ„å‘³ç€$c,d\in\mathbb{Q}$ã€‚éé›¶æœ‰ç†æ•°åŠ å‡ä¹˜é™¤ä¸€å®šè¿˜ä¸ºæœ‰ç†æ•°ï¼Œå› æ­¤$c,d\in\mathbb{Q}$ä¸€å®šæˆç«‹ï¼Œè¿™æ„å‘³ç€$\mathbb{Q}[\mathrm{i}]$ä¸­éé›¶å…ƒç´ å‡å¯é€†ï¼Œå®ƒæ˜¯åŸŸã€‚</p></li><li><p>è¯æ˜$\mathbb{Z}[x]$ä¸ä¸ºä¸»ç†æƒ³ç¯ã€‚</p><p> è€ƒè™‘$(2,x)$ï¼Œè‹¥$(2,x)$ä¸ºä¸»ç†æƒ³ï¼Œæ„å‘³ç€å­˜åœ¨$f(x)\in\mathbb{Z}[x]$ä½¿å¾—$2=g(x)f(x),x=h(x)f(x),g(x),h(x)\in\mathbb{Z}[x]$ã€‚ç”±è¿™ä¸¤å¼å¯ä»¥æ¨å‡º$f(x)|\gcd(2,x)=1$ï¼Œå› æ­¤$f(x)=\pm1$ã€‚</p><p> ä½†æ˜¯ï¼Œ$f(x)=\pm1$æ—¶ï¼Œ$f(x)$ç”Ÿæˆçš„ç†æƒ³ä¸º$\mathbb{Z}[x]$ï¼Œè€Œ$2$ä¸$x$ç”Ÿæˆçš„ç†æƒ³ä¸åŒ…å«1ï¼ˆæ³¨æ„$\frac{1}{2}\notin\mathbb{Z}[x]$ï¼‰ï¼ŒçŸ›ç›¾ï¼Œç”±æ­¤å³è¯æ˜äº†$(2,x)$ä¸ä¸ºä¸»ç†æƒ³ï¼Œ$\mathbb{Z}[x]$ä¸ä¸ºä¸»ç†æƒ³ç¯ã€‚</p></li></ol><ul><li>è¿™ä¹Ÿå±•ç°äº†ä¸ºä»€ä¹ˆæœ€å¤§å…¬å› æ•°ä¸ç”Ÿæˆç†æƒ³å¸¸éƒ½è®°ä½œ$(a,b)$ï¼Œåœ¨ä¸»ç†æƒ³ç¯ä¸­ï¼Œå¯ä»¥è¯æ˜ç†æƒ³$(a,b)$å³ä¸ºæœ€å¤§å…¬å› æ•°$(a,b)$ç”Ÿæˆçš„ç†æƒ³ã€‚</li></ul><ol><li><p>ï¼ˆæ”¹ç¼–è‡ªå»å¹´æœŸæœ«è€ƒè¯•ï¼‰è¯æ˜$\mathbb{R}[x]/(x^2+1)\simeq\mathbb{C}$ï¼Œè¿™é‡Œ$\simeq$è¡¨ç¤ºç¯åŒæ„ã€‚</p><p> æ„é€ æ˜ å°„$\phi:\mathbb{R}[x]\to\mathbb{C},\phi(f(x))=f(\mathrm{i})$ï¼Œç”±äº$\phi(f(x)+g(x))=f(\mathrm{i})+g(\mathrm{i})=\phi(f(x))+\phi(g(x))$ï¼Œ$\phi(f(x)g(x))=f(\mathrm{i})g(\mathrm{i})=\phi(f(x))\phi(g(x))$ï¼Œå…¶ä¸ºç¯åŒæ€ã€‚</p><p> å¯¹å…¶åº”ç”¨ç¯åŒæ€ç¬¬ä¸€å®šç†ï¼Œ$\mathrm{ker}\phi=\{f\mid f(\mathrm{i})=0\}$ï¼Œä¸‹è¯$\mathbb{R}[x]$ä¸­è¿™ç­‰ä»·äº$x^2+1\mid f(x)$ï¼š</p><p> è‹¥$f(\mathrm{i})=0$ï¼Œç­‰å¼ä¸¤è¾¹å–å…±è½­ï¼Œç”±äºç³»æ•°å‡ä¸ºå®æ•°ï¼Œå¯çŸ¥$f(-\mathrm{i})=0$ã€‚åˆ©ç”¨å› å¼å®šç†ï¼Œè¿™æ„å‘³ç€$(x-\mathrm{i})(x+\mathrm{i})\mid f(x)$ï¼Œä¹Ÿå³$x^2+1\mid f(x)$ï¼Œå¦ä¸€æ–¹é¢ï¼Œå½“$f(x)$æœ‰å› å¼$x^2+1$æ—¶ï¼Œä»£å…¥å¯çŸ¥$f(\mathrm{i})=0$ã€‚</p><p> äºæ˜¯ï¼Œ$\mathrm{ker}\phi=\{f\mid x^2+1\mid f(x)\}=(x^2+1)$ã€‚</p><p> è€Œå¯¹ä»»ä½•$a+b\mathrm{i}\in\mathbb{C}$ï¼Œå–$f(x)=bx+a$å³æœ‰$\phi(f)=a+bi$ï¼Œå› æ­¤$\phi$æ˜¯æ»¡å°„ï¼Œä»è€Œåˆ©ç”¨ç¯åŒæ€ç¬¬ä¸€å®šç†å¾—è¯ã€‚</p></li></ol><ul><li>ç¯åŒæ€ç¬¬ä¸€å®šç†çš„æœ€å¤§ä½œç”¨æ˜¯è¯æ˜å•†ç¯ä¸æŸä¸ªç¯åŒæ€ï¼Œä½†æ„é€ æ˜ å°„çš„è¿‡ç¨‹å¯èƒ½æœ‰ä¸€å®šçš„æŠ€å·§æ€§ã€‚æœ¬é¢˜æ˜¯ç”±äºæ³¨æ„åˆ°$\mathbb{i}$æ˜¯$x^2+1$çš„æ ¹ï¼Œè€Œ$\mathbb{C}=\mathbb{R}[\mathrm{i}]$ï¼Œå› æ­¤æƒ³åˆ°å¦‚æ­¤æ„é€ ã€‚</li></ul><ol><li>è¯æ˜$\mathbb{Z}[x]/(x+1,x^2+4)\simeq\mathbb{Z}_5$ã€‚</li></ol><ul><li><p>æœ¬é¢˜åŸºæœ¬ä¸å¯èƒ½ç›´æ¥çœ‹å‡ºæ˜ å°„ï¼Œå› æ­¤éœ€è¦æ„é€ ï¼šå‡ºäº$\ker\phi=(x+1,x^2+4)$å¸Œæœ›$\phi(x^2+4)=\phi(x+1)=0$ã€‚æ³¨æ„åˆ°$x^2+4=(x-1)(x+1)+5$ï¼Œåˆ©ç”¨ç¯åŒæ€å¯çŸ¥$\phi(x^2+4)=\phi(x+1)\phi(x-1)+\phi(5)=0$ï¼Œäºæ˜¯$\phi(5)=\phi(x+1)=0$ã€‚å› æ­¤å¯ä»¥æ„é€ ï¼š</p><p>  æ„é€ $\phi:\mathbb{Z}[x]\to\mathbb{Z}_5$ï¼Œ$\phi(f(x))=[f(-1)]$ï¼Œç±»ä¼¼ä¸Šé¢˜å¯è¯´æ˜å…¶ä¸ºç¯åŒæ€ï¼Œä¸‹é¢è®¡ç®—$\ker\phi$ã€‚</p><p>  $f\in\ker\phi\Leftrightarrow 5\mid f(-1)$ï¼Œåˆ©ç”¨å› å¼å®šç†å¾—ä¹Ÿå³å­˜åœ¨$t\in\mathbb{Z}$ä½¿å¾—$f(x)-5t=(x+1)g(x),g\in\mathbb{Z}[x]$ã€‚å› æ­¤ï¼Œ$f(x)=5t+(x+1)g(x)$ï¼Œè¿™æ„å‘³ç€$f(x)\in(5,x+1)$ã€‚å¦ä¸€æ–¹é¢ï¼Œ$f(x)\in(5,x+1)$æ—¶ï¼Œä¸€å®šå¯ä»¥å†™ä¸º$5g(x)+(x+1)h(x),g,h\in\mathbb{Z}[x]$ï¼Œäºæ˜¯$\phi(f)=[5g(-1)]=[0]$ï¼Œå³è¯æ˜$\ker\phi=(5,x+1)$ã€‚</p><p>  ç”±äº$x^2+4=(x-1)(x+1)+5$ï¼Œåœ¨æœ‰$x+1$æ—¶$x^2+4$ä¸5å¯ä»¥äº’ç›¸ç”Ÿæˆï¼Œäºæ˜¯$(x^2+4,x+1)=(5,x+1)$ã€‚æ­¤å¤–ï¼Œä»¤$f(x)=0,1,2,3,4$å¯çŸ¥$\phi$æ˜¯æ»¡å°„ï¼Œä»è€Œåˆ©ç”¨ç¯åŒæ€ç¬¬ä¸€å®šç†å¾—è¯ã€‚</p></li><li><p>è¿™é‡Œä¹Ÿå¯ä»¥å‘ç°ï¼Œç”Ÿæˆç†æƒ³ä¸æœ€å¤§å…¬å› æ•°æœ‰ç±»ä¼¼çš„å…è®¸è¾—è½¬ç›¸é™¤æ€§è´¨ã€‚</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;2023springä»£æ•°ç»“æ„ä¹ é¢˜è¯¾è®²ä¹‰&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾&quot;&gt;&lt;a href=&quot;#ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾&quot;&gt;&lt;/a&gt;ç¬¬äºŒæ¬¡ä¹ é¢˜è¯¾&lt;/h3&gt;&lt;h4 id=&quot;çŸ¥è¯†æ•´ç†&quot;</summary>
      
    
    
    
    <category term="ä»£æ•°ç»“æ„" scheme="http://sn1987a-1.github.io/categories/%E4%BB%A3%E6%95%B0%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>Astar&amp;CSP</title>
    <link href="http://sn1987a-1.github.io/posts/58da92e9.html"/>
    <id>http://sn1987a-1.github.io/posts/58da92e9.html</id>
    <published>2023-06-01T12:48:34.000Z</published>
    <updated>2023-09-24T03:23:59.051Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Astar-and-CSP-Question"><a href="#Astar-and-CSP-Question" class="headerlink" title="Astar and CSP Question"></a>Astar and CSP Question</h2><h3 id="å®éªŒ1-1"><a href="#å®éªŒ1-1" class="headerlink" title="å®éªŒ1.1"></a>å®éªŒ1.1</h3><h4 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h4><p>ä½¿ç”¨A-starç®—æ³•ï¼Œè§£å†³$N\times N$äºŒè¿›åˆ¶è¿·é”é—®é¢˜ã€‚</p><h4 id="å®éªŒå†…å®¹"><a href="#å®éªŒå†…å®¹" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h4><p><strong>å¯å‘å¼å‡½æ•°</strong></p><p>åœ¨æœ¬å®éªŒä¸­ï¼Œé€‰ç”¨å¯å‘å¼å‡½æ•°$h(x)=\frac13\sum$(1çš„ä¸ªæ•°)ã€‚åœ¨å®é™…æœç´¢ä¸­ï¼Œå¯ä»¥æ ¹æ®å½“å‰çŠ¶æ€è®¡ç®—ä¸‹ä¸€æ­¥çš„1çš„ä¸ªæ•°ï¼Œæ— éœ€é‡æ–°éå†æ•°ç»„è¿›è¡Œè®¡ç®—</p><ul><li>admissibleï¼šæ¯æ¬¡æ“ä½œæ—¶ï¼Œå¯¹3ä¸ªä½ç½®è¿›è¡Œç¿»è½¬ï¼Œå› æ­¤å¯èƒ½å­˜åœ¨çš„æœ€ä¼˜è§£ä¸º$\sum (d_{ij}==1)/3$å‘ä¸Šå–æ•´ï¼Œ$h(x)\leq h*(x)$</li><li>consistentï¼šè¯¥å¯å‘å‡½æ•°æ˜¯consistentçš„ï¼Œå› ä¸ºä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹ä¹‹é—´$c(m,n)\geq${mä¸­1çš„ä¸ªæ•°å’Œnä¸­1çš„ä¸ªæ•°çš„å·®}/3ï¼Œ$h(n)-h(m)=h(n-m)$ï¼Œå› æ­¤$h(n)\leq c(n,m)+h(m)$</li></ul><p><strong>æ€è·¯</strong></p><ul><li><p>å€ŸåŠ©æ•°ç»„<code>data[][]</code>å­˜å‚¨å½“å‰çš„å›¾çš„æƒ…å†µï¼Œ<code>step</code>å­˜å‚¨å½“å‰çš„æ­¥æ•°ï¼Œ<code>solution</code>å­˜å‚¨å½“å‰çš„è§£æ³•ï¼Œå…¶ä¸­<code>solution</code>æ¯ä¸€è¡Œåˆ†åˆ«å­˜å‚¨æ¯ä¸€æ­¥çš„xï¼Œyåæ ‡å’Œä»¥è¯¥ç‚¹ä¸ºä¸­å¿ƒçš„å››ç§è½¬æ³•ï¼›</p></li><li><p>ä½¿ç”¨å­˜å‚¨å—é™çš„å¯å‘å¼æœç´¢ï¼Œå¹¶é™åˆ¶æ·±åº¦ï¼Œæ¯æ¬¡é€’å½’æœç´¢ï¼Œä½¿ç”¨<code>priority queue</code>å­˜å‚¨æ¯æ¬¡æœç´¢æ—¶æ¢ç´¢çš„èŠ‚ç‚¹ï¼Œå…¶ä¸­ä¼˜å…ˆé˜Ÿåˆ—çš„æ’åºæ ¹æ®æ˜¯æ¯ä¸ªèŠ‚ç‚¹æ¢ç´¢åå‰©ä½™çš„1çš„ä¸ªæ•°ï¼Œä»å°åˆ°å¤§æ’åºï¼Œå³ä¸ºä¼˜å…ˆæ¢ç´¢å¯ä»¥æœ€å°åŒ–1çš„ä¸ªæ•°çš„æƒ…å†µã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">auto cmp = [](const int* a, const int* b) { return a[0] &gt; b[0]; };priority_queue&lt;int*, vector&lt;int*&gt;, decltype(cmp)&gt; pq(cmp);while(!pq.empty())    {        auto cur=pq.top();        pq.pop();        change_data(cur[1],cur[2],cur[3]);        solution[step-1][0]=cur[1];        solution[step-1][1]=cur[2];        solution[step-1][2]=cur[3];        cur_1_num=cur[0];        visit_state[cur[1]][cur[2]][cur[3]]=1;        if(RBFS()==2)        return 2;        visit_state[cur[1]][cur[2]][cur[3]]=0;        change_data(cur[1],cur[2],cur[3]);        cur_1_num=temp_1_num;    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ¯æ¬¡æœç´¢ï¼Œè®¡ç®—ä¸‹ä¸€æ­¥1çš„ä¸ªæ•°</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int each_step(int cases,int x,int y){    int after_num=cur_1_num;    after_num+=1-2*data[x][y];    switch (cases)    {    case 1:        after_num+=1-2*data[x][y+1];        after_num+=1-2*data[x-1][y];        break;    //...case 2 3 4    default:        break;    }    return after_num;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ¯æ¬¡è¿›å…¥é€’å½’æˆ–é€€å‡ºé€’å½’æ—¶ï¼Œéƒ½è¦åŠæ—¶æ›´æ–°ï¼š<code>step</code>,<code>cur_1_num</code>,<code>data</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void change_data(int x,int y,int cases){    data[x][y]=1-data[x][y];    switch (cases)    {    case 1:        data[x][y+1]=1-data[x][y+1];        data[x-1][y]=1-data[x-1][y];        break;    //case 2 3 4:    default:        break;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>å‰ªææ“ä½œ</p><ul><li><p>ç”±äºæœ€ä¼˜è§£ä¸­ï¼Œä¸€å®šä¸å­˜åœ¨åŒä¸€ä¸ªä½ç½®çš„åŒä¸€ç§è½¬æ³•ï¼Œå¯ä»¥ç»´æŠ¤æ•°ç»„é™åˆ¶ä»…æ‹“å±•æœªè¢«æ¢ç´¢çš„èŠ‚ç‚¹</p></li><li><p>è§£æ³•çš„é¡ºåºä¸å½±å“è§£çš„ç»“æœï¼Œå› æ­¤å¯ä»¥é™åˆ¶æ¯æ¬¡æ‹“å±•çš„èŠ‚ç‚¹ï¼Œå…·ä½“æ–¹æ³•ä¸ºï¼šéå†<code>data</code>æ•°ç»„ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ª1ï¼Œè¦æŠŠè¿™ä¸ª1ç¿»è½¬æˆ0ï¼Œåˆ™å¿…é¡»å­˜åœ¨ä¸€æ­¥åŒ…å«è¯¥1ï¼Œè¿™æ ·çš„æ“ä½œæœ€å¤šå­˜åœ¨12ç§ï¼Œå› æ­¤åªéœ€æ‹“å±•ç›¸å…³çš„12ä¸ªèŠ‚ç‚¹å³å¯ã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for(int i=0;i&lt;size;i++){    for(int j=0;j&lt;size;j++)    {        if(data[i][j]==1)        {            if(i!=0&amp;&amp;j!=0)            {                next_step=find_next(i,j,2);                if(visit_state[i][j][2]==0)                pq.push(next_step);                next_step=find_next(i-1,j,3);                if(visit_state[i-1][j][3]==0)                pq.push(next_step);                next_step=find_next(i,j-1,1);                if(visit_state[i][j-1][1]==0)                pq.push(next_step);            }            //...other nine states            t_flag=1;            break;        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ·±åº¦å—é™æœç´¢ä¸­ï¼Œç†è®ºä¸Šå¯¹äºæ¯ä¸ªå•ç‹¬å­˜åœ¨çš„1ï¼Œå¯ä»¥ç”¨3æ­¥å°†å…¶å˜ä¸º0ä¸”ä¸æ”¹å˜å…¶ä»–çš„çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥æ ¹æ®æ¯æ¬¡æœç´¢åˆ°è§£æ—¶å½“å‰çš„è§£çš„æ­¥æ•°æ›´æ–°æ·±åº¦é™åˆ¶<code>depth-limit</code>ï¼Œä»¥åŠæ›´æ–°å½“å‰æœ€ä¼˜è§£</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">if(cur_1_num==0)    {        if(step&lt;best_step)        {            best_step=step;            for(int i=0;i&lt;step;i++)            for(int j=0;j&lt;3;j++)            best_solution[i][j]=solution[i][j];        }        if(depth_limit&gt;step)        depth_limit=step;        step--;        return 1;    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>å¯¹æ¯”Dijkstra</strong></p><p>Dijkstraæœç´¢å’Œå¯å‘å¼æœç´¢çš„åŒºåˆ«åœ¨äºDijkstraä¸éœ€è¦å€ŸåŠ©å¯å‘å‡½æ•°ç¡®å®šä¸‹ä¸€æ­¥éœ€æ‹“å±•çš„èŠ‚ç‚¹ï¼Œå³å°†åŸå‡½æ•°çš„å¯å‘å‡½æ•°ä¸€ç›´è®¤ä¸ºæ˜¯0å³å¯ï¼Œåœ¨å…¶ä»–æ¡ä»¶ä¸å˜çš„æƒ…å†µä¸‹ï¼Œå’Œå¯å‘å¼æœç´¢çš„åŒºåˆ«ï¼š</p><ul><li>å¦‚æœéœ€è¦æœç´¢æœ€ä¼˜è§£ï¼Œç”±äºå¯å‘å¼æœç´¢å¯¹æ·±åº¦é™åˆ¶å’Œå‰ªæçš„å­˜åœ¨ï¼Œå¯ä»¥å¤§å¤§é™ä½è¿è¡Œçš„æ—¶é—´å’Œè¿è¡Œçš„å†…å­˜å ç”¨ï¼ŒDijkstraå¹¶ä¸é€‚åˆæ±‚è§£æœ€ä¼˜è§£</li><li>å¦‚æœè¦æœç´¢å¯è¡Œè§£ï¼Œå¯å‘å¼æœç´¢çš„æœç´¢ç»“æœæ­¥æ•°ä½äºDijkstraç®—æ³•</li></ul><h3 id="å®éªŒ1-2"><a href="#å®éªŒ1-2" class="headerlink" title="å®éªŒ1.2"></a>å®éªŒ1.2</h3><h4 id="å®éªŒç›®çš„-1"><a href="#å®éªŒç›®çš„-1" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h4><p>ä½¿ç”¨CSPç®—æ³•ï¼Œä¸ºå­¦æ ¡å®¿ç®¡é˜¿å§¨å®‰æ’å€¼ç­è¡¨ï¼Œä»¥æ»¡è¶³çº¦æŸæ¡ä»¶ï¼Œå°½å¯èƒ½åœ°æ»¡è¶³é˜¿å§¨ä»¬çš„è½®ç­è¯·æ±‚ï¼Œæ–Œå¹¶ä½¿ç”¨MRVã€Forward Checkingã€Constraint Propagationç­‰ä¼˜åŒ–æŠ€æœ¯ï¼Œä»¥ä¾¿å¿«é€Ÿè§£å†³ä»»åŠ¡å¹¶æœ€å¤§åŒ–æ»¡è¶³è¯·æ±‚æ•°ã€‚</p><h4 id="å®éªŒå†…å®¹-1"><a href="#å®éªŒå†…å®¹-1" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h4><p>å®éªŒçš„é—®é¢˜æ¨¡å‹å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªCSPé—®é¢˜ï¼šè¦æ‰¾åˆ°æœ€å¤§åŒ–æ»¡è¶³çº¦æŸ$Request\subset \{0,1\}^{N\times D\times S}$çš„å–å€¼ä¸ºstaff_numçš„days_num*shifts_numä¸ªå˜é‡ã€‚ä¸‹é¢æ˜¯CSPç®—æ³•è®¾è®¡çš„å…·ä½“å†…å®¹ï¼š</p><ul><li><p>æœ€å°å‰©ä½™å€¼ï¼šä½¿ç”¨MRVæ±‚è§£é—®é¢˜ï¼Œå¯ä»¥æé«˜æ±‚è§£é€Ÿåº¦ï¼Œmrvå‡½æ•°çš„å·¥ä½œå°±æ˜¯æ ¹æ®å½“å‰çš„æœªè¢«åˆ†é…çš„å˜é‡ä¸­ï¼Œå‰©ä½™å€¼æœ€å°‘çš„å˜é‡å¹¶è¿”å›å…¶ indexï¼Œå¦‚æœä¸å­˜åœ¨æœªè¢«åˆ†é…çš„å˜é‡ï¼Œå³å‰næ­¥å·²ç»å®Œæˆäº†æ’ç‰ˆï¼Œè¿”å›-1</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int mrv(){    int min_index=0;    int flag=0;    for(int i=1;i&lt;shifts_num*days_num;i++)    {        if(remaining_value[i]&lt;remaining_value[min_index])        min_index=i;        if(remaining_value[i]&gt;0)        flag=1;    }    if(flag==0||remaining_value[min_index]==1000000)    return -1;    return min_index;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å¤„äºå…¬å¹³èµ·è§ï¼Œåº”è¯¥è®©æ‰€æœ‰çš„staffè¢«æ’ç­çš„æ¬¡æ•°å‡æ¥è¿‘å¹³å‡å€¼ï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸€æ•ˆæœï¼Œæ¯æ¬¡å¯¹æŸä¸€æ—¶é—´æ®µè¿›è¡Œæ’ç‰ˆæ—¶ï¼Œæ ¹æ®æ»¡è¶³æ¡ä»¶çš„staffå·²ç»æ’ç­çš„æ¬¡æ•°ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œä¼˜å…ˆå®‰æ’æ’ç‰ˆæ¬¡æ•°è¾ƒå°‘è€…ï¼›å¦å¤–ï¼Œä¸ºäº†ä¿è¯ä¼˜å…ˆæœ€å¤§åŒ–è¯·æ±‚æ•°é‡ï¼Œå¦‚æœè¯¥æ—¶é—´æ®µå­˜åœ¨å¯ä»¥æ»¡è¶³çº¦æŸçš„è¯·æ±‚ï¼Œä¼˜å…ˆåœ¨å¯ä»¥æ»¡è¶³è¯·æ±‚çš„staffä¸­é€‰æ‹©ï¼Œä¸è€ƒè™‘æ— æ³•æ»¡è¶³çš„éƒ¨åˆ†ï¼Œå¦åˆ™å†è€ƒè™‘æ— æ³•æ»¡è¶³è¯·æ±‚çš„æƒ…å†µã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">vector&lt;int&gt; staff_order(int index){    vector&lt;int&gt; order;    for(int i=0;i&lt;staff_num;i++)    {        if(data[i][index]==1)            order.push_back(i);    }    if(order.size()==0)    {         for(int i=0;i&lt;staff_num;i++)        {            if(data[i][index]==0)                order.push_back(i);        }    }    sort(order.begin(), order.end(), [](int a, int b){return staff_times[a] &lt; staff_times[b];});    return order;   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>CSPç®—æ³•çš„ä¸»å¹²éƒ¨åˆ†ï¼Œé€’å½’æ±‚è§£ï¼Œä¸‹é¢æ˜¯ä¸ºå…¨éƒ¨çš„æ—¶é—´æ®µæ‰¾åˆ°è§£çš„å¤„ç†ï¼Œå…¶ä¸­å¯¹è¿”å›å€¼çš„è§£é‡Šå¦‚ä¸‹ï¼šå…¶ä¸­not_fot_numè®°å½•äº†æœªæ»¡è¶³çš„çº¦æŸçš„æ•°ç›®</p><ul><li>1ï¼šæ‰¾åˆ°äº†æ»¡è¶³æ‰€æœ‰è¯·æ±‚çš„è§£ï¼Œæ­¤æ—¶è¦æ›´æ–°ç›¸å…³å‚æ•°å¹¶é€€å‡ºé€’å½’</li><li>2ï¼šæ‰¾åˆ°äº†è§£ï¼Œæ²¡æœ‰æ»¡è¶³æ‰€æœ‰è¯·æ±‚ï¼Œä½†æ¯”ä¹‹å‰æ±‚è§£çš„è§£æ›´å¥½ï¼Œæ­¤æ—¶è¦æ›´æ–°ç›¸å…³å‚æ•°</li><li>-1ï¼šæ‰¾åˆ°äº†ä¸æ»¡è¶³æ‰€æœ‰çº¦æŸçš„è§£ï¼Œå¹¶ä¸”ä¸å¦‚ä¹‹å‰çš„è§£ï¼Œä¸åšå¤„ç†</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">if(num==days_num*shifts_num&amp;&amp;not_fit_num==0)    {        best_fit_num=not_fit_num;        for(int i=0;i&lt;days_num*shifts_num;i++)        {            best_plan[i]=final_plan[i];        }        return 1;}     else if (not_fit_num&gt;best_fit_num)    return -1;    else if(num==days_num*shifts_num&amp;&amp;not_fit_num&lt;best_fit_num)    {        best_fit_num=not_fit_num;        for(int i=0;i&lt;days_num*shifts_num;i++)        {            best_plan[i]=final_plan[i];        }        return 2;    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºä¸€èˆ¬çš„æƒ…å†µï¼Œè¦æ ¹æ®MRVçš„åŸåˆ™æ‰¾åˆ°æœ€å°å‰©ä½™å€¼ï¼Œå¹¶æ ¹æ®å·²æ’ç­æ•°é‡staff_numæ¥ç¡®å®šèµ‹å€¼é¡ºåºã€‚æ¯æ¬¡è¿›å…¥æˆ–é€€å‡ºé€’å½’æ—¶ï¼Œéƒ½è¦æ›´æ–°æˆ–æ¢å¤ç›¸å…³çš„å˜é‡ï¼š</p><ul><li>ä¿®æ”¹dataä¸­è¯¥staffç›¸é‚»æ—¶é—´çš„çŠ¶æ€</li><li>ä¿®æ”¹ç›¸é‚»æ—¶é—´ä¸­remain_value</li><li>æ›´æ”¹æ— æ³•æ»¡è¶³çš„æƒ…å†µæ—¶not_fit_num</li><li>ä¿®æ”¹staffå·²ç»è¢«æ’ç­çš„æ¬¡æ•°</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int index=mrv();    int state=0;    auto order=staff_order(index);    int t;    for(int j=0;j&lt;order.size();j++)    {        int i=order[j];        int old_data_i_index=data[i][index];        if(old_data_i_index==0)        not_fit_num+=1;        data[i][index]=0;        state=0;        if(index!=0&amp;&amp;data[i][index-1]==1)        {           remaining_value[index-1]-=1;            state=1;        }        if(index!=0)            data[i][index-1]=-1;        if(index!=days_num*shifts_num-1&amp;&amp;data[i][index+1]==1)        {            remaining_value[index+1]-=1;            state+=2;        }        if(index!=days_num*shifts_num-1)            data[i][index+1]=-1;        final_plan[index]=i;        int temp=remaining_value[index];        remaining_value[index]=1000000;        staff_times[i]++;        t=csp(num+1);        staff_times[i]--;        remaining_value[index]=temp;        if(t==1)        {            return 1;        }        if(index!=0)        data[i][index-1]=0;        if(index!=days_num*shifts_num-1)        data[i][index+1]=0;        if(state%2==1)        {            data[i][index-1]=1;            remaining_value[index-1]+=1;        }        if(state&gt;=2)        {            data[i][index+1]=1;            remaining_value[index+1]+=1;        }        data[i][index]=old_data_i_index;         if(old_data_i_index==0)         not_fit_num--;      }return 2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><ul><li><p>æœ€åå¤„ç†è¾“å…¥æ•°æ®ï¼Œè¾“å‡ºæ•°æ®æ¨¡å—ï¼Œå³å¯å®ŒæˆCSPæ’ç­çš„å…¨éƒ¨å†…å®¹ã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void get_input(char * filename){    ifstream file(filename);    char c;    file&gt;&gt;staff_num&gt;&gt;c&gt;&gt;days_num&gt;&gt;c&gt;&gt;shifts_num;    each_time=days_num*shifts_num/staff_num;    best_fit_num=100000;    not_fit_num=0;    for(int i=0;i&lt;staff_num;i++)    {        for(int j=0;j&lt;days_num;j++)        {            for(int k=0;k&lt;shifts_num;k++)            {                if(k)                file&gt;&gt;c;                file&gt;&gt;data[i][j*shifts_num+k];                remaining_value[j*shifts_num+k]+=data[i][j*shifts_num+k];            }} }}void get_output(char * filename){    fstream file(filename);    for(int i=0;i&lt;days_num;i++)    {        for(int j=0;j&lt;shifts_num;j++)        {            if(j!=shifts_num-1)            file&lt;&lt;best_plan[i*shifts_num+j]&lt;&lt;',';            else            file&lt;&lt;best_plan[i*shifts_num+j]&lt;&lt;endl; } }    file&lt;&lt;days_num*shifts_num-best_fit_num&lt;&lt;endl;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Astar-and-CSP-Question&quot;&gt;&lt;a href=&quot;#Astar-and-CSP-Question&quot; class=&quot;headerlink&quot; title=&quot;Astar and CSP Question&quot;&gt;&lt;/a&gt;Astar and CSP Questi</summary>
      
    
    
    
    <category term="äººå·¥æ™ºèƒ½" scheme="http://sn1987a-1.github.io/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>UTXOåŒºå—é“¾</title>
    <link href="http://sn1987a-1.github.io/posts/e65e9bf0.html"/>
    <id>http://sn1987a-1.github.io/posts/e65e9bf0.html</id>
    <published>2023-05-28T12:48:34.000Z</published>
    <updated>2023-09-24T03:52:59.486Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PART1"><a href="#PART1" class="headerlink" title="PART1"></a>PART1</h2><h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><ul><li>äº†è§£åŒºå—é“¾ä¸Šçš„ç®€å•æ•°æ®ç»“æ„</li><li>å®ç°Merkleæ ‘çš„æ„å»º</li><li>åˆæ­¥ç†è§£UTXOçš„ä½¿ç”¨å’ŒéªŒè¯</li><li>ç†è§£æ¯”ç‰¹å¸ä¸Šçš„äº¤æ˜“åˆ›å»º</li></ul><h3 id="å®éªŒå†…å®¹"><a href="#å®éªŒå†…å®¹" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h3><h4 id="åŒºå—é“¾çš„åŸºæœ¬ç»“æ„"><a href="#åŒºå—é“¾çš„åŸºæœ¬ç»“æ„" class="headerlink" title="åŒºå—é“¾çš„åŸºæœ¬ç»“æ„"></a>åŒºå—é“¾çš„åŸºæœ¬ç»“æ„</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> BlockChain <span class="token keyword">struct</span><span class="token punctuation">{</span>    tip <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token comment">//æœ€æ–°åŒºå—çš„å“ˆå¸Œå€¼</span>    db <span class="token operator">*</span>bolt<span class="token punctuation">.</span>DB<span class="token comment">//æ•°æ®åº“è¿æ¥</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åŒºå—é“¾é€šè¿‡é“¾å¼ç»“æ„è¿æ¥å„ä¸ªåŒºå—ï¼Œå½¢æˆä¸€ä¸ªä¸æ–­å¢é•¿çš„åˆ†å¸ƒå¼è´¦æœ¬ç³»ç»Ÿã€‚</p><h4 id="åŒºå—çš„åŸºæœ¬ç»“æ„"><a href="#åŒºå—çš„åŸºæœ¬ç»“æ„" class="headerlink" title="åŒºå—çš„åŸºæœ¬ç»“æ„"></a>åŒºå—çš„åŸºæœ¬ç»“æ„</h4><p>ä½œä¸ºåŒºå—é“¾çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼ŒåŒºå—ç”±åŒºå—å¤´å’ŒåŒºå—ä½“æ„æˆï¼ŒåŒºå—å¤´å­˜å‚¨äº†ç‰ˆæœ¬å·ï¼Œä¸Šä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ï¼Œå½“å‰åŒºå—äº¤æ˜“çš„å“ˆå¸Œå€¼ï¼Œæ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªåŒºå—ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> BlkHeader <span class="token keyword">struct</span> <span class="token punctuation">{</span>Version       <span class="token builtin">int64</span>PrevBlockHash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>MerkleRoot    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>Timestamp     <span class="token builtin">int64</span>Bits          <span class="token builtin">int64</span>Nonce         <span class="token builtin">int64</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h4 id="Merkleæ ‘"><a href="#Merkleæ ‘" class="headerlink" title="Merkleæ ‘"></a>Merkleæ ‘</h4><p>æ¯ä¸€ä¸ªåŒºå—çš„äº¤æ˜“èŠ‚ç‚¹ä»åº•å‘ä¸Šæ„å»ºMerkleæ ‘ï¼Œé‡‡ç”¨å“ˆå¸ŒåŠ å¯†ï¼ˆå•æ¬¡sha256ï¼‰ã€‚</p><ul><li><p>æ–°å»ºMerkleèŠ‚ç‚¹ï¼Œåˆ†ä¸ºå¶å­èŠ‚ç‚¹å’Œéå¶å­èŠ‚ç‚¹</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewMerkleNode</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right <span class="token operator">*</span>MerkleNode<span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token operator">*</span>MerkleNode <span class="token punctuation">{</span>NewNode<span class="token operator">:=</span><span class="token operator">&amp;</span>MerkleNode<span class="token punctuation">{</span><span class="token punctuation">}</span>NewNode<span class="token punctuation">.</span>Left<span class="token operator">=</span>leftNewNode<span class="token punctuation">.</span>Right<span class="token operator">=</span>right<span class="token keyword">if</span> left<span class="token operator">==</span><span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> right<span class="token operator">==</span><span class="token boolean">nil</span><span class="token punctuation">{</span>data_sha<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>NewNode<span class="token punctuation">.</span>Data<span class="token operator">=</span>data_sha<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>data_c<span class="token operator">:=</span><span class="token function">append</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>Data<span class="token punctuation">,</span>right<span class="token punctuation">.</span>Data<span class="token operator">...</span><span class="token punctuation">)</span>data_sha<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>data_c<span class="token punctuation">)</span>NewNode<span class="token punctuation">.</span>Data<span class="token operator">=</span>data_sha<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token keyword">return</span> NewNode<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ–°å»ºMerkleæ ‘ï¼Œè°ƒç”¨æ–°å»ºèŠ‚ç‚¹çš„å‡½æ•°è‡ªåº•å‘ä¸Šæ„å»ºï¼Œç›´åˆ°ç»“ç‚¹æ•°ä¸º1ï¼Œå¹¶ä¸”ä¿è¯èŠ‚ç‚¹æ•°é‡ä¸ºå¶æ•°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewMerkleTree</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token operator">*</span>MerkleTree <span class="token punctuation">{</span>NewTree<span class="token operator">:=</span><span class="token operator">&amp;</span>MerkleTree<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">var</span> nodes <span class="token punctuation">[</span><span class="token punctuation">]</span>MerkleNodeNewTree<span class="token punctuation">.</span>Leaf<span class="token operator">=</span>data<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span>data_i <span class="token operator">:=</span> <span class="token keyword">range</span> data<span class="token punctuation">{</span>node_i<span class="token operator">:=</span><span class="token function">NewMerkleNode</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">,</span>data_i<span class="token punctuation">)</span>nodes<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span><span class="token operator">*</span>node_i<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">{</span><span class="token keyword">var</span> newnodes <span class="token punctuation">[</span><span class="token punctuation">]</span>MerkleNode<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">{</span>node<span class="token operator">:=</span><span class="token function">NewMerkleNode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nodes<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nodes<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">)</span>newnodes<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>newnodes<span class="token punctuation">,</span><span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">{</span>node<span class="token operator">:=</span><span class="token function">NewMerkleNode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nodes<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nodes<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">)</span>newnodes<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>newnodes<span class="token punctuation">,</span><span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">}</span>nodes<span class="token operator">=</span>newnodes<span class="token punctuation">}</span>NewTree<span class="token punctuation">.</span>RootNode<span class="token operator">=</span><span class="token operator">&amp;</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">return</span> NewTree<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>SPVè¯æ˜è·¯å¾„ï¼Œè‡ªåº•å‘ä¸Šè·å–èŠ‚ç‚¹çš„è·¯å¾„çš„å…„å¼Ÿç»“ç‚¹çš„å“ˆå¸Œå€¼</p><p>å…ˆæ ¹æ®ç»“ç‚¹çš„indexåˆ¤æ–­èŠ‚ç‚¹åœ¨æ ‘çš„å…·ä½“ä½ç½®ï¼Œè‡ªé¡¶å‘ä¸‹è®¿é—®è·¯å¾„ï¼Œå†å°†è·¯å¾„é€†åºå³å¯è·å–SPVè¯æ˜è·¯å¾„</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>MerkleTree<span class="token punctuation">)</span> <span class="token function">SPVproof</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>t_len<span class="token operator">:=</span><span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Leaf<span class="token punctuation">)</span><span class="token keyword">if</span> index<span class="token operator">&gt;</span>t_len<span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Outof Index"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>depth<span class="token operator">:=</span><span class="token number">0</span>leaf_number<span class="token operator">:=</span><span class="token number">1</span>t_node<span class="token operator">:=</span>t<span class="token punctuation">.</span>RootNode<span class="token punctuation">.</span>Left<span class="token keyword">for</span> t_node<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">{</span>t_node<span class="token operator">=</span>t_node<span class="token punctuation">.</span>Leftdepth<span class="token operator">+=</span><span class="token number">1</span>leaf_number<span class="token operator">*=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token keyword">var</span> n_path <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>t_node<span class="token operator">=</span>t<span class="token punctuation">.</span>RootNode<span class="token keyword">for</span> t_node<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> t_node<span class="token punctuation">.</span>Left<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">{</span><span class="token keyword">if</span> index<span class="token operator">&gt;=</span>leaf_number<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">{</span>index<span class="token operator">-=</span>leaf_number<span class="token operator">/</span><span class="token number">2</span>n_path<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>n_path<span class="token punctuation">,</span>t_node<span class="token punctuation">.</span>Left<span class="token punctuation">.</span>Data<span class="token punctuation">)</span>t_node<span class="token operator">=</span>t_node<span class="token punctuation">.</span>Right<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>n_path<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>n_path<span class="token punctuation">,</span>t_node<span class="token punctuation">.</span>Right<span class="token punctuation">.</span>Data<span class="token punctuation">)</span>t_node<span class="token operator">=</span>t_node<span class="token punctuation">.</span>Left<span class="token punctuation">}</span>leaf_number<span class="token operator">/=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token keyword">var</span> path <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>n_path<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">{</span>path<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>n_path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n_path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> path<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>éªŒè¯SPVè·¯å¾„ï¼Œå°†è¯¥èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å’ŒSPVè¯æ˜è·¯å¾„ä¾æ¬¡è®¡ç®—ï¼Œæœ€ç»ˆå’Œæ ¹èŠ‚ç‚¹çš„å“ˆå¸Œå€¼æ¯”è¾ƒå³å¯å®ŒæˆSPVè·¯å¾„çš„éªŒè¯ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>MerkleTree<span class="token punctuation">)</span> <span class="token function">VerifyProof</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">,</span> path <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> index<span class="token operator">&gt;</span><span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Leaf<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Outof Index"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>data_sha<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Leaf<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>n_data<span class="token operator">:=</span>data_sha<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span>t_data <span class="token operator">:=</span><span class="token keyword">range</span> path<span class="token punctuation">{</span><span class="token keyword">if</span> index<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">{</span>temp<span class="token operator">:=</span><span class="token function">append</span><span class="token punctuation">(</span>t_data<span class="token punctuation">,</span>n_data<span class="token operator">...</span><span class="token punctuation">)</span>temp2<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>n_data<span class="token operator">=</span>temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>temp<span class="token operator">:=</span><span class="token function">append</span><span class="token punctuation">(</span>n_data<span class="token punctuation">,</span>t_data<span class="token operator">...</span><span class="token punctuation">)</span>temp2<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>n_data<span class="token operator">=</span>temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span>index<span class="token operator">/=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>n_data<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">{</span><span class="token keyword">if</span> t<span class="token punctuation">.</span>RootNode<span class="token punctuation">.</span>Data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>n_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="åˆ¤æ–­Coinbaseäº¤æ˜“"><a href="#åˆ¤æ–­Coinbaseäº¤æ˜“" class="headerlink" title="åˆ¤æ–­Coinbaseäº¤æ˜“"></a>åˆ¤æ–­Coinbaseäº¤æ˜“</h4><p>æ¯ä¸ªåŒºå—æ–°å»ºç«‹æ—¶ï¼Œå¯ä»¥åŠ å…¥ä¸€ç¬”coinbaseäº¤æ˜“ï¼Œè¿™ç¬”äº¤æ˜“åªæœ‰è¾“å‡ºï¼Œæ²¡æœ‰è¾“å…¥ï¼Œåˆ¤æ–­çš„åŸºæœ¬ä¾æ®ä¸ºï¼š</p><ul><li>åªå‡ºç°åœ¨ç¬¬ä¸€ç¬”äº¤æ˜“ï¼Œå…¶ä»–äº¤æ˜“å‡ä¸æ˜¯coinbaseäº¤æ˜“</li><li>è¾“å…¥çš„Txidä¸ºç©ºï¼ŒVoutä¸º-1</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Transaction<span class="token punctuation">)</span> <span class="token function">IsCoinBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Vin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Txid<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span>  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>Vin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Vout<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Vin<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Vin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Txid<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>Vin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Vout<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®¡ç®—å…¬é’¥å¯¹åº”çš„åœ°å€"><a href="#è®¡ç®—å…¬é’¥å¯¹åº”çš„åœ°å€" class="headerlink" title="è®¡ç®—å…¬é’¥å¯¹åº”çš„åœ°å€"></a>è®¡ç®—å…¬é’¥å¯¹åº”çš„åœ°å€</h4><p>æ¯”ç‰¹å¸ä¸Šçš„åœ°å€çš„è®¡ç®—å¦‚ä¸‹</p><ol><li>è®¡ç®—å…¬é’¥çš„å“ˆå¸Œå€¼ï¼ˆ<code>RIPEMD16(SHA256(PubKey))</code>ï¼‰</li><li>åœ°å€è®¡ç®—å‰åŠ å…¥ç‰ˆæœ¬å·</li><li>æŠŠæ­¥éª¤2çš„å†…å®¹é€šè¿‡è®¡ç®—å…¬é’¥å“ˆå¸Œçš„åŒé‡SHA256å“ˆå¸ŒåŠ å¯†ï¼Œå–<strong>å‰4ä¸ªå­—èŠ‚</strong>ä½œä¸ºæ ¡éªŒå’Œ</li><li><code>ç‰ˆæœ¬å·ï¼Œå…¬é’¥å“ˆå¸Œï¼Œæ ¡éªŒå’Œ</code>çš„ç»„åˆé€šè¿‡Base58åŠ å¯†ç”Ÿæˆæ¯”ç‰¹å¸çš„åœ°å€</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>Wallet<span class="token punctuation">)</span> <span class="token function">GetAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>key_hash<span class="token operator">:=</span><span class="token function">HashPublicKey</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>PublicKey<span class="token punctuation">)</span><span class="token keyword">var</span> temp <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>temp<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span>version<span class="token punctuation">)</span>temp<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span>key_hash<span class="token operator">...</span><span class="token punctuation">)</span>checksum<span class="token operator">:=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>hash_checksum<span class="token operator">:=</span>checksum<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>checksum<span class="token operator">=</span>sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>hash_checksum<span class="token punctuation">)</span>hash_checksum<span class="token operator">=</span>checksum<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token keyword">var</span> res <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>res<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span>version<span class="token punctuation">)</span>res<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span>key_hash<span class="token operator">...</span><span class="token punctuation">)</span>res<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span>hash_checksum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>checkSumlen<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>res<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>base58<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> res<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="P2PKHé”å®šéƒ¨åˆ†"><a href="#P2PKHé”å®šéƒ¨åˆ†" class="headerlink" title="P2PKHé”å®šéƒ¨åˆ†"></a>P2PKHé”å®šéƒ¨åˆ†</h4><p>P2PKHæŒ‡çš„æ˜¯å‘å…¬é’¥çš„å“ˆå¸Œæ”¯ä»˜ï¼Œæ ¹æ®å…¬é’¥çš„åœ°å€çš„è®¡ç®—æ–¹æ³•ï¼Œç±»ä¼¼çš„å¯ä»¥é€šå…¬é’¥åœ°å€è·å–å…¬é’¥çš„å“ˆå¸Œï¼š</p><p>å…¬é’¥åœ°å€ç»è¿‡base58è§£ç åï¼Œç¬¬ä¸€ä½æ˜¯versionç‰ˆæœ¬å·ï¼Œåå››ä½ä¸ºæ ¡éªŒå’Œï¼Œä¸­é—´å³ä¸ºå…¬é’¥å“ˆå¸Œ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>out <span class="token operator">*</span>TXOutput<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span>address <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>data<span class="token punctuation">,</span><span class="token boolean">_</span><span class="token operator">:=</span>base58<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>out<span class="token punctuation">.</span>PubKeyHash<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h3><p>å€ŸåŠ©<code>go test</code>å¯¹å®éªŒç»“æœè¿›è¡Œæ£€éªŒ</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">PS E:\2023spring\blockchain\lab2\lab2&gt; go testPASSok      lab2    0.657s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="PART2"><a href="#PART2" class="headerlink" title="PART2"></a>PART2</h2><h3 id="å®éªŒç›®çš„-1"><a href="#å®éªŒç›®çš„-1" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><ul><li>è¿›ä¸€æ­¥ç†è§£åŒºå—é“¾ä¸Šçš„æ•°æ®ç»“æ„</li><li>å®ç°åŸºäºçš„POWå…±è¯†ç®—æ³•å‡ºå—</li><li>å®ç°æ¯”ç‰¹å¸ä¸Šçš„è´¦æˆ·åˆ›å»ºå’ŒæŸ¥è¯¢</li><li>ç†è§£UTXOçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</li><li>å®ç°åŒºå—é“¾ä¸æ•°æ®åº“çš„äº¤äº’</li></ul><h3 id="å®éªŒå†…å®¹-1"><a href="#å®éªŒå†…å®¹-1" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h3><h4 id="å·¥ä½œé‡è¯æ˜"><a href="#å·¥ä½œé‡è¯æ˜" class="headerlink" title="å·¥ä½œé‡è¯æ˜"></a>å·¥ä½œé‡è¯æ˜</h4><p>å·¥ä½œé‡çš„è¯æ˜æœºåˆ¶ï¼ˆPOWï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æäº¤ä¸€ä¸ªå®¹æ˜“æ£€æµ‹ï¼Œä½†æ˜¯éš¾ä»¥è®¡ç®—çš„ç»“æœï¼Œæ¥è¯æ˜èŠ‚ç‚¹åšè¿‡ä¸€å®šé‡çš„å·¥ä½œã€‚</p><p>é¦–å…ˆå®Œæˆ<code>Run</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä»£è¡¨çŸ¿å·¥é€šè¿‡å¦‚ä¸‹æµç¨‹å®ŒæˆæŒ–çŸ¿å·¥ä½œï¼š</p><ol><li>é¦–å…ˆæ„å»ºå½“å‰åŒºå—å¤´ï¼ŒåŒºå—å¤´åŒ…å«<strong>ç‰ˆæœ¬å·ï¼Œä¸Šâ¼€ä¸ªåŒºå—å“ˆå¸Œå€¼(32ä½)ï¼Œå½“å‰åŒºå—æ•°æ®å¯¹åº”å“ˆå¸Œï¼ˆ32ä½ï¼Œå³åŒºå—æ•°æ®çš„merkleæ ¹ï¼‰ï¼Œæ—¶é—´æˆ³ï¼ŒåŒºå—éš¾åº¦ï¼Œè®¡æ•°å™¨(nonce)</strong>ã€‚</li><li>æ·»åŠ è®¡æ•°å™¨ï¼Œä½œä¸ºéšæœºæ•°ã€‚è®¡ç®—å™¨ä»0å¼€å§‹åŸºç¡€ï¼Œæ¯ä¸ªå›åˆ<strong>+1</strong></li><li>å¯¹äºä¸Šè¿°çš„æ•°æ®æ¥è¿›è¡Œä¸€ä¸ªå“ˆå¸Œçš„æ“ä½œã€‚</li><li>åˆ¤æ–­ç»“æœæ˜¯å¦æ»¡è¶³è®¡ç®—çš„æ¡ä»¶ï¼š<ol><li>å¦‚æœç¬¦åˆï¼Œåˆ™å¾—åˆ°äº†æ»¡è¶³ç»“æœã€‚</li><li>å¦‚æœæ²¡æœ‰ç¬¦åˆï¼Œä»2å¼€å§‹é‡æ–°ç›´æ¥2ã€3ã€4æ­¥éª¤ã€‚</li></ol></li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pow <span class="token operator">*</span>ProofOfWork<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>nonce <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">var</span> hash <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token keyword">var</span> hashInt big<span class="token punctuation">.</span>Intblkh <span class="token operator">:=</span> pow<span class="token punctuation">.</span>block<span class="token punctuation">.</span>Header<span class="token keyword">for</span> nonce <span class="token operator">&lt;</span> maxNonce <span class="token punctuation">{</span><span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>blkh<span class="token punctuation">.</span>PrevBlockHash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>blkh<span class="token punctuation">.</span>MerkleRoot<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Timestamp<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Bits<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>hash <span class="token operator">=</span> sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>hashInt<span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">if</span> hashInt<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>pow<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>nonce<span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> nonce<span class="token punctuation">,</span> hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€ŸåŠ©<code>Validate</code>å‡½æ•°å®Œæˆå¯¹æŒ–çŸ¿ç»“æœçš„éªŒè¯ï¼Œå³éªŒè¯çŸ¿å·¥ç»™å‡ºçš„<code>Nonce</code>æ˜¯å¦æ˜¯è¯¥éš¾é¢˜çš„ç­”æ¡ˆã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pow <span class="token operator">*</span>ProofOfWork<span class="token punctuation">)</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span><span class="token keyword">var</span> hashInt big<span class="token punctuation">.</span>Int<span class="token keyword">var</span> hash <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">byte</span>blkh <span class="token operator">:=</span> pow<span class="token punctuation">.</span>block<span class="token punctuation">.</span>Header<span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>blkh<span class="token punctuation">.</span>PrevBlockHash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>blkh<span class="token punctuation">.</span>MerkleRoot<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Timestamp<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Bits<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token function">IntToHex</span><span class="token punctuation">(</span>blkh<span class="token punctuation">.</span>Nonce<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>hash <span class="token operator">=</span> sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>hashInt<span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">return</span> hashInt<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>pow<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="UTXO"><a href="#UTXO" class="headerlink" title="UTXO"></a>UTXO</h4><p>UTXO(Unspent Transaction Outputs)ï¼Œå³æ²¡æœ‰èŠ±æ‰çš„äº¤æ˜“è¾“å‡ºï¼Œå®é™…å¯ä»¥ç†è§£ä¸ºåœ¨ä¸€æ¬¡è½¬è´¦æ—¶å‰©ä½™æ²¡æœ‰è½¬å‡ºçš„èµ„é‡‘ã€‚UTXOçš„äº¤æ˜“æ¨¡å‹ä¸Šï¼Œç”¨æˆ·é€šè¿‡ä½¿ç”¨æœªä½¿ç”¨çš„äº¤æ˜“è¾“å‡ºï¼ˆUTXOï¼‰æ¥æ‰§è¡Œä¸€ç¬”äº¤æ˜“ã€‚</p><p>æ„å»ºæ–°çš„UTXOäº¤æ˜“çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>æ‰¾åˆ°è¾“å…¥åœ°å€å¯¹åº”çš„äº¤æ˜“PubKeyHashï¼Œå€ŸåŠ©<code>findunspentOutputs</code>æ‰¾åˆ°è¾“å…¥è´¦æˆ·çš„UTXO</li><li>æ ¹æ®UTXOæ„å»ºäº¤æ˜“å¹¶è¿›è¡Œç­¾å</li><li>å®Œæˆæ‰¾é›¶æ“ä½œï¼šå‰©ä½™çš„é‡‘é¢ä½œä¸ºUTXOè¿”å›åˆ°åŸè¾“å…¥ä¸­</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewUTXOTransaction</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> to <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">,</span> UTXOSet <span class="token operator">*</span>UTXOSet<span class="token punctuation">)</span> <span class="token operator">*</span>Transaction <span class="token punctuation">{</span><span class="token keyword">var</span> inputs <span class="token punctuation">[</span><span class="token punctuation">]</span>TXInput<span class="token keyword">var</span> outputs <span class="token punctuation">[</span><span class="token punctuation">]</span>TXOutputwal <span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">NewWallets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>bc <span class="token operator">:=</span> UTXOSet<span class="token punctuation">.</span>BlockchainpubKeyHash <span class="token operator">:=</span> <span class="token function">HashPublicKey</span><span class="token punctuation">(</span>wal<span class="token punctuation">.</span><span class="token function">GetWallet</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span>PublicKey<span class="token punctuation">)</span>acc<span class="token punctuation">,</span> validOutputs <span class="token operator">:=</span> UTXOSet<span class="token punctuation">.</span><span class="token function">FindUnspentOutputs</span><span class="token punctuation">(</span>pubKeyHash<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token keyword">if</span> acc <span class="token operator">&lt;</span> amount <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token string">"ERROR: Not enough funds"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> txid<span class="token punctuation">,</span> outs <span class="token operator">:=</span> <span class="token keyword">range</span> validOutputs <span class="token punctuation">{</span>txID<span class="token punctuation">,</span> err <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span>txid<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> out <span class="token operator">:=</span> <span class="token keyword">range</span> outs <span class="token punctuation">{</span>input <span class="token operator">:=</span> TXInput<span class="token punctuation">{</span>Txid<span class="token punctuation">:</span>      txID<span class="token punctuation">,</span>Vout<span class="token punctuation">:</span>      out<span class="token punctuation">,</span>Signature<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>PubKey<span class="token punctuation">:</span>    wal<span class="token punctuation">.</span><span class="token function">GetWallet</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span>PublicKey<span class="token punctuation">,</span><span class="token punctuation">}</span>inputs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">}</span>out_1 <span class="token operator">:=</span> TXOutput<span class="token punctuation">{</span>amount<span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">}</span>out_1<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>outputs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> out_1<span class="token punctuation">)</span><span class="token keyword">if</span> acc <span class="token operator">&gt;</span> amount <span class="token punctuation">{</span>out_2 <span class="token operator">:=</span> TXOutput<span class="token punctuation">{</span>acc<span class="token operator">-</span>amount<span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">}</span>out_2<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>outputs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> out_2<span class="token punctuation">)</span> <span class="token punctuation">}</span>tx <span class="token operator">:=</span> Transaction<span class="token punctuation">{</span><span class="token boolean">nil</span><span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> outputs<span class="token punctuation">}</span>bc<span class="token punctuation">.</span><span class="token function">SignTransaction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tx<span class="token punctuation">,</span>wal<span class="token punctuation">.</span><span class="token function">GetWallet</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span>tx<span class="token punctuation">.</span><span class="token function">SetID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>tx<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="UTXOæ± "><a href="#UTXOæ± " class="headerlink" title="UTXOæ± "></a>UTXOæ± </h4><p>æ¯”ç‰¹å¸æ‰€æœ‰çš„äº¤æ˜“éƒ½æ˜¯æ”¾åœ¨UTXOæ± ä¸­ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸ºäº†å¿«é€Ÿçš„å¾—åˆ°æŸä¸ªUTXOæ˜¯å¦å½“å‰å¯ç”¨ã€‚éœ€è¦é€šè¿‡å…¬ç§é’¥çš„å”¯ä¸€æ ‡è¯†æ¥ç®—å‡ºæˆ‘ä»¬å½“å‰çš„ä½™é¢ã€‚åœ¨æ„å»ºUTXOçš„äº¤æ˜“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡UTXOæ± æ¥éœ€è¦å½“å‰å±äºè‡ªå·±çš„UTXOï¼Œç„¶åè·å¾—ç›¸å¯¹åº”çš„è´¦æˆ·é‡‘é¢ï¼Œç„¶åå†ç”Ÿæˆå¯¹åº”çš„è¾“å‡ºã€‚<code>FindUnspentOutputs</code>å‡½æ•°æ¥æŸ¥è¯¢ç”¨æˆ·å½“å‰æœªæœªèŠ±è´¹çš„UTXOé‡‘é¢åŠå…¶æ˜ å°„å…³ç³»(å­˜å‚¨txidå’Œå¯¹åº”çš„indexï¼Œä¾¿äºåç»­æŸ¥æ‰¾)ï¼Œå…·ä½“å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>u UTXOSet<span class="token punctuation">)</span> <span class="token function">FindUnspentOutputs</span><span class="token punctuation">(</span>pubkeyHash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>unspentOutputs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>totalAmount <span class="token operator">:=</span> <span class="token number">0</span>db <span class="token operator">:=</span> u<span class="token punctuation">.</span>Blockchain<span class="token punctuation">.</span>dberr <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>bolt<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>b <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Bucket</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>utxoBucket<span class="token punctuation">)</span><span class="token punctuation">)</span>c <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">Cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> k<span class="token punctuation">,</span> v <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>outs <span class="token operator">:=</span> <span class="token function">DeserializeOutputs</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>txid <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token keyword">for</span> outIndex<span class="token punctuation">,</span> out <span class="token operator">:=</span> <span class="token keyword">range</span> outs<span class="token punctuation">.</span>Outputs <span class="token punctuation">{</span><span class="token keyword">if</span> out<span class="token punctuation">.</span><span class="token function">IsLockedWithKey</span><span class="token punctuation">(</span>pubkeyHash<span class="token punctuation">)</span>  <span class="token punctuation">{</span>unspentOutputs<span class="token punctuation">[</span>txid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>unspentOutputs<span class="token punctuation">[</span>txid<span class="token punctuation">]</span><span class="token punctuation">,</span> outIndex<span class="token punctuation">)</span>totalAmount <span class="token operator">+=</span> out<span class="token punctuation">.</span>Value<span class="token keyword">if</span> totalAmount <span class="token operator">&gt;=</span> amount <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> totalAmount<span class="token punctuation">,</span> unspentOutputs<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="BlockChain"><a href="#BlockChain" class="headerlink" title="BlockChain"></a>BlockChain</h4><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å®Œæˆ<code>mineblock</code>æ¥ç”Ÿæˆæ–°çš„åŒºå—ï¼šé’ˆå¯¹ä¸€ç»„äº¤æ˜“åœ¨åŒºå—é“¾ä¸Šå†™å…¥ä¸€ä¸ªæ–°å—ï¼Œç»´æŠ¤åŒºå—é“¾çš„ç›¸å…³ä¿¡æ¯</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>bc <span class="token operator">*</span>Blockchain<span class="token punctuation">)</span> <span class="token function">MineBlock</span><span class="token punctuation">(</span>transactions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Transaction<span class="token punctuation">)</span> <span class="token operator">*</span>Block <span class="token punctuation">{</span><span class="token keyword">var</span> last_hash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>err <span class="token operator">:=</span> bc<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>bolt<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>b <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Bucket</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>blocksBucket<span class="token punctuation">)</span><span class="token punctuation">)</span>last_hash <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">var</span> prev_hash <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token function">copy</span><span class="token punctuation">(</span>prev_hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span>last_hash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>newBlock <span class="token operator">:=</span> <span class="token function">NewBlock</span><span class="token punctuation">(</span>transactions<span class="token punctuation">,</span>prev_hash<span class="token punctuation">)</span>err <span class="token operator">=</span> bc<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>bolt<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>b <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Bucket</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>blocksBucket<span class="token punctuation">)</span><span class="token punctuation">)</span>b<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>newBlock<span class="token punctuation">.</span><span class="token function">CalCulHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newBlock<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newBlock<span class="token punctuation">.</span><span class="token function">CalCulHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>bc<span class="token punctuation">.</span>tip <span class="token operator">=</span> newBlock<span class="token punctuation">.</span><span class="token function">CalCulHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> newBlock<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ï¼Œä¸ºäº†ç»´æŠ¤UTXOï¼Œéœ€è¦æ‰¾åˆ°æ‰€æœ‰UTXOå¹¶æ„å»ºæ˜ å°„ï¼Œé€šè¿‡å‡½æ•°<code>findUTXO</code>å®ç°ï¼š</p><ul><li>UTXOçš„ç‰¹ç‚¹ï¼šâ€œæœªä½¿ç”¨çš„äº¤æ˜“â€</li><li>å¯¹äºæ¯ç¬”éCoinBaseäº¤æ˜“ï¼Œæ¯ä¸ªè¾“å…¥éƒ½æŒ‡å‘ä¹‹å‰çš„è¾“å‡ºï¼Œæ ¹æ®æ‰€æœ‰äº¤æ˜“çš„è¾“å…¥åˆ¤æ–­ä¹‹å‰çš„äº¤æ˜“æ˜¯å¦å·²è¢«è¾“å‡º</li><li>ç»´æŠ¤UTXOå’ŒspentTXOsé€šè¿‡å¾ªç¯æ±‚å¾—æœ€ç»ˆçš„UTXO</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>bc <span class="token operator">*</span>Blockchain<span class="token punctuation">)</span> <span class="token function">FindUTXO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>TXOutputs <span class="token punctuation">{</span>UTXO <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>TXOutputs<span class="token punctuation">)</span>spentTXOs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>bci <span class="token operator">:=</span> bc<span class="token punctuation">.</span><span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token punctuation">{</span>block <span class="token operator">:=</span> bci<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> block<span class="token punctuation">.</span><span class="token function">GetTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>txID <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>Outputs<span class="token punctuation">:</span><span class="token keyword">for</span> outIdx<span class="token punctuation">,</span> out <span class="token operator">:=</span> <span class="token keyword">range</span> tx<span class="token punctuation">.</span>Vout <span class="token punctuation">{</span><span class="token keyword">if</span> spentTXOs<span class="token punctuation">[</span>txID<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> spentOutIdx <span class="token operator">:=</span> <span class="token keyword">range</span> spentTXOs<span class="token punctuation">[</span>txID<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token keyword">if</span> spentOutIdx <span class="token operator">==</span> outIdx <span class="token punctuation">{</span><span class="token keyword">continue</span> Outputs<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>outs <span class="token operator">:=</span> UTXO<span class="token punctuation">[</span>txID<span class="token punctuation">]</span>outs<span class="token punctuation">.</span>Outputs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>outs<span class="token punctuation">.</span>Outputs<span class="token punctuation">,</span> out<span class="token punctuation">)</span>UTXO<span class="token punctuation">[</span>txID<span class="token punctuation">]</span> <span class="token operator">=</span> outs<span class="token punctuation">}</span><span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">IsCoinBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> in <span class="token operator">:=</span> <span class="token keyword">range</span> tx<span class="token punctuation">.</span>Vin <span class="token punctuation">{</span>inTxID <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>Txid<span class="token punctuation">)</span>spentTXOs<span class="token punctuation">[</span>inTxID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>spentTXOs<span class="token punctuation">[</span>inTxID<span class="token punctuation">]</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span>Vout<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> block<span class="token punctuation">.</span><span class="token function">GetPrevhash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> UTXO<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å®éªŒç»“æœ-1"><a href="#å®éªŒç»“æœ-1" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h4><p>æœ¬æ¬¡å®éªŒåŸºæœ¬å®Œæˆäº†åŸºäºæ¯”ç‰¹å¸çš„åŒºå—é“¾æ­å»ºï¼Œå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">go run .  createblockchain -address ADDRESS //åˆ›å»ºåŒºå—é“¾go run .  createwallet //åˆ›å»ºé’±åŒ…go run .  getbalance -address ADDRESS //æŸ¥è¯¢è´¦æˆ·ä½™é¢go run .  listaddresses //æŸ¥è¯¢åŒºå—é“¾ä¸Šçš„åœ°å€go run .  printchain //æ‰“å°åŒºå—é“¾go run .  reindexutxo //é‡æ„UTXOæ± go run .  send -from FROM -to TO -amount AMOUNT //å‘èµ·è½¬è´¦äº¤æ˜“<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹å®ç°çš„åŒºå—é“¾è¿›è¡Œ<code>go test</code></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">...</span>PASSok      lab3    <span class="token number">0.188</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;PART1&quot;&gt;&lt;a href=&quot;#PART1&quot; class=&quot;headerlink&quot; title=&quot;PART1&quot;&gt;&lt;/a&gt;PART1&lt;/h2&gt;&lt;h3 id=&quot;å®éªŒç›®çš„&quot;&gt;&lt;a href=&quot;#å®éªŒç›®çš„&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒç›®çš„&quot;</summary>
      
    
    
    
    <category term="åŒºå—é“¾" scheme="http://sn1987a-1.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>ä»£æ•°ç»“æ„ä¹ é¢˜è¯¾-1</title>
    <link href="http://sn1987a-1.github.io/posts/94cbcba9.html"/>
    <id>http://sn1987a-1.github.io/posts/94cbcba9.html</id>
    <published>2023-05-02T12:48:34.000Z</published>
    <updated>2023-09-23T13:29:20.211Z</updated>
    
    <content type="html"><![CDATA[<p><strong>2023springä»£æ•°ç»“æ„ä¹ é¢˜è¯¾è®²ä¹‰</strong></p><h2 id="ä»£æ•°ç»“æ„-ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾"><a href="#ä»£æ•°ç»“æ„-ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾" class="headerlink" title="ä»£æ•°ç»“æ„ ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾"></a>ä»£æ•°ç»“æ„ ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾</h2><p>2023.5.3</p><h3 id="ç¬¬ä¸‰ç« -æ˜ å°„"><a href="#ç¬¬ä¸‰ç« -æ˜ å°„" class="headerlink" title="ç¬¬ä¸‰ç«  æ˜ å°„"></a>ç¬¬ä¸‰ç«  æ˜ å°„</h3><h4 id="å†…å®¹å›é¡¾"><a href="#å†…å®¹å›é¡¾" class="headerlink" title="å†…å®¹å›é¡¾"></a>å†…å®¹å›é¡¾</h4><ul><li>æ˜ å°„çš„åŸºæœ¬å®šä¹‰<ul><li>æ¦‚å¿µï¼šæ˜ å°„ï¼ŒåŸåƒï¼Œåƒï¼Œå€¼åŸŸï¼Œæ˜ å°„ç›¸ç­‰</li><li>ç»™å®šé›†åˆAï¼ŒBï¼Œä»Aåˆ°Bçš„æ˜ å°„æœ‰$|B|^{|A|}$ä¸ª</li></ul></li><li>ç‰¹æ®Šæ˜ å°„ï¼šå¯¹äº$f:A\rightarrow B$:<ul><li>$B=A,\forall a,f(a)=a$ï¼šæ’ç­‰æ˜ å°„</li><li>$R_f=B$ï¼šæ»¡å°„</li><li>ä»»ç»™$a_1,a_2\in A,a_1\neq a_2\Rightarrow f(a_1)\neq f(a_2)$ï¼šå•å°„</li><li>å•å°„+æ»¡å°„ï¼šä¸€ä¸€æ˜ å°„ï¼ˆåŒå°„ï¼‰ ç›¸å…³æ€§è´¨ï¼š$f^{-1}$ï¼Œ$n!$ä¸ªåŒå°„</li></ul></li><li>æ˜ å°„çš„å¤åˆï¼š$g\circ f(a)=g(f(a))$ <em>ä»å³å¾€å·¦è®¡ç®—</em><ul><li>ç»“åˆå¾‹ï¼š$(h\circ g)\circ f=h\circ (g\circ f)$</li><li>$f^{-1}\circ f=f\circ f^{-1}=I_A$</li><li>å¤åˆè¿ç®—ä¿æŒå•å°„/æ»¡å°„/åŒå°„</li></ul></li><li>ç½®æ¢ï¼šæ˜ å°„åˆ°è‡ªèº«çš„<strong>åŒå°„</strong><ul><li>æ’ç­‰æ˜ å°„ä¹Ÿå¯ä»¥ç§°ä¸ºæ’ç­‰ç½®æ¢</li><li>æ±‚é€†ç½®æ¢ï¼šäº¤æ¢ä¸¤è¡Œå¹¶æŒ‰ç…§ç¬¬ä¸€è¡Œæ’åº</li><li>å¥‡ç½®æ¢ä¸å¶ç½®æ¢ï¼šç”±é€†åºçš„ä¸ªæ•°å¥‡å¶å†³å®š</li></ul></li><li>è½®æ¢ï¼šç‰¹æ®Šçš„ç½®æ¢ï¼Œ$\sigma=(a_1a_2â€¦a_r)$<ul><li><em>ä¸ç›¸äº¤</em>çš„è½®æ¢çš„ä¹˜ç§¯å¯ä»¥äº¤æ¢</li><li>ä»»ä½•ç½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆè‹¥å¹²ä¸ç›¸äº¤çš„è½®æ¢ä¹‹ä¹˜ç§¯</li><li>ç½®æ¢çš„é˜¶ï¼šå°†ç½®æ¢è¡¨ç¤ºä¸ºä¸ç›¸äº¤çš„è½®æ¢ï¼Œé˜¶ä¸ºå„è½®æ¢çš„å› å­é•¿åº¦çš„æœ€å°å…¬å€æ•°</li></ul></li><li>å¯¹æ¢ï¼šä¸¤ä¸ªå…ƒç´ çš„è½®æ¢<ul><li>ä»»ä½•è½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆå¯¹æ¢ä¹‹ç§¯</li><li>å¯¹æ¢æ˜¯å¥‡ç½®æ¢ï¼Œnå…ƒç½®æ¢ä¸­ï¼Œå¥‡ç½®æ¢å’Œå¶ç½®æ¢å„å ä¸€åŠ</li></ul></li><li>å¼€å…³å‡½æ•°ï¼š$F_2={0,1},f(x_1,â€¦x_n)$ä¸º$F_2^n$åˆ°$F_2$çš„æ˜ å°„å³ä¸ºnå…ƒå¼€å…³å‡½æ•°ï¼Œå…±æœ‰$2^{2^n}$ä¸ª<ul><li>æ±‚è¡¥è¿ç®—$\overline f$ï¼Œé€»è¾‘åŠ  $ +$ï¼Œé€»è¾‘ä¹˜  $ \cdot$     ï¼ˆæ³¨æ„å’Œç®—æœ¯è¿ç®—çš„åŒºåˆ«ï¼‰</li><li>ç»“åˆå¾‹ï¼Œäº¤æ¢å¾‹ï¼Œåˆ†é…å¾‹ï¼Œ$f+0=f;f\cdot 1=f;f+\overline f=1;f\cdot \overline f=0$</li><li>å°é¡¹è¡¨è¾¾å¼ï¼šå”¯ä¸€çš„è¡¨è¾¾$f(x_1,..x_n)=\sum_{a_i=0/1,1\leq i\leq n} f(a_1,..a_n)x_1^{a_1}â€¦x_n^{a_n}$</li></ul></li></ul><h4 id="ä½œä¸šé¢˜ç›®"><a href="#ä½œä¸šé¢˜ç›®" class="headerlink" title="ä½œä¸šé¢˜ç›®"></a>ä½œä¸šé¢˜ç›®</h4><p><img src="file:///C:\Users\SN1987A\Documents\Tencent Files\945093063\Image\C2C\46D000D57075B73B5A3DF00E1FBC3BF1.png" alt="img" style="zoom:50%;"></p><p><img src="file:///C:\Users\SN1987A\Documents\Tencent Files\945093063\Image\C2C\9DE5D0814A324D580516AA5C871458E6.png" alt="img" style="zoom:50%;"></p><p><strong>3.16 è¯æ˜ï¼šä»»ä½•nå…ƒç½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆ(1 2),(2 3),â€¦,(n-1,n)çš„ä¹˜ç§¯</strong></p><p>æ–¹æ³•1ï¼šç”¨å½’çº³æ³•è¯æ˜ï¼š</p><p>n=2æ—¶ï¼Œ2å…ƒç½®æ¢å³ä¸º(1 2);</p><p>n&gt;2æ—¶ï¼Œå‡è®¾å¯¹äºä»»ä½•kï¼Œ$k\le n$,æ»¡è¶³ä»»ä½•kå…ƒç½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆ(1 2),(2 3),â€¦,(k-1,k)çš„ä¹˜ç§¯ï¼Œè€ƒè™‘ä»»ä½•ä¸€ä¸ªnå…ƒç½®æ¢$\sigma$,è®¾è¯¥ç½®æ¢å¯¹åº”çš„ä½ç½®içš„å…ƒç´ ä¸ºnï¼Œä»¤$\tau=(n-1\ n)â€¦(i+1\ i+2)(i\ i+1)\sigma$ï¼Œä¾æ¬¡è®¡ç®—ï¼Œå³ä¸ºå°†$\sigma$çš„ç¬¬iä¸ªå…ƒç´ å’Œç¬¬i+1ä¸ªå…ƒç´ å¯¹æ¢ï¼Œç¬¬i+1ä¸ªå…ƒç´ å’Œç¬¬i+2ä¸ªå…ƒç´ å¯¹æ¢â€¦æœ€ç»ˆå¯ä»¥å°†å…ƒç´ næ¢åˆ°ç¬¬nä¸ªä½ç½®ï¼Œå³$\tau$ä¸ºï¼ˆn-1ï¼‰å…ƒç½®æ¢ï¼›å°†ä¸Šå¼è¿›è¡Œæ•´ç†ï¼ŒåŸnå…ƒç½®æ¢å¯ä»¥å†™ä¸º$\sigma=(i+1\ i+2)(i\ i+1)â€¦(n-1\ n)\tau$ï¼Œæ ¹æ®å½’çº³å‡è®¾ï¼Œ$\tau$å¯ä»¥å†™ä¸º(1 2),(2 3),â€¦,(k-1,k)çš„ä¹˜ç§¯ï¼Œå› æ­¤$\sigma$å¯ä»¥å†™ä¸º(1 2),(2 3),â€¦,(n-1,n)çš„ä¹˜ç§¯ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œä»»ä½•nå…ƒç½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆ(1 2),(2 3),â€¦,(n-1,n)çš„ä¹˜ç§¯ã€‚</p><p>æ–¹æ³•2ï¼š</p><p>ä»»ä½•ç½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºä¸ºæˆä¸ç›¸äº¤çš„è½®æ¢ä¹‹ç§¯ï¼Œä»»ä½•è½®æ¢éƒ½å¯ä»¥è¡¨ç¤ºæˆå¯¹æ¢ä¹‹ç§¯ï¼Œå› æ­¤åªéœ€è®¨è®ºå°†å¯¹æ¢è¡¨ç¤ºä¸º(1 2),(2 3),â€¦,(n-1,n)çš„ä¹˜ç§¯ã€‚å¯¹æ¢$(a_i\ a_j),i&gt;j$å¯è¡¨ç¤ºä¸º$(a_{i+1}\ a_{i+2})â€¦(a_{j-2}\ a_{j-1})(a_{j-1}\ a_{j})â€¦(a_{i+1}\ a_{i+2})(a_i\ a_{i+1})$ä»è€Œå¾—è¯ã€‚</p><p><strong>3.17 æ±‚è¯ä¸‹åˆ—æ’ç­‰å¼</strong></p><p><strong>ï¼ˆ1ï¼‰$x_1=x_1x_2x_3+x_1\overline x_2x_3+x_1x_2\overline x_3+x_1\overline x_2\overline x_3$</strong></p><p><strong>$x_1=x_1(x_2+\overline x_2)(x_3+\overline x_3)=x_1x_2x_3+x_1\overline x_2x_3+x_1x_2\overline x_3+x_1\overline x_2\overline x_3$</strong></p><p><strong>ï¼ˆ2ï¼‰$x_1x_2+x_2x_3+x_3\overline x_1=x_1x_2+\overline x_1x_3$</strong></p><p><strong>$x_1x_2+x_2x_3+x_3\overline x_1=x_1x_2+x_2x_3(x_1+\overline x_1)+x_3\overline x_1 = x_1x_2(1+x_3)+\overline x_1x_3(x_2+1)=x_1x_2+\overline x_1x_3$</strong></p><p><strong>æ³¨æ„ï¼šå¼€å…³å‡½æ•°çš„è¿ç®—ä¸­$a+c=b+c$æ— æ³•æ¨å‡º$a=b$</strong></p><h4 id="è¡¥å……ä¹ é¢˜"><a href="#è¡¥å……ä¹ é¢˜" class="headerlink" title="è¡¥å……ä¹ é¢˜"></a>è¡¥å……ä¹ é¢˜</h4><p>æ³¨æ„ï¼Œåœ¨ç½®æ¢/å¯¹æ¢/è½®æ¢çš„è®¡ç®—ä¸­ï¼Œä¹˜ç§¯è¦ä»å³å¾€å·¦è®¡ç®—ï¼Œè½®æ¢çš„è®¡ç®—æ–¹å¼æ˜¯å°†æ¯ä¸ªå…ƒç´ æ˜ å°„åˆ°å³è¾¹çš„ä½ç½®ã€‚</p><h4 id="ç¬¬å››ç« -äºŒå…ƒå…³ç³»"><a href="#ç¬¬å››ç« -äºŒå…ƒå…³ç³»" class="headerlink" title="ç¬¬å››ç«  äºŒå…ƒå…³ç³»"></a>ç¬¬å››ç«  äºŒå…ƒå…³ç³»</h4><h4 id="å†…å®¹å›é¡¾-1"><a href="#å†…å®¹å›é¡¾-1" class="headerlink" title="å†…å®¹å›é¡¾"></a>å†…å®¹å›é¡¾</h4><p>å…³ç³»</p><ul><li>å…³ç³»çš„å®šä¹‰ï¼š<ul><li>ç›¸å…³æ¦‚å¿µï¼šç©ºå…³ç³»ï¼ˆå¹³å‡¡å…³ç³»ï¼‰ï¼Œå…¨å…³ç³»</li></ul></li><li>å…³ç³»çš„æ€§è´¨ï¼šåˆ¤æ–­æ˜¯å¦å…·æœ‰æŸç§æ€§è´¨<ul><li>è‡ªåæ€§ï¼Œåè‡ªåæ€§ï¼Œå¯¹ç§°æ€§ï¼Œåå¯¹ç§°æ€§ï¼Œä¼ é€’æ€§</li></ul></li><li>å…³ç³»çš„è¡¨ç¤ºï¼š<ul><li>æœ‰åºäºŒå…ƒç»„ï¼š$xRy$</li><li>å…³ç³»çŸ©é˜µï¼š$mij=\begin{cases}0,a_iR\mkern-10.5mu/ a_j\\1,a_iRa_j\end{cases} $</li><li>å…³ç³»å›¾ï¼šå¦‚æœæœ‰$a_iRa_j$ï¼Œåˆ™ç”»ä¸€æ¡ç”±$a_i$æŒ‡å‘$a_j$çš„æœ‰å‘å¼§ï¼ˆç¯ï¼‰</li></ul></li><li>å…³ç³»çš„è¿ç®—ï¼š<ul><li>ç›¸ç­‰ï¼Œ$&lt;,\leq,&gt;,\geq$</li><li>å¹¶äº¤è¡¥è¿ç®—ï¼ˆäº¤æ¢å¾‹ï¼Œç»“åˆå¾‹ï¼‰</li><li>å¤åˆå…³ç³» ï¼šç»“åˆå¾‹ï¼Œå¹‚è¿ç®—$R^n=R^m\circ R1^{n-m}$</li><li>è‡ªåé—­åŒ…ï¼šåŒ…å«Rä¸”æ»¡è¶³è‡ªåæ€§è´¨çš„æœ€å°å…³ç³»</li><li>å¯¹ç§°é—­åŒ…ï¼Œä¼ é€’é—­åŒ…</li></ul></li></ul><p>ç­‰ä»·å…³ç³»</p><ul><li>æ»¡è¶³è‡ªåï¼Œå¯¹ç§°ï¼Œä¼ é€’</li><li>ç­‰ä»·ç±»$[a]_R$ï¼Œä»£è¡¨å…ƒ</li><li>é›†åˆçš„åˆ’åˆ†ä¸é›†åˆä¸Šçš„ç­‰ä»·å…³ç³»ä¸€ä¸€å¯¹åº”ï¼ˆåˆ’åˆ†ç›¸åŒâ€”â€”ç­‰ä»·å…³ç³»æœ¬è´¨ç›¸åŒï¼‰ </li><li>A/Rï¼šå…³äºç­‰ä»·å…³ç³»Rçš„å•†é›†</li></ul><p>åºå…³ç³»</p><ul><li>$\preceq$ï¼šè‡ªåï¼Œåå¯¹ç§°ï¼Œä¼ é€’ï¼›ååºé›†$<a,\preceq>$<ul><li>å¯æ¯”è¾ƒ/ä¸å¯æ¯”è¾ƒ</li></ul></a,\preceq></li><li>çº¿åºå…³ç³»ï¼šä»»æ„ä¸¤ä¸ªå…ƒç´ éƒ½æ˜¯å¯æ¯”è¾ƒçš„ï¼ˆå®Œå…¨åºå…³ç³»ï¼‰</li><li>åºå…³ç³»ä¸­çš„æ§åˆ¶å…³ç³»ï¼šyæ§åˆ¶xï¼Œå³$x\hat \preceq_\neq y$ï¼Œä¸”ä¸å­˜åœ¨$z,x\hat \preceq_\neq z ,z\hat\preceq_\neq y$</li><li>æå¤§å…ƒï¼Œæå°å…ƒ</li><li>å“ˆå¸Œå›¾ï¼š<em>æœ€ä¸Šæ–¹æ˜¯æå¤§å…ƒï¼Œæœ€ä¸‹æ–¹æ˜¯æå°å…ƒ</em></li><li>æœ€å¤§å…ƒï¼Œæœ€å°å…ƒ<ul><li>æœ€å¤§å…ƒä¸€å®šæ˜¯æå¤§å…ƒï¼Œæœ€å¤§å…ƒè‡³å¤šä¸€ä¸ª</li></ul></li><li>ï¼ˆå­é›†çš„ï¼‰ä¸Šç•Œ/ä¸‹ç•Œï¼šä¸ä¸€å®šæœ‰ï¼Œä¸ä¸€å®šå”¯ä¸€<ul><li>æœ€å°ä¸Šç•Œ/ä¸Šç¡®ç•Œï¼›æœ€å¤§ä¸‹ç•Œ/ä¸‹ç¡®ç•Œ</li></ul></li></ul><p>é›†åˆçš„åŠ¿</p><ul><li>ç­‰åŠ¿ï¼š$A \sim B$ï¼šå­˜åœ¨åŒå°„<ul><li>$\mathscr P(E)$ä¸Šçš„ç­‰ä»·å…³ç³»</li></ul></li><li>æœ‰é™é›†åˆ</li><li>å¯æ•°é›†åˆ ï¼›å¯æ•°æ— é™é›†åˆï¼šä¸è‡ªç„¶æ•°é›†åˆç­‰åŠ¿çš„é›†åˆ</li><li>åŠ¿çš„å¤§å°ï¼›æ”¯é…ï¼šAå’ŒBçš„ä¸€ä¸ªå­é›†ç­‰åŠ¿ï¼Œåˆ™ç§°Bæ”¯é…Aï¼Œ$A\preceq B$ï¼šååºå…³ç³»</li><li>$A\prec \mathscr P(A) $</li><li>æ— é™é›†åˆ<ul><li>æ¯ä¸ªæ— é™é›†åˆéƒ½æœ‰ä¸€ä¸ªå¯æ•°æ— é™å­é›†</li><li>æ¯ä¸ªæ— é™é›†åˆéƒ½å’Œå®ƒçš„æŸä¸ªçœŸå­é›†é›†åˆç­‰åŠ¿</li></ul></li></ul><h4 id="ä½œä¸šé¢˜ç›®-1"><a href="#ä½œä¸šé¢˜ç›®-1" class="headerlink" title="ä½œä¸šé¢˜ç›®"></a>ä½œä¸šé¢˜ç›®</h4><p><strong>4.7.è®¾$A=\{1,2,3,4\},$åœ¨$\mathscr{P} (A)$ä¸Šå®šä¹‰å…³ç³»â€œ$\sim$â€ã€‚ä»»ç»™$S,T\in \mathscr{P}(A)$,</strong></p><script type="math/tex; mode=display">S\sim T,å½“ä¸”ä»…å½“\quad |S|=|T|</script><p><strong>è¯æ˜ï¼šâ€œ$\sim$â€æ˜¯$\mathscr{P}(A)$ä¸Šçš„ç­‰ä»·å…³ç³»ï¼Œå¹¶å†™å‡ºå®ƒçš„å•†é›†$\mathscr{P}(A)/\sim$ã€‚</strong></p><ul><li>è‡ªåæ€§ï¼š$\forall S\in \mathscr P(A),|S|=|S|\Rightarrow S\sim S$</li><li>å¯¹ç§°æ€§ï¼š$\forall S,T\in \mathscr P(A),S\sim T\Rightarrow |S|=|T|\Rightarrow |T|=|S|\Rightarrow T\sim S$</li><li>ä¼ é€’æ€§ï¼š$\forall S,T,V\in \mathscr P(A),S\sim T,T\sim V$</li></ul><p>å•†é›†ï¼š$\{\{\empty\},\\\{\{1\},\{2\},\{3\},\{4\}\},\\\{\{1,2\},\{1,3\},\{1,4\},\{2,3\},\{2,4\},\{3,4\}\},\\\{\{1,2,3\},\{1,2,4\},\{1,3,4\},\{2,3,4\}\},\\\{\{1,2,3,4\}\}\}$</p><p><strong>4.16.$A=\{a_1,a_2,â€¦,a_n,â€¦\}$æ˜¯ä»»æ„é›†åˆã€‚åœ¨ååºé›†$&lt;\mathscr{P}(A),\subseteq&gt;$ä¸­å–å­é›†åºåˆ—$\{a_1\},\{a_1,a_2\},\{a_1,a_2,a_3\},â€¦,\{a_1,a_2,â€¦,a_n,\},â€¦$,å®ƒä»¬çš„å¹¶é›†æ˜¯å¦æ˜¯$\mathscr{P}(A)$çš„ä¸€ä¸ªæå¤§å…ƒï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</strong></p><ul><li>è‹¥Aä¸ºæœ‰é™é›†åˆï¼Œæ˜¾ç„¶å­é›†åºåˆ—çš„å¹¶é›†ä¸ºæå¤§å…ƒï¼ˆåè¯æ³•ï¼‰</li><li>è‹¥Aæ˜¯å¯æ•°æ— é™é›†åˆï¼Œåˆ™å¹¶é›†På¯èƒ½æ˜¯æå¤§å…ƒï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯æå¤§å…ƒã€‚ä¸¾ä¾‹ï¼šè®¾Aä¸ºè‡ªç„¶æ•°é›†åˆ<ul><li>æ˜¯æå¤§å…ƒï¼š $a_i=i-1,\{a_1,a_2,â€¦a_n,â€¦\}=\{0,1,â€¦.n,..\}=A$</li><li>ä¸æ˜¯æå¤§å…ƒï¼š$a_i=i,\{a_1,a_2,â€¦a_n,â€¦\}=\{1,2,â€¦n,â€¦\}\subset A$</li></ul></li><li>è‹¥Aæ˜¯ä¸å¯æ•°é›†åˆï¼Œåˆ™ä¸€å®šä¸æ˜¯æå¤§å…ƒï¼Œå¦åˆ™å¹¶é›†$P=A,{a_1,a_2,â€¦a_n,â€¦}$åˆ—ä¸¾å‡ºäº†Açš„æ‰€æœ‰å…ƒç´ ï¼Œä¸Aæ˜¯ä¸å¯æ•°é›†åˆçŸ›ç›¾ã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;2023springä»£æ•°ç»“æ„ä¹ é¢˜è¯¾è®²ä¹‰&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;ä»£æ•°ç»“æ„-ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾&quot;&gt;&lt;a href=&quot;#ä»£æ•°ç»“æ„-ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾&quot; class=&quot;headerlink&quot; title=&quot;ä»£æ•°ç»“æ„ ç¬¬ä¸€æ¬¡ä¹ é¢˜è¯¾&quot;&gt;&lt;/a&gt;ä»£æ•°ç»“æ„ ç¬¬ä¸€æ¬¡ä¹ </summary>
      
    
    
    
    <category term="ä»£æ•°ç»“æ„" scheme="http://sn1987a-1.github.io/categories/%E4%BB%A3%E6%95%B0%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>åŠ å¯†ç®—æ³•</title>
    <link href="http://sn1987a-1.github.io/posts/79dcde63.html"/>
    <id>http://sn1987a-1.github.io/posts/79dcde63.html</id>
    <published>2023-04-28T12:48:34.000Z</published>
    <updated>2023-09-24T03:52:09.035Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><ul><li>ç†è§£éå¯¹ç§°åŠ å¯†ç®—æ³•</li><li>ç†è§£æ¤­åœ†æ›²çº¿ç®—æ³•ECC</li><li>å®ç°æ¯”ç‰¹å¸ä¸Šçš„æ¤­åœ†æ›²çº¿secp256k1ç®—æ³•</li></ul><h4 id="ECCç®—æ³•æµç¨‹"><a href="#ECCç®—æ³•æµç¨‹" class="headerlink" title="ECCç®—æ³•æµç¨‹"></a>ECCç®—æ³•æµç¨‹</h4><p>ECCç®—æ³•ä¸­ï¼Œé™·é—¨å‡½æ•°æ˜¯å®šä¹‰åœ¨æœ‰é™åŸŸä¸Šçš„äºŒå…ƒä¸‰æ¬¡æ›²çº¿y^2^=x^3^+ax+bä¸Šçš„ç‚¹æ‰€ç»„æˆçš„é˜¿è´å°”ç¾¤ã€‚</p><p>å…¬é’¥ï¼šç‚¹Q</p><p>ç§é’¥ï¼šå¤§æ•°k</p><p>ECCç®—æ³•æ˜¯æœ‰é™åŸŸFpæ»¡è¶³å…¬å¼ï¼šQ=kPã€‚</p><p>ç­¾åè¿‡ç¨‹ï¼š</p><ul><li><p>å–ä¸€ä¸ªæ–°çš„éšæœºæ•°kï¼Œä»¤$k*G\equiv R\ mod \ N$</p></li><li><p>è®¡ç®—Sï¼š</p></li></ul><script type="math/tex; mode=display">uG + vP = R = kG \\  uG + veG = kG\\  u + ve = k \\  z/s + re/s = k\\  (z + re)/s = k\\  s = (z + re)/k</script><ul><li>è¿”å›ç­¾åï¼šsignature(s,r)</li></ul><p>ç­¾åçš„æ•°å­—ä¸ºï¼ˆs,rï¼‰</p><p>éªŒç­¾è¿‡ç¨‹ï¼š</p><ul><li>è®¡ç®—uï¼Œv</li><li>è®¡ç®—uG+vP</li><li>åˆ¤æ–­(uG+vp).xæ˜¯å¦å’Œræ¨¡NåŒä½™ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç­¾åæˆåŠŸ</li></ul><h3 id="å®éªŒå†…å®¹"><a href="#å®éªŒå†…å®¹" class="headerlink" title="å®éªŒå†…å®¹"></a>å®éªŒå†…å®¹</h3><h4 id="ECCç­¾å"><a href="#ECCç­¾å" class="headerlink" title="ECCç­¾å"></a>ECCç­¾å</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ecc <span class="token operator">*</span>MyECC<span class="token punctuation">)</span> <span class="token function">Sign</span><span class="token punctuation">(</span>msg <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> secKey <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Signature<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>k<span class="token punctuation">,</span>err <span class="token operator">:=</span><span class="token function">newRand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>err<span class="token punctuation">}</span>R <span class="token operator">:=</span> <span class="token function">Multi</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span>k<span class="token punctuation">)</span>r<span class="token operator">:=</span>R<span class="token punctuation">.</span>Xr<span class="token operator">=</span>r<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>N<span class="token punctuation">)</span>z<span class="token operator">:=</span>crypto<span class="token punctuation">.</span><span class="token function">Keccak256</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>z_i <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>s<span class="token operator">:=</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>z_i<span class="token punctuation">,</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>secKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Inv</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">)</span>s<span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>N<span class="token punctuation">)</span>sig<span class="token operator">:=</span><span class="token operator">&amp;</span>Signature<span class="token punctuation">{</span>s<span class="token punctuation">,</span>r<span class="token punctuation">}</span><span class="token keyword">return</span> sig<span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ECCéªŒç­¾"><a href="#ECCéªŒç­¾" class="headerlink" title="ECCéªŒç­¾"></a>ECCéªŒç­¾</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ecc <span class="token operator">*</span>MyECC<span class="token punctuation">)</span> <span class="token function">VerifySignature</span><span class="token punctuation">(</span>msg <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> signature <span class="token operator">*</span>Signature<span class="token punctuation">,</span> pubkey <span class="token operator">*</span>Point<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>s<span class="token operator">:=</span>signature<span class="token punctuation">.</span>sr<span class="token operator">:=</span>signature<span class="token punctuation">.</span>rz<span class="token operator">:=</span>crypto<span class="token punctuation">.</span><span class="token function">Keccak256</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>z_i <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>s_inv<span class="token operator">:=</span><span class="token function">Inv</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>N<span class="token punctuation">)</span>s_inv<span class="token operator">=</span>s_inv<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>s_inv<span class="token punctuation">,</span>N<span class="token punctuation">)</span>u<span class="token operator">:=</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>z_i<span class="token punctuation">,</span>s_inv<span class="token punctuation">)</span>u<span class="token operator">=</span>u<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span>N<span class="token punctuation">)</span>v<span class="token operator">:=</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>s_inv<span class="token punctuation">)</span>v<span class="token operator">=</span>v<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>N<span class="token punctuation">)</span>ans<span class="token operator">:=</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">Multi</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Multi</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Xans<span class="token operator">=</span>ans<span class="token punctuation">.</span><span class="token function">Mod</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®éªŒç›®çš„&quot;&gt;&lt;a href=&quot;#å®éªŒç›®çš„&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒç›®çš„&quot;&gt;&lt;/a&gt;å®éªŒç›®çš„&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ç†è§£éå¯¹ç§°åŠ å¯†ç®—æ³•&lt;/li&gt;
&lt;li&gt;ç†è§£æ¤­åœ†æ›²çº¿ç®—æ³•ECC&lt;/li&gt;
&lt;li&gt;å®ç°æ¯”ç‰¹å¸ä¸Šçš„æ¤­åœ†æ›²çº¿secp2</summary>
      
    
    
    
    <category term="åŒºå—é“¾" scheme="http://sn1987a-1.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>MLç®—æ³•ï¼šç‰¹å¾æŠ½å–</title>
    <link href="http://sn1987a-1.github.io/posts/72ae2b6b.html"/>
    <id>http://sn1987a-1.github.io/posts/72ae2b6b.html</id>
    <published>2023-01-10T12:48:34.000Z</published>
    <updated>2023-09-24T03:49:02.486Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç‰¹å¾æŠ½å–"><a href="#ç‰¹å¾æŠ½å–" class="headerlink" title="ç‰¹å¾æŠ½å–"></a>ç‰¹å¾æŠ½å–</h2><h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><p>æœ¬æ¬¡å®éªŒçš„å®éªŒç›®çš„æ˜¯å¯¹ä¸€æ•°æ®é›†è¿›è¡Œåˆ†ç±»ï¼Œå› ä¸ºæ•°æ®é›†ä¸­å­˜åœ¨ç€å™ªå£°æ•°æ®ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œç‰¹å¾æŠ½å–ï¼Œå¹¶ä½¿ç”¨çº¿æ€§å›å½’ï¼Œå†³ç­–æ ‘ï¼Œç¥ç»ç½‘ç»œï¼ŒSVMä»¥åŠXGBooståˆ†åˆ«å®ç°å¯¹æ¨¡å‹çš„é¢„æµ‹å¹¶è¿›è¡Œè¯„ä¼°ã€‚</p><h3 id="å®éªŒåŸç†"><a href="#å®éªŒåŸç†" class="headerlink" title="å®éªŒåŸç†"></a>å®éªŒåŸç†</h3><h4 id="ç‰¹å¾æŠ½å–å’Œç‰¹å¾é€‰æ‹©"><a href="#ç‰¹å¾æŠ½å–å’Œç‰¹å¾é€‰æ‹©" class="headerlink" title="ç‰¹å¾æŠ½å–å’Œç‰¹å¾é€‰æ‹©"></a>ç‰¹å¾æŠ½å–å’Œç‰¹å¾é€‰æ‹©</h4><p>å¯¹å®éªŒçš„è®­ç»ƒæ•°æ®é›†è¿›è¡Œè§‚å¯Ÿå¯å¾—ï¼šå¯¹äºæ¯ä¸€æ¡æ ·æœ¬ï¼Œæœ‰ä¸ä¹‹ç›¸å…³çš„120ä¸ªfeatureï¼ˆä¸ªåˆ«featureå¯èƒ½æ˜¯naï¼‰ï¼Œä½†æ˜¯å¯¹äºè®­ç»ƒæœ‰æ•ˆçš„ç‰¹å¾ä¸è¶³20ä¸ªï¼Œå¦‚æœå¯¹åŸæ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆï¼Œè®­ç»ƒè¿‡æ…¢ï¼Œæ•ˆæœè¾ƒå·®ç­‰ç»“æœï¼Œå› æ­¤è¦å¯¹æ•°æ®è¿›è¡Œç‰¹å¾æŠ½å–ï¼Œé€‰å–å¯¹è®­ç»ƒæœ‰ç›Šçš„ç‰¹å¾</p><p>æœ¬æ¬¡å®éªŒä¸­ï¼Œç‰¹å¾æŠ½å–ä½¿ç”¨äº†å¦‚ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p><h5 id="åŸºäºå†³ç­–æ ‘æŠ½å–"><a href="#åŸºäºå†³ç­–æ ‘æŠ½å–" class="headerlink" title="åŸºäºå†³ç­–æ ‘æŠ½å–"></a>åŸºäºå†³ç­–æ ‘æŠ½å–</h5><p>æœ¬éƒ¨åˆ†å€ŸåŠ©sklearnä¸­çš„DecisionTreeClassifierè¿›è¡Œå¤„ç†ï¼Œå› ä¸ºæ¯ä¸ªç‰¹å¾å…·æœ‰å¯¹åº”çš„æƒé‡ï¼Œå¯¹äºåˆ†ç±»ç»“æœå¸®åŠ©è¾ƒå¤§çš„featureçš„æƒé‡å¤§ï¼Œä¸ºäº†ç­›é€‰å‡ºæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¯ä»¥é€‰æ‹©å†³ç­–æ ‘ä¸­æƒé‡å¤§çš„ç‚¹ï¼Œå¤„ç†æ€è·¯ä¸ºï¼š</p><ul><li>å°†æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œå¾—åˆ°è®­ç»ƒé›†å¯¹åº”çš„å†³ç­–æ ‘ï¼Œåœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•å‡†ç¡®ç‡</li><li>å¦‚æœæµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡å¤§äº25.5%ï¼ˆè¡¨æ˜æ­¤æ¬¡è®­ç»ƒçš„ç»“æœè¾ƒä¸ºæœ‰æ•ˆï¼‰ï¼Œè®°å½•ä¸‹æ­¤æ—¶æ‰€æœ‰featureå¯¹åº”çš„æƒé‡</li><li>é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æ”¶é›†åˆ°çš„æƒé‡æ•°å¤§äº100ï¼Œå°†å„ä¸ªfeatureå¾—åˆ°çš„æƒé‡ç›¸åŠ ï¼Œå¾—åˆ°æ–°çš„æƒé‡</li><li>æ ¹æ®æ–°çš„æƒé‡ï¼Œä¿ç•™æœ€å¤§çš„äºŒåä¸ªfeatureç”¨äºè®­ç»ƒ</li></ul><p>ç±»ä¼¼çš„ï¼Œä¸ä»…ä»…æ˜¯åŸºäºå†³ç­–æ ‘ï¼ŒåŸºäºXGBoostï¼ŒSVMç­‰é€šè¿‡å¤šæ¬¡æ„å»ºæ¨¡å‹æ‰¾åˆ°æƒé‡æœ€å¤§çš„ç‰¹å¾</p><h5 id="RFEæ–¹æ³•"><a href="#RFEæ–¹æ³•" class="headerlink" title="RFEæ–¹æ³•"></a>RFEæ–¹æ³•</h5><p>ä¸ä¸Šä¸€ç§æŠ½å–æ–¹æ³•ç±»ä¼¼ï¼ŒRFEä¹Ÿæ˜¯å€ŸåŠ©åå¤æ„å»ºæ¨¡å‹å¯»æ‰¾è¾ƒå¥½çš„ç‰¹å¾ï¼Œä¸åŒçš„æ˜¯RFEå€ŸåŠ©é€’å½’çš„æ€è·¯ï¼Œä¾æ¬¡æ‰¾å‡ºç‰¹å¾ä¸­æœ€å¥½çš„ç‰¹å¾å¹¶å†ä¸‹ä¸€è½®è®­ç»ƒä¸­æ’é™¤å½“å‰ç‰¹å¾ï¼Œåœ¨å‰©ä½™çš„ç‰¹å¾ä¸Šé‡å¤è®­ç»ƒï¼Œç›´åˆ°æ‰¾å‡º20ä¸ªæœ€å¥½çš„ç‰¹å¾ã€‚</p><p>RFEä¹Ÿå¯ä»¥é‡‡å–çº¿æ€§å›å½’ï¼ŒSVMç­‰æ¨¡å‹ä½œä¸ºåº•å±‚æ¨¡å‹å®ç°ç‰¹å¾é€‰æ‹©ï¼Œæœ¬æ¬¡å®éªŒä¸­RFEå€ŸåŠ©sklearnåº“ä¸­çš„RFEå‡½æ•°ä»¥åŠçº¿æ€§å›å½’å‡½æ•°ä½œä¸ºæ•°æ®æŠ½å–çš„æ–¹æ³•</p><h5 id="Relief-Fæ–¹æ³•"><a href="#Relief-Fæ–¹æ³•" class="headerlink" title="Relief-Fæ–¹æ³•"></a>Relief-Fæ–¹æ³•</h5><p>Reliefç®—æ³•æ˜¯ç”¨äºä¸¤ç±»æ•°æ®çš„åˆ†ç±»é—®é¢˜çš„ç‰¹å¾æƒé‡è®¡ç®—æ–¹æ³•ï¼Œè€ŒRelief-Fä½œä¸ºReliefç®—æ³•æ‹“å±•ï¼Œå¯ä»¥å®ç°å¤šåˆ†ç±»é—®é¢˜çš„ç‰¹å¾æƒé‡è®¡ç®—ï¼Œç®—æ³•çš„ä¸»è¦æ­¥éª¤ä¸ºï¼š</p><ul><li>å°†æ‰€æœ‰æ ·æœ¬æŒ‰ç±»åˆ«åˆ†ç±»ï¼Œå¯¹äºæ¯ç±»æ ·æœ¬ï¼Œåˆ†åˆ«æŠ½å–ä¸€ä¸ªæ ·æœ¬è®°ä½œx</li><li>å¯¹äºæ¯ä¸€ä¸ªxï¼Œåœ¨è¯¥ç±»ä¸­æ‰¾åˆ°xçš„kä¸ªæœ€è¿‘é‚»ï¼Œåœ¨ä¸åŒ…å«è¯¥ç±»åˆ«çš„è®­ç»ƒé›†ä¸­ä¹Ÿæ‰¾å‡ºkä¸ªæœ€è¿‘é‚»</li><li>æ ¹æ®è¿‘é‚»åŠæ‰€å±çš„ç±»åˆ«è®¡ç®—ç‰¹å¾çš„æƒé‡</li><li>å¯¹ç‰¹å¾çš„æƒé‡è¿›è¡Œæ´¾åˆ«ï¼Œå¾—åˆ°åˆé€‚çš„ç‰¹å¾</li></ul><h4 id="å¤šåˆ†ç±»ä»»åŠ¡"><a href="#å¤šåˆ†ç±»ä»»åŠ¡" class="headerlink" title="å¤šåˆ†ç±»ä»»åŠ¡"></a>å¤šåˆ†ç±»ä»»åŠ¡</h4><p>åœ¨å‰é¢çš„å®éªŒä¸­ï¼Œå·²ç»å®Œæˆäº†å¯¹äºŒåˆ†ç±»ä»»åŠ¡çš„é€»è¾‘å›å½’ã€SVMæ¨¡å‹ï¼Œä¸ºäº†é€‚åº”æœ¬å®éªŒçš„ä»»åŠ¡ï¼Œè¦å°†å…¶è¿›è¡Œé€‚å½“ä¿®æ”¹ï¼Œä»¥ä¾¿å®ç°å¤šåˆ†ç±»ä»»åŠ¡ã€‚</p><p>å¤šåˆ†ç±»å­¦ä¹ å¯ä»¥æœ‰äºŒåˆ†ç±»å­¦ä¹ å™¨é›†æˆè€Œæ¥ï¼Œæœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><ul><li>ä¸€å¯¹ä¸€</li><li>ä¸€å¯¹å…¶ä½™</li><li>å¤šå¯¹å¤š</li></ul><p>å…¶ä¸­ï¼Œæœ¬å®éªŒé‡‡ç”¨äº†å¤šå¯¹å¤šçš„æ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œç”±äºæœ¬å®éªŒåˆ†ç±»ä¸ºå››ç±»ï¼Œå¯ä»¥å°†å¤šå¯¹å¤šçš„åˆ†ç±»å­¦ä¹ ç®€åŒ–è®¾è®¡å¦‚ä¸‹ï¼š</p><ul><li>è®¾è®¡ä¸åŒçš„äºŒåˆ†ç±»å™¨ï¼Œæ¯ä¸ªäºŒåˆ†ç±»å™¨å°†ä¸¤ä¸ªç±»åˆ«è§†ä½œæ­£ç±»ï¼Œå¦å¤–ä¸¤ä¸ªç±»åˆ«è§†ä¸ºè´Ÿç±»ï¼Œå› æ­¤å…±éœ€è¦å…­ä¸ªäºŒåˆ†ç±»å­¦ä¹ å™¨</li><li>å¯¹äºæ¯ä¸ªåˆ†ç±»å™¨ï¼Œå› ä¸ºå…¶å¯¹ç§°æ€§ï¼Œæ­£ç±»å’Œè´Ÿç±»çš„æƒé‡å¯ä»¥è§†ä¸ºä¸€è‡´çš„ï¼Œåœ¨é¢„æµ‹æ—¶ï¼Œå¯¹äºä¸€ä¸ªæ ·æœ¬ç»Ÿè®¡ï¼Œå°†æŸä¸€ç±»åˆ«è§†ä¸ºæ­£ç±»çš„æ¦‚ç‡ï¼Œå¾—åˆ°çš„æœ€å¤§çš„æ¦‚ç‡å¯¹åº”çš„ç±»åˆ«è§†ä½œè¯¥æ ·æœ¬çš„é¢„æµ‹å€¼</li></ul><h3 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h4 id="æ•°æ®é¢„å¤„ç†"><a href="#æ•°æ®é¢„å¤„ç†" class="headerlink" title="æ•°æ®é¢„å¤„ç†"></a>æ•°æ®é¢„å¤„ç†</h4><ul><li><p>ä»æ•°æ®é›†ä¸­è¯»å–æ•°æ®</p></li><li><p>å°†ç©ºæ•°æ®å¡«å……ä¸ºè¯¥ç‰¹å¾ä¸­å…¶ä»–ä¸ä¸ºç©ºçš„æ•°æ®çš„ä¸­ä½æ•°</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> column <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>feature<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>feature<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    val <span class="token operator">=</span> feature<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span>    feature<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>val<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>æ­£åˆ™åŒ–æ•°æ®</p></li><li>å°†æ•°æ®é›†éšæœºåˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼ˆ7ï¼š3ï¼‰</li></ul><h4 id="ç‰¹å¾æŠ½å–-1"><a href="#ç‰¹å¾æŠ½å–-1" class="headerlink" title="ç‰¹å¾æŠ½å–"></a>ç‰¹å¾æŠ½å–</h4><ul><li><p>åŸºäºå†³ç­–æ ‘åˆ’åˆ†ï¼Œå¾—åˆ°æƒé‡æœ€å¤§çš„ç‰¹å¾å¯¹åº”çš„åºå·</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>é‡æ–°åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†    dtree<span class="token operator">=</span>tree<span class="token punctuation">.</span>DecisionTreeClassifier<span class="token punctuation">(</span>splitter<span class="token operator">=</span><span class="token string">"random"</span><span class="token punctuation">,</span>min_samples_leaf<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>    dtree<span class="token operator">=</span>dtree<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>    test_res<span class="token operator">=</span>dtree<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>    <span class="token builtin">sum</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>test_label<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>test_label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>test_res<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span>    <span class="token keyword">if</span> <span class="token builtin">sum</span><span class="token operator">/</span>test_label<span class="token punctuation">.</span>size<span class="token operator">&gt;</span><span class="token number">0.255</span><span class="token punctuation">:</span>        weight<span class="token operator">+=</span>dtree<span class="token punctuation">.</span>feature_importances_        t<span class="token operator">+=</span><span class="token number">1</span>    <span class="token keyword">if</span> t<span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">:</span>        <span class="token keyword">break</span>max_indexs <span class="token operator">=</span> heapq<span class="token punctuation">.</span>nlargest<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight<span class="token punctuation">.</span>take<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å€ŸåŠ©RFEåˆ’åˆ†</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> RFE<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LinearRegression <span class="token keyword">as</span> LRlinear_model<span class="token operator">=</span>LR<span class="token punctuation">(</span><span class="token punctuation">)</span>s<span class="token operator">=</span> RFE<span class="token punctuation">(</span>linear_model<span class="token punctuation">,</span> n_features_to_select<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Label<span class="token punctuation">)</span>  Data <span class="token operator">=</span> s<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="çº¿æ€§å›å½’"><a href="#çº¿æ€§å›å½’" class="headerlink" title="çº¿æ€§å›å½’"></a>çº¿æ€§å›å½’</h4><p>åœ¨LogisticRegressionä¸­æ·»åŠ ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">multi_fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>X<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>    yi<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>y<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">### set yi</span>    theta<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    J<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        t<span class="token punctuation">,</span>j<span class="token punctuation">,</span>temp<span class="token operator">=</span>self<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span>yi<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        theta<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>        J<span class="token operator">+=</span>j    <span class="token keyword">return</span> theta<span class="token punctuation">,</span>J<span class="token keyword">def</span> <span class="token function">multi_pred</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>X<span class="token punctuation">,</span>multi_theta<span class="token punctuation">)</span><span class="token punctuation">:</span>    m<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    pre<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    X<span class="token operator">=</span>np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        theta<span class="token operator">=</span>multi_theta<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        p<span class="token operator">=</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>X<span class="token punctuation">,</span>theta<span class="token punctuation">)</span>        p<span class="token operator">=</span>p<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>        pre<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token keyword">return</span> pre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›è¡Œè®­ç»ƒã€é¢„æµ‹ã€ç»˜åˆ¶å›¾åƒ</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">lr<span class="token operator">=</span>LogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>theta<span class="token punctuation">,</span>loss<span class="token operator">=</span>lr<span class="token punctuation">.</span>multi_fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>preds<span class="token operator">=</span>lr<span class="token punctuation">.</span>multi_pred<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span>theta<span class="token punctuation">)</span>test_r<span class="token operator">=</span><span class="token punctuation">[</span>preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>preds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span>preds<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>loss<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">u"times"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">u"loss-value"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">sum</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>test_label<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> test_label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>j<span class="token punctuation">:</span>            <span class="token keyword">if</span> test_r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;=</span>test_r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">and</span> test_r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;=</span>test_r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">and</span> test_r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;=</span>test_r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">and</span> test_r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;=</span>test_r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>                <span class="token builtin">sum</span><span class="token operator">+=</span><span class="token number">1</span><span class="token builtin">sum</span><span class="token operator">/</span>test_label<span class="token punctuation">.</span>size<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å†³ç­–æ ‘"><a href="#å†³ç­–æ ‘" class="headerlink" title="å†³ç­–æ ‘"></a>å†³ç­–æ ‘</h4><p>è°ƒç”¨sklearn.treeä¸­çš„DecisionTreeClassifierå®ç°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> treedtree<span class="token operator">=</span>tree<span class="token punctuation">.</span>DecisionTreeClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>dtree<span class="token operator">=</span>dtree<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>test_res<span class="token operator">=</span>dtree<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ç¥ç»ç½‘ç»œ"><a href="#ç¥ç»ç½‘ç»œ" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p>è°ƒç”¨sklearnä¸­çš„neural_networkå®ç°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn <span class="token keyword">import</span> neural_network <span class="token keyword">as</span> NNnn<span class="token operator">=</span>NN<span class="token punctuation">.</span>MLPClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>nn<span class="token operator">=</span>nn<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>test_res<span class="token operator">=</span>nn<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SVM"><a href="#SVM" class="headerlink" title="SVM"></a>SVM</h4><p>å¤„ç†æ–¹å¼ä¸çº¿æ€§å›å½’çš„æ¨¡å‹ç›¸ä¼¼</p><h4 id="XGBoost"><a href="#XGBoost" class="headerlink" title="XGBoost"></a>XGBoost</h4><p>è°ƒç”¨xgboost.sklearnåº“å®ç°XGBoost</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">xgb<span class="token operator">=</span>XGB<span class="token punctuation">(</span><span class="token punctuation">)</span>xgb<span class="token operator">=</span>xgb<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>test_res<span class="token operator">=</span>xgb<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h3><h4 id="ç‰¹å¾æŠ½å–-2"><a href="#ç‰¹å¾æŠ½å–-2" class="headerlink" title="ç‰¹å¾æŠ½å–"></a>ç‰¹å¾æŠ½å–</h4><ul><li><p>åŸºäºå†³ç­–æ ‘è¿›è¡Œç‰¹å¾é€‰æ‹©</p><p>æ‰€æœ‰èŠ‚ç‚¹çš„æƒé‡æ•°æ®:æ ¹æ®è§‚å¯Ÿä¸éš¾çœ‹å‡ºï¼Œä¸åŒç‰¹å¾çš„æƒé‡åˆ†å¸ƒå­˜åœ¨å·®è·ï¼Œå¤§éƒ¨åˆ†åˆ†å¸ƒåœ¨0.8-1.0ä¹‹é—´</p></li></ul><ul><li><p>RFEç‰¹å¾æŠ½å–</p><p>å¯¹RFEåˆ†åˆ«å€ŸåŠ©çº¿æ€§å›å½’ï¼ŒSVMå’Œéšæœºæ£®æ—çš„åº•å±‚æ¨¡å‹è®­ç»ƒï¼Œå‘ç°çº¿æ€§å›å½’è®­ç»ƒæ—¶é—´è¾ƒçŸ­ï¼Œå¦å¤–ä¸¤ä¸ªæ¨¡å‹éœ€è¦è¾ƒé•¿æ—¶é—´çš„è®­ç»ƒï¼Œä¸”è¿™å‡ ç±»æ¨¡å‹å¯¹è®­ç»ƒç»“æœçš„é¢„æµ‹æ•ˆæœæ²¡æœ‰æ˜æ˜¾çš„å½±å“ï¼Œæ•…é€‰å–çº¿æ€§å›å½’æ¨¡å‹è¿›è¡ŒRFEå¤„ç†ã€‚</p><p>å¯¹ç‰¹å¾çš„é‡è¦æ€§è¿›è¡Œæ’åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šç­›é€‰å»å‰20ä¸ªç‰¹å¾ï¼Œè¿›è¡Œåç»­è®­ç»ƒå’Œæ¨¡å‹é¢„æµ‹</p></li></ul><h3 id="æ¨¡å‹è®­ç»ƒç»“æœ"><a href="#æ¨¡å‹è®­ç»ƒç»“æœ" class="headerlink" title="æ¨¡å‹è®­ç»ƒç»“æœ"></a>æ¨¡å‹è®­ç»ƒç»“æœ</h3><p>äº”ä¸ªæ¨¡å‹æœ€ä½³å‚æ•°çš„è®­ç»ƒç»“æœï¼š</p><div class="table-container"><table><thead><tr><th>æ¨¡å‹</th><th>è®­ç»ƒæ—¶é—´</th><th>å‡†ç¡®ç‡</th></tr></thead><tbody><tr><td>LogisticRegression</td><td>15s</td><td>27.4%</td></tr><tr><td>DecisionTree</td><td>0.4s</td><td>27.0%</td></tr><tr><td>NeuralNetwork</td><td>2.3s</td><td>26.9%</td></tr><tr><td>SVM</td><td>33s</td><td>26.3%</td></tr><tr><td>XGBoost</td><td>4.5s</td><td>25.8%</td></tr></tbody></table></div><p>æ€»ä½“æ¥è¯´ï¼Œçº¿æ€§å›å½’çš„è®­ç»ƒæ•ˆæœè¾ƒå¥½ï¼Œä½†å‡ ç§æ¨¡å‹å‡åœ¨è¾ƒä½å‡†ç¡®ç‡çš„è¾ƒå°èŒƒå›´å†…æ³¢åŠ¨ï¼Œå¹¶æ²¡æœ‰å®ç°è¾ƒå¥½çš„ç»“æœã€‚</p><p>å¯¹äºä¸åŒçš„ç‰¹å¾é€‰æ‹©æ¨¡å‹ï¼Œç”šè‡³ä¸è¿›è¡Œç‰¹å¾é€‰æ‹©ï¼Œè®­ç»ƒå‡†ç¡®ç‡çš„å·®è·è¾ƒå°ï¼Œåœ¨åç»­è°ƒå‚è¿‡ç¨‹ä¸­ä¸åšåŒºåˆ†ã€‚ç”±äºDecisionTreeå’ŒNeuralNetworkæ¨¡å‹çš„è®­ç»ƒæ•ˆæœè¾ƒå¥½å¹¶ä¸”è®­ç»ƒæ—¶é—´çŸ­ï¼Œæœ¬æ¬¡å®éªŒå°†é‡ç‚¹åˆ†æè¯¥ä¸¤ç±»æ¨¡å‹çš„è°ƒå‚æ•ˆæœã€‚</p><h4 id="é€»è¾‘å›å½’"><a href="#é€»è¾‘å›å½’" class="headerlink" title="é€»è¾‘å›å½’"></a>é€»è¾‘å›å½’</h4><p>è¿­ä»£3000æ¬¡ï¼Œå¾—åˆ°çš„æŸå¤±å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>è¯¥æ¬¡è®­ç»ƒç»“æœå‡†ç¡®ç‡ï¼š26.8%</p><p>å¯ä»¥çœ‹å‡ºï¼Œæ¨¡å‹è®­ç»ƒçš„æŸå¤±æ˜¯é€æ¸é€’å‡è‡³æ”¶æ•›çš„ï¼Œä½†æ˜¯æŸå¤±çš„ä¸‹é™æœ‰é™ï¼šä»2.88ä¸‹é™åˆ°2.86ï¼Œä»…æœ‰2%çš„æå‡ï¼Œè¯´æ˜é€»è¾‘å›å½’æ— æ³•è¾ƒå¥½çš„å­¦ä¹ åˆ°æ¨¡å‹å“¦é‚£ä¸ªçš„åˆ†å¸ƒç‰¹å¾ã€‚</p><h4 id="å†³ç­–æ ‘-1"><a href="#å†³ç­–æ ‘-1" class="headerlink" title="å†³ç­–æ ‘"></a>å†³ç­–æ ‘</h4><p>ä½¿ç”¨GridSearchCVå¯»æ‰¾æœ€ä¼˜å‚æ•°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">param <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'criterion'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'gini'</span><span class="token punctuation">,</span><span class="token string">'entropy'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token punctuation">{</span><span class="token string">'criterion'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'gini'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'max_depth'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'min_samples_leaf'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'min_impurity_decrease'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token punctuation">{</span><span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'min_impurity_decrease'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>grid <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>tree<span class="token punctuation">.</span>DecisionTreeClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>param_grid<span class="token operator">=</span>param<span class="token punctuation">,</span>cv<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>grid<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾—åˆ°çš„æœ€ä¼˜å‚æ•°ï¼š</p><p>æ­¤æ—¶æœ€ä¼˜ç»“æœï¼š26.8%</p><p>å¯¹å‚æ•°max_depthå–ä¸åŒå€¼ç»Ÿè®¡å‡†ç¡®ç‡</p><p>é‡å¤å‡ æ¬¡å³å¯å‘ç°ï¼Œmax_depthå‚æ•°å¯¹å‡†ç¡®ç‡çš„å½±å“çš„ç»“æœä¸æ˜æ˜¾ï¼Œæ›´å¤šæ˜¯éšæœºçš„å› ç´ ã€‚ï¼ˆsplitter=â€randomâ€ï¼‰</p><p>åŒæ ·ï¼Œå¯¹äºå‚æ•°min_sample_leafï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„ç»“æœ</p><h4 id="ç¥ç»ç½‘ç»œ-1"><a href="#ç¥ç»ç½‘ç»œ-1" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h4><p>ä¸€æ¬¡è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±ç‡ï¼š</p><p>åŒæ ·ï¼Œä½¿ç”¨GridSearchCVå¯»æ‰¾æœ€ä¼˜å‚æ•°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> GridSearchCVparam <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'hidden_layer_sizes'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'alpha'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.001</span><span class="token punctuation">,</span><span class="token number">0.0001</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'learning_rate_init'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.005</span><span class="token punctuation">,</span><span class="token number">0.001</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>grid <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>NN<span class="token punctuation">.</span>MLPClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>param_grid<span class="token operator">=</span>param<span class="token punctuation">,</span>cv<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>grid<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶çš„å‡†ç¡®ç‡ä¸º26.4%</p><h4 id="SVM-1"><a href="#SVM-1" class="headerlink" title="SVM"></a>SVM</h4><p>å®éªŒä¸­ï¼Œè¯¥SVMæ¨¡å‹é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•å®ç°ã€‚</p><p>æ­¤æ¬¡è®­ç»ƒçš„å‡†ç¡®ç‡ï¼š25.4%</p><p>ç”±å›¾å¯è§ï¼ŒSVMæ¨¡å‹çš„è®­ç»ƒæ”¶æ•›é€Ÿåº¦è¾ƒå¿«ï¼Œå¤§çº¦10æ¬¡å³å¯æ”¶æ•›ï¼ŒæŸå¤±ç”±8500ä¸‹é™åˆ°äº†3500ï¼Œä½†æ˜¯åœ¨æµ‹è¯•é›†çš„å‡†ç¡®ç‡ä»è¾ƒä½ï¼Œè¯´æ˜SVMå¯èƒ½å¯¹è®­ç»ƒé›†å­˜åœ¨è¿‡æ‹Ÿåˆï¼Œä¹Ÿæ— æ³•è¾ƒå¥½çš„å­¦ä¹ åˆ°æ•°æ®é›†ä¸­çš„æ•°æ®ã€‚</p><h4 id="XGBoost-1"><a href="#XGBoost-1" class="headerlink" title="XGBoost"></a>XGBoost</h4><p>å¯¹åº”çš„å‚æ•°å’Œå‡†ç¡®ç‡ï¼š</p><div class="table-container"><table><thead><tr><th>boost</th><th>gamma</th><th>max_depth</th><th>max_delta_step</th><th>å‡†ç¡®ç‡</th></tr></thead><tbody><tr><td>gblinear</td><td>-</td><td>-</td><td>0</td><td>25.6%</td></tr><tr><td>gbtree</td><td>0</td><td>-</td><td>0</td><td>25.2%</td></tr><tr><td>gbtree</td><td>0</td><td>3</td><td>0</td><td>25.7%</td></tr><tr><td>gbtree</td><td>0.1</td><td>3</td><td>0</td><td>25.4%</td></tr><tr><td>gbtree</td><td>0.1</td><td>3</td><td>1</td><td>25.8%</td></tr><tr><td>gbtree</td><td>0</td><td>3</td><td>1</td><td>25.4%</td></tr></tbody></table></div><p>å¯è§ï¼Œå‡†ç¡®ç‡æœ€é«˜çš„ä¸€ç»„å‚æ•°ä¸ºï¼šboost=â€™gbtreeâ€™,gamma=0.1,max_depth=3,max_delta_step=1</p><h3 id="å®éªŒåˆ†æ"><a href="#å®éªŒåˆ†æ" class="headerlink" title="å®éªŒåˆ†æ"></a>å®éªŒåˆ†æ</h3><p>ä»å®éªŒç»“æœçš„è§’åº¦åˆ†æï¼Œæœ¬æ¬¡å®éªŒçš„å®éªŒç»“æœè¾ƒä¸ç†æƒ³ï¼Œè®­ç»ƒæ•ˆæœæœ€å¥½çš„ä¸€ç»„æ•°æ®ä¸ºå€ŸåŠ©RFEè¿›è¡Œç‰¹å¾æŠ½å–ï¼Œçº¿æ€§å›å½’å¤šåˆ†ç±»æ¨¡å‹ï¼ˆ3000è½®è¿­ä»£ï¼‰ï¼Œæœ€ç»ˆçš„å‡†ç¡®ç‡ä¸º27.4%ï¼Œå…¶ä»–çš„æ¨¡å‹å‡åœ¨26%ä¸Šä¸‹æµ®åŠ¨ï¼Œå¯¹äºå››åˆ†ç±»é—®é¢˜ï¼Œè¿™æ ·çš„æ•ˆæœæ— ç–‘æ˜¯è¾ƒå·®çš„ï¼Œæ ¹æœ¬åŸå› åœ¨äºæ•°æ®ç‰¹å¾çš„æŠ½å–æ•ˆæœè¾ƒå·®ï¼Œä¾‹å¦‚æœ¬å®éªŒä¸­é‡‡ç”¨äº†ä¸‰ç§ä¸åŒçš„æ¨¡å‹æ¥è¿›è¡Œç‰¹å¾é€‰æ‹©ï¼Œæ¯æ¬¡é€‰å‡ºçš„ç‰¹å¾ä¹‹é—´çš„é‡åˆç‡è¾ƒä½ï¼Œå¹¶æœªæ‰¾åˆ°çœŸæ­£æœ‰æ•ˆçš„ç‰¹å¾ï¼Œå­¦ä¹ å™¨æ— æ³•å­¦åˆ°æ•°æ®çš„åˆ†å¸ƒç‰¹å¾ï¼Œå› æ­¤æ— è®ºæ˜¯åç»­è°ƒå‚è¿˜æ˜¯æ›´æ”¹æ¨¡å‹ï¼Œéƒ½æ— æ³•å¾—åˆ°è¾ƒå¥½çš„ç»“æœã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç‰¹å¾æŠ½å–&quot;&gt;&lt;a href=&quot;#ç‰¹å¾æŠ½å–&quot; class=&quot;headerlink&quot; title=&quot;ç‰¹å¾æŠ½å–&quot;&gt;&lt;/a&gt;ç‰¹å¾æŠ½å–&lt;/h2&gt;&lt;h3 id=&quot;å®éªŒç›®çš„&quot;&gt;&lt;a href=&quot;#å®éªŒç›®çš„&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒç›®çš„&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="http://sn1987a-1.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¯‘åŸç†-GVN</title>
    <link href="http://sn1987a-1.github.io/posts/7e7a9082.html"/>
    <id>http://sn1987a-1.github.io/posts/7e7a9082.html</id>
    <published>2022-11-14T12:48:34.000Z</published>
    <updated>2023-09-24T05:30:05.756Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ€è€ƒé¢˜"><a href="#æ€è€ƒé¢˜" class="headerlink" title="æ€è€ƒé¢˜"></a>æ€è€ƒé¢˜</h2><ol><li>è¯·ç®€è¿°æ¦‚å¿µï¼šæ”¯é…æ€§ã€ä¸¥æ ¼æ”¯é…æ€§ã€ç›´æ¥æ”¯é…æ€§ã€æ”¯é…è¾¹ç•Œã€‚</li></ol><ul><li>æ”¯é…æ€§<ul><li>åœ¨å…¥å£èŠ‚ç‚¹ä¸ºb0çš„æµå›¾ä¸­ï¼Œè‹¥biåœ¨ä»b0åˆ°bjçš„æ‰€æœ‰è·¯å¾„ä¸­å‡å‡ºç°ï¼Œåˆ™ç§°b1æ”¯é…bjï¼Œå…¶ä¸­Dom(bj)æ˜¯æ‰€æœ‰æ”¯é…bjçš„èŠ‚ç‚¹çš„é›†åˆ</li></ul></li><li>ä¸¥æ ¼æ”¯é…æ€§<ul><li>å¯¹äºæµå›¾ä¸­ç»™å®šçš„èŠ‚ç‚¹bï¼Œè‹¥èŠ‚ç‚¹$a\in Dom(b)-b$,åˆ™ç§°aä¸¥æ ¼æ”¯é…bèŠ‚ç‚¹</li></ul></li><li>ç›´æ¥æ”¯é…æ€§<ul><li>å¯¹äºæµå›¾ä¸­ç»™å®šçš„èŠ‚ç‚¹bï¼Œä¸¥æ ¼æ”¯é…bçš„èŠ‚ç‚¹é›†åˆä¸ºDom(b)-b,åœ¨è¯¥é›†åˆä¸­è·ç¦»bæœ€è¿‘çš„èŠ‚ç‚¹ç›´æ¥æ”¯é…bï¼Œè®°ä¸ºIDom(b)</li></ul></li><li>æ”¯é…è¾¹ç•Œ<ul><li>å¯¹äºæµå›¾ä¸­ç»™å®šçš„èŠ‚ç‚¹bï¼Œè‹¥èŠ‚ç‚¹aæ»¡è¶³:(1)bæ”¯é…aä¸€ä¸ªå‰é©±q($q\in preds(a),b\in Dom(q)$)(2)bä¸ä¸¥æ ¼æ”¯é…aï¼Œå°†å…·æœ‰è¿™ç§æ€§è´¨çš„açš„é›†åˆè®°ä¸ºbçš„æ”¯é…è¾¹ç•ŒDF(b)</li></ul></li></ul><ol><li><code>phi</code>èŠ‚ç‚¹æ˜¯SSAçš„å…³é”®ç‰¹å¾ï¼Œè¯·ç®€è¿°<code>phi</code>èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œä»¥åŠå¼•å…¥<code>phi</code>èŠ‚ç‚¹çš„ç†ç”±ã€‚</li></ol><p><code>phi</code>èŠ‚ç‚¹:å‡ºç°åœ¨ç¨‹åºåŸºæœ¬å—æ±‡åˆèŠ‚ç‚¹çš„å¯¹æŸä¸€å˜é‡xè¿›è¡Œä¸€æ¬¡æ–°çš„å®šä¹‰ï¼Œä½œä¸ºç¨‹åºçš„ä¸€æ¡æŒ‡ä»¤ï¼Œå®Œæˆäº†å°†æ¥è‡ªä¸åŒè¾¹çš„xçš„å€¼è¿›è¡Œåˆå¹¶çš„å·¥ä½œ</p><p>å¼•å…¥ç†ç”±:ä¸ºäº†æ»¡è¶³SSAçš„é™æ€å•èµ‹å€¼å½¢å¼ï¼Œæ²¿ç€æµå›¾çš„ä¸åŒè·¯å¾„ï¼Œxçš„å½“å‰å€¼å¯èƒ½è¢«åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼Œåœ¨å¤šæ¡è·¯å¾„çš„æ±‡åˆå¤„ï¼Œä¸åŒçš„é™æ€å•èµ‹å€¼å½¢å¼åå¿…é¡»è°ƒæ•´ä¸ºä¸€ä¸ªåå­—ï¼Œ<code>phi</code>èŠ‚ç‚¹çš„ä½œç”¨å°±æ˜¯åœ¨è·¯å¾„æ±‡åˆç‚¹å°†åŒä¸€å˜é‡çš„å¤šä¸ªå½¢å¼ååˆå¹¶ä¸ºä¸€ä¸ªåå­—ã€‚</p><ol><li><p>è§‚å¯Ÿä¸‹é¢ç»™å‡ºçš„<code>cminus</code>ç¨‹åºå¯¹åº”çš„ LLVM IRï¼Œä¸<strong>å¼€å¯</strong><code>Mem2Reg</code>ç”Ÿæˆçš„LLVM IRå¯¹æ¯”ï¼Œæ¯æ¡<code>load</code>, <code>store</code>æŒ‡ä»¤å‘ç”Ÿäº†å˜åŒ–å—ï¼Ÿå˜åŒ–æˆ–è€…æ²¡å˜åŒ–çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿè¯·åˆ†ç±»è§£é‡Šã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> globVar<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> arr<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> b<span class="token punctuation">;</span>    globVar <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    arr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>    b <span class="token operator">=</span> <span class="token number">2333</span><span class="token punctuation">;</span>    <span class="token function">func</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">func</span><span class="token punctuation">(</span>globVar<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>before <code>Mem2Reg</code>ï¼š</p><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">@globVar = global i32 zeroinitializerdeclare void @neg_idx_except()define i32 @func(i32 %arg0) {label_entry:  %op1 = alloca i32  store i32 %arg0, i32* %op1  %op2 = load i32, i32* %op1  %op3 = icmp sgt i32 %op2, 0  %op4 = zext i1 %op3 to i32  %op5 = icmp ne i32 %op4, 0  br i1 %op5, label %label6, label %label7label6:                                                ; preds = %label_entry  store i32 0, i32* %op1  br label %label7label7:                                                ; preds = %label_entry, %label6  %op8 = load i32, i32* %op1  ret i32 %op8}define i32 @main() {label_entry:  %op0 = alloca [10 x i32]  %op1 = alloca i32  store i32 1, i32* @globVar  %op2 = icmp slt i32 5, 0  br i1 %op2, label %label3, label %label4label3:                                                ; preds = %label_entry  call void @neg_idx_except()  ret i32 0label4:                                                ; preds = %label_entry  %op5 = getelementptr [10 x i32], [10 x i32]* %op0, i32 0, i32 5  store i32 999, i32* %op5  store i32 2333, i32* %op1  %op6 = load i32, i32* %op1  %op7 = call i32 @func(i32 %op6)  %op8 = load i32, i32* @globVar  %op9 = call i32 @func(i32 %op8)  ret i32 0}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After <code>Mem2Reg</code>ï¼š</p><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">@globVar = global i32 zeroinitializerdeclare void @neg_idx_except()define i32 @func(i32 %arg0) {label_entry:  %op3 = icmp sgt i32 %arg0, 0  %op4 = zext i1 %op3 to i32  %op5 = icmp ne i32 %op4, 0  br i1 %op5, label %label6, label %label7label6:                                                ; preds = %label_entry  br label %label7label7:                                                ; preds = %label_entry, %label6  %op9 = phi i32 [ %arg0, %label_entry ], [ 0, %label6 ]  ret i32 %op9}define i32 @main() {label_entry:  %op0 = alloca [10 x i32]  store i32 1, i32* @globVar  %op2 = icmp slt i32 5, 0  br i1 %op2, label %label3, label %label4label3:                                                ; preds = %label_entry  call void @neg_idx_except()  ret i32 0label4:                                                ; preds = %label_entry  %op5 = getelementptr [10 x i32], [10 x i32]* %op0, i32 0, i32 5  store i32 999, i32* %op5  %op7 = call i32 @func(i32 2333)  %op8 = load i32, i32* @globVar  %op9 = call i32 @func(i32 %op8)  ret i32 0}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ é™¤çš„<code>load</code>/<code>store</code>:</p><ul><li>ç¬¬6ï¼Œ7è¡Œï¼šç¨‹åºä¸­å¯¹å˜é‡xè¿›è¡Œäº†å¤šæ¬¡èµ‹å€¼ï¼Œåœ¨æœªå¼€å¯Mem2Regçš„IRä¸­æ˜¯é€šè¿‡å†—ä½™çš„è®¿å­˜å®ç°çš„ï¼Œåœ¨<code>load</code>è¯­å¥å‰çš„ç¨‹åºå—ä¸­å·²å­˜åœ¨xå¯¹åº”çš„å€¼ï¼Œåœ¨åˆ å»è¯¥æ¡<code>load</code>åï¼Œå˜é‡xä¸ä¼šè¢«å…¶ä»–è¯­å¥loadï¼Œ<code>store</code>è¯­å¥ä¹Ÿè¢«åˆ é™¤ï¼Œloadå’Œstoreæ˜¯ä¸å¿…è¦çš„ã€‚</li><li>ç¬¬13è¡Œï¼šæ­¤å¤„å¯¹xçš„å€¼è¿›è¡Œäº†å­˜å‚¨ï¼Œä½†æ˜¯åœ¨è¯¥è¯­å¥ä¹‹åxå¹¶ä¸æ˜¯æ´»è·ƒå˜é‡ï¼Œxçš„å€¼ä¸ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤è¯¥å¤„çš„storeæ˜¯å¤šä½™çš„ã€‚</li><li>ç¬¬32ï¼Œ33è¡Œï¼šç¨‹åºä¸­å¯¹å˜é‡bè¿›è¡Œäº†èµ‹å€¼ï¼Œåˆå°†bä½œä¸ºå‡½æ•°å‚æ•°è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°è°ƒç”¨æ—¶æ‰€ç”¨çš„å€¼å®é™…ä¸Šå°±æ˜¯ç«‹å³æ•°ï¼Œæ˜¯åœ¨è¯¥ç¨‹åºå—ä¸­å·²å­˜åœ¨å¯¹åº”çš„å€¼ï¼Œå› æ­¤å¯ä»¥ä¸ç”¨<code>load</code>ï¼Œä¹Ÿæ— éœ€<code>store</code>æŒ‡ä»¤ï¼Œæ­¤å¤„å¯ä»¥åˆ é™¤loadå’ŒstoreæŒ‡ä»¤ã€‚</li></ul><p>æœªå˜åŒ–çš„<code>load</code>/<code>store</code>:</p><ul><li>ç¬¬23è¡Œï¼šæ­¤å¤„<code>store</code>å¯¹å…¨å±€å˜é‡globVarè¿›è¡Œèµ‹å€¼ï¼Œå› ä¸ºæ˜¯ç”¨ç«‹å³æ•°æ›´æ–°æ•°æ®çš„å€¼ï¼Œç”±äº<code>Mem2Reg</code>ä¸ä¼šå¯¹è¯¥å…¨å±€å˜é‡è¿›è¡Œå¤„ç†ï¼Œéœ€è¦åœ¨æ­¤å¤„å­˜å‚¨å˜é‡çš„å€¼ï¼Œä¸å­˜åœ¨å†—ä½™ã€‚</li><li>ç¬¬31è¡Œï¼šæ­¤å¤„<code>store</code>å¯¹æ•°ç»„aä¸­çš„å…ƒç´ åˆ©ç”¨ç«‹å³æ•°è¿›è¡Œèµ‹å€¼ï¼Œç”±äº<code>Mem2Reg</code>ä¸ä¼šå¯¹æ•°ç»„å‹å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œéœ€è¦åœ¨æ­¤å¤„å­˜å‚¨å˜é‡çš„å€¼ï¼Œä¸å­˜åœ¨å†—ä½™ã€‚</li><li>ç¬¬35è¡Œï¼šæ­¤å¤„<code>load</code>å°†å…¨å±€å˜é‡globVarçš„å€¼èµ‹ç»™ä¸´æ—¶å˜é‡ï¼Œç”¨äºåç»­å‡½æ•°è°ƒç”¨ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œä¸”æ­¤å‰globVarå¯¹åº”çš„å€¼åœ¨è¯¥å—ä¸­ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å†—ä½™ï¼Œä¸éœ€è¦åˆ é™¤ã€‚</li></ul></li><li><p>æŒ‡å‡ºæ”¾ç½®phièŠ‚ç‚¹çš„ä»£ç ï¼Œå¹¶è§£é‡Šæ˜¯å¦‚ä½•ä½¿ç”¨æ”¯é…æ ‘çš„ä¿¡æ¯çš„ã€‚ï¼ˆéœ€è¦ç»™å‡ºä»£ç ä¸­çš„æˆå‘˜å˜é‡æˆ–æˆå‘˜å‡½æ•°åç§°ï¼‰</p><ul><li>æ”¾ç½®ä¼ªä»£ç çš„å‡½æ•°ä¸º<code>src\optimization\Mem2Reg.cpp</code>ä¸­çš„<code>Mem2Reg::generate_phi</code>å‡½æ•°ã€‚</li><li>step1ï¼šä»¥åŸºæœ¬å—ä¸ºå•ä½ï¼Œé€ä¸ªéå†å‡½æ•°çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œå…ˆæ‰¾å¤§æ´»è·ƒåœ¨å¤šä¸ªåŸºæœ¬å—çš„å˜é‡åŠå…¶å¯¹åº”çš„å—ï¼Œå­˜å‚¨åœ¨<code>live_var_2blocks</code>ä¸­</li><li>step2ï¼šå¯¹äºæ‰€æœ‰çš„å˜é‡ï¼Œé€æ¬¡éå†<code>live_var_2blocks</code>,åœ¨å¯¹åº”çš„domé›†åˆ<code>bb_dominance_frontier_bb</code>ä¸­ä¾æ¬¡å¯»æ‰¾æ”¯é…è¾¹ç•Œï¼Œå¦‚æœåœ¨è¯¥åŸºæœ¬å—ä¸­æœªæ·»åŠ <code>phi</code>ï¼ˆ<code>bb_has_var_phi</code>ä¸­ä¸å­˜åœ¨è®°å½•ï¼‰,åˆ™æ’å…¥<code>phi</code>ï¼š<code>create_phi</code>,åœ¨<code>bb_dominance_frontier_bb</code>ä¸­æ·»åŠ è¯¥è¯­å¥ï¼Œå¹¶åœ¨<code>bb_has_var_phi</code>ä¸­æ·»åŠ è®°å½•ï¼Œé˜²æ­¢é‡å¤æ·»åŠ ã€‚</li></ul></li><li><p>ç®—æ³•æ˜¯å¦‚ä½•é€‰æ‹©<code>value</code>(å˜é‡æœ€æ–°çš„å€¼)æ¥æ›¿æ¢<code>load</code>æŒ‡ä»¤çš„ï¼Ÿï¼ˆæè¿°æ¸…æ¥šå¯¹åº”å˜é‡ä¸ç»´æŠ¤è¯¥å˜é‡çš„ä½ç½®ï¼‰</p></li></ol><ul><li>é€‰æ‹©<code>value</code>æ¥æ›¿æ¢<code>load</code>æŒ‡ä»¤çš„ä½ç½®åœ¨<code>src\optimization\Mem2Reg.cpp</code>ä¸­çš„<code>Mem2Reg::rename()</code>å‡½æ•°ã€‚</li><li>å¯¹å…¨å±€å˜é‡<code>var_val_stack</code>è¿›è¡Œä»¥ä¸‹è°ƒç”¨å’Œç»´æŠ¤ï¼š<ul><li>ç¬¬ä¸€æ¬¡éå†åŸºæœ¬å—çš„æ‰€æœ‰æŒ‡ä»¤ï¼š<code>phi</code>æŒ‡ä»¤ï¼šæ ¹æ®æ’å…¥çš„<code>phi</code>æŒ‡ä»¤ï¼Œå°†å¯¹åº”å˜é‡çš„æœ€æ–°å®šå€¼çš„ä½ç½®è®¾ä¸ºè¯¥<code>phi</code>è¯­å¥</li><li>ç¬¬äºŒæ¬¡éå†åŸºæœ¬å—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ï¼š<code>load</code>æŒ‡ä»¤ï¼šå¦‚æœloadçš„å˜é‡åœ¨<code>var_val_stack</code>ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™å°†è¯¥è¯­å¥åŠ å…¥<code>wait_delete</code>ï¼Œå¹¶ç»´æŠ¤å¯¹åº”çš„å…¨å±€å˜é‡ã€‚<code>store</code>æŒ‡ä»¤ï¼šå°†storeå­˜å…¥å†…å­˜çš„å€¼ä½œä¸ºæœ€æ–°å®šå€¼</li><li>å€ŸåŠ©<code>get_succ_basic_blocks</code>è¡¥å……å› <code>phi</code>æ”¹åŠ¨çš„<code>var_val_stack</code>å¯¹åº”çš„å€¼</li><li>ç¬¬ä¸‰æ¬¡éå†åŸºæœ¬å—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ï¼špopå‡º<code>var_val_stack</code>ä¸­çš„æœ€æ–°å®šå€¼</li></ul></li><li>åœ¨ç¬¬äºŒæ¬¡éå†ä¸­ï¼Œå¯¹äº<code>load</code>æŒ‡ä»¤ï¼Œå¦‚æœloadçš„å˜é‡åœ¨<code>var_val_stack</code>ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™å°†è¯¥è¯­å¥åŠ å…¥<code>wait_delete</code>ï¼Œå¹¶åˆ©ç”¨<code>replace_all_use_with</code>å‡½æ•°ç»´æŠ¤å…¶ä»–æŒ‡ä»¤ã€‚æœ€åå°†<code>wait_delete</code>è¿›è¡Œåˆ é™¤ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤<code>load</code>æŒ‡ä»¤ã€‚</li></ul><h3 id="ä»£ç é˜…è¯»æ€»ç»“"><a href="#ä»£ç é˜…è¯»æ€»ç»“" class="headerlink" title="ä»£ç é˜…è¯»æ€»ç»“"></a>ä»£ç é˜…è¯»æ€»ç»“</h3><p>æ­¤æ¬¡å®éªŒçš„ä¸»è¦å†…å®¹æ˜¯ç†Ÿæ‚‰ä»£ç ä¼˜åŒ–çš„åŸºç¡€çŸ¥è¯†ï¼Œäº†è§£SSAæ ¼å¼çš„IRçš„ç›¸å…³æ¦‚å¿µï¼Œå¹¶é˜…è¯»äº†ç”¨æ¥ä¼˜åŒ–Lab3ç”Ÿæˆçš„IRæŒ‡ä»¤çš„<code>Mem2Reg</code>ç›¸å…³ä»£ç ,ä¸»è¦ä¼˜åŒ–äº†å†—ä½™çš„loadï¼Œstoreï¼ŒallocaæŒ‡ä»¤ã€‚ä¸»è¦æ”¶è·æ˜¯ç†Ÿæ‚‰äº†æ”¯é…èŠ‚ç‚¹ï¼Œæ”¯é…è¾¹ç•Œç­‰æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•å°†è¿™äº›æ¦‚å¿µç”¨äºä»£ç ä¼˜åŒ–ï¼Œå¦‚ä½•åœ¨ç¨‹åºä¸­ç»´æŠ¤å’Œåˆ©ç”¨è¿™äº›å±æ€§æ¥å®ç°ä»£ç çš„ä¼˜åŒ–ã€‚</p><h2 id="PART2-å®éªŒè¦æ±‚"><a href="#PART2-å®éªŒè¦æ±‚" class="headerlink" title="PART2 å®éªŒè¦æ±‚"></a>PART2 å®éªŒè¦æ±‚</h2><p>æœ¬æ¬¡å®éªŒè¦å®Œæˆçš„ç›®æ ‡æ˜¯åœ¨lab4.1 SSA IRçš„åŸºç¡€ä¸Šï¼Œæ ¹æ®å®éªŒæ¡†æ¶å®Œæˆå¯¹SSA IRåŸºäºæ•°æ®æµåˆ†æå®Œæˆçš„GVNä¼˜åŒ–ã€‚</p><h2 id="å®éªŒéš¾ç‚¹"><a href="#å®éªŒéš¾ç‚¹" class="headerlink" title="å®éªŒéš¾ç‚¹"></a>å®éªŒéš¾ç‚¹</h2><ul><li>æ ¹æ®LLVM IRçš„æŒ‡ä»¤ç±»å‹è®¾è®¡Expressionå­ç±»çš„ç±»å‹ï¼Œå¹¶é€šè¿‡é€’å½’å®šä¹‰çš„æ–¹æ³•å®šä¹‰å€¼è¡¨è¾¾å¼ï¼Œå®Œæˆ<code>Value Expr</code></li><li>å¤„ç†<code>phi</code>æŒ‡ä»¤ï¼Œæ„æ€è®¾è®¡<code>copy stmt</code>éƒ¨åˆ†å’Œ<code>intersect</code>,<code>ValuePhiFunc</code>å‡½æ•°</li></ul><h2 id="å®éªŒè®¾è®¡"><a href="#å®éªŒè®¾è®¡" class="headerlink" title="å®éªŒè®¾è®¡"></a>å®éªŒè®¾è®¡</h2><h3 id="å®éªŒæ€è·¯"><a href="#å®éªŒæ€è·¯" class="headerlink" title="å®éªŒæ€è·¯"></a>å®éªŒæ€è·¯</h3><h4 id="ValueNumber"><a href="#ValueNumber" class="headerlink" title="ValueNumber"></a>ValueNumber</h4><p>GVNçš„æ ¸å¿ƒå°±æ˜¯å»ºç«‹å…¨å±€å€¼ç¼–å·ï¼Œæœ¬æ¬¡å®éªŒä¸­ä½¿ç”¨valueexprä½œä¸ºå€¼ç¼–å·ï¼Œæ¯ä¸ªç­‰ä»·ç±»çš„valueexpræ˜¯å”¯ä¸€çš„ã€‚</p><p>ä¸ºäº†è§£å†³å¯èƒ½å­˜åœ¨çš„valueexprç›¸äº’ä¾èµ–å¯¼è‡´çš„æ— é™é€’å½’çš„é—®é¢˜ï¼Œå°†ç­‰ä»·ç±»è¿ç®—ç¬¦é‡è½½éƒ¨åˆ†å®šä¹‰ä¸ºï¼š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">bool CongruenceClass::operator==(const CongruenceClass &amp;other) const {    auto v1=value_expr_;    auto v2=other.value_expr_;    if(v2==nullptr&amp;&amp;v1==nullptr)    return true;    else if(v1==nullptr||v2==nullptr)    return false;   if(members_==other.members_)    return true;    return false;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å³ï¼Œç®—æ³•æ”¶æ•›çš„åˆ¤æ–­ä¾æ®æ˜¯æ ¹æ®ç­‰ä»·ç±»æˆå‘˜ä¸å†æ”¹å˜ï¼Œè€Œä¸æ˜¯æ ¹æ®valueexprçš„å€¼ä¸å†æ”¹å˜ï¼Œè¿™æ ·å°±å¯ä»¥é¿å¼€valueexpræ— é™é€’å½’çš„æƒ…å†µã€‚</p><p>ä¸ºäº†è·å–ä¸€ä¸ªå˜é‡çš„valueexprï¼Œå°†getVNå®šä¹‰å¦‚ä¸‹ï¼š</p><p>å…¶ä¸­å¦‚æœveçš„è¡¨è¾¾å¼ä¸ºSingleExpressionçš„ç±»å‹æ—¶ï¼Œæ˜¯åœ¨valueexprå¯»æ‰¾å‚æ•°å¯¹åº”çš„å€¼è¡¨è¾¾å¼æ—¶å»ºç«‹çš„Expressionã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">shared_ptr&lt;Expression&gt; GVN::getVN(const partitions &amp;pout, shared_ptr&lt;Expression&gt; ve) {  if(ve==nullptr)   return nullptr;       auto sve=std::dynamic_pointer_cast&lt;SingleExpression&gt;(ve);    if(sve!=nullptr)    {         auto num=dynamic_cast&lt;Constant*&gt;(sve-&gt;va());        if(num!=nullptr)        return ConstantExpression::create(num);    for(auto &amp;cc:pout)    {        if(cc-&gt;index_==0)        return nullptr;        for(auto &amp;mem:cc-&gt;members_)            if(mem==sve-&gt;va())                return cc-&gt;value_expr_ ;    }    for(auto &amp;cc:pout)    {        if(cc-&gt;index_==0)        return nullptr;        if(*ve==*cc-&gt;value_expr_)        return cc-&gt;value_expr_;    }    return nullptr;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="valueexpr"><a href="#valueexpr" class="headerlink" title="valueexpr"></a>valueexpr</h4><p>åœ¨Expressionä¸­æ–°å»ºè‹¥å¹²å­ç±»ï¼Œå¹¶å®Œå–„å¯¹åº”çš„å†…éƒ¨å˜é‡å’Œåˆ›å»ºï¼Œæ¯”è¾ƒï¼Œæ‰“å°ç­‰å‡½æ•°</p><ul><li><code>Single Expression</code>ï¼Œå­˜æ”¾éçº¯å‡½æ•°ï¼Œload/storeæŒ‡ä»¤çš„value</li><li><code>Constant Expression</code>ï¼Œå¸¸æ•°</li><li><code>Binary Expression</code>ï¼ŒäºŒå…ƒæŒ‡ä»¤çš„æ“ä½œæ•°å’Œç±»å‹</li><li><code>Phi Expression</code>ï¼ŒphiæŒ‡ä»¤çš„æ“ä½œæ•°</li><li><code>Call Expression</code>ï¼Œå‡½æ•°è°ƒç”¨æŒ‡ä»¤çš„å‡½æ•°ç±»å‹å’Œå’Œå‡½æ•°å‚æ•°ï¼Œä»…è€ƒè™‘çº¯å‡½æ•°</li><li><code>Gep Expression</code>ï¼Œå­˜gepæŒ‡ä»¤çš„æ“ä½œæ•°</li><li><code>Cmp Expression</code>ï¼Œç±»å‹ä¸ºicmpçš„æŒ‡ä»¤çš„æŒ‡ä»¤ç±»å‹ï¼ˆcmp_op)å’Œæ“ä½œæ•°</li><li><code>Fcmp Expression</code>ï¼Œç±»å‹ä¸ºfcmpçš„æŒ‡ä»¤çš„æŒ‡ä»¤ç±»å‹ï¼ˆcmp_op)å’Œæ“ä½œæ•°</li><li><code>Trans Expression</code>ï¼Œç±»å‹è½¬æ¢çš„æŒ‡ä»¤ç±»å‹å’Œæ“ä½œæ•°</li></ul><p>æ ¹æ®æŒ‡ä»¤ç±»å‹çš„ä¸åŒåˆ†åˆ«å¤„ç†ï¼š</p><ul><li>phiæŒ‡ä»¤ï¼šå°†åœ¨intersectä¸­å’Œtransferä¸­å¤„ç†ï¼Œæ­¤å¤„ä¸ä¼šå¤„ç†</li><li>voidç±»å‹æŒ‡ä»¤ï¼šæ­¤ç±»æŒ‡ä»¤ä¸ä¼šè¢«å¤„ç†</li><li>callæŒ‡ä»¤ï¼šè‹¥å±äºçº¯å‡½æ•°ï¼Œæ‰¾åˆ°å‚æ•°çš„å€¼è¡¨è¾¾å¼å¹¶å»ºç«‹<code>CallExpression</code>ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ª<code>SingleExpression</code>ç±»å‹çš„ve</li><li>gepæŒ‡ä»¤ï¼šç±»ä¼¼äºçº¯å‡½æ•°ï¼Œæ‰¾åˆ°å„ä¸ªå‚æ•°å¯¹åº”çš„å€¼è¡¨è¾¾å¼å¹¶å»ºç«‹<code>GepExpression</code></li><li>cmp,fcmp,binary,fp2si,si2fp,zextæŒ‡ä»¤ï¼šæ‰¾åˆ°å‚æ•°å¯¹åº”çš„å€¼è¡¨è¾¾å¼ï¼Œè¿›è¡Œå¸¸é‡ä¼ æ’­ï¼Œå¹¶å»ºç«‹å¯¹åº”çš„expressionï¼š<code>CmpExpression,FcmpExpression,BinaryExpression,TransExpression</code></li><li>å…¶ä»–è¯­å¥ï¼Œæ–°å»º<code>SingleExpression</code>ä½œä¸ºå€¼è¡¨è¾¾å¼</li></ul><h4 id="å¤„ç†Phi"><a href="#å¤„ç†Phi" class="headerlink" title="å¤„ç†Phi"></a>å¤„ç†Phi</h4><p>ç”±äºPhiæŒ‡ä»¤è¦ä½œä¸º<code>Copy stmt</code>åŠ å…¥æ¯ä¸ªåŸºæœ¬å—çš„å‰é©±ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥åœ¨æ¯ä¸ªåŸºæœ¬å—æŒ‡ä»¤éå†å®Œåï¼Œéå†å¹¶å¤„ç†è¯¥åŸºæœ¬å—åç»§ä¸­å‡ºç°çš„phiæŒ‡ä»¤ï¼Œå°†åç»§å—ä¸­çš„phiæŒ‡ä»¤åŠ å…¥è¯¥åŸºæœ¬å—çš„ç­‰ä»·ç±»ä¸­ã€‚</p><p>PhiæŒ‡ä»¤ä¸ºå››å…ƒæŒ‡ä»¤ï¼ŒæŒ‡ä»¤æ“ä½œæ•°ä¾æ¬¡ä¸º[op,label;op,label],æ­¤å¤„å¯ä»¥é€šè¿‡get_name()è·å–labelå’Œbbçš„åå­—è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™å€ŸåŠ©<code>transferFunction</code>åœ¨è¯¥å—ç­‰ä»·ç±»ä¸­æ·»åŠ è¯¥æ¡è¯­å¥ã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">auto succ=bb.get_succ_basic_blocks();if(succ.size()&gt;0)    for(auto s:succ)        for(auto &amp;sinst:s-&gt;get_instructions())            if(sinst.is_phi())            {                auto op0=sinst.get_operand(0);                //op1/2/3=...                if(op1-&gt;get_name()==bb.get_name())                    pouts=GVN::transferFunction(&amp;sinst,op0,pouts);                if(op3-&gt;get_name()==bb.get_name())                    pouts=GVN::transferFunction(&amp;sinst,op2,pouts);            }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ºäº†å¤„ç†å­˜åœ¨äº†ä¸¤ä¸ªå‰é©±å—çš„åŸºæœ¬å—çš„pinï¼Œéœ€è¦è®¾è®¡Joinå’Œintersectå‡½æ•°ã€‚</p><p>å…¶ä¸­ï¼ŒTopå—è®¾è®¡ä¸ºåªå«æœ‰ä¸€ä¸ªç­‰ä»·ç±»ï¼Œä¸”ç­‰ä»·ç±»çš„ç´¢å¼•ä¸º0çš„é›†åˆ;Joinå‡½æ•°é‡åˆ°Topå—æ—¶ï¼Œè§„å®š<code>Join(P, Top) = P = Join(Top, P)</code>ï¼Œå¦åˆ™é€ä¸ªéå†ç­‰ä»·ç±»å¹¶è°ƒç”¨intersectå‡½æ•°ã€‚</p><p>è€Œå¯¹äºIntersectå‡½æ•°ï¼Œå¯¹äºå…¶ä»–éphiè¯­å¥ï¼Œè‹¥members_å­˜åœ¨äº¤é›†ï¼Œåˆ™å¿…ç„¶æœ‰è¯¥ä¸¤ä¸ªç­‰ä»·ç±»çš„å€¼è¡¨è¾¾å¼ä¸€è‡´ï¼Œè¿›è¡Œåˆå¹¶å³å¯ï¼Œå¦åˆ™åˆå¹¶å¾—åˆ°çš„Ckä¸ºç©ºï¼›å¯¹äºå°†å‡ºç°åœ¨ä¸‹ä¸€ä¸ªåŸºæœ¬å—çš„ï¼ˆåœ¨ä¸Šæ–‡ä¸­æ·»åŠ ï¼‰çš„phiè¯­å¥ï¼Œå°±ä¼šå­˜åœ¨<code>members</code>ä¸ä¸ºç©ºä¸”valueexprä¸ç›¸ç­‰çš„æƒ…å†µï¼Œæ­¤æ—¶åœ¨Ckä¸­æ ¹æ®Phiæ–°å»ºvalueexprå’ŒvaluePhiè¯­å¥ï¼Œå³å¯å®Œæˆå¯¹Phiè¯­å¥çš„å¤„ç†ã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for(auto i :Ci-&gt;members_)    if(Cj-&gt;members_.find(i)!=Cj-&gt;members_.end())    {        Ck-&gt;members_.insert(i);        if(Ck-&gt;leader_==nullptr)            Ck-&gt;leader_=i;    }if(Ci-&gt;value_expr_==Cj-&gt;value_expr_){    Ck-&gt;value_expr_=Ci-&gt;value_expr_;    Ck-&gt;value_phi_=Ci-&gt;value_phi_;    Ck-&gt;leader_=Ci-&gt;leader_;}else if(Ck-&gt;members_.size()!=0){    Ck-&gt;value_phi_=PhiExpression::create(Ci-&gt;value_expr_,Cj-&gt;value_expr_);    Ck-&gt;value_expr_=PhiExpression::create(Ci-&gt;value_expr_,Cj-&gt;value_expr_);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤å¤–ï¼Œåœ¨valuePhiFuncå‡½æ•°ä¸­éœ€è¦è¯†åˆ«phiå‡½æ•°ä¹‹é—´å­˜åœ¨çš„å†—ä½™ï¼Œå‡½æ•°æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>åªéœ€è¦å¤„ç†binaryå‡½æ•°ä¸­çš„phiè¯­å¥å­˜åœ¨çš„å†—ä½™ï¼Œå¹¶ä¸”è¯¥binaryæŒ‡ä»¤çš„lhså’Œrhså‡ä¸ºPhiç±»å‹ï¼Œæ ¹æ®æŒ‡ä»¤çš„å€¼è¡¨è¾¾å¼å³å¯è¿›è¡Œä¸Šè¿°ç±»å‹åˆ¤æ–­ï¼ŒæŒ‡ä»¤æ ¼å¼ä¸ºbin(phi(vi1,vj1),phi(vi2,vj2))</li><li>æ ¹æ®vi1,vi2,vj1,vj2(æ­¤æ—¶å‡ä¸ºå€¼è¡¨è¾¾å¼)åˆ›å»ºæ–°çš„äºŒå…ƒè¡¨è¾¾å¼ï¼šc1=bin(vi1,vi2),c2=bin(vj1,vj2)</li><li>åœ¨è¯¥åŸºæœ¬å—çš„å‰é©±å—ä¸­æ‰¾åˆ°c1,c2å¯¹åº”çš„å€¼è¡¨è¾¾å¼ï¼Œå€ŸåŠ©getVNå®ç°ï¼Œå¦‚æœæœªæ‰¾åˆ°å¯¹åº”çš„å€¼è¡¨è¾¾å¼ï¼Œåˆ™é€’å½’æŸ¥æ‰¾è¯¥å‰é©±å—çš„valuePhiFunc</li><li>å¦‚æœæ‰¾åˆ°å¯¹åº”çš„å€¼è¡¨è¾¾å¼ï¼Œå€ŸåŠ©ä¸¤ä¸ªå€¼è¡¨è¾¾å¼æ–°å»ºphiæŒ‡ä»¤å¹¶è¿”å›ï¼Œå¦åˆ™è¿”å›nullptr</li></ul><h4 id="transferFunction"><a href="#transferFunction" class="headerlink" title="transferFunction"></a>transferFunction</h4><p><code>transferFunction</code>å‡½æ•°çš„ä¸»è¦æ€è·¯ï¼š</p><ul><li>åœ¨å·²æœ‰ç­‰ä»·ç±»ä¸­åˆ¤æ–­è¯¥æŒ‡ä»¤æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤ï¼Œå¦‚æœè¯¥æŒ‡ä»¤åœ¨å¯¹åº”çš„ç­‰ä»·ç±»ä¸­ä½œä¸ºleaderå‡ºç°ï¼Œå°†é‡æ–°æŒ‡å®šleader</li><li>æ‰¾åˆ°eå¯¹åº”çš„å€¼è¡¨è¾¾å¼ï¼ˆgetVNï¼‰ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå°†xæ·»åŠ åˆ°å¯¹åº”çš„ç­‰ä»·ç±»é›†åˆä¸­ï¼Œï¼ˆå¤„ç†åç»§å—phiè¯­å¥çš„æƒ…å†µä¸‹å¯èƒ½ä¼šæ‰§è¡Œè¯¥æ­¥éª¤ï¼‰ï¼Œè¿”å›pout</li><li>å¦‚æœeä¸ºå¸¸æ•°ç±»ï¼Œå› ä¸ºä¸Šæ–‡ä¸­æœªæ‰¾åˆ°å¯¹åº”çš„ç­‰ä»·ç±»ï¼Œå°†æ–°å»ºç­‰ä»·ç±»ï¼Œvalue_expr_å³ä¸ºè¯¥å¸¸æ•°å¯¹åº”çš„å¸¸æ•°è¡¨è¾¾å¼ï¼Œæ·»åŠ åˆ°poutä¸­å¹¶è¿”å›</li><li>è°ƒç”¨valueexprå’ŒvaluePhifuncå‡½æ•°ï¼Œæ‰¾åˆ°å¯¹åº”çš„veå’Œvpfï¼Œå¹¶éå†å·²æœ‰ç­‰ä»·ç±»ï¼Œå¦‚æœå·²æœ‰ç­‰ä»·ç±»ä¸­å­˜åœ¨è¯¥veæˆ–vpfï¼Œå³å¯åœ¨ç­‰ä»·ç±»ä¸­æ·»åŠ è¯¥æˆå‘˜ï¼Œå¦åˆ™ä»¥è¯¥æ¡æŒ‡ä»¤ä¸ºleaderæ–°å»ºç­‰ä»·ç±»ï¼Œè¿”å›pout</li></ul><h4 id="detectEquivalences"><a href="#detectEquivalences" class="headerlink" title="detectEquivalences"></a>detectEquivalences</h4><p>åœ¨ä¸Šè¿°æ¡†æ¶çš„åŸºç¡€ä¸Šï¼Œå®Œå–„<code>detectequivalences</code>å‡½æ•°ï¼š</p><ul><li><p>ä¸æ–­æ·±åº¦ä¼˜å…ˆéå†åŸºæœ¬å—ï¼Œç›´åˆ°æ¯ä¸ªåŸºæœ¬å—çš„ç­‰ä»·ç±»é›†åˆä¸å†æ”¹å˜</p></li><li><p>åœ¨label_entryä½ç½®å¤„ç†å‡½æ•°å‚æ•°ï¼Œå…¨å±€å˜é‡ï¼Œå¯¹äºè¿™ç±»å‚æ•°ç›´æ¥æ–°å»ºç­‰ä»·ç±»å³å¯</p></li><li><p>å¯¹äºæ¯ä¸ªåŸºæœ¬å—ï¼Œå¦‚æœåŒ…å«å¤šä¸ªå‰é©±ï¼Œè°ƒç”¨joinè·å–pinï¼Œå¦åˆ™ç›´æ¥å°†å‰é©±å—çš„ç­‰ä»·ç±»ä½œä¸ºpin</p></li><li><p>éå†æ¯æ¡æŒ‡ä»¤å¹¶è°ƒç”¨transferFunctionå‡½æ•°æ›´æ”¹å½“å‰åŸºæœ¬å—ç­‰ä»·ç±»æˆå‘˜</p></li><li><p>è®¿é—®å½“å‰åŸºæœ¬å—çš„åç»§åŸºæœ¬å—ï¼Œå¤„ç†phiå‡½æ•°</p><p>å…·ä½“ä»£ç æ€è·¯å¦‚ä¸‹æ‰€ç¤º</p></li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for(auto &amp;bb:func_-&gt;get_basic_blocks())    if(&amp;bb==entry) continue;    else pout_[&amp;bb]=clone(top);do     next_value_number_=1;    changed=false;    for (auto &amp;bb : func_-&gt;get_basic_blocks())         partitions pouts={};        if(&amp;bb!=entry)            if( bb.get_pre_basic_blocks().size()&gt;1)            //use join() to deal with            else  for(auto s:predecessors)                 pouts=clone(pout_[s]);        else             //deal with func args and global var        for(auto &amp;inst:bb.get_instructions())            if(!inst.is_void()&amp;&amp;!inst.is_phi())                pouts=GVN::transferFunction(&amp;inst,&amp;inst,pouts);        //deal with phi instr        if(pouts!=pout_[&amp;bb])            changed=true;          pout_[&amp;bb]=std::move(pouts);while (changed);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å¸¸é‡ä¼ æ’­"><a href="#å¸¸é‡ä¼ æ’­" class="headerlink" title="å¸¸é‡ä¼ æ’­"></a>å¸¸é‡ä¼ æ’­</h4><p>å¸¸é‡ä¼ æ’­/å¸¸é‡æŠ˜å æ˜¯ä¸ºäº†åœ¨ç¼–è¯‘æ—¶è¿›è¡Œè®¡ç®—ç¨‹åºä¸­å­˜åœ¨çš„å¸¸æ•°ï¼Œå¦‚äºŒå…ƒè®¡ç®—ï¼Œcmpï¼Œç±»å‹è½¬æ¢æŒ‡ä»¤ï¼Œä»¥ä¾¿æä¾›æ›´å¤šå¯ä¼˜åŒ–çš„è¡¨è¾¾å¼ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚åªéœ€è¦åœ¨ä¸¤ä¸ªåœ°æ–¹å¤„ç†ï¼švalueexpréƒ¨åˆ†å’Œvaluephifuncéƒ¨åˆ†ã€‚</p><p>valueexpréƒ¨åˆ†ï¼šå¯¹binaryï¼Œcmpï¼Œtransè¯­å¥å‡è¿›è¡Œå¸¸é‡ä¼ æ’­ï¼š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">//äºŒå…ƒif(expr1-&gt;get_expr_type()==Expression::e_constant&amp;&amp;expr2-&gt;get_expr_type()==Expression:: e_constant){    auto e1=std::dynamic_pointer_cast&lt;ConstantExpression&gt;(expr1);    auto e2=std::dynamic_pointer_cast&lt;ConstantExpression&gt;(expr2);    auto expr=folder_-&gt;compute(instr,e1-&gt;get_c(),e2-&gt;get_c());    return ConstantExpression::create(expr);}//ä¸€å…ƒ if(ve-&gt;get_expr_type()==Expression::e_constant) {     auto e=std::dynamic_pointer_cast&lt;ConstantExpression&gt;(ve);     auto expr=folder_-&gt;compute(instr,e-&gt;get_c());     return ConstantExpression::create(expr); }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨valuePhiFuncä¸­ï¼Œåªéœ€å¤„ç†å¯¹binaryæŒ‡ä»¤çš„å¸¸é‡ä¼ æ’­ï¼Œä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œåœ¨ConstFolderç±»ä¸­æ·»åŠ å¯¹computeçš„é‡è½½ï¼ˆå‚æ•°ä¸ºInstruction::opID,Constant<em>,Constant\</em>)</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++"> auto e1=std::dynamic_pointer_cast&lt;ConstantExpression&gt;(vi1);auto e2=std::dynamic_pointer_cast&lt;ConstantExpression&gt;(vi2);auto e=folder_-&gt;compute(opid,e1-&gt;get_c(),e2-&gt;get_c());c1=ConstantExpression::create(e);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>ä»¥<code>bin.cminus</code>ä¸ºä¾‹ï¼Œæœªå¼€å¯ä»£ç ä¼˜åŒ–æ—¶ï¼Œç”Ÿæˆçš„LLVM ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">define i32 @main() {label_entry:  %op0 = call i32 @input()  %op1 = call i32 @input()  %op2 = icmp sgt i32 %op0, %op1  %op3 = zext i1 %op2 to i32  %op4 = icmp ne i32 %op3, 0  br i1 %op4, label %label5, label %label14label5:                                                ; preds = %label_entry  %op6 = add i32 33, 33  %op7 = add i32 44, 44  %op8 = add i32 %op6, %op7  br label %label9label9:                                                ; preds = %label5, %label14  %op10 = phi i32 [ %op8, %label5 ], [ %op17, %label14 ]  %op11 = phi i32 [ %op7, %label5 ], [ %op16, %label14 ]  %op12 = phi i32 [ %op6, %label5 ], [ %op15, %label14 ]  call void @output(i32 %op10)  %op13 = add i32 %op12, %op11  call void @output(i32 %op13)  ret i32 0label14:                                                ; preds = %label_entry  %op15 = add i32 55, 55  %op16 = add i32 66, 66  %op17 = add i32 %op15, %op16  br label %label9}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€å¯ä»£ç ä¼˜åŒ–åï¼Œæœ€ç»ˆç”Ÿæˆçš„ä»£ç ï¼›</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">define i32 @main() {label_entry:  %op0 = call i32 @input()  %op1 = call i32 @input()  %op2 = icmp sgt i32 %op0, %op1  %op3 = zext i1 %op2 to i32  %op4 = icmp ne i32 %op3, 0  br i1 %op4, label %label5, label %label14label5:                                                ; preds = %label_entry  %op6 = add i32 33, 33  %op7 = add i32 44, 44  %op8 = add i32 %op6, %op7  br label %label9label9:                                                ; preds = %label5, %label14  %op10 = phi i32 [ %op8, %label5 ], [ %op17, %label14 ]  call void @output(i32 %op10)  call void @output(i32 %op10)  ret i32 0label14:                                                ; preds = %label_entry  %op15 = add i32 55, 55  %op16 = add i32 66, 66  %op17 = add i32 %op15, %op16  br label %label9}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œ<code>op13</code>å’Œ<code>op10</code>ç­‰ä»·ï¼Œç»è¿‡æ­»ä»£ç åˆ é™¤ï¼Œå°†åˆ é™¤è®¡ç®—op13ä¸op11ï¼Œop12çš„è¯­å¥ã€‚</p><p>ä¸Šè¿°ä¾‹å­å„ä¸ªåŸºæœ¬å—çš„ç­‰ä»·ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-josn" data-language="josn"><code class="language-josn">"label_entry": [["%op0", ], ["%op1", ], ["%op2", ], ["%op3", ], ["%op4", ], ],"label5": [["%op0", ], ["%op1", ], ["%op2", ], ["%op3", ], ["%op4", ], ["%op6", "%op12", ], ["%op7", "%op11", ], ["%op8", "%op10", ],  ],"label9": [["%op0", ], ["%op1", ], ["%op2", ], ["%op3", ], ["%op4", ], , ["%op13", "%op10", ], ["%op11", ], ["%op12", ], ],"label14": [["%op0", ], ["%op1", ], ["%op2", ], ["%op3", ], ["%op4", ], ["%op15", "%op12", ], ["%op16", "%op11", ], ["%op17", "%op10", ],, ],}},]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€è€ƒé¢˜-1"><a href="#æ€è€ƒé¢˜-1" class="headerlink" title="æ€è€ƒé¢˜"></a>æ€è€ƒé¢˜</h3><p>1.è¯·ç®€è¦åˆ†æä½ çš„ç®—æ³•å¤æ‚åº¦</p><p>ä»…å¯¹ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†ä»¥æŒ‡ä»¤ä¸ºå•ä½è¿›è¡Œè®¨è®ºï¼Œå®éªŒå®Œæˆéƒ¨åˆ†çš„ä»£ç ç”±<code>run()</code>å‡½æ•°é€ä¸ªåˆ†ææ¯ä¸ªå‡½æ•°ï¼Œå¹¶è¿›å…¥<code>detectEquivalences()</code>å‡½æ•°ï¼Œåœ¨<code>detectEquivalences()</code>å‡½æ•°ä¸­ï¼Œå¯¹å‡½æ•°ä¸­çš„åŸºæœ¬å—ä¸æ–­è¿›è¡Œéå†åˆ†æå¾—åˆ°æ¯ä¸ªåŸºæœ¬å—çš„<code>pin</code>å’Œ<code>pout</code>ç­‰ä»·ç±»ï¼Œç›´åˆ°<code>pout</code>æ”¶æ•›ï¼Œä»£è¡¨è¯¥å‡½æ•°åˆ†æå®Œæˆï¼Œä¸€èˆ¬æ¥è¯´ï¼Œéå†çš„æ¬¡æ•°ä¸ºä¸€ä¸ªè¾ƒå°çš„æ•°ï¼ˆé€šå¸¸å°äº10ï¼‰ï¼Œè§†ä¸ºå¸¸æ•°ï¼›è€Œå¯¹äºæ¯ä¸ªåŸºæœ¬å—ï¼Œè¦ä¾æ¬¡éå†åŸºæœ¬å—ä¸­çš„æŒ‡ä»¤ï¼Œåœ¨<code>transferfunction</code>ä¸­å®Œæˆå¯¹æ¯ä¸ªæŒ‡ä»¤çš„åˆ†æï¼ŒåŒæ—¶åœ¨ç­‰ä»·ç±»ä¸­éå†å¯»æ‰¾å€¼è¡¨è¾¾å¼æˆ–å¯¹åº”çš„å€¼ã€‚</p><p>ç»¼ä¸Šåˆ†æï¼Œå¯¹äºä¸€ä¸ªç¨‹åºï¼Œæœ¬å®éªŒç®—æ³•çš„æ—¶é—´å¤æ‚åº¦å¤§çº¦ä¸º$T(n)=O(n^2)$,å…¶ä¸­nä¸ºæŒ‡ä»¤æ¡æ•°</p><p>2.<code>std::shared_ptr</code>å¦‚æœå­˜åœ¨ç¯å½¢å¼•ç”¨ï¼Œåˆ™æ— æ³•æ­£ç¡®é‡Šæ”¾å†…å­˜ï¼Œä½ çš„ Expression ç±»æ˜¯å¦å­˜åœ¨ circular reference?</p><p>ä¸å­˜åœ¨ã€‚<code>Expression</code>çš„å„ä¸ªå­ç±»æ˜¯é€’å½’å®šä¹‰çš„ï¼Œå…¶å­ç±»ä»¥åŠçš„æ„æˆæ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><code>Single Expression</code>ï¼Œç”±ä¸€ä¸ª<code>Value *</code>ç»„æˆï¼Œç”¨æ¥å¤„ç†ç‰¹æ®ŠæŒ‡ä»¤ï¼Œå¦‚éçº¯å‡½æ•°ï¼Œ<code>load</code>,<code>store</code>æŒ‡ä»¤ç­‰</li><li><code>Constant Expression</code>ï¼Œç”±ä¸€ä¸ª<code>Constant *</code>ç»„æˆ</li><li><code>Binary Expression</code>ï¼Œç”±ä¸¤ä¸ª<code>Expression</code>å’ŒæŒ‡ä»¤ç±»å‹ç»„æˆ</li><li><code>Phi Expression</code>ï¼Œç”±ä¸¤ä¸ª<code>Expression</code>ç»„æˆ</li><li><code>Call Expression</code>ï¼Œç”±å‡ ä¸ª<code>Expression</code>å’Œ<code>Function*</code>ç»„æˆ</li><li><code>Gep Expression</code>ï¼Œç”±å‡ ä¸ª<code>Expression</code>ç»„æˆ</li><li><code>Cmp Expression</code>ï¼Œç”±ä¸¤ä¸ª<code>Expression</code>å’ŒæŒ‡ä»¤ç±»å‹ç»„æˆ</li><li><code>Fcmp Expression</code>ï¼Œç”±ä¸¤ä¸ª<code>Expression</code>å’ŒæŒ‡ä»¤ç±»å‹ç»„æˆ</li><li><code>Trans Expression</code>ï¼Œç”±ä¸€ä¸ª<code>Expression</code>å’ŒæŒ‡ä»¤ç±»å‹ç»„æˆ</li></ul><p>æ‰€æœ‰é€’å½’å®šä¹‰çš„Expressionæœ€ç»ˆéƒ½ä¼šå½’ç»“åˆ°<code>Single Expression</code>ä»¥åŠ<code>Constant Expression</code>æŒ‡ä»¤ä¸Šï¼Œä¸ä¼šå‡ºç°ç¯å½¢å¼•ç”¨</p><p>3.å°½ç®¡æœ¬æ¬¡å®éªŒå·²ç»å†™äº†å¾ˆå¤šä»£ç ï¼Œä½†æ˜¯åœ¨ç®—æ³•ä¸Šå’Œå·¥ç¨‹ä¸Šä»ç„¶å¯ä»¥å¯¹ GVN è¿›è¡Œæ”¹è¿›ï¼Œè¯·ç®€è¿°ä½ çš„ GVN å®ç°å¯ä»¥æ”¹è¿›çš„åœ°æ–¹</p><ul><li>æœ¬æ¬¡å®éªŒ<code>ValuePhiFunc</code>å¯¹PhiæŒ‡ä»¤å†—ä½™çš„æ£€æµ‹ä»…ä»…æ£€æµ‹äº†<code>Binaray</code>æŒ‡ä»¤çš„å†—ä½™æƒ…å†µï¼Œå®é™…ä¸Šå¯ä»¥æ‰©å¤§æ£€æµ‹èŒƒå›´ï¼Œå¹¶ä¸”å¢åŠ æ£€æµ‹å†—ä½™çš„å½¢å¼ï¼Œå¦‚æ£€æµ‹<code>phi(0, c+d)</code>ä¸ <code>phi(0,c)+phi(0,d)</code>ï¼Œå®ç°æ€è·¯ç±»ä¼¼ã€‚</li><li>æ•ˆç‡è¾ƒä½ï¼Œå¯¹äºè§„æ¨¡è¾ƒå¤§çš„ä»£ç ï¼ŒGVNåˆ†æçš„æ•ˆç‡ä¼šå˜æ…¢ï¼Œå¯ä»¥é€šè¿‡å‡å°‘ä»£ç ä¸­ä¸å¿…è¦çš„éå†æ“ä½œæé«˜ç®—æ³•æ•ˆç‡ã€‚</li></ul><h2 id="å®éªŒæ€»ç»“"><a href="#å®éªŒæ€»ç»“" class="headerlink" title="å®éªŒæ€»ç»“"></a>å®éªŒæ€»ç»“</h2><ul><li>æœ¬æ¬¡å®éªŒåŸºäºè®ºæ–‡ã€ŠDetection of Redundant Expressions: A Complete and Polynomial-Time Algorithm in SSA ã€‹åŸºäºæ•°æ®æµåˆ†æå®Œæˆäº†SSA IRçš„GVNä¼˜åŒ–ï¼Œé€šè¿‡åŠ¨æ‰‹å®ç°å’Œè®¾è®¡å…·ä½“çš„ç®—æ³•ï¼Œè®©æˆ‘å¯¹æ•°æ®æµåˆ†ææœ‰äº†æ›´æ¸…æ¥šåœ°è®¤è¯†</li><li>æœ¬æ¬¡å®éªŒä½œä¸ºä»£ç ä¼˜åŒ–éƒ¨åˆ†ä¸å‰å‡ æ¬¡å®éªŒå…±åŒå®Œæˆäº†Cminusçš„Compilerï¼Œå¯¹ã€Šç¼–è¯‘åŸç†ä¸æŠ€æœ¯ã€‹ä¸€è¯¾çš„è¯¾ç¨‹å†…å®¹æœ‰äº†æ›´æ¸…æ™°çš„æ•´ä½“è®¤è¯†ã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ€è€ƒé¢˜&quot;&gt;&lt;a href=&quot;#æ€è€ƒé¢˜&quot; class=&quot;headerlink&quot; title=&quot;æ€è€ƒé¢˜&quot;&gt;&lt;/a&gt;æ€è€ƒé¢˜&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;è¯·ç®€è¿°æ¦‚å¿µï¼šæ”¯é…æ€§ã€ä¸¥æ ¼æ”¯é…æ€§ã€ç›´æ¥æ”¯é…æ€§ã€æ”¯é…è¾¹ç•Œã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯é…æ€§&lt;ul&gt;
&lt;li&gt;</summary>
      
    
    
    
    <category term="ç¼–è¯‘åŸç†" scheme="http://sn1987a-1.github.io/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¯‘åŸç†-è¯æ³•åˆ†æ</title>
    <link href="http://sn1987a-1.github.io/posts/8254dc99.html"/>
    <id>http://sn1987a-1.github.io/posts/8254dc99.html</id>
    <published>2022-09-25T12:48:34.000Z</published>
    <updated>2023-09-24T05:22:47.819Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è¯æ³•åˆ†æ"><a href="#è¯æ³•åˆ†æ" class="headerlink" title="è¯æ³•åˆ†æ"></a>è¯æ³•åˆ†æ</h2><h2 id="å®éªŒè¦æ±‚"><a href="#å®éªŒè¦æ±‚" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h2><ul><li>å®ŒæˆåŸºäºflexçš„C-minusè¯æ³•åˆ†æå™¨</li><li>å®ŒæˆåŸºäºbisonçš„C-minusè¯­æ³•åˆ†æå™¨</li></ul><h2 id="å®éªŒéš¾ç‚¹"><a href="#å®éªŒéš¾ç‚¹" class="headerlink" title="å®éªŒéš¾ç‚¹"></a>å®éªŒéš¾ç‚¹</h2><ul><li>æ ¹æ®C-minusçš„è¯æ³•ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å®Œæˆè¯æ³•åˆ†æå™¨</li><li>ç†è§£flexå’Œbisonçš„ç”¨æ³•ä»¥åŠæŒæ¡flexï¼Œbisonè”åŠ¨æ„å»ºè¯­æ³•åˆ†æå™¨çš„æ–¹æ³•</li><li>æ­£ç¡®æ„å»ºC-minusçš„è¯­æ³•æ ‘</li></ul><h2 id="å®éªŒè®¾è®¡"><a href="#å®éªŒè®¾è®¡" class="headerlink" title="å®éªŒè®¾è®¡"></a>å®éªŒè®¾è®¡</h2><ol><li>æ­£åˆ™åŒ¹é…</li></ol><p>æ­£ç¡®åŒ¹é…C-minusçš„æ‰€æœ‰tokenï¼Œä»¥åŠæ³¨é‡Šï¼Œç©ºæ ¼ï¼Œæ¢è¡Œç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œåˆ©ç”¨flexä¸tokençš„åå­—å…³è”èµ·æ¥ï¼ˆä½œä¸ºè¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚:<code>"if" {pos_start = pos_end-1; pos_end ++; pass_node(yytext); return IF;}</code>,åŒæ—¶ç»´æŠ¤<code>pos_start</code>,<code>pos_end</code>ï¼Œ<code>lines</code>çš„å€¼ï¼Œè¡¨è¾¾å¼çš„é¡ºåºä»£è¡¨äº†åŒ¹é…çš„ä¼˜å…ˆçº§ï¼š</p><ul><li>æ³¨é‡Š <code>\/\*(?:[^\*]|\*+[^\/\*])*\*+\/</code></li><li>ç©ºæ ¼ï¼Œåˆ¶è¡¨ç¬¦ <code>" "|\t</code></li><li>æ¢è¡Œ<code>\n</code></li><li>æµ®ç‚¹æ•°<code>[0-9]+\.[0-9]*|[0-9]*\.[0-9]+</code></li><li>æ•´å½¢<code>[0-9]+</code></li><li>å˜é‡å <code>[a-zA-Z_]*</code></li><li>å…¶ä»–token <code>"if" "else" "while" "return""void" "int" "float" "+" "-" "*" "/" "{" "}" "(" ")" "[" "]" "&gt;=" "&gt;" "==" "&lt;=" "&lt;" "!=" "=""," ";"</code></li></ul><ol><li>tokenï¼Œtypeçš„æ•°æ®ç±»å‹</li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">%</span><span class="token keyword">union</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">_syntax_tree_node</span> <span class="token operator">*</span>node<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">%</span>token <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> ERROR ADD SUB IF ELSE WHILE RETURN INT <span class="token operator">%</span>token <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span>FLOAT VOID GE G E L LE NE MUX DIV DOT SEM<span class="token operator">%</span>token <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span>LEFT1 LEFT2 LEFT3 RIGHT1 RIGHT2 RIGHT3 ASS<span class="token operator">%</span>token <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> INTEGER ID FLOATPOINT<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> program<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> type<span class="token operator">-</span>specifier relop addop mulop<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> declaration<span class="token operator">-</span>list declaration var<span class="token operator">-</span>declaration fun<span class="token operator">-</span>declaration<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> local<span class="token operator">-</span>declarations compound<span class="token operator">-</span>stmt statement<span class="token operator">-</span>list statement expression<span class="token operator">-</span>stmt<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> iteration<span class="token operator">-</span>stmt selection<span class="token operator">-</span>stmt <span class="token keyword">return</span><span class="token operator">-</span>stmt expression simple<span class="token operator">-</span>expression<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> var additive<span class="token operator">-</span>expression term factor integer <span class="token keyword">float</span> call<span class="token operator">%</span>type <span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> params param<span class="token operator">-</span>list param args arg<span class="token operator">-</span>list <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>æ„å»ºè¯­æ³•æ ‘</li></ol><p>åˆ©ç”¨bisonæ ¹æ®C-minusçš„è¯­æ³•æ„å»ºè¯­æ³•æ ‘ï¼Œå…¶ä¸­æ¯ä¸ªtypeéƒ½æ˜¯è¯­æ³•æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼Œtokenéƒ½æ˜¯è¯­æ³•æ ‘çš„å¶å­èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">declaration<span class="token operator">-</span>list<span class="token operator">:</span> declaration<span class="token operator">-</span>list declaration <span class="token punctuation">{</span>$$<span class="token operator">=</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token string">"declaration-list"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>$<span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token operator">|</span> declaration <span class="token punctuation">{</span>$$<span class="token operator">=</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token string">"declaration-list"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>param<span class="token operator">-</span>list<span class="token operator">:</span> param<span class="token operator">-</span>list DOT param <span class="token punctuation">{</span>$$<span class="token operator">=</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token string">"param-list"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>$<span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">2</span><span class="token punctuation">,</span>$<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token operator">|</span>param <span class="token punctuation">{</span>$$<span class="token operator">=</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token string">"param-list"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å®éªŒç»“æœéªŒè¯"><a href="#å®éªŒç»“æœéªŒè¯" class="headerlink" title="å®éªŒç»“æœéªŒè¯"></a>å®éªŒç»“æœéªŒè¯</h2><ol><li>testæµ‹è¯•æ ·ä¾‹</li></ol><p>ç•¥</p><ol><li>è‡ªè¡Œè®¾è®¡çš„æ ·ä¾‹</li></ol><ul><li>è·¨è¡Œæ³¨é‡Šå’Œç©ºè¡Œï¼š</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* This my testcase */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºï¼šä¸åœ¨parserå’Œlexerçš„åˆ†æä¸­å‡ºç°</p><ul><li>æ•°ç»„å®šä¹‰</li></ul><p><code>int y[2]</code><br>è¾“å‡º<br>| | | | | &gt;â€”+ var-declaration<br>| | | | | | &gt;â€”+ type-specifier<br>| | | | | | | &gt;â€”<em> int<br>| | | | | | &gt;â€”</em> y<br>| | | | | | &gt;â€”<em> [<br>| | | | | | &gt;â€”</em> 2<br>| | | | | | &gt;â€”<em> ]<br>| | | | | | &gt;â€”</em> ;</p><ul><li>å¾ªç¯</li></ul><pre class="line-numbers language-none"><code class="language-none">while (0) {y=0;}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¾“å‡º<br>| &gt;â€”<em> while<br>| &gt;â€”</em> (<br>| &gt;â€”+ expression<br>| | &gt;â€”+ simple-expression<br>| | | &gt;â€”+ additive-expression<br>| | | | &gt;â€”+ term<br>| | | | | &gt;â€”+ factor<br>| | | | | | &gt;â€”+ integer<br>| | | | | | | &gt;â€”<em> 0<br>| &gt;â€”</em> )<br>| &gt;â€”+ statement<br>| | &gt;â€”+ compound-stmt<br>| | | &gt;â€”<em> {<br>| | | &gt;â€”+ local-declarations<br>| | | | &gt;â€”</em> epsilon<br>| | | &gt;â€”+ statement-list<br>| | | | &gt;â€”+ statement-list<br>| | | | | &gt;â€”<em> epsilon<br>| | | | &gt;â€”+ statement<br>| | | | | &gt;â€”+ expression-stmt<br>| | | | | | &gt;â€”+ expression<br>| | | | | | | &gt;â€”+ var<br>| | | | | | | | &gt;â€”</em> y<br>| | | | | | | &gt;â€”<em> =<br>| | | | | | | &gt;â€”+ expression<br>| | | | | | | | &gt;â€”+ simple-expression<br>| | | | | | | | | &gt;â€”+ additive-expression<br>| | | | | | | | | | &gt;â€”+ term<br>| | | | | | | | | | | &gt;â€”+ factor<br>| | | | | | | | | | | | &gt;â€”+ integer<br>| | | | | | | | | | | | | &gt;â€”</em> 0<br>| | | | | | &gt;â€”<em> ;<br>| | | &gt;â€”</em> }</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;è¯æ³•åˆ†æ&quot;&gt;&lt;a href=&quot;#è¯æ³•åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;è¯æ³•åˆ†æ&quot;&gt;&lt;/a&gt;è¯æ³•åˆ†æ&lt;/h2&gt;&lt;h2 id=&quot;å®éªŒè¦æ±‚&quot;&gt;&lt;a href=&quot;#å®éªŒè¦æ±‚&quot; class=&quot;headerlink&quot; title=&quot;å®éªŒè¦æ±‚&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="ç¼–è¯‘åŸç†" scheme="http://sn1987a-1.github.io/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"/>
    
    
    <category term="ä¸“ä¸šè¯¾" scheme="http://sn1987a-1.github.io/tags/%E4%B8%93%E4%B8%9A%E8%AF%BE/"/>
    
  </entry>
  
</feed>
